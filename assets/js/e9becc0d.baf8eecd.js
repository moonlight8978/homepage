(self.webpackChunkmoonlight_8978_github_io=self.webpackChunkmoonlight_8978_github_io||[]).push([[5789],{3905:function(e,t,n){"use strict";n.d(t,{Zo:function(){return u},kt:function(){return k}});var i=n(7294);function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function r(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function l(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?r(Object(n),!0).forEach((function(t){a(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function o(e,t){if(null==e)return{};var n,i,a=function(e,t){if(null==e)return{};var n,i,a={},r=Object.keys(e);for(i=0;i<r.length;i++)n=r[i],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(i=0;i<r.length;i++)n=r[i],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var p=i.createContext({}),s=function(e){var t=i.useContext(p),n=t;return e&&(n="function"==typeof e?e(t):l(l({},t),e)),n},u=function(e){var t=s(e.components);return i.createElement(p.Provider,{value:t},e.children)},c={inlineCode:"code",wrapper:function(e){var t=e.children;return i.createElement(i.Fragment,{},t)}},m=i.forwardRef((function(e,t){var n=e.components,a=e.mdxType,r=e.originalType,p=e.parentName,u=o(e,["components","mdxType","originalType","parentName"]),m=s(n),k=a,h=m["".concat(p,".").concat(k)]||m[k]||c[k]||r;return n?i.createElement(h,l(l({ref:t},u),{},{components:n})):i.createElement(h,l({ref:t},u))}));function k(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var r=n.length,l=new Array(r);l[0]=m;var o={};for(var p in t)hasOwnProperty.call(t,p)&&(o[p]=t[p]);o.originalType=e,o.mdxType="string"==typeof e?e:a,l[1]=o;for(var s=2;s<r;s++)l[s]=n[s];return i.createElement.apply(null,l)}return i.createElement.apply(null,n)}m.displayName="MDXCreateElement"},3670:function(e,t,n){"use strict";n.r(t),n.d(t,{frontMatter:function(){return o},metadata:function(){return p},toc:function(){return s},default:function(){return c}});var i=n(2122),a=n(9756),r=(n(7294),n(3905)),l=["components"],o={},p={unversionedId:"mysql-chap8/subquery",id:"mysql-chap8/subquery",isDocsHomePage:!1,title:"Optimize Subquery v\u1edbi Semijoin transformation",description:"Ho\xe0ng th\xf9y link//dev.mysql.com/doc/refman/5.7/en/semijoins.html",source:"@site/books/mysql-chap8/2-subquery.md",sourceDirName:"mysql-chap8",slug:"/mysql-chap8/subquery",permalink:"/books/mysql-chap8/subquery",editUrl:"https://github.com/moonlight8978/moonlight8978.github.io/edit/v2/books/books/mysql-chap8/2-subquery.md",version:"current",lastUpdatedAt:1623052541,formattedLastUpdatedAt:"6/7/2021",sidebarPosition:2,frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"T\u1ed1i \u01b0u SELECT",permalink:"/books/mysql-chap8/where"},next:{title:"OAuth2 in Action",permalink:"/books/www/oauth2-in-action"}},s=[{value:"Semijoin l\xe0 g\xec",id:"semijoin-l\xe0-g\xec",children:[]},{value:"Materialization",id:"materialization",children:[]}],u={toc:s};function c(e){var t=e.components,n=(0,a.Z)(e,l);return(0,r.kt)("wrapper",(0,i.Z)({},u,n,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"Ho\xe0ng th\xf9y link:")," ",(0,r.kt)("a",{parentName:"p",href:"https://dev.mysql.com/doc/refman/5.7/en/semijoins.html"},"https://dev.mysql.com/doc/refman/5.7/en/semijoins.html")),(0,r.kt)("h2",{id:"semijoin-l\xe0-g\xec"},"Semijoin l\xe0 g\xec"),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"Semijoin")," l\xe0 qu\xe1 tr\xecnh chu\u1ea9n b\u1ecb tr\u01b0\u1edbc khi query, optimizer c\u1ee7a MySQL c\xf3 th\u1ec3 s\u1eed d\u1ee5ng nhi\u1ec1u strategy nh\u01b0 table pullout, duplicate weedout, first match, loose scan, hay materizalization \u0111\u1ec3 t\u1ed1i \u01b0u c\xe2u l\u1ec7nh subquery."),(0,r.kt)("h4",{id:"v\xed-d\u1ee5-v\u1ec1-semijoin"},"V\xed d\u1ee5 v\u1ec1 semijoin"),(0,r.kt)("p",null,"Gi\u1ea3 s\u1eed ta c\xf3 db v\u1ec1 qu\u1ea3n l\xfd l\u1edbp h\u1ecdc, ",(0,r.kt)("inlineCode",{parentName:"p"},"subject")," l\xe0 danh s\xe1ch t\u1ea5t c\u1ea3 c\xe1c m\xf4n h\u1ecdc, ",(0,r.kt)("inlineCode",{parentName:"p"},"roster")," l\xe0 b\u1ea3ng join c\u1ee7a ",(0,r.kt)("inlineCode",{parentName:"p"},"student")," v\u1edbi ",(0,r.kt)("inlineCode",{parentName:"p"},"subject")," nh\u1eb1m th\u1ec3 hi\u1ec3n h\u1ecdc sinh \u0111\xe3 \u0111\u0103ng k\xed h\u1ecdc m\xf4n n\xe0o. Quan h\u1ec7 gi\u1eefa ",(0,r.kt)("inlineCode",{parentName:"p"},"subject")," v\xe0 ",(0,r.kt)("inlineCode",{parentName:"p"},"student")," l\xe0 many to many."),(0,r.kt)("p",null,"Query sau \u0111\xe2y s\u1ebd l\u1ea5y ra \u0111\u01b0\u1ee3c nh\u1eefng ",(0,r.kt)("inlineCode",{parentName:"p"},"subject")," c\xf3 h\u1ecdc sinh \u0111\u0103ng k\xed."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-SQL"},"SELECT subject.id, subject.name\nFROM subject INNER JOIN roster\nWHERE subject.id = roster.subject_id;\n")),(0,r.kt)("p",null,"Tuy nhi\xean do l\xe0 quan h\u1ec7 many to many, n\xean trong b\u1ea3ng ",(0,r.kt)("inlineCode",{parentName:"p"},"roster")," c\xf3 th\u1ec3 c\xf3 nhi\u1ec1u ",(0,r.kt)("inlineCode",{parentName:"p"},"subject_id")," b\u1ecb tr\xf9ng l\u1eb7p. N\xean k\u1ebft qu\u1ea3 c\u1ee7a query tr\xean c\xf3 th\u1ec3 s\u1ebd b\u1ecb duplicate."),(0,r.kt)("p",null,"Ta c\xf3 th\u1ec3 s\u1eed d\u1ee5ng ",(0,r.kt)("inlineCode",{parentName:"p"},"SELECT DISTINCT")," \u0111\u1ec3 gi\u1ea3i quy\u1ebft v\u1ea5n \u0111\u1ec1 n\xe0y. Tuy nhi\xean vi\u1ec7c query t\u1ea5t, r\u1ed3i kh\u1eed \u0111i nh\u1eefng gi\xe1 tr\u1ecb tr\xf9ng l\u1eb7p nh\u01b0 v\u1eady l\xe0 kh\xf4ng t\u1ed1i \u01b0u."),(0,r.kt)("p",null,"Ta c\xf3 th\u1ec3 gi\u1ea3i quy\u1ebft v\u1ea5n \u0111\u1ec1 tr\xean b\u1eb1ng vi\u1ec7c d\xf9ng subquery."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sql"},"SELECT subject.id, subject.name\nFROM subject INNER JOIN roster\nWHERE subject.id IN (SELECT subject_id FROM roster);\n")),(0,r.kt)("p",null,"C\xe2u truy v\u1ea5n v\u1eeba r\u1ed3i ch\xfang ta s\u1eed d\u1ee5ng s\u1ebd s\u1eed d\u1ee5ng semijoin."),(0,r.kt)("p",null,"C\xe2u truy v\u1ea5n ch\xednh (outer query) c\xf3 th\u1ec3 s\u1eed d\u1ee5ng outer join ho\u1eb7c inner join. V\xe0 reference table c\xf3 th\u1ec3 l\xe0 base table, derived table ho\u1eb7c view."),(0,r.kt)("h4",{id:"\u0111i\u1ec1u-ki\u1ec7n-\u0111\u1ec3-subquery-l\xe0-m\u1ed9t-semiquery"},"\u0110i\u1ec1u ki\u1ec7n \u0111\u1ec3 subquery l\xe0 m\u1ed9t semiquery"),(0,r.kt)("p",null,"Subquery ph\u1ea3i th\u1ecfa m\xe3n nh\u1eefng \u0111i\u1ec1u ki\u1ec7n sau:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Ph\u1ea3i l\xe0 ",(0,r.kt)("inlineCode",{parentName:"li"},"IN")," (ho\u1eb7c ",(0,r.kt)("inlineCode",{parentName:"li"},"=ANY"),") subquery, \u0111\u1eb7t trong m\u1ec7nh \u0111\u1ec1 ",(0,r.kt)("inlineCode",{parentName:"li"},"WHERE")," ho\u1eb7c ",(0,r.kt)("inlineCode",{parentName:"li"},"ON")," \u1edf top-level."),(0,r.kt)("li",{parentName:"ul"},"Kh\xf4ng d\xf9ng ",(0,r.kt)("inlineCode",{parentName:"li"},"UNION"),"."),(0,r.kt)("li",{parentName:"ul"},"Kh\xf4ng c\xf3 m\u1ec7nh \u0111\u1ec1 ",(0,r.kt)("inlineCode",{parentName:"li"},"GROUP BY")," ho\u1eb7c ",(0,r.kt)("inlineCode",{parentName:"li"},"HAVING"),", c\xe1c aggregate functions."),(0,r.kt)("li",{parentName:"ul"},"Kh\xf4ng c\xf3 ",(0,r.kt)("inlineCode",{parentName:"li"},"ORDER BY")," \u0111i k\xe8m v\u1edbi ",(0,r.kt)("inlineCode",{parentName:"li"},"LIMIT"),", ch\u1ec9 c\xf3 ",(0,r.kt)("inlineCode",{parentName:"li"},"ORDER_BY")," th\xf4i th\xec okay."),(0,r.kt)("li",{parentName:"ul"},"Outer query kh\xf4ng d\xf9ng ",(0,r.kt)("inlineCode",{parentName:"li"},"STRAIGHT_JOIN")),(0,r.kt)("li",{parentName:"ul"},"Kh\xf4ng c\xf3 ",(0,r.kt)("inlineCode",{parentName:"li"},"STRAIGHT_JOIN")," trong subquery."),(0,r.kt)("li",{parentName:"ul"},"T\u1ed5ng s\u1ed1 table c\u1ea3 trong inner query l\u1eabn outer query b\xe9 h\u01a1n 61 (maximum number of tables permitted in a join)")),(0,r.kt)("h4",{id:"strategy"},"Strategy"),(0,r.kt)("p",null,"N\u1ebfu th\u1ecfa m\xe3n nh\u1eefng \u0111i\u1ec1u ki\u1ec7n tr\xean, MySQL s\u1ebd convert subquery th\xe0nh semijoin v\xe0 th\u1ef1c hi\u1ec7n t\xednh to\xe1n cost, r\u1ed3i ch\u1ecdn m\u1ed9t trong nh\u1eefng strategy sau:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Table pullout: Convert subquery th\xe0nh join. Ho\u1eb7c s\u1ebd l\u1ea5y table trong inner query ra, truy v\u1ea5n, sau \u0111\xf3 inner join v\u1edbi outer table.")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},(0,r.kt)("a",{parentName:"p",href:"https://mariadb.com/kb/en/library/duplicateweedout-strategy/"},"Duplicate Weedout"),": Join table, l\u1ea5y ra to\xe0n b\u1ed9 k\u1ebft qu\u1ea3 tr\u01b0\u1edbc, sau \u0111\xf3 s\u1eed d\u1ee5ng b\u1ea3ng t\u1ea1m \u0111\u1ec3 remove \u0111i nh\u1eefng gi\xe1 tr\u1ecb duplicate"),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-sql"},"select * from Country\nwhere\n   Country.code IN (select City.Country\n                    from City\n                    where\n                      City.Population > 0.33 * Country.Population and\n                      City.Population > 1*1000*1000);\n")),(0,r.kt)("p",{parentName:"li"},(0,r.kt)("img",{parentName:"p",src:"https://mariadb.com/kb/en/duplicateweedout-strategy/+image/duplicate-weedout-diagram",alt:"duplicate-weedout-diagram"}))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},(0,r.kt)("a",{parentName:"p",href:"https://mariadb.com/kb/en/library/firstmatch-strategy/"},"First Match"),": inner join table, khi t\xecm \u0111\u01b0\u1ee3c m\u1ed9t k\u1ebft qu\u1ea3 th\u1ecfa m\xe3n, n\xf3 s\u1ebd return lu\xf4n, kh\xf4ng t\xecm gi\xe1 tr\u1ecb ti\u1ebfp theo n\u1eefa \u0111\u1ec3 tr\xe1nh duplicate"),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-sql"},"select * from Country\nwhere Country.code IN (select City.Country\n                       from City\n                       where City.Population > 1*1000*1000)\n      and Country.continent='Europe'\n")),(0,r.kt)("p",{parentName:"li"},(0,r.kt)("img",{parentName:"p",src:"https://mariadb.com/kb/en/firstmatch-strategy/+image/firstmatch-firstmatch",alt:"firstmatch-firstmatch"}))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},(0,r.kt)("a",{parentName:"p",href:"https://mariadb.com/kb/en/library/loosescan-strategy/"},"Loose Scan"),": Scan subquery table b\u1eb1ng index, group nh\u1eefng gi\xe1 tr\u1ecb gi\u1ed1ng nhau l\u1ea1i th\xe0nh t\u1eebng group, r\u1ed3i l\u1ea5y m\u1ed9t gi\xe1 tr\u1ecb t\u1eeb m\u1ed7i group."),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-sql"},"select * from Country\nwhere\n  Country.code in (select country_code from Satellite)\n")),(0,r.kt)("p",{parentName:"li"},(0,r.kt)("img",{parentName:"p",src:"https://mariadb.com/kb/en/loosescan-strategy/+image/loosescan-diagram-no-where",alt:"loosescan-diagram-no-where"}))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Materialization: \u0110\u1ec1 c\u1eadp ri\xeang \u1edf d\u01b0\u1edbi"))),(0,r.kt)("h4",{id:"m\u1ed9t-v\xe0i-l\u01b0u-\xfd"},"M\u1ed9t v\xe0i l\u01b0u \xfd:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"C\xf3 th\u1ec3 enable/disable semijoin, strategy b\u1eb1ng bi\u1ebfn ",(0,r.kt)("inlineCode",{parentName:"p"},"optimizer_switch"))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Khi disable ",(0,r.kt)("inlineCode",{parentName:"p"},"duplicateweedout"),", strategy n\xe0y s\u1ebd kh\xf4ng \u0111\u01b0\u1ee3c s\u1eed d\u1ee5ng tr\u1eeb khi t\u1ea5t c\u1ea3 nh\u1eefng strategy kh\xe1c \u0111\u1ec1u kh\xf4ng \xe1p d\u1ee5ng \u0111\u01b0\u1ee3c \u0111\u1ec3 t\u1ed1i \u01b0u."))),(0,r.kt)("h4",{id:"explain-query"},"EXPLAIN query"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Semijoin table s\u1ebd \u0111\u01b0\u1ee3c hi\u1ec3n th\u1ecb \u1edf outer select")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Temporary table \u0111\u01b0\u1ee3c s\u1eed d\u1ee5ng s\u1ebd \u0111\u01b0\u1ee3c ch\u1ec9 ra b\u1eb1ng ",(0,r.kt)("strong",{parentName:"p"},"Start temporary")," v\xe0 ",(0,r.kt)("strong",{parentName:"p"},"End temporary")," trong c\u1ed9t ",(0,r.kt)("inlineCode",{parentName:"p"},"extra"))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},(0,r.kt)("strong",{parentName:"p"},"FirstMatch(table_name)")," trong c\u1ed9t ",(0,r.kt)("inlineCode",{parentName:"p"},"extra")," cho ta bi\u1ebft shortcut \u0111\xe3 \u0111\u01b0\u1ee3c d\xf9ng trong strategy First Match.")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},(0,r.kt)("strong",{parentName:"p"},"LooseScan(m..n)")," trong c\u1ed9t ",(0,r.kt)("inlineCode",{parentName:"p"},"extra")," ch\u1ec9 ra r\u1eb1ng Loose Scan \u0111\xe3 \u0111\u01b0\u1ee3c \xe1p d\u1ee5ng, m, n l\xe0 key part number.")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Temporary table d\xf9ng cho materialization \u0111\u01b0\u1ee3c ch\u1ec9 ra b\u1eb1ng nh\u1eefng row c\xf3 ",(0,r.kt)("strong",{parentName:"p"},"select_type")," c\u1ee7a ",(0,r.kt)("strong",{parentName:"p"},"MATERIALIZED")," v\xe0 nh\u1eefng row c\xf3 ",(0,r.kt)("strong",{parentName:"p"},"table")," c\u1ee7a ",(0,r.kt)("strong",{parentName:"p"},"subqueryN")))),(0,r.kt)("h2",{id:"materialization"},"Materialization"),(0,r.kt)("h4",{id:"materialization-l\xe0-g\xec"},"Materialization l\xe0 g\xec"),(0,r.kt)("p",null,"Khi th\u1ea5y subquery v\xe0 outer query l\xe0 c\xf9ng b\u1ed1 kh\xe1c \xf4ng n\u1ed9i (ch\u1ea3 li\xean quan g\xec t\u1edbi nhau), th\xec subquery ho\xe0n to\xe0n c\xf3 th\u1ec3 t\xe1ch ri\xeang ra, th\u1ef1c thi 2 query \u0111\u1ed9c l\u1eadp, cu\u1ed1i c\xf9ng join 2 table \u0111\xf3 v\u1edbi nhau. \xdd t\u01b0\u1edfng c\u1ee7a strategy n\xe0y l\xe0 nh\u01b0 v\u1eady."),(0,r.kt)("p",null,"Khi s\u1eed d\u1ee5ng strategy n\xe0y, tr\u01b0\u1edbc h\u1ebft MySQL s\u1ebd query subquery, sau \u0111\xf3 l\u1ea5y k\u1ebft qu\u1ea3 \u0111\u1ec3 t\u1ea1o 1 b\u1ea3ng t\u1ea1m (materialize), \u0111\xe1nh index \u0111\u1ec3 remove duplicate, cu\u1ed1i c\xf9ng join v\u1edbi outer table."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sql"},"select * from Country\nwhere Country.code IN (select City.Country\n                       from City\n                       where City.Population > 7*1000*1000)\n      and Country.continent='Europe'\n")),(0,r.kt)("p",null,(0,r.kt)("img",{parentName:"p",src:"https://mariadb.com/kb/en/semi-join-materialization-strategy/+image/sj-materialization1",alt:"sj-materialization1"})),(0,r.kt)("p",null,"Khi th\u1ef1c hi\u1ec7n ph\xe9p join v\u1edbi outer table, c\xf3 2 h\u01b0\u1edbng:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Join t\u1eeb b\u1ea3ng t\u1ea1m v\xe0o outer table"),(0,r.kt)("p",{parentName:"li"},"N\u1ebfu l\xe0m v\u1eady, ta s\u1ebd ph\u1ea3i th\u1ef1c hi\u1ec7n fullscan b\u1ea3ng t\u1ea1m, sau \u0111\xf3 lookup nh\u1eefng gi\xe1 tr\u1ecb \u0111\xf3 trong outer table"),(0,r.kt)("p",{parentName:"li"},"=> g\u1ecdi l\xe0 Materialization-scan")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Join t\u1eeb outer table v\xe0o b\u1ea3ng t\u1ea1m"),(0,r.kt)("p",{parentName:"li"},"Khi \u0111\xf3 ta s\u1ebd d\xf9ng gi\xe1 tr\u1ecb \u1edf outer table \u0111\u1ec3 lookup trong b\u1ea3ng t\u1ea1m"),(0,r.kt)("p",{parentName:"li"},"=> g\u1ecdi l\xe0 Materialization-lookup"))),(0,r.kt)("h4",{id:"\u0111i\u1ec1u-ki\u1ec7n"},"\u0110i\u1ec1u ki\u1ec7n"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-sql"},"(oe_1, oe_2, ..., oe_N) [NOT] IN (SELECT ie_1, i_2, ..., ie_N ...)\n")))),(0,r.kt)("p",null,"N\u1ebfu predicate c\xf3 form nh\u01b0 tr\xean, ",(0,r.kt)("inlineCode",{parentName:"p"},"oe_1")," v\xe0 ",(0,r.kt)("inlineCode",{parentName:"p"},"ie_1")," kh\xf4ng \u0111\u01b0\u1ee3c null."),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-sql"},"oe [NOT] IN (SELECT ie ...)\n")))),(0,r.kt)("p",null,"Predicate form n\xe0y ch\u1ea5p nh\u1eadn gi\xe1 tr\u1ecb null."),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Outer expression v\xe0 inner expression ph\u1ea3i c\xf3 c\xf9ng ki\u1ec3u d\u1eef li\u1ec7u"),(0,r.kt)("li",{parentName:"ul"},"Inner expression kh\xf4ng \u0111\u01b0\u1ee3c l\xe0 ki\u1ec3u ",(0,r.kt)("inlineCode",{parentName:"li"},"BLOB"))),(0,r.kt)("h4",{id:"rewrite-sql"},"Rewrite SQL"),(0,r.kt)("p",null,"Khi disable materialization semijoin \u0111i, MySQL c\xf3 th\u1ec3 s\u1ebd convert c\xe2u l\u1ec7nh subquery c\u1ee7a ta."),(0,r.kt)("p",null,"VD:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sql"},"SELECT * FROM t1\nWHERE t1.a IN (SELECT t2.b FROM t2 WHERE where_condition);\n")),(0,r.kt)("p",null,"\u1ede v\xed d\u1ee5 tr\xean, subquery ho\xe0n to\xe0n kh\xf4ng li\xean quan g\xec t\u1edbi outer query, n\u1ebfu b\xecnh th\u01b0\u1eddng l\xe0 c\xf3 th\u1ec3 d\xf9ng materialization r\u1ed3i, nh\u01b0ng n\u1ebfu ta disable \u0111i, MySQL s\u1ebd convert l\u1ea1i th\xe0nh nh\u01b0 sau:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sql"},"SELECT * FROM t1\nWHERE EXISTS (SELECT t2.b FROM t2 WHERE where_condition AND t1.a=t2.b);\n")),(0,r.kt)("p",null,"Inner query v\xe0 outer query \u0111\xe3 tr\u1edf th\xe0nh l\xe1ng gi\u1ec1ng v\u1edbi nhau."),(0,r.kt)("p",null,"V\xe0 c\u1ee9 m\u1ed7i row c\u1ee7a ",(0,r.kt)("inlineCode",{parentName:"p"},"t1"),", s\u1ebd ph\u1ea3i lookup 1 l\u1ea7n trong subquery table, kh\xe1 th\u1ed1n."),(0,r.kt)("h4",{id:"example"},"Example"),(0,r.kt)("p",null,"Database structure: ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/moonlight8978/rsch-glr/blob/mysql/subquery/mysql-optimization/subquery/db/schema.rb"},"link")),(0,r.kt)("h6",{id:"first-match"},"First Match"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sql"},"explain select cities.name from cities where id IN (select city_id from populations where number > 5000000)\\G\n")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-txt"},"*************************** 1. row ***************************\n           id: 1\n  select_type: SIMPLE\n        table: cities\n   partitions: NULL\n         type: ALL\npossible_keys: PRIMARY\n          key: NULL\n      key_len: NULL\n          ref: NULL\n         rows: 7\n     filtered: 100.00\n        Extra: NULL\n*************************** 2. row ***************************\n           id: 1\n  select_type: SIMPLE\n        table: populations\n   partitions: NULL\n         type: ALL\npossible_keys: index_populations_on_city_id\n          key: NULL\n      key_len: NULL\n          ref: NULL\n         rows: 7\n     filtered: 33.33\n        Extra: Using where; FirstMatch(cities); Using join buffer (Block Nested Loop)\n2 rows in set, 1 warning (0.00 sec)\n")),(0,r.kt)("h6",{id:"loose-scan"},"Loose Scan"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sql"},"explain select cities.name from cities where id IN (select city_id from satellites)\\G\n")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-txt"},"*************************** 1. row ***************************\n           id: 1\n  select_type: SIMPLE\n        table: satellites\n   partitions: NULL\n         type: index\npossible_keys: index_satellites_on_city_id\n          key: index_satellites_on_city_id\n      key_len: 9\n          ref: NULL\n         rows: 4\n     filtered: 50.00\n        Extra: Using where; Using index; LooseScan\n*************************** 2. row ***************************\n           id: 1\n  select_type: SIMPLE\n        table: cities\n   partitions: NULL\n         type: eq_ref\npossible_keys: PRIMARY\n          key: PRIMARY\n      key_len: 8\n          ref: app_development.satellites.city_id\n         rows: 1\n     filtered: 100.00\n        Extra: NULL\n2 rows in set, 1 warning (0.00 sec)\n")),(0,r.kt)("p",null,"\u0110o\u1ea1n explain tr\xean ch\u1ec9 ra r\u1eb1ng, b\u1ea3ng ",(0,r.kt)("inlineCode",{parentName:"p"},"satellites")," \u0111\xe3 \u0111\u01b0\u1ee3c \xe1p d\u1ee5ng strategy LooseScan, n\xf3 s\u1ebd group nh\u1eefng gi\xe1 tr\u1ecb gi\u1ed1ng nhau l\u1ea1i, v\xe0 l\u1ea5y ra 1 gi\xe1 tr\u1ecb trong m\u1ed7i group."),(0,r.kt)("p",null,"Cu\u1ed1i c\xf9ng join v\u1edbi b\u1ea3ng ",(0,r.kt)("inlineCode",{parentName:"p"},"cities")," v\u1edbi access_method ",(0,r.kt)("inlineCode",{parentName:"p"},"eq_ref"),"."),(0,r.kt)("h6",{id:"materialization-1"},"Materialization"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sql"},"set session optimizer_switch='duplicateweedout=off,firstmatch=off,loosescan=off';\nexplain select cities.name from cities where id IN (select city_id from populations where number > 5000000)\\G\n")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-txt"},"*************************** 1. row ***************************\n           id: 1\n  select_type: SIMPLE\n        table: cities\n   partitions: NULL\n         type: ALL\npossible_keys: PRIMARY\n          key: NULL\n      key_len: NULL\n          ref: NULL\n         rows: 7\n     filtered: 100.00\n        Extra: Using where\n*************************** 2. row ***************************\n           id: 1\n  select_type: SIMPLE\n        table: <subquery2>\n   partitions: NULL\n         type: eq_ref\npossible_keys: <auto_key>\n          key: <auto_key>\n      key_len: 9\n          ref: app_development.cities.id\n         rows: 1\n     filtered: 100.00\n        Extra: NULL\n*************************** 3. row ***************************\n           id: 2\n  select_type: MATERIALIZED\n        table: populations\n   partitions: NULL\n         type: ALL\npossible_keys: index_populations_on_city_id,index_populations_on_number\n          key: NULL\n      key_len: NULL\n          ref: NULL\n         rows: 7\n     filtered: 57.14\n        Extra: Using where\n3 rows in set, 1 warning (0.00 sec)\n")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Row 3 cho th\u1ea5y b\u1ea3ng populations \u0111\xe3 \u0111\u01b0\u1ee3c query, nh\u01b0ng v\u1edbi \u0111i\u1ec1u ki\u1ec7n ",(0,r.kt)("inlineCode",{parentName:"li"},"population > 5000000")," th\xec kh\xf4ng c\xf3 index n\xe0o \u0111\u01b0\u1ee3c d\xf9ng, v\xe0 n\xf3 th\u1ef1c hi\u1ec7n fullscan. MySQL d\xf9ng k\u1ebft qu\u1ea3 \u0111\xf3 \u0111\u1ec3 t\u1ea1o n\xean materialized table, ch\xednh l\xe0 b\u1ea3ng ",(0,r.kt)("inlineCode",{parentName:"li"},"<subquery2>")," \u1edf Row 1."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"eq_ref")," cho th\u1ea5y ",(0,r.kt)("inlineCode",{parentName:"li"},"<subquery2>")," v\xe0 ",(0,r.kt)("inlineCode",{parentName:"li"},"cities")," \u0111\xe3 join v\u1edbi nhau, ",(0,r.kt)("inlineCode",{parentName:"li"},"<subquery2>")," fullscan => \u0111\xe2y ch\xednh l\xe0 strategy Materialization-Scan.")),(0,r.kt)("h6",{id:"rewrite-sql-1"},"Rewrite SQL"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sql"},"explain select cities.name from cities where id IN (select city_id from populations)\\G;\n")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-txt"},"*************************** 1. row ***************************\n           id: 1\n  select_type: PRIMARY\n        table: cities\n   partitions: NULL\n         type: ALL\npossible_keys: NULL\n          key: NULL\n      key_len: NULL\n          ref: NULL\n         rows: 7\n     filtered: 100.00\n        Extra: Using where\n*************************** 2. row ***************************\n           id: 2\n  select_type: DEPENDENT SUBQUERY\n        table: populations\n   partitions: NULL\n         type: index_subquery\npossible_keys: index_populations_on_city_id\n          key: index_populations_on_city_id\n      key_len: 9\n          ref: func\n         rows: 7\n     filtered: 100.00\n        Extra: Using index\n2 rows in set, 1 warning (0.00 sec)\n")))}c.isMDXComponent=!0}}]);