<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-list-page plugin-blog plugin-id-default" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.1.1">
<title data-rh="true">Blog | Welcome to my personal blog | _MoonLight_</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://moonlight8978.github.io/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://moonlight8978.github.io/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://moonlight8978.github.io/blog"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" property="og:title" content="Blog | Welcome to my personal blog | _MoonLight_"><meta data-rh="true" name="description" content="Blog"><meta data-rh="true" property="og:description" content="Blog"><meta data-rh="true" name="docusaurus_tag" content="blog_posts_list"><meta data-rh="true" name="docsearch:docusaurus_tag" content="blog_posts_list"><link data-rh="true" rel="icon" href="/favicon.ico"><link data-rh="true" rel="canonical" href="https://moonlight8978.github.io/blog"><link data-rh="true" rel="alternate" href="https://moonlight8978.github.io/blog" hreflang="en"><link data-rh="true" rel="alternate" href="https://moonlight8978.github.io/blog" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Welcome to my personal blog | _MoonLight_ RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Welcome to my personal blog | _MoonLight_ Atom Feed">




<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.24/dist/katex.min.css" integrity="sha384-odtC+0UGzzFL/6PNoE8rX/SPcQDXBJ+uRepguP4QkPCm2LBxH3FA3y+fKSiJ+AmM" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/styles.9709e2f3.css">
<script src="/assets/js/runtime~main.0f8698e7.js" defer="defer"></script>
<script src="/assets/js/main.2e5390a1.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_pAeB" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/peach-goma-pc-night-keyboard-smashing-sd.gif" alt="Goma smashing his keyboard" class="themedComponent_RIc6 themedComponent--light_aQWN"><img src="/peach-goma-pc-night-keyboard-smashing-sd.gif" alt="Goma smashing his keyboard" class="themedComponent_RIc6 themedComponent--dark_XAeT"></div><b class="navbar__title text--truncate">Home</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/blog">Blog</a><a class="navbar__item navbar__link" href="/docs/intro">Notes</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/facebook/docusaurus" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_sT5S"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_c7W3 colorModeToggle_k_Ia"><button class="clean-btn toggleButton_vdzZ toggleButtonDisabled_T9bY" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_Vd5J"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_Yt2c"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_cTIM"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_jMRO"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_WlgU thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_knSc margin-bottom--md">Recent posts</div><ul class="sidebarItemList_OaoK clean-list"><li class="sidebarItem_gihs"><a class="sidebarItemLink_dDE_" href="/blog/tim-hieu-ve-active-record-encryption">Tìm hiểu về Active Record Encryption</a></li><li class="sidebarItem_gihs"><a class="sidebarItemLink_dDE_" href="/blog/websocket-hoat-dong-nhu-the-nao">WebSocket hoạt động như thế nào?</a></li><li class="sidebarItem_gihs"><a class="sidebarItemLink_dDE_" href="/blog/cung-tim-hieu-ve-puma-ruby-on-rails">Cùng tìm hiểu về Puma (Ruby on Rails)</a></li><li class="sidebarItem_gihs"><a class="sidebarItemLink_dDE_" href="/blog/cuoi-react-native-xem-appium-phan-1-cung-tim-hieu-cach-hoat-dong-cua-appium">Cưỡi React Native xem Appium (Phần 1 - Cùng tìm hiểu cách hoạt động của Appium)</a></li><li class="sidebarItem_gihs"><a class="sidebarItemLink_dDE_" href="/blog/gioi-thieu-ve-kubernetes">Giới thiệu về Kubernetes</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="https://schema.org/Blog"><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="https://schema.org/BlogPosting"><meta itemprop="description" content="Overview"><header><h2 class="title_DEF8" itemprop="headline"><a itemprop="url" href="/blog/tim-hieu-ve-active-record-encryption">Tìm hiểu về Active Record Encryption</a></h2><div class="container_Y0Yj margin-vert--md"><time datetime="2021-06-17T00:00:00.000Z" itemprop="datePublished">June 17, 2021</time> · <!-- -->8 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_fNYc"><div class="avatar margin-bottom--sm"><a href="https://github.com/moonlight8978" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://avatars.githubusercontent.com/u/26299310?v=4" alt="Lê Sĩ Bích" itemprop="image"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/moonlight8978" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Lê Sĩ Bích</span></a></div><small class="avatar__subtitle" itemprop="description">Ruby on Rails/React Developer</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><h2 class="anchor anchorWithStickyNavbar_FlIw" id="overview">Overview<a href="#overview" class="hash-link" aria-label="Direct link to Overview" title="Direct link to Overview">​</a></h2>
<p>Vào ngày 28/5/2021, trên blog của Rails có thông báo về 1 tính năng mới đó là <a href="https://weblog.rubyonrails.org/2021/5/28/this-week-in-rails-active-record-encrytion-several-performance-optimizations-and-much-more/" target="_blank" rel="noopener noreferrer">ActiveRecord Encryption</a>.</p>
<p>ActiveRecord Encryption giúp encrypt attribute nào đó của model, và lưu vào DB dưới dạng mã hoá. Tính năng này được extract ra từ dự án <a href="https://www.hey.com" target="_blank" rel="noopener noreferrer">HEY</a> của Basecamp.</p>
<p>Hãy thử tìm hiểu xem tính năng này có gì thú vị.</p>
<h2 class="anchor anchorWithStickyNavbar_FlIw" id="usage">Usage<a href="#usage" class="hash-link" aria-label="Direct link to Usage" title="Direct link to Usage">​</a></h2>
<p>Theo <a href="https://edgeguides.rubyonrails.org/active_record_encryption.html#basic-usage" target="_blank" rel="noopener noreferrer">guide</a>, đầu tiên chúng ta sẽ cần phải chạy câu lệnh sau</p>
<div class="language-bash codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-bash codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token plain">rails db:encryption:init</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Rails sẽ cho ta 1 gợi ý là copy đống sau vào credentials. Ừ <code>EDITOR=vim rails credentials:edit</code> rồi copy paste thôi.</p>
<div class="language-yml codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-yml codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">active_record_encryption</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">primary_key</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> EGY8WhulUOXixybod7ZWwMIL68R9o5kC</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">deterministic_key</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> aPA5XyALhf75NNnMzaspW7akTfZp0lPY</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">key_derivation_salt</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> xEY0dt6TZcAMg52K7O84wYzkjvbA62Hz</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Trong model, ta define attribute cần mã hoá như sau:</p>
<div class="language-ruby codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-ruby codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token plain">class Article &lt; ApplicationRecord</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  encrypts :title</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Rồi create/update model như bình thường</p>
<div class="language-ruby codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-ruby codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token plain">article = Article.create(title: &quot;Encrypt it all!&quot;)</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Và bùm, magic...</p>
<div class="language-sql codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-sql codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">INSERT</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">INTO</span><span class="token plain"> </span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token identifier">articles</span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token identifier">title</span><span class="token identifier punctuation" style="color:#393A34">`</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">VALUES</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;{\&quot;p\&quot;:\&quot;n7J0/ol+a7DRMeaE\&quot;,\&quot;h\&quot;:{\&quot;iv\&quot;:\&quot;DXZMDWUKfp3bg/Yu\&quot;,\&quot;at\&quot;:\&quot;X1/YjMHbHD4talgF9dt61A==\&quot;}}&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Vô hạn bối rối...</p>
<h2 class="anchor anchorWithStickyNavbar_FlIw" id="aes">AES<a href="#aes" class="hash-link" aria-label="Direct link to AES" title="Direct link to AES">​</a></h2>
<p>Trước tiên ta hãy tìm hiểu về đống key mà Rails đã gen cho ta lúc đầu</p>
<div class="language-yml codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-yml codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">active_record_encryption</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">primary_key</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> EGY8WhulUOXixybod7ZWwMIL68R9o5kC</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">deterministic_key</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> aPA5XyALhf75NNnMzaspW7akTfZp0lPY</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">key_derivation_salt</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> xEY0dt6TZcAMg52K7O84wYzkjvbA62Hz</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Rails gen ra đống trên như nào vậy?</p>
<div class="language-ruby codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-ruby codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token plain">puts &lt;&lt;~MSG</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Add this entry to the credentials of the target environment:#{&#x27; &#x27;}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  active_record_encryption:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    primary_key: #{SecureRandom.alphanumeric(32)}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    deterministic_key: #{SecureRandom.alphanumeric(32)}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    key_derivation_salt: #{SecureRandom.alphanumeric(32)}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">MSG</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Nếu ai chưa biết thì đây là <a href="https://ruby-doc.org/stdlib-3.0.1/libdoc/securerandom/rdoc/SecureRandom.html" target="_blank" rel="noopener noreferrer">standard lib của Ruby</a>, đơn thuần là... random mà thôi =))</p>
<p>Thế đống key này để làm gì? Ở mục <a href="https://edgeguides.rubyonrails.org/active_record_encryption.html#setup" target="_blank" rel="noopener noreferrer">Setup</a> của guide, Rails cũng đã gợi ý cho ta, đống này dùng cho AES.</p>
<blockquote>
<p>this will be used to derive the AES 32 bytes key</p>
</blockquote>
<p>Vậy AES là cái khỉ mốc gì? Theo <a href="https://en.wikipedia.org/wiki/Advanced_Encryption_Standard" target="_blank" rel="noopener noreferrer">wiki</a>, AES là viết tắt của <strong>A</strong>dvanced <strong>E</strong>ncryption <strong>S</strong>tandard. Hay còn được biết đến với cái tên Rijndael. AES là 1 chuẩn mã hoá, sử dụng symmetric encryption. AES rất phổ biến ngày nay.</p>
<p>Thế bất nào mà lại đẻ ra thêm nhiều thuật ngữ hại não hơn vậy =)) Cứ từ từ rồi khoai sẽ nhừ, chúng ta sẽ tìm hiểu tiếp.</p>
<p>Trước hết thì, thế nào là mã hoá? Ví dụ như ở 1 diễn đàn nào đó người ta share nhau hoàng thuỳ link bằng đống kí tự này</p>
<blockquote>
<p>68747470733A2F2F7777772E676F6F676C652E636F6D2E766E2F</p>
</blockquote>
<p>thay vì huỵch toẹt ra là một đường link <del>đồi truỵ</del> nào đó. Nhưng do việc giải mã quá đơn giản, cụ thể là dùng mã HEX, nên đây chỉ là encode/decode sang 1 dạng dữ liệu khác mà thôi, và việc chuyển đổi thường khá nhanh. Các bạn có thể vào đây <a href="https://www.convertstring.com/vi/EncodeDecode/HexDecode" target="_blank" rel="noopener noreferrer">đây</a> để decode chuỗi huyền bí trên.</p>
<p>Còn encrypt và decrypt dùng trong cryptography nó ở 1 tầm cao khác. Thông thường sẽ có thêm 1 key (hoặc 1 cặp key public/private). Khi đó input sẽ là key + data. Và output sẽ là 1 chuỗi nào đó, chuỗi này cực kì khó để giải mã nếu không nắm trong tay key. Thông thường thì phải cho chạy thuật toán vét cạn - tức là thử từng key một, và việc này cần đến hàng triệu năm đối với cả siêu máy tính.</p>
<ul>
<li>Với thuật toán dùng 1 key cho cả việc encrypt lẫn decrypt thì sẽ được gọi là <strong>symmetric encryption</strong></li>
</ul>
<p><img decoding="async" loading="lazy" alt="symmetric" src="/assets/images/symmetric-encryption-c4990731ab3014224c16d7235e908fbe.png" width="730" height="409" class="img_XBWr"></p>
<ul>
<li>Thuật toán dùng 1 cặp key, trong đó public key để mã hoá, còn private key để giải mã, được gọi là <strong>asymmetric encryption</strong></li>
</ul>
<p><img decoding="async" loading="lazy" alt="asymmetric" src="/assets/images/asymmetric-encryption-76191effbf7bf88a765cf47ab256a20d.png" width="730" height="409" class="img_XBWr"></p>
<p><a href="https://hackernoon.com/symmetric-and-asymmetric-encryption-5122f9ec65b1" target="_blank" rel="noopener noreferrer">Image source</a></p>
<p>Quay lại với AES, nó dùng symmetric, nên sẽ dùng 1 key cho cả việc mã hoá lẫn giải mã. AES key có độ dài là 128, 192, hoặc 256 bit. Tuỳ vào độ dài key nó sẽ có tên khác nhau AES-128, AES-192, AES-256. Key càng dài thì việc xử lý càng lâu, nhưng đổi lại càng bảo mật hơn. Mặc định Rails sử dụng key có độ d ài 256 bit (32 bytes)</p>
<div class="language-ruby codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-ruby codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token plain">CIPHER_TYPE = &quot;aes-256-gcm&quot;</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Về việc làm thế nào để AES mã hoá/giải mã thì mình sẽ không đề cập tại đây <del>vì mình cũng không có hiểu mấy =))</del>, nếu ai muốn tìm hiểu thêm có thể xem link <a href="https://www.youtube.com/watch?v=lnKPoWZnNNM" target="_blank" rel="noopener noreferrer">này</a>, hoặc gúc gồ ~~. Ở dưới là bản preview, trông cái thuật toán nó nôm na như sau</p>
<p>AES sẽ chia nhỏ input thành từng block để xử lý</p>
<p><img decoding="async" loading="lazy" alt="block-cipher" src="/assets/images/aes-block-cipher-ba94fcb32b74eafd7a18ddbb9374e1e2.png" width="1152" height="732" class="img_XBWr"></p>
<p><img decoding="async" loading="lazy" alt="flow" src="/assets/images/aes-flow-3601bffc1d50d478fe633836df3bf026.jpeg" width="605" height="423" class="img_XBWr"></p>
<p><img decoding="async" loading="lazy" alt="round" src="/assets/images/aes-round-06e45529741ace75731d96822323cb45.jpeg" width="387" height="308" class="img_XBWr"></p>
<p><a href="https://www.tutorialspoint.com/cryptography/advanced_encryption_standard.htm" target="_blank" rel="noopener noreferrer">Image Source</a></p>
<p>Cơ mà chỉ quan tâm là một chuỗi đầu vào + 1 key, đi qua đống black magic rồi trở thành 1 chuỗi bảo mật siêu hạng là quá đủ cho một cuộc tình rồi.</p>
<p>À mà nhìn cái constant Rails define ở trên kia, lại có thêm cái gì ở cuối chuỗi thế nhỉ. <code>gcm</code>???? Bối rối again.</p>
<h2 class="anchor anchorWithStickyNavbar_FlIw" id="gcm">GCM<a href="#gcm" class="hash-link" aria-label="Direct link to GCM" title="Direct link to GCM">​</a></h2>
<p>GCM là viết tắt của <strong>G</strong>alois/<strong>C</strong>ounter <strong>M</strong>ode... Nghe xong hiểu chết liền .__. Mò thử xem nào!</p>
<p>Như tên gọi của nó, GCM là một <em>mode</em> trong symmetric encryption, kết hợp của <strong>Counter Mode</strong> và <strong>Galois Mode</strong>, dùng cho mã hoá dạng khối (block). Vậy thì AES đi với GCM là chuẩn bài rồi nhỉ.</p>
<p>Ngoài GCM ra còn các mode khác như CCM, SIV, ...vân vân mây mây. Các bạn có thể xem thêm tại <a href="https://en.wikipedia.org/wiki/Block_cipher_mode_of_operation" target="_blank" rel="noopener noreferrer">đây</a></p>
<p>Trước tiên ta hãy bắt đầu từ <strong>mode</strong>, từ này nằm trong <strong>Mode of Operation</strong>. Các mode sẽ được apply trên từng block data (như đã nói ở trên thì AES chia data thành các block nhỏ và mã hoá), giúp cho output của việc mã hoá block bảo mật hơn.</p>
<p>Counter mode sử dụng 1 số integer làm counter, qua từng block counter sẽ tăng lên 1. Ở mỗi block, số này sẽ được mã hoá cùng với data để có được output bảo mật hơn.</p>
<p><img decoding="async" loading="lazy" alt="counter-mode" src="/assets/images/ctr-mode-2014a29f09bb87b5f9d8ccefab9d6cb9.png" width="1219" height="484" class="img_XBWr"></p>
<p>Galois Mode là một authentication mode. Galois Mode giúp đảm bảo rằng cipher output của ta không bị chỉnh sửa bởi một bên thứ 3. Hoạt động như nào thì mình chịu à =))</p>
<p>Kết hợp 2 mode trên và ta có GCM, giúp thuật toán mã hoá của ta bảo mật hơn, đồng thời đảm bảo được tính toàn vẹn của dữ liệu.</p>
<p><img decoding="async" loading="lazy" alt="gcm-mode" src="/assets/images/gcm-mode-e5c2e6aa4299003be322c78d1a8b0d93.png" width="534" height="563" class="img_XBWr"></p>
<p>Bên trên là giải thích sơ qua về thuật toán mã hoá mà Rails sử dụng, nếu có sai sót thì cũng đừng gạch đá tội mình =))</p>
<h2 class="anchor anchorWithStickyNavbar_FlIw" id="aes-256-gcm-meets-rails">AES-256-GCM meets Rails<a href="#aes-256-gcm-meets-rails" class="hash-link" aria-label="Direct link to AES-256-GCM meets Rails" title="Direct link to AES-256-GCM meets Rails">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_FlIw" id="encryption-key">Encryption Key<a href="#encryption-key" class="hash-link" aria-label="Direct link to Encryption Key" title="Direct link to Encryption Key">​</a></h3>
<div class="language-yml codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-yml codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">active_record_encryption</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">primary_key</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> EGY8WhulUOXixybod7ZWwMIL68R9o5kC</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">deterministic_key</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> aPA5XyALhf75NNnMzaspW7akTfZp0lPY</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">key_derivation_salt</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> xEY0dt6TZcAMg52K7O84wYzkjvbA62Hz</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Quay trở lại với đống key, hãy cùng mò code đáy bể xem chúng dẫn ta tới đâu <!-- -->:v</p>
<div class="language-ruby codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-ruby codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token plain"># https://github.com/rails/rails/blob/9c091b4fd378df515c4c31b85bb6a968463a1d82/activerecord/lib/active_record/railtie.rb#L313-L317</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ActiveRecord::Encryption.configure \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  primary_key: app.credentials.dig(:active_record_encryption, :primary_key),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  deterministic_key: app.credentials.dig(:active_record_encryption, :deterministic_key),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  key_derivation_salt: app.credentials.dig(:active_record_encryption, :key_derivation_salt),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  **config.active_record.encryption</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># https://github.com/rails/rails/blob/9c091b4fd378df515c4c31b85bb6a968463a1d82/activerecord/lib/active_record/encryption/configurable.rb#L20-L33</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">def configure(primary_key:, deterministic_key:, key_derivation_salt:, **properties)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  config.primary_key = primary_key</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  config.deterministic_key = deterministic_key</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  config.key_derivation_salt = key_derivation_salt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  context.key_provider = ActiveRecord::Encryption::DerivedSecretKeyProvider.new(primary_key)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># https://github.com/rails/rails/blob/9c091b4fd378df515c4c31b85bb6a968463a1d82/activerecord/lib/active_record/encryption/derived_secret_key_provider.rb#L7-L9</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">def initialize(passwords)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  super(Array(passwords).collect { |password| Key.derive_from(password) })</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Xem tiếp class <code>Key</code> có gì nào.</p>
<div class="language-ruby codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-ruby codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token plain"># https://github.com/rails/rails/blob/9c091b4fd378df515c4c31b85bb6a968463a1d82/activerecord/lib/active_record/encryption/key.rb#L10-L26</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class Key</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  def initialize(secret)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @secret = secret</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @public_tags = Properties.new</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  def self.derive_from(password)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    secret = ActiveRecord::Encryption.key_generator.derive_key_from(password)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ActiveRecord::Encryption::Key.new(secret)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># https://github.com/rails/rails/blob/9c091b4fd378df515c4c31b85bb6a968463a1d82/activerecord/lib/active_record/encryption/key_generator.rb#L32-L34</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">def derive_key_from(password, length: key_length)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ActiveSupport::KeyGenerator.new(password).generate_key(ActiveRecord::Encryption.config.key_derivation_salt, length)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Như vậy, 2 trong số 3 thanh niên của ta đã bị lộ mặt:</p>
<ul>
<li><code>primary_key</code> đóng vai trò là <code>password</code> param của <code>ActiveSupport::KeyGenerator.new</code></li>
<li><code>key_derivation_salt</code> đóng vai trò là tham số thứ nhất của <code>ActiveSupport::KeyGenerator#generate_key</code></li>
</ul>
<p>Hãy check tiếp <code>ActiveSupport::KeyGenerator</code></p>
<div class="language-ruby codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-ruby codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token plain"># https://github.com/rails/rails/blob/9c091b4fd378df515c4c31b85bb6a968463a1d82/activesupport/lib/active_support/key_generator.rb#L26-L41</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">def initialize(secret, options = {})</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  @secret = secret</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  @iterations = options[:iterations] || 2**16</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  @hash_digest_class = options[:hash_digest_class] || self.class.hash_digest_class</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">def generate_key(salt, key_size = 64)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  OpenSSL::PKCS5.pbkdf2_hmac(@secret, salt, @iterations, key_size, @hash_digest_class.new)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Qua hết wrapper của Rails rồi, giờ ta phải mò vào docs của Ruby thôi.
Theo <a href="https://ruby-doc.org/stdlib-3.0.1/libdoc/openssl/rdoc/OpenSSL.html#module-OpenSSL-label-Encryption" target="_blank" rel="noopener noreferrer">docs</a>, docs lại bảo hàm này giờ đổi tên thành <a href="https://ruby-doc.org/stdlib-3.0.1/libdoc/openssl/rdoc/OpenSSL/KDF.html#method-c-pbkdf2_hmac" target="_blank" rel="noopener noreferrer"><code>OpenSSL::KDF.pbkdf2_hmac</code></a> mất rồi... Ờ thì lại mò vào xem. Nôm na hàm này sẽ tạo ra 1 cipher key dùng cho việc mã hoá.</p>
<p>Tại đây, ta có thể kết luận key mã hoá mà Rails dùng có:</p>
<ul>
<li><code>passphrase</code>: <code>primary_key</code></li>
<li><code>salt</code>: <code>key_derivation_salt</code></li>
<li><code>iterations</code>: 2^16</li>
<li><code>key_len</code>: độ dài key 32 bytes</li>
<li><code>digest</code>: hash algorithm SHA-1</li>
</ul>
<p>Hãy cùng test qua cái key này xem</p>
<div class="language-ruby codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-ruby codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token plain">require &#x27;openssl&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cipher = OpenSSL::Cipher.new(&#x27;aes-256-gcm&#x27;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cipher.encrypt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">iv = cipher.random_iv</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pwd = &#x27;EGY8WhulUOXixybod7ZWwMIL68R9o5kC&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">salt = &#x27;xEY0dt6TZcAMg52K7O84wYzkjvbA62Hz&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">iter = 2**16</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">key_len = OpenSSL::Cipher.new(&quot;aes-256-gcm&quot;).key_len</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">digest = OpenSSL::Digest.new(&#x27;SHA1&#x27;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">key = OpenSSL::PKCS5.pbkdf2_hmac(pwd, salt, iter, key_len, digest)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cipher.key = key</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">encrypted = cipher.update &quot;hello&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">encrypted &lt;&lt; cipher.final # =&gt; &quot;\xB2#\x10\xE7n&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cipher.decrypt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cipher.iv = iv</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">decrypted = cipher.update(encrypted) # =&gt; &quot;hello&quot;</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Sau bao nhiêu vất vả thì cũng tìm được cái key =)) Vậy quá trình mã hoá như thế nào? Lại mò tiếp .__.</p>
<h3 class="anchor anchorWithStickyNavbar_FlIw" id="encryption-process">Encryption Process<a href="#encryption-process" class="hash-link" aria-label="Direct link to Encryption Process" title="Direct link to Encryption Process">​</a></h3>
<p>Hãy cùng bắt đầu từ việc khai báo trong model</p>
<div class="language-ruby codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-ruby codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token plain">class Article &lt; ApplicationRecord</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  encrypts :title</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Rồi cùng tìm xem <code>ApplicationRecord.encrypts</code> nó làm trò gì nào</p>
<h2 class="anchor anchorWithStickyNavbar_FlIw" id="tham-khảo">Tham khảo<a href="#tham-khảo" class="hash-link" aria-label="Direct link to Tham khảo" title="Direct link to Tham khảo">​</a></h2>
<ul>
<li><a href="https://edgeguides.rubyonrails.org/active_record_encryption.html" target="_blank" rel="noopener noreferrer">https://edgeguides.rubyonrails.org/active_record_encryption.html</a></li>
<li><a href="https://www.precisely.com/blog/data-security/aes-vs-rsa-encryption-differences" target="_blank" rel="noopener noreferrer">https://www.precisely.com/blog/data-security/aes-vs-rsa-encryption-differences</a></li>
<li><a href="https://www.youtube.com/watch?v=lnKPoWZnNNM" target="_blank" rel="noopener noreferrer">https://www.youtube.com/watch?v=lnKPoWZnNNM</a></li>
<li><a href="https://www.youtube.com/watch?v=g_eY7JXOc8U" target="_blank" rel="noopener noreferrer">https://www.youtube.com/watch?v=g_eY7JXOc8U</a></li>
<li><a href="https://www.includehelp.com/cryptography/mode-of-operation.aspx" target="_blank" rel="noopener noreferrer">https://www.includehelp.com/cryptography/mode-of-operation.aspx</a></li>
</ul></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_qmVs padding--none margin-left--sm"><li class="tag_aHj4"><a class="tag_rlZX tagRegular_E7nr" href="/blog/tags/websocket">websocket</a></li><li class="tag_aHj4"><a class="tag_rlZX tagRegular_E7nr" href="/blog/tags/javascript">javascript</a></li><li class="tag_aHj4"><a class="tag_rlZX tagRegular_E7nr" href="/blog/tags/web">web</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="https://schema.org/BlogPosting"><meta itemprop="description" content="WebSocket là gì"><header><h2 class="title_DEF8" itemprop="headline"><a itemprop="url" href="/blog/websocket-hoat-dong-nhu-the-nao">WebSocket hoạt động như thế nào?</a></h2><div class="container_Y0Yj margin-vert--md"><time datetime="2021-06-16T00:00:00.000Z" itemprop="datePublished">June 16, 2021</time> · <!-- -->3 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_fNYc"><div class="avatar margin-bottom--sm"><a href="https://github.com/moonlight8978" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://avatars.githubusercontent.com/u/26299310?v=4" alt="Lê Sĩ Bích" itemprop="image"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/moonlight8978" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Lê Sĩ Bích</span></a></div><small class="avatar__subtitle" itemprop="description">Ruby on Rails/React Developer</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><h2 class="anchor anchorWithStickyNavbar_FlIw" id="websocket-là-gì">WebSocket là gì<a href="#websocket-là-gì" class="hash-link" aria-label="Direct link to WebSocket là gì" title="Direct link to WebSocket là gì">​</a></h2>
<p>Cũng giống như HTTP, WebSocket là 1 protocol, hoạt động trên mô hình client/server, và sử dụng TCP connection.
Là một protocol, có nghĩa là bất kể việc implement ra sao, nhưng server cứ lắng nghe 1 TCP port, và giao tiếp giữa client/server tuân theo đúng spec mà WebSocket đề ra là được.</p>
<p>WebSocket cho phép trao đổi dữ liệu 2 chiều giữa client và server. Tuy nhiên chắc sẽ có nhiều người thắc mắc</p>
<blockquote>
<p>Sao không dùng HTTP rồi set interval request lên, hay là server push cho đơn giản. Đẻ ra lắm protocol làm gì đau đầu?</p>
</blockquote>
<p>Nếu sử dụng HTTP, mỗi lần cập nhật data mới thì client lại phải tạo request HTTP, và sẽ có rất nhiều header dư thừa, gây lãng phí băng thông, và việc khởi tạo request cũng mất thêm 1 chút thời gian. Trong khi đó WebSocket, sau khi client và server <em>say hello</em> với nhau, TCP connection sẽ vẫn alive, và chúng sẽ giao lưu kết hợp với nhau qua connection đó mà không cần thêm những thông tin dư thừa như header. Và có lẽ còn nhiều lợi ích nữa, nhưng mình không biết =))</p>
<p>Khen thế đủ rồi, hãy thử tìm hiểu xem WebSocket ngang dọc ra sao.</p>
<h2 class="anchor anchorWithStickyNavbar_FlIw" id="cách-hoạt-động-của-websocket">Cách hoạt động của WebSocket<a href="#cách-hoạt-động-c  ủa-websocket" class="hash-link" aria-label="Direct link to Cách hoạt động của WebSocket" title="Direct link to Cách hoạt động của WebSocket">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_FlIw" id="tiền-đề">Tiền đề<a href="#tiền-đề" class="hash-link" aria-label="Direct link to Tiền đề" title="Direct link to Tiền đề">​</a></h3>
<p>Ví dụ với ứng dụng mạng xã hội, ta có 1 tính năng chat. Mỗi khi bật chat với 1 người, 1 WebSocket tới webserver của ta sẽ được khởi tạo. Như vậy, ta đang có 1 webserver, và đang cần 1 websocket connection tới webserver đó. Mặt khác việc sử dụng raw TCP trên client cũng rất hạn chế. Chính vì vậy, WebSocket đã tận dụng luôn port 80/443 của HTTP(S) để khởi tạo connection.</p>
<h3 class="anchor anchorWithStickyNavbar_FlIw" id="handshaking">Handshaking<a href="#handshaking" class="hash-link" aria-label="Direct link to Handshaking" title="Direct link to Handshaking">​</a></h3>
<p>Khi khởi tạo connection, client sẽ tạo 1 HTTP request để thực hiện <em>handshake</em> với server</p>
<p><img decoding="async" loading="lazy" alt="handshake" src="/assets/images/websocket-handshake-adc15c177bb901fb7fb81d48ac042d27.jpeg" width="561" height="353" class="img_XBWr"></p>
<ul>
<li>
<p>Trước tiên client sẽ gửi request tới endpoint mà websocket server đang lắng nghe. ví dụ như <code>/chat</code>.
Request sẽ kèm theo 1 vài header mà WebSocket protocol quy định: <code>Sec-WebSocket-Key</code>, <code>Sec-WebSocket-Version</code>, <code>Upgrade</code>, <code>Connection</code>, ... và những header cơ bản của 1 HTTP request khác nữa.</p>
</li>
<li>
<p>WebSocket server sẽ tiếp nhận request, authen (nếu có), nếu không hợp lệ sẽ trả về <code>400 Bad Request</code> và terminate connection đó.
Ngược lại nếu OK, server sẽ trả về <code>101 Switching Protocols</code> cùng với header <code>Sec-WebSocket-Accept</code>. Connection đó sẽ được giữ, và sau đó client và server bắt đầu trao đổi thông tin qua lại với nhau.</p>
</li>
</ul>
<p>Giá trị của <code>Sec-WebSocket-Accept</code> được quy định như sau:</p>
<div class="language-txt codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-txt codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token plain">Sec-WebSocket-Accept = Base64( SHA1 ( Sec-WebSocket-Key + 258EAFA5-E914-47DA-95CA-C5AB0DC85B11 ) )</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><code>258EAFA5-E914-47DA-95CA-C5AB0DC85B11</code> còn được gọi là <em>magic string</em></p>
<h3 class="anchor anchorWithStickyNavbar_FlIw" id="trao-đổi-dữ-liệu">Trao đổi dữ liệu<a href="#trao-đổi-dữ-liệu" class="hash-link" aria-label="Direct link to Trao đổi dữ liệu" title="Direct link to Trao đổi dữ liệu">​</a></h3>
<p>Việc trao đổi dữ liệu giữa client và server khá là hại não, cụ thể việc decode message, hay format message có thể xem thêm tại <a href="https://developer.mozilla.org/en-US/docs/Web/API/WebSockets_API/Writing_WebSocket_servers#exchanging_data_frames" target="_blank" rel="noopener noreferrer">đây</a>. Giữ chỗ để sau này nếu không <del>lười</del> bận quay lại tìm hiểu sau =))</p>
<p>Trong quá trình connection được keep alive, sẽ có rất nhiều request ping giữa client/server để kiểm tra xem phía bên kia còn active hay không. Bên gửi ping, bên nhận pong, vẫn còn sống thì ta lại giao lưu kết hợp tiếp. Còn không thì server/client sẽ biết để terminate inactive connection đó đi.</p>
<h2 class="anchor anchorWithStickyNavbar_FlIw" id="tham-khảo">Tham khảo<a href="#tham-khảo" class="hash-link" aria-label="Direct link to Tham khảo" title="Direct link to Tham khảo">​</a></h2>
<ul>
<li>
<p><a href="https://developer.mozilla.org/en-US/docs/Web/API/WebSockets_API/Writing_WebSocket_servers" target="_blank" rel="noopener noreferrer">https://developer.mozilla.org/en-US/docs/Web/API/WebSockets_API/Writing_WebSocket_servers</a></p>
</li>
<li>
<p><a href="https://stackoverflow.com/questions/50197453/how-long-can-a-websocket-connection-last" target="_blank" rel="noopener noreferrer">https://stackoverflow.com/questions/50197453/how-long-can-a-websocket-connection-last</a></p>
</li>
<li>
<p><a href="https://datatracker.ietf.org/doc/html/rfc6455" target="_blank" rel="noopener noreferrer">https://datatracker.ietf.org/doc/html/rfc6455</a></p>
</li>
</ul></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_qmVs padding--none margin-left--sm"><li class="tag_aHj4"><a class="tag_rlZX tagRegular_E7nr" href="/blog/tags/websocket">websocket</a></li><li class="tag_aHj4"><a class="tag_rlZX tagRegular_E7nr" href="/blog/tags/javascript">javascript</a></li><li class="tag_aHj4"><a class="tag_rlZX tagRegular_E7nr" href="/blog/tags/web">web</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="https://schema.org/BlogPosting"><meta itemprop="description" content="1. Mở đầu"><header><h2 class="title_DEF8" itemprop="headline"><a itemprop="url" href="/blog/cung-tim-hieu-ve-puma-ruby-on-rails">Cùng tìm hiểu về Puma (Ruby on Rails)</a></h2><div class="container_Y0Yj margin-vert--md"><time datetime="2021-05-31T00:00:00.000Z" itemprop="datePublished">May 31, 2021</time> · <!-- -->11 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_fNYc"><div class="avatar margin-bottom--sm"><a href="https://github.com/moonlight8978" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://avatars.githubusercontent.com/u/26299310?v=4" alt="Lê Sĩ Bích" itemprop="image"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/moonlight8978" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Lê Sĩ Bích</span></a></div><small class="avatar__subtitle" itemprop="description">Ruby on Rails/React Developer</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><h2 class="anchor anchorWithStickyNavbar_FlIw" id="1-mở-đầu">1. Mở đầu<a href="#1-mở-đầu" class="hash-link" aria-label="Direct link to 1. Mở đầu" title="Direct link to 1. Mở đầu">​</a></h2>
<p>Chắc hẳn Puma không phải một cái tên xa lạ đối với mỗi Rails developer, một phần cũng vì đây là appserver mặc định khi tạo mới một project Rails.</p>
<p>Hãy cùng nhìn qua những config cơ bản khi chạy 1 ứng dụng Rails với Puma server. <a href="https://github.com/rails/rails/blob/0f5700ac3589081126fbfde1e4037dc1d4166cce/railties/lib/rails/generators/rails/app/templates/config/puma.rb.tt" target="_blank" rel="noopener noreferrer">link</a></p>
<div class="language-ruby codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-ruby codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token plain">max_threads_count = ENV.fetch(&quot;RAILS_MAX_THREADS&quot;) { 5 }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">min_threads_count = ENV.fetch(&quot;RAILS_MIN_THREADS&quot;) { max_threads_count }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">threads min_threads_count, max_threads_count</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">worker_timeout 3600 if ENV.fetch(&quot;RAILS_ENV&quot;, &quot;development&quot;) == &quot;development&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">port ENV.fetch(&quot;PORT&quot;) { 3000 }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">environment ENV.fetch(&quot;RAILS_ENV&quot;) { &quot;development&quot; }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pidfile ENV.fetch(&quot;PIDFILE&quot;) { &quot;tmp/pids/server.pid&quot; }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">workers ENV.fetch(&quot;WEB_CONCURRENCY&quot;) { 2 }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">preload_app!</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">plugin :tmp_restart</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Đối với những người mới bắt đầu, khi deploy puma, có lẽ sẽ từ chối hiểu đống config trên và set một số biến môi trường như sau:</p>
<ul>
<li><code>WEB_CONCURRENCY</code>: bằng với số lượng vcore/process của máy</li>
<li><code>RAILS_MAX_THREADS</code>: ờ thì nhiều RAM thì set 16, 32 cho oách, không thì thôi dùng mặc định 5 và mặc do dòng đời xô đẩy <!-- -->:v</li>
</ul>
<p>Hãy cùng tìm hiểu thêm về Puma để góp phần làm chủ từng dòng code trong app của chúng ta.</p>
<h2 class="anchor anchorWithStickyNavbar_FlIw" id="2-multi-processing-và-multi-threading">2. Multi-processing và Multi-threading<a href="#2-multi-processing-và-multi-threading" class="hash-link" aria-label="Direct link to 2. Multi-processing và Multi-threading" title="Direct link to 2. Multi-processing và Multi-threading">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_FlIw" id="21-puma-dùng-loại-nào">2.1. Puma dùng loại nào?<a href="#21-puma-dùng-loại-nào" class="hash-link" aria-label="Direct link to 2.1. Puma dùng loại nào?" title="Direct link to 2.1. Puma dùng loại nào?">​</a></h3>
<ul>
<li>Khi chạy 1 Rails app mới tạo, hãy để ý lúc boot server, bạn sẽ thấy:</li>
</ul>
<div class="language-log codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-log codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token plain">Puma starting in single mode...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">* Puma version: 5.3.1 (ruby 3.0.1-p64) (&quot;Sweetnighter&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">*  Min threads: 5</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">*  Max threads: 5</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">*  Environment: development</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">*          PID: 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">* Listening on http://0.0.0.0:3000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Use Ctrl-C to stop</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Đây là dấu hiệu cho ta thấy, Rails đang chạy ở chế độ single process (1 process), và multi-thread (cụ thể là 5 thread)</p>
<ul>
<li>Còn khi config deploy, có thể bạn sẽ được 1 người có kinh nghiệm hơn bảo rằng <em>&quot;Bỏ comment cái dòng <code>workers ENV.fetch(&quot;WEB_CONCURRENCY&quot;) { 2 }</code> đi em êi&quot;</em></li>
</ul>
<p>Và đây là kết quả khi ta làm như vậy</p>
<div class="language-log codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-log codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token plain">[1] Puma starting in cluster mode...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[1] * Puma version: 5.3.1 (ruby 3.0.1-p64) (&quot;Sweetnighter&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[1] *  Min threads: 5</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[1] *  Max threads: 5</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[1] *  Environment: development</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[1] *   Master PID: 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[1] *      Workers: 2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[1] *     Restarts: (���) hot (���) phased</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[1] * Preloading application</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[1] * Listening on htp://0.0.0.0:3000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[1] Use Ctrl-C to stop</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[1] - Worker 0 (PID: 16) booted in 0.02s, phase: 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[1] - Worker 1 (PID: 17) booted in 0.05s, phase: 0</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Puma đang chạy đồng thời multi-process (2 process) và multi-thread (5 thread)</p>
<blockquote>
<p>Multi-process, multi-thread là cái của nợ gì vậy?</p>
</blockquote>
<p>Chúng ta sẽ tìm hiểu về nó ngay sau đây. Tuy nhiên chúng ta sẽ focus vào cluster mode của Puma nhé.</p>
<h3 class="anchor anchorWithStickyNavbar_FlIw" id="22-multi-threading">2.2. Multi-threading<a href="#22-multi-threading" class="hash-link" aria-label="Direct link to 2.2. Multi-threading" title="Direct link to 2.2. Multi-threading">​</a></h3>
<p>Trước tiên ta hãy nhớ lại định nghĩa về <code>process</code> - tiến trình, mỗi khi ta chạy 1 command nào đó (ví dụ như <code>ruby xxx.rb</code> hay bật chrome chẳng hạn), OS sẽ tạo 1 process để xử lý command của ta.</p>
<p>Mỗi <em>process</em> có thể tạo ra nhiều <em>thread</em> để xử lý task (ví dụ mỗi tab chrome được handle bởi 1 thread). Các thread được tạo bởi 1 process sẽ share nhau 1 vùng nhớ (memory), trong shared memory này, mỗi thread sẽ có stack, register (google để biết thêm đống này là gì =)) ) riêng của mình. Tuy nhiên, việc chung đụng memory như trên sẽ dẫn đến 1 vấn đề là nhiều thread cùng chọc tới 1 resource nào đó, dẫn tới conflict về data, hay còn được biết đến với cái tên nguy hiểm hơn là <strong>race condition</strong>. Code của ta sẽ cần <em>thread-safe</em> (các bạn có thể google thêm <!-- -->:v<!-- -->)</p>
<p>Đối với ứng dụng Ruby thì khi chạy ở môi trường MRI... À đấy lại nhắc tới MRI, chắc nhiều người sẽ thắc mắc liệu đó là gì. Đây là tên của 1 Ruby Runtime. Ruby 1 chuẩn spec, implement kiểu gì cũng được, miễn là đáp ứng được spec đó thì đều là Ruby. Có thể kể đến các Runtime phổ biến sau</p>
<ul>
<li>
<p>MRI - aka CRuby: Matz’s Ruby Interpreter (Matz - hay Matsumoto Yukihiro) là người tạo ra runtime này, được viết bằng C, nên còn gọi là CRuby</p>
<p>Đa số là dùng MRI</p>
</li>
<li>
<p>JRuby: Ruby implement bằng Java</p>
</li>
<li>
<p>Rubinius</p>
</li>
<li>
<p>mruby</p>
</li>
<li>
<p>...</p>
</li>
</ul>
<p>MRI có 1 cơ chế là <strong>Global Interpreter Lock</strong> (GIL), khi chạy multi-thread, nó chỉ cho phép 1 thread chạy source code Ruby tại 1 thời điểm, nên là ta có nhiều thread đi chăng nữa thì cũng chỉ có 1 thread được chạy mà thôi.</p>
<p>Tuy nhiên với các thao tác IO như đọc DB, request external resource, đọc ghi file, ... thì GIL không block. Puma đã tận dụng điều này, khi 1 thread đang xử lý IO, nó sẽ quay trở lại xử lý ở process, nhận thêm các request khác để xử lý.</p>
<p>Chính vì vậy, ngay cả khi chỉ chạy ở single mode, Puma vẫn có thể handle được concurrent request. Tuy nhiên với các request cần thời gian dài để xử lý, do chỉ có 1 thread được chạy, nên request sau sẽ phải chờ request trước xử lý xong, dẫn đến Puma bị thọt trong trường hợp này.</p>
<p>Ta có thể kiểm tra về trạng thái các thread của Puma bằng đoạn code sau:</p>
<div class="language-ruby codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-ruby codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token plain">class HomesController &lt; ApplicationController</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  def show</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Thread.list.select { |t| t.name&amp;.match?(/puma threadpool \d+/) }.each do |t|</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Rails.logger.info(&quot;Thread #{t.name}: #{t.status}, alive: #{t.alive?}, current: #{t == Thread.current}&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    head :ok</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Vì sao lại là <code>/puma threadpool \d+/</code>? Các bạn có thể xem tại <a href="https://github.com/puma/puma/blob/3e80f7c704e5585da4faa32edf0fa7a0abed3689/lib/puma/thread_pool.rb#L104" target="_blank" rel="noopener noreferrer">đây</a>.</p>
<div class="language-ruby codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-ruby codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token plain">Rails.application.routes.draw do</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  resource :home</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-ruby codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-ruby codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token plain">max_threads_count = ENV.fetch(&#x27;RAILS_MAX_THREADS&#x27;, 5)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">min_threads_count = ENV.fetch(&#x27;RAILS_MIN_THREADS&#x27;) { max_threads_count }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">threads min_threads_count, max_threads_count</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">worker_timeout 3600 if ENV.fetch(&#x27;RAILS_ENV&#x27;, &#x27;development&#x27;) == &#x27;development&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">port ENV.fetch(&#x27;PORT&#x27;, 3000)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">environment ENV.fetch(&#x27;RAILS_ENV&#x27;, &#x27;development&#x27;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pidfile ENV.fetch(&#x27;PIDFILE&#x27;, &#x27;tmp/pids/server.pid&#x27;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">plugin :tmp_restart</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-curl codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-curl codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token plain">curl http://localhost:3000/home</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tail -n 50 log/development.log</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Và đây là output:</p>
<div class="language-log codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-log codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token plain">Thread puma threadpool 001: sleep, alive: true, current: false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Thread puma threadpool 002: sleep, alive: true, current: false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Thread puma threadpool 003: sleep, alive: true, current: false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Thread puma threadpool 004: sleep, alive: true, current: false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Thread puma threadpool 005: run, alive: true, current: true</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Đó chính là 5 thread của chúng ta, như ví dụ là thread 5 đang tiến hành xử lý request, còn những thread khác nếu rảnh nó sẽ ở trạng thái <code>sleep</code>. Ở đây có 1 điểm đáng chú ý là sau khi kết thúc request, thread không bị kill mà chỉ về trạng thái <code>sleep</code>, do vậy nếu ta tuỳ tiện modify biến global, nó sẽ ảnh hưởng tới request tiếp theo mà thread đó handle.</p>
<p>Ví dụ:</p>
<div class="language-ruby codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-ruby codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token plain">before_action :set_locale</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">def set_locale</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  I18n.locale = params[:locale] || I18n.default_locale</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Không cần biết code cái gì, nhưng modify 1 biến global tại runtime như trên là đã thấy nguy hiểm rồi. Và ta hãy tiến hành test xem</p>
<div class="language-ruby codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-ruby codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token plain">class HomesController &lt; ApplicationController</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  def show</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Thread.current.tap { |t| Rails.logger.info(&quot;Current thread #{t.name}: #{t.status}, alive: #{t.alive?}&quot;) }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Rails.logger.info(&quot;Before: #{I18n.locale}&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    I18n.locale = params[:locale]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Rails.logger.info(&quot;After: #{I18n.locale}&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    head :ok</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>rồi sau đó spam khoảng chục cái request</p>
<div class="language-bash codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-bash codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token plain">curl http://localhost:3000/home?locale=vi</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>và ta sẽ thấy kết quả như sau</p>
<div class="language-log codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-log codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token plain">Current thread puma threadpool 003: run, alive: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Before: en</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">After: vi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Current thread puma threadpool 003: run, alive: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Before: vi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">After: vi</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Có thể dễ dàng nhận ra rằng việc set <code>I18n.locale = &quot;vi&quot;</code> ở request trước đã bị leak sang request sau. Nếu ở tất cả các request, trước khi xử lý ta đều set <code>I18n.locale</code> thì việc leak trên sẽ ít ảnh hưởng hơn.</p>
<p>Tuy nhiên hãy thử tưởng tượng khi app của bạn có chứa cả code admin và api, bên admin có thể đổi ngôn ngữ, còn api thì không, thì kết quả sẽ ra sao. Khi admin đổi ngôn ngữ, tình cờ, 1 user vô phúc nào đó request tới trúng cái thread vừa handle việc admin đổi ngôn ngữ, và API sẽ trả về locale của ông admin kia <!-- -->:v</p>
<p>Chính vì vậy, ở docs của Rails cũng có recommend chúng ta xử lý chuyển locale bằng <code>I18n.with_locale</code>, các bạn có thể xem tại <a href="https://guides.rubyonrails.org/i18n.html#managing-the-locale-across-requests" target="_blank" rel="noopener noreferrer">đây</a></p>
<div class="language-ruby codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-ruby codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token plain">around_action :switch_locale</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">def switch_locale(&amp;action)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  locale = params[:locale] || I18n.default_locale</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  I18n.with_locale(locale, &amp;action)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Túm váy lại là multi-threading hỗ trợ concurrent rất tốt, tuy nhiên cũng ẩn chứa 1 vài vấn đề. Nên sẽ cần chú ý hơn khi code.</p>
<h3 class="anchor anchorWithStickyNavbar_FlIw" id="23-multi-processing">2.3. Multi-processing<a href="#23-multi-processing" class="hash-link" aria-label="Direct link to 2.3. Multi-processing" title="Direct link to 2.3. Multi-processing">​</a></h3>
<p>Máy tính hiện nay đa số đều có khá nhiều core, và đều hỗ trợ đa nhiệm để tối ưu hoá việc xử lý song song. Vậy với webserver thì sao? Có cần chứ, multi-processing giúp ta có thể xử lý thêm nhiều request đồng thời hơn nữa. Trừ khi server của ta quá yếu, chứ không thì tội gì, nhà chả có gì ngoài core mà lại chạy đơn nhân thì phí của giời quá <!-- -->:v</p>
<p>Mặc định Puma sẽ chạy ở single mode, khi đó chỉ có 1 process, process này sẽ đảm nhận hết từ việc lưu code của app, tiếp nhận request, ... sau đó sẽ đẩy request sang cho các thread xử lý như đã mô tả ở trên.</p>
<p>Còn đối với cluster mode, trước hết Puma sẽ tạo ra một master process. Từ process này, dựa vào giá trị của config dưới, Puma sẽ <em>fork</em> để tạo ra số process tương ứng, hay còn gọi là <em>worker</em>.</p>
<div class="language-ruby codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-ruby codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token plain">workers ENV.fetch(&quot;WEB_CONCURRENCY&quot;) { 2 }</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Lại nói về fork, đây là quá trình mà 1 process tạo ra 1 process mới, gọi là <em>child process</em>. Mỗi child process đều có process id (PID) riêng biệt, và một môi trường riêng tách biệt hoàn toàn với parent process (source code, memory, stack, ...). Không như thread vẫn share code với process, nhưng có stack, register riêng. Do vậy, có thể nói forking an toàn và bảo mật hơn so với multi-thread.</p>
<p>Quay trở lại với Puma, ở cluster mode, master process chỉ đảm nhận việc tiếp nhận request, sau đó sẽ bắn sang các worker để chúng tự xử với các thread mà chúng spawn. Các worker của Puma đều có 1 bản copy source code app riêng, nên khi chạy nhiều worker, hãy chắc chắn là server của bạn có đủ RAM <!-- -->:v</p>
<p>Ở Ruby, có thể kiểm tra xem app của ta đang chạy ở process nào bằng cách sử dụng</p>
<div class="language-ruby codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-ruby codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token plain">Process.pid  # Current child process</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Process.ppid # Parent process</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Hãy thử ở app Rails của ta xem</p>
<div class="language-ruby codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-ruby codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token plain">class HomesController &lt; ApplicationController</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  def show</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Rails.logger.info(&quot;Current: #{Process.pid}. Parent: #{Process.ppid}&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    head :ok</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-ruby codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-ruby codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token plain"># ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">workers 2</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-log codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-log codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token plain">Processing by HomesController#show as */*</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Current: 128. Parent: 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Processing by HomesController#show as */*</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Current: 129. Parent: 1</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-bash codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-bash codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token plain">ps aux</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># USER       PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># root         1  0.5  7.1 236000 145864 pts/0   Ssl+ 03:28   0:04 puma 5.3.1 (tcp://0.0.0.0:3000) [app]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># root         7  0.0  0.1   3544  3192 pts/1    Ss   03:29   0:00 zsh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># root       128  0.0  6.9 288680 142008 pts/0   Sl+  03:29   0:00 puma: cluster worker 0: 1 [app]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># root       129  0.0  6.9 288720 142116 pts/0   Sl+  03:29   0:00 puma: cluster worker 1: 1 [app]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># root       219  0.0  0.0   1640   856 pts/1    R+   03:40   0:00 ps aux</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_FlIw" id="3-kết-luận">3. Kết luận<a href="#3-kết-luận" class="hash-link" aria-label="Direct link to 3. Kết luận" title="Direct link to 3. Kết luận">​</a></h2>
<p>Cả multi-threading và multi-processing đều quan trọng, chúng góp phần giúp app ta xử lý đc concurrent request. Hy vọng bài viết có thể giúp ích cho các bạn ít nhiều.</p>
<p>Ngoài ra, về vấn đề set số worker và thread ở phần đầu đã nói, tốt nhất chắc vẫn là:</p>
<ul>
<li><code>WEB_CONCURRENCY</code> = vcore, ngoài ra còn phụ thuộc vào RAM nữa</li>
<li><code>RAILS_MAX_THREADS</code> không có con số cụ thể, phụ thuộc vào RAM và CPU, nhiều RAM, CPU khoẻ thì set được càng nhiều, nhưng cũng khá là hên xui, phải tiến hành test rồi mới căn chỉnh con số phù hợp được =))</li>
</ul>
<p>Nếu có sai sót gì các bạn cứ gạch đá thoải mái à <!-- -->:v<!-- --> chi tiết có thể tham khảo ở <a href="https://devcenter.heroku.com/articles/deploying-rails-applications-with-the-puma-web-server#workers" target="_blank" rel="noopener noreferrer">đây</a></p>
<h2 class="anchor anchorWithStickyNavbar_FlIw" id="4-tham-khảo">4. Tham khảo<a href="#4-tham-khảo" class="hash-link" aria-label="Direct link to 4. Tham khảo" title="Direct link to 4. Tham khảo">​</a></h2>
<ul>
<li><a href="https://www.speedshop.co/2015/07/29/scaling-ruby-apps-to-1000-rpm.html" target="_blank" rel="noopener noreferrer">https://www.speedshop.co/2015/07/29/scaling-ruby-apps-to-1000-rpm.html</a></li>
<li><a href="https://devcenter.heroku.com/articles/concurrency-and-database-connections" target="_blank" rel="noopener noreferrer">https://devcenter.heroku.com/articles/concurrency-and-database-connections</a></li>
<li><a href="https://devcenter.heroku.com/articles/deploying-rails-applications-with-the-puma-web-server" target="_blank" rel="noopener noreferrer">https://devcenter.heroku.com/articles/deploying-rails-applications-with-the-puma-web-server</a></li>
<li><a href="http://www.geekride.com/fork-forking-vs-threading-thread-linux-kernel/" target="_blank" rel="noopener noreferrer">http://www.geekride.com/fork-forking-vs-threading-thread-linux-kernel/</a></li>
<li><a href="https://www.studytonight.com/operating-system/multithreading" target="_blank" rel="noopener noreferrer">https://www.studytonight.com/operating-system/multithreading</a></li>
<li><a href="https://www.tutorialspoint.com/how-to-create-a-process-in-linux#:~:text=A%20new%20process%20can%20be,newly%20is%20called%20child%20process" target="_blank" rel="noopener noreferrer">https://www.tutorialspoint.com/how-to-create-a-process-in-linux#:~:text=A%20new%20process%20can%20be,newly%20is%20called%20child%20process</a>.</li>
</ul></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_qmVs padding--none margin-left--sm"><li class="tag_aHj4"><a class="tag_rlZX tagRegular_E7nr" href="/blog/tags/puma">puma</a></li><li class="tag_aHj4"><a class="tag_rlZX tagRegular_E7nr" href="/blog/tags/ruby-on-rails">ruby-on-rails</a></li><li class="tag_aHj4"><a class="tag_rlZX tagRegular_E7nr" href="/blog/tags/multi-threading">multi-threading</a></li><li class="tag_aHj4"><a class="tag_rlZX tagRegular_E7nr" href="/blog/tags/multi-processing">multi-processing</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="https://schema.org/BlogPosting"><meta itemprop="description" content="Do dòng đời đưa đẩy và khách thì tiền ít nhưng lại thích hít hàng thơm (toàn đòi 80~100 coverage -\_-) nên mình cũng đã kinh qua react-native-testing-library một thời gian kha khá, và cũng nghịch thử Detox, nhưng chưa thằng nào làm mình hài lòng:"><header><h2 class="title_DEF8" itemprop="headline"><a itemprop="url" href="/blog/cuoi-react-native-xem-appium-phan-1-cung-tim-hieu-cach-hoat-dong-cua-appium">Cưỡi React Native xem Appium (Phần 1 - Cùng tìm hiểu cách hoạt động của Appium)</a></h2><div class="container_Y0Yj margin-vert--md"><time datetime="2021-01-04T00:00:00.000Z" itemprop="datePublished">January 4, 2021</time> · <!-- -->14 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_fNYc"><div class="avatar margin-bottom--sm"><a href="https://github.com/moonlight8978" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://avatars.githubusercontent.com/u/26299310?v=4" alt="Lê Sĩ Bích" itemprop="image"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/moonlight8978" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Lê Sĩ Bích</span></a></div><small class="avatar__subtitle" itemprop="description">Ruby on Rails/React Developer</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>Do dòng đời đưa đẩy và khách thì tiền ít nhưng lại thích hít hàng thơm (toàn đòi 80~100 coverage -_-) nên mình cũng đã kinh qua <a href="https://github.com/callstack/react-native-testing-library" target="_blank" rel="noopener noreferrer">react-native-testing-library</a> một thời gian kha khá, và cũng nghịch thử <a href="https://github.com/wix/Detox" target="_blank" rel="noopener noreferrer">Detox</a>, nhưng chưa thằng nào làm mình hài lòng:</p>
<ul>
<li>Testing-library: Khi test e2e thì phải mock quá nhiều, khá khó để mock component sao cho hoạt động giống như component thật. Có những lúc mình chỉ viết để cho % coverage lên chứ các fn của test đó bị mock hết, thành ra chả có ý nghĩa gì nhiều. Các thành phần UI bị mock hết, nên test pass mà vẫn chết là điều bình thường như cân đường hộp sữa.</li>
<li>Detox: chơi với mỗi simulator, device thật ko rõ tới giờ đã được đánh điện tử chưa.</li>
</ul>
<p>Và gần đây thì mình đọc lại <a href="https://reactnative.dev/docs/testing-overview#end-to-end-tests" target="_blank" rel="noopener noreferrer">docs của React Native</a> có recommend thêm 1 thằng - Appium. Appium sử dụng driver như XCUITest, UIAutomator, Espresso, ... Được các teito (tay to <!-- -->:v<!-- -->) native ở công ty bảo mấy thằng driver trên toàn là hàng hịn bên native dùng để chạy test, nên thử nghịch luôn. Sau một thời gian mày mò thì khá hài lòng.</p>
<h4 class="anchor anchorWithStickyNavbar_FlIw" id="tại-sao-lại-dùng-appium-mà-ko-chạy-cơm-cho-khỏe">Tại sao lại dùng Appium mà ko chạy cơm cho khỏe?<a href="#tại-sao-lại-dùng-appium-mà-ko-chạy-cơm-cho-khỏe" class="hash-link" aria-label="Direct link to Tại sao lại dùng Appium mà ko chạy cơm cho khỏe?" title="Direct link to Tại sao lại dùng Appium mà ko chạy cơm cho khỏe?">​</a></h4>
<p>Nói thế chứ thực ra thì chạy cơm không hề khỏe tí nào đâu các bạn.</p>
<p>Khi ta phát triển 1 feature mới cho app, ta phải test cho cả những tính năng đã có, ảnh hưởng tới chúng là điều khó tránh khỏi.</p>
<p>Thông thường dev chúng ta sẽ nghĩ là &quot;Có tester rồi xoắn gì&quot; đúng không nào? Tuy nhiên phận dev quèn thì cũng vẫn phải check qua những case cơ bản, (test thêm case dị càng tốt) trước khi chuyển qua cho tester. Nhưng không lẽ cứ viết một feature là ngồi bật app lên bấm từng nút, chưa kể <del>xe đạp mới ( mình có một người bạn rất hay nhầm newbie và newbike =)) )</del> newbie không nắm rõ hệ thống, lack case là điều tất nhiên, hơn nữa con người chúng ta không giỏi trong những việc nhàm chán có tính lặp lại cao như test app, vì vậy dù có là bô lão thì cũng sẽ có lúc nhầm lẫn.</p>
<p>Ngoài ra, ở cuốn &quot;The Effective Engineer&quot; của Edmond Lau (nếu ko có gì sai sót thì là trang 159) có viết:</p>
<blockquote>
<p>If you have to do something manually more than twice, then write a tool for the third time</p>
</blockquote>
<p>Vậy thì sao chúng ta không để máy làm những công việc nhàm chán như test, và focus vào những việc khiến ta hứng thú hơn. Hãy cùng học viết test tự động cho ứng dụng React Native của chúng ta thôi nào!</p>
<h3 class="anchor anchorWithStickyNavbar_FlIw" id="một-vài-kiến-thức-cần-có">Một vài kiến thức cần có<a href="#một-vài-kiến-thức-cần-có" class="hash-link" aria-label="Direct link to Một vài kiến thức cần có" title="Direct link to Một vài kiến thức cần có">​</a></h3>
<ul>
<li>React Native, Babel (không cần quá mát tơ)</li>
<li>Nắm được cơ bản về viết unit test (với jest, hay gì đó tương tự)</li>
<li>Typescript (optional): do ở bài viết sẽ dùng Typescript</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_FlIw" id="hardware">Hardware<a href="#hardware" class="hash-link" aria-label="Direct link to Hardware" title="Direct link to Hardware">​</a></h3>
<ul>
<li>Máy Mac/Hackintosh để build iOS hoặc máy Win (chỉ chạy được Android thôi)</li>
<li>1 con điện thoại iOS hoặc Android - nói không với integration test trên simulator <!-- -->:v</li>
</ul>
<h1>2. Chạy thử ví dụ nhỏ</h1>
<p>Tự dưng nhồi một đống lý thuyết suông, trong khi không biết mình sẽ làm gì có phải rất chán không nào? Vì vậy trước tiên ta hãy chạy thử một ví dụ nhỏ sau trước đã: Đăng kí account</p>
<p>Ví dụ sau dùng Typescript + WebdriverIO, và có cấu trúc tương đương với ví dụ trên trang chủ của Appium <a href="https://github.com/appium/appium/tree/master/sample-code/javascript-webdriverio" target="_blank" rel="noopener noreferrer">link</a> (Các bạn cũng có thể vào link trên bằng truy cập <a href="http://appium.io/" target="_blank" rel="noopener noreferrer">trang chủ Appium</a> rồi bấm vào nút Examples), tất nhiên để go pro thì ta sẽ ko code như vậy, mình sẽ thực hiện refactor và chuyển đổi môi trường chạy test ở các bài sau ( nếu có =)) ).</p>
<p>Sau khi setup Babel cùng với Jest (do Jest luôn đi kèm với React Native nên mình dùng luôn để demo cho thân thiện), hãy viết 1 đoạn test đơn giản cho quá trình sign up của ta.
Hiện tại mình chỉ fill những field text input, vì field select, date picker viết khá dài, nên mình sẽ đề cập sau.</p>
<blockquote>
<p>Nói nhiều quá, code đâu?</p>
</blockquote>
<p>Vâng, code đây (ở dưới có giải thích code)</p>
<div class="language-js codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-js codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token keyword module" style="color:#00009f">import</span><span class="token plain"> </span><span class="token imports punctuation" style="color:#393A34">{</span><span class="token imports"> </span><span class="token imports maybe-class-name">BrowserObject</span><span class="token imports punctuation" style="color:#393A34">,</span><span class="token imports"> remote</span><span class="token imports punctuation" style="color:#393A34">,</span><span class="token imports"> </span><span class="token imports maybe-class-name">RemoteOptions</span><span class="token imports"> </span><span class="token imports punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword module" style="color:#00009f">from</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;webdriverio&quot;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token literal-property property" style="color:#36acaa">iOS</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token maybe-class-name">RemoteOptions</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">path</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;/wd/hub&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">host</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;localhost&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">port</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">4723</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">capabilities</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">platformName</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;iOS&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">automationName</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;XCUITest&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">deviceName</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;iPhone (2)&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">platformVersion</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;14.1&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">app</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;org.reactjs.native.example.LearnRnE2eTest&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">udid</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> process</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">env</span><span class="token punctuation" style="color:#393A34">.</span><span class="token constant" style="color:#36acaa">IOS_DEVICE_UUID</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">xcodeOrgId</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;xxx&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">xcodeSigningId</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Apple Development&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token literal-property property" style="color:#36acaa">android</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token maybe-class-name">RemoteOptions</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">path</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;/wd/hub&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">host</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;localhost&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">port</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">4723</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">capabilities</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">automationName</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;UiAutomator2&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">platformName</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;android&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">platformVersion</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;8.0.0&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">deviceName</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;BH9057609A&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">appPackage</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;com.learnrne2etest&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">appActivity</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;.MainActivity&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> </span><span class="token literal-property property" style="color:#36acaa">client</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token maybe-class-name">BrowserObject</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">beforeEach</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">async</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  client </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#00009f">await</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">remote</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">iOS</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token console class-name">console</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">error</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">client</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">afterEach</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">async</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">client</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword control-flow" style="color:#00009f">await</span><span class="token plain"> client</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">deleteSession</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token function-variable function" style="color:#d73a49">scrollTo</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">async</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter literal-property property" style="color:#36acaa">a11yId</span><span class="token parameter operator" style="color:#393A34">:</span><span class="token parameter"> string</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">client</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">options</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">capabilities</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">platformName</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">===</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;android&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword control-flow" style="color:#00009f">await</span><span class="token plain"> client</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">execute</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;mobile: scroll&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token literal-property property" style="color:#36acaa">strategy</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;accessibility id&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token literal-property property" style="color:#36acaa">selector</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> a11yId</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">it</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;sign up the user&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">async</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> toRegistrationScreenButton </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#00009f">await</span><span class="token plain"> client</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">$</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;~login/toRegistrationScreenButton&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">await</span><span class="token plain"> toRegistrationScreenButton</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">click</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> registerButton </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#00009f">await</span><span class="token plain"> client</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">$</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;~registration/registerButton&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">await</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">scrollTo</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;registration/toLoginScreenButton&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">await</span><span class="token plain"> registerButton</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">click</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">await</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">scrollTo</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;registration/usernameInput-error&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> usernameError </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#00009f">await</span><span class="token plain"> client</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">$</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;~registration/usernameInput-error&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">expect</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword control-flow" style="color:#00009f">await</span><span class="token plain"> usernameError</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">getText</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">toMatch</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;Please enter username&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> passwordError </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#00009f">await</span><span class="token plain"> client</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">$</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;~registration/passwordInput-error&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">expect</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword control-flow" style="color:#00009f">await</span><span class="token plain"> passwordError</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">getText</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">toMatch</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;Please enter password&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> passwordConfirmationError </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#00009f">await</span><span class="token plain"> client</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">$</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;~registration/passwordConfirmationInput-error&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">expect</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword control-flow" style="color:#00009f">await</span><span class="token plain"> passwordConfirmationError</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">getText</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">toMatch</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;Please confirm your password&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> fullNameError </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#00009f">await</span><span class="token plain"> client</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">$</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;~registration/fullNameInput-error&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">expect</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword control-flow" style="color:#00009f">await</span><span class="token plain"> fullNameError</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">getText</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">toMatch</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;Please enter your full name&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> usernameInput </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#00009f">await</span><span class="token plain"> client</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">$</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;~registration/usernameInput&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">await</span><span class="token plain"> usernameInput</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">setValue</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;user..01&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  usernameError </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#00009f">await</span><span class="token plain"> client</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">$</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;~registration/usernameInput-error&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">expect</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword control-flow" style="color:#00009f">await</span><span class="token plain"> usernameError</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">getText</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">toMatch</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;Username must be alphabet and numbers&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">await</span><span class="token plain"> usernameInput</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">setValue</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;user&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> passwordInput </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#00009f">await</span><span class="token plain"> client</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">$</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;~registration/passwordInput&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">await</span><span class="token plain"> passwordInput</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">setValue</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;password&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> passwordConfirmationInput </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#00009f">await</span><span class="token plain"> client</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">$</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;~registration/passwordConfirmationInput&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">await</span><span class="token plain"> passwordConfirmationInput</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">setValue</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;password123&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  passwordConfirmationError </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#00009f">await</span><span class="token plain"> client</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">$</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;~registration/passwordConfirmationInput-error&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">expect</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword control-flow" style="color:#00009f">await</span><span class="token plain"> passwordConfirmationError</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">getText</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">toMatch</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;Password confirmation must match your password&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">await</span><span class="token plain"> passwordConfirmationInput</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">setValue</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;password&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> fullNameInput </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#00009f">await</span><span class="token plain"> client</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">$</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;~registration/fullNameInput&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">await</span><span class="token plain"> fullNameInput</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">setValue</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;Test&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">await</span><span class="token plain"> client</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">hideKeyboard</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">await</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">scrollTo</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;registration/toLoginScreenButton&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">await</span><span class="token plain"> registerButton</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">click</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">await</span><span class="token plain"> client</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">waitUntil</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#393A34">=&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      client</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">$</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;~registrationCompleted/toLoginScreenButton&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">then</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">element</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#393A34">=&gt;</span><span class="token plain"> element</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">isDisplayed</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token literal-property property" style="color:#36acaa">timeout</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">10000</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Chi tiết source code có thể xem tại <a href="https://github.com/moonlight8978/learn-rn-e2e-test/tree/jest/e2e" target="_blank" rel="noopener noreferrer">đây</a></p>
<p>Source code của các màn hình có thể xem tại đây:</p>
<ul>
<li>Login screen <a href="https://github.com/moonlight8978/learn-rn-e2e-test/blob/jest/rn-app/src/screens/login/login.tsx" target="_blank" rel="noopener noreferrer">link</a></li>
<li>Registration screen <a href="https://github.com/moonlight8978/learn-rn-e2e-test/blob/jest/rn-app/src/screens/registration/registration.tsx" target="_blank" rel="noopener noreferrer">link</a></li>
</ul>
<p>Và đây là thành phẩm:</p>
<div class="language-js codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-js codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token plain">$ yarn test</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token constant" style="color:#36acaa">PASS</span><span class="token plain">  __tests__</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">sign</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">up</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">spec</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">ts</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">18.817</span><span class="token plain"> s</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ✓ sign up the </span><span class="token function" style="color:#d73a49">user</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">17179</span><span class="token plain"> ms</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token maybe-class-name">Test</span><span class="token plain"> </span><span class="token maybe-class-name">Suites</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> passed</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> total</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">Tests</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">       </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> passed</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> total</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">Snapshots</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> total</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">Time</span><span class="token operator" style="color:#393A34">:</span><span class="token plain">        </span><span class="token number" style="color:#36acaa">18.869</span><span class="token plain"> s</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> estimated </span><span class="token number" style="color:#36acaa">29</span><span class="token plain"> s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token maybe-class-name">Ran</span><span class="token plain"> all test suites</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token property-access">✨</span><span class="token plain">  </span><span class="token maybe-class-name">Done</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">21</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">80s</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<table><thead><tr><th style="text-align:center">iOS</th><th style="text-align:center">Android</th></tr></thead><tbody><tr><td style="text-align:center"><img decoding="async" loading="lazy" src="https://images.viblo.asia/30a3e57a-44ab-4c56-b4cf-0047bb221353.gif" alt="" class="img_XBWr"></td><td style="text-align:center"><img decoding="async" loading="lazy" src="https://images.viblo.asia/907005db-f46a-40ea-9b3c-f269fe06646d.gif" alt="" class="img_XBWr"></td></tr></tbody></table>
<h3 class="anchor anchorWithStickyNavbar_FlIw" id="ví-dụ-trên-làm-gì">Ví dụ trên làm gì?<a href="#ví-dụ-trên-làm-gì" class="hash-link" aria-label="Direct link to Ví dụ trên làm gì?" title="Direct link to Ví dụ trên làm gì?">​</a></h3>
<ol>
<li>
<p>Từ màn <strong>Login</strong>, bấm vào button 「Create an account」 <code>login/toRegistrationScreenButton</code> để vào màn <strong>Registration</strong></p>
</li>
<li>
<p>Tại màn <strong>Registration</strong></p>
<p>1.1.Bấm vào nút 「Register」<code>registration/registerButton</code>, do máy Android của mình màn hơi ngắn, nên trước khi click phải scroll tới element đó trước.</p>
<p>1.2. Do chưa fill gì nên expect error message hiển thị tương ứng</p>
<p>1.3. Fill 「user..01」vào input username, do field này chỉ nhận alphabet và số, nên giá trị đó ko hợp lệ, expect hiển thị error message</p>
<p>1.4. Fill username 1 giá trị hợp lệ 「user」</p>
<p>1.5. Fill password 「password」</p>
<p>1.6. Fill password confirmation「password123」, do ko match password đã nhập nên sẽ hiển thị error</p>
<p>1.7. Fill password confirmation hợp lệ 「password」</p>
<p>1.8. Fill full name</p>
<p>1.9. Bấm vào nút 「Register」</p>
</li>
<li>
<p>User được chuyển qua màn RegistrationCompleted, nên ta expect button ở màn này được hiển thị.</p>
</li>
</ol>
<h3 class="anchor anchorWithStickyNavbar_FlIw" id="phân-tích-một-vài-note-về-cú-pháp">Phân tích một vài note về cú pháp<a href="#phân-tích-một-vài-note-về-cú-pháp" class="hash-link" aria-label="Direct link to Phân tích một vài note về cú pháp" title="Direct link to Phân tích một vài note về cú pháp">​</a></h3>
<p>Cú pháp của WebdriverIO nhìn khá trong sáng và dễ hiểu, nên mình sẽ không giải thích nhiều, tuy nhiên có một vài chú ý dưới đây cho các bạn.</p>
<ul>
<li>
<p>Khi tìm element, mình đã dùng <code>~</code>, đây là shorthand để tìm element theo <code>accessibility id</code> của WebdriverIO, tuỳ theo OS mà ta sẽ phải gán prop khác nhau để có thể dùng được strategy tìm theo <code>accessibility id</code> này <a href="https://github.com/webdriverio/native-demo-app/blob/master/js/config/TestProperties.js" target="_blank" rel="noopener noreferrer">link</a>, chỉ vì cái này mà mình mất vài tiếng, ko hiểu tại sao ko tìm thấy element =))</p>
<ul>
<li>
<p>Ở bên iOS ta phải dùng <code>testID</code>, và tránh gán <code>accessibilityLabel</code> và <code>accessibilityHint</code> cho component.</p>
</li>
<li>
<p>Ở bên Android, hãy dùng <code>accessibilityLabel</code></p>
</li>
</ul>
<ul>
<li>Các bạn có thể tham khảo các strategy khác ở docs của webdriverio <a href="https://webdriver.io/docs/selectors.html" target="_blank" rel="noopener noreferrer">link</a></li>
</ul>
</li>
<li>
<p>Tại sao lại dùng <code>accessibility id</code> mà không dùng content của nó?</p>
<ul>
<li>Đúng ra là khi bấm button hay thao tác trên màn hình, chúng ta nên dùng text của nó, để khi text (requirement) thay đổi thì test cũng oẳng. Nhưng mà cơ bản là do <del>hơi bận</del> lười =)) và trường hợp accessibility id đúng nhưng text sai thì phải chấp nhận thôi à =))</li>
</ul>
</li>
</ul>
<ul>
<li>
<p>Do API của WebdriverIO toàn trả về Promise, nên hầu như câu lệnh nào cũng cần phải dùng <code>async/await</code>, các bạn có thể sử dụng kèm package <a href="https://www.npmjs.com/package/@wdio/sync" target="_blank" rel="noopener noreferrer"><code>@wdio/sync</code></a> để API của WebdriverIO trở nên đồng bộ.</p>
</li>
<li>
<p>Các bạn có để ý đoạn code ở <code>beforeEach</code> và <code>afterEach</code> không? Mỗi test, chúng ta đang tạo ra một session mới, và xoá session đó sau mỗi test. Nếu dùng CLI của wdio thì sẽ thuận tiện hơn.</p>
</li>
<li>
<p>Options <code>xcodeOrgId</code> và <code>xcodeSigningId</code> bên trong <code>capabilities</code> của <code>RemoteOptions</code> iOS</p>
<ul>
<li>
<p>Để chạy test trên thiết bị iOS, Appium sẽ cài một phần mềm tên là <code>WebDriverAgent</code> lên thiết bị, và để cài đặt được, ta phải cung cấp developer team và signing certificate.</p>
<p>Các bạn có thể xem thêm tại đây <a href="http://appium.io/docs/en/drivers/ios-xcuitest-real-devices/" target="_blank" rel="noopener noreferrer">link</a></p>
<p><img decoding="async" loading="lazy" src="https://images.viblo.asia/8915c299-098f-4f94-a9a4-cbdf450e371b.jpg" alt="" class="img_XBWr"></p>
</li>
</ul>
</li>
<li>
<p>Đối với thiết bị thật thì ta cần thêm UUID, có thể xem cách tìm UUID tại <a href="https://www.idownloadblog.com/2018/11/20/how-to-find-udid-iphone-xs-max-xr/" target="_blank" rel="noopener noreferrer">đây</a></p>
</li>
<li>
<p><code>capabilities</code> của Android</p>
<ul>
<li>
<p>Để lấy <code>deviceName</code>, hãy chạy <code>adb devices</code></p>
</li>
<li>
<p><code>com.learnrne2etest</code> và <code>.MainActivity</code> có thể lấy từ <code>android/app/src/main/AndroidManifest.xml</code></p>
<div class="language-xml codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-xml codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">manifest</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">package</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">com.learnrne2etest</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">&lt;!-- ... --&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">activity</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name namespace" style="color:#00a4db;opacity:0.7">android:</span><span class="token tag attr-name" style="color:#00a4db">name</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">.MainActivity</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       </span><span class="token comment" style="color:#999988;font-style:italic">&lt;!-- ... --&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">activity</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">manifest</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Hoặc tham khảo bài sau <a href="http://www.automationtestinghub.com/apppackage-and-appactivity-name/" target="_blank" rel="noopener noreferrer">link</a></p>
</li>
</ul>
</li>
</ul>
<p>Cưỡi ngựa xem hoa như vậy đủ rồi, chúng ta hãy cùng tìm hiểu thêm về cách hoạt động của Appium</p>
<h1>3. Kiến trúc, flow của Appium</h1>
<p><img decoding="async" loading="lazy" src="https://images.viblo.asia/d5fa4bea-70c4-4bfa-9d89-03aac8d9a92c.jpg" alt="" class="img_XBWr"></p>
<p>Appium dựa trên kiến trúc client-server, bản thân Appium là 1 server, có thể dễ dàng nhận thấy điều này ở đoạn config.</p>
<div class="language-ts codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-ts codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> iOS</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> RemoteOptions </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  path</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;/wd/hub&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  host</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;localhost&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  port</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">4723</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_FlIw" id="31-test-library--webdriver-client">3.1. Test library + WebDriver client<a href="#31-test-library--webdriver-client" class="hash-link" aria-label="Direct link to 3.1. Test library + WebDriver client" title="Direct link to 3.1. Test library + WebDriver client">​</a></h4>
<p>Khi viết test, ta sẽ dành phần lớn thời gian để làm việc với chúng, như ví dụ ở phần 2, ta đã sử dụng Jest (với các câu lệnh <code>it</code>, <code>describe</code>, <code>afterEach</code>, <code>afterAll</code>) là công cụ để chạy test, và WebdriverIO (với <code>$</code>, <code>click()</code>, <code>setValue(value)</code>) để giao tiếp với Appium server.</p>
<p>Ngoài bộ đôi này, chúng ta có thể sử dụng bất cứ ngôn ngữ nào mà ta thích (miễn là Appium nó support <!-- -->:v<!-- -->), từ Ruby, Python cho đến PHP, C#, có thể xem list tại <a href="http://appium.io/docs/en/about-appium/appium-clients/index.html" target="_blank" rel="noopener noreferrer">đây</a></p>
<p>Nhưng mà mình recommend combo sau:</p>
<ul>
<li>
<p>Ngôn ngữ: JS/TS thân thiện với React Native dev</p>
</li>
<li>
<p>WebDriver client: <a href="https://webdriver.io/" target="_blank" rel="noopener noreferrer">WebdriverIO</a> vì trong đám client, thằng này nhiều star trên github nhất =))</p>
</li>
</ul>
<ul>
<li>Test library: <a href="https://jasmine.github.io/index.html" target="_blank" rel="noopener noreferrer">jasmine</a>
<ul>
<li>Vì nó có cú pháp giống Jest, mà anh em code React Native thì quá quen thuộc với Jest rồi</li>
<li>Là 1 trong 3 test framework được WebdriverIO support sẵn để go pro =)) (ngoài ra còn có mocha và cucumber), dùng Jest nếu lỗi thì phải tự mày mò thôi <!-- -->:v</li>
</ul>
</li>
</ul>
<p>Như đã nói ở trên, Appium áp dụng kiến trúc client-server. Khi ta viết những câu lệnh sau</p>
<div class="language-ts codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-ts codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// ./__tests__/sign-up.spec.ts</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">await</span><span class="token plain"> passwordConfirmationInput</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">setValue</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;password123&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>nếu để ý log ta có thể thấy những dòng log dưới đây, webdriverio chỉ đơn thuần gửi 1 HTTP request tới server, server làm gì thì chúng ta sẽ tìm hiểu sau <!-- -->:v</p>
<ul>
<li>iOS</li>
</ul>
<div class="language-js codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-js codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">[</span><span class="token constant" style="color:#36acaa">HTTP</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">POST</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">wd</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">hub</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">session</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">b891507e</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">4d84</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">4e62</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">a5b2</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">e9110c529c9e</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">element</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">6F000000</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">0000</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">0000</span><span class="token operator" style="color:#393A34">-</span><span class="token constant" style="color:#36acaa">E00E</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">000000000000</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">value</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token constant" style="color:#36acaa">HTTP</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token string-property property" style="color:#36acaa">&quot;text&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot;password123&quot;</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">debug</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token constant" style="color:#36acaa">W3C</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">b891507e</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token maybe-class-name">Calling</span><span class="token plain"> </span><span class="token maybe-class-name">AppiumDriver</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">setValue</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">with</span><span class="token plain"> </span><span class="token literal-property property" style="color:#36acaa">args</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;password123&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token string" style="color:#e3116c">&quot;6F000000-0000-0000-E00E-000000000000&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token string" style="color:#e3116c">&quot;b891507e-4d84-4e62-a5b2-e9110c529c9e&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">debug</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token maybe-class-name">XCUITest</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token maybe-class-name">Executing</span><span class="token plain"> command </span><span class="token string" style="color:#e3116c">&#x27;setValue&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">debug</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token constant" style="color:#36acaa">WD</span><span class="token plain"> </span><span class="token known-class-name class-name">Proxy</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token maybe-class-name">Matched</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;/element/6F000000-0000-0000-E00E-000000000000/value&#x27;</span><span class="token plain"> to command name </span><span class="token string" style="color:#e3116c">&#x27;setValue&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">debug</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token maybe-class-name">Protocol</span><span class="token plain"> </span><span class="token maybe-class-name">Converter</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token maybe-class-name">Added</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;text&#x27;</span><span class="token plain"> property </span><span class="token string" style="color:#e3116c">&quot;password123&quot;</span><span class="token plain"> to </span><span class="token string" style="color:#e3116c">&#x27;setValue&#x27;</span><span class="token plain"> request body</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">debug</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token constant" style="color:#36acaa">WD</span><span class="token plain"> </span><span class="token known-class-name class-name">Proxy</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token maybe-class-name">Proxying</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token constant" style="color:#36acaa">POST</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">element</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">6F000000</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">0000</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">0000</span><span class="token operator" style="color:#393A34">-</span><span class="token constant" style="color:#36acaa">E00E</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">000000000000</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">value</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> to </span><span class="token punctuation" style="color:#393A34">[</span><span class="token constant" style="color:#36acaa">POST</span><span class="token plain"> </span><span class="token literal-property property" style="color:#36acaa">http</span><span class="token operator" style="color:#393A34">:</span><span class="token operator" style="color:#393A34">/</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">127.0</span><span class="token number" style="color:#36acaa">.0</span><span class="token number" style="color:#36acaa">.1</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">8100</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">session</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">01BFCDD1</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">27D7</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">4904</span><span class="token operator" style="color:#393A34">-</span><span class="token constant" style="color:#36acaa">A95A</span><span class="token operator" style="color:#393A34">-</span><span class="token constant" style="color:#36acaa">C75086994546</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">element</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">6F000000</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">0000</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">0000</span><span class="token operator" style="color:#393A34">-</span><span class="token constant" style="color:#36acaa">E00E</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">000000000000</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">value</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">with</span><span class="token plain"> </span><span class="token literal-property property" style="color:#36acaa">body</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token string-property property" style="color:#36acaa">&quot;value&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;p&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token string" style="color:#e3116c">&quot;a&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token string" style="color:#e3116c">&quot;s&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token string" style="color:#e3116c">&quot;s&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token string" style="color:#e3116c">&quot;w&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token string" style="color:#e3116c">&quot;o&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token string" style="color:#e3116c">&quot;r&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token string" style="color:#e3116c">&quot;d&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token string" style="color:#e3116c">&quot;1&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token string" style="color:#e3116c">&quot;2&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token string" style="color:#e3116c">&quot;3&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token string-property property" style="color:#36acaa">&quot;text&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot;password123&quot;</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">debug</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token constant" style="color:#36acaa">WD</span><span class="token plain"> </span><span class="token known-class-name class-name">Proxy</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token maybe-class-name">Got</span><span class="token plain"> response </span><span class="token keyword" style="color:#00009f">with</span><span class="token plain"> status </span><span class="token number" style="color:#36acaa">200</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token string-property property" style="color:#36acaa">&quot;value&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token keyword null nil" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">,</span><span class="token string-property property" style="color:#36acaa">&quot;sessionId&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot;01BFCDD1-27D7-4904-A95A-C75086994546&quot;</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">debug</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token constant" style="color:#36acaa">W3C</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">b891507e</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token maybe-class-name">Responding</span><span class="token plain"> to client </span><span class="token keyword" style="color:#00009f">with</span><span class="token plain"> driver</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">setValue</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> result</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword null nil" style="color:#00009f">null</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token constant" style="color:#36acaa">HTTP</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">--</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">POST</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">wd</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">hub</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">session</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">b891507e</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">4d84</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">4e62</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">a5b2</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">e9110c529c9e</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">element</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">6F000000</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">0000</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">0000</span><span class="token operator" style="color:#393A34">-</span><span class="token constant" style="color:#36acaa">E00E</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">000000000000</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">value </span><span class="token number" style="color:#36acaa">200</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">821</span><span class="token plain"> ms </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">14</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ul>
<li>Android</li>
</ul>
<div class="language-js codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-js codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token console class-name">console</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">info</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">2020</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">12</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">31T02</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">12</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">23</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">288Z </span><span class="token constant" style="color:#36acaa">INFO</span><span class="token plain"> </span><span class="token literal-property property" style="color:#36acaa">webdriver</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">COMMAND</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">findElement</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;accessibility id&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;login/toRegistrationScreenButton&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at node_modules</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">@wdio</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">logger</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">build</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">node</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">js</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">76</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">9</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token console class-name">console</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">info</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">2020</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">12</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">31T02</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">12</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">23</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">289Z </span><span class="token constant" style="color:#36acaa">INFO</span><span class="token plain"> </span><span class="token literal-property property" style="color:#36acaa">webdriver</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token constant" style="color:#36acaa">POST</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> http</span><span class="token operator" style="color:#393A34">:</span><span class="token operator" style="color:#393A34">/</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">localhost</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">4723</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">wd</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">hub</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">session</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">7fc4b801</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">deae</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">49dc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">947d</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">292d67ba5467</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">element</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at node_modules</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">@wdio</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">logger</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">build</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">node</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">js</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">76</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">9</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token console class-name">console</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">info</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">2020</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">12</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">31T02</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">12</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">23</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">289Z </span><span class="token constant" style="color:#36acaa">INFO</span><span class="token plain"> </span><span class="token literal-property property" style="color:#36acaa">webdriver</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">DATA</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">using</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;accessibility id&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">value</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;login/toRegistrationScreenButton&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at node_modules</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">@wdio</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">logger</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">build</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">node</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">js</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">76</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">9</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token console class-name">console</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">info</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">2020</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">12</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">31T02</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">12</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">23</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">414Z </span><span class="token constant" style="color:#36acaa">INFO</span><span class="token plain"> </span><span class="token literal-property property" style="color:#36acaa">webdriver</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">RESULT</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string-property property" style="color:#36acaa">&#x27;element-6066-11e4-a52e-4f735466cecf&#x27;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;bb82f194-16d1-4ba0-a520-33f47e117211&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token constant" style="color:#36acaa">ELEMENT</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;bb82f194-16d1-4ba0-a520-33f47e117211&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    at node_modules</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">@wdio</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">logger</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">build</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">node</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">js</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">76</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">9</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_FlIw" id="32-appium-server-automation-tool-devices">3.2. Appium server, Automation tool, Devices<a href="#32-appium-server-automation-tool-devices" class="hash-link" aria-label="Direct link to 3.2. Appium server, Automation tool, Devices" title="Direct link to 3.2. Appium server, Automation tool, Devices">​</a></h4>
<p>Đây là phần xương sống trong kiến trúc của Appium, nó đảm nhận việc handle request từ client, giao tiếp với native automation tool để thực thi những command mà ta cần.</p>
<p>Appium server expose ra API theo chuẩn JSON Wire Protocol (WebDriver Protocol). Tuỳ vào target là iOS hay Android, nó sẽ có cách hoạt động riêng để phù hợp với nền tảng đó.</p>
<h5 class="anchor anchorWithStickyNavbar_FlIw" id="321-appium-meets-ios">3.2.1. Appium meets iOS<a href="#321-appium-meets-ios" class="hash-link" aria-label="Direct link to 3.2.1. Appium meets iOS" title="Direct link to 3.2.1. Appium meets iOS">​</a></h5>
<p>Quay trở lại đoạn log ở phần 3.1, nó đã ít nhiều gợi ý cho ta cách hoạt động của Appium</p>
<div class="language-js codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-js codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">[</span><span class="token constant" style="color:#36acaa">HTTP</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">--</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">POST</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">wd</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">hub</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">session</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">b891507e</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">4d84</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">4e62</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">a5b2</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">e9110c529c9e</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">element</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">6F000000</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">0000</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">0000</span><span class="token operator" style="color:#393A34">-</span><span class="token constant" style="color:#36acaa">E00E</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">000000000000</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">value</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">debug</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token constant" style="color:#36acaa">WD</span><span class="token plain"> </span><span class="token known-class-name class-name">Proxy</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token maybe-class-name">Proxying</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token constant" style="color:#36acaa">POST</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">element</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">6F000000</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">0000</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">0000</span><span class="token operator" style="color:#393A34">-</span><span class="token constant" style="color:#36acaa">E00E</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">000000000000</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">value</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> to </span><span class="token punctuation" style="color:#393A34">[</span><span class="token constant" style="color:#36acaa">POST</span><span class="token plain"> </span><span class="token literal-property property" style="color:#36acaa">http</span><span class="token operator" style="color:#393A34">:</span><span class="token operator" style="color:#393A34">/</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">127.0</span><span class="token number" style="color:#36acaa">.0</span><span class="token number" style="color:#36acaa">.1</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">8100</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">session</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">01BFCDD1</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">27D7</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">4904</span><span class="token operator" style="color:#393A34">-</span><span class="token constant" style="color:#36acaa">A95A</span><span class="token operator" style="color:#393A34">-</span><span class="token constant" style="color:#36acaa">C75086994546</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">element</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">6F000000</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">0000</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">0000</span><span class="token operator" style="color:#393A34">-</span><span class="token constant" style="color:#36acaa">E00E</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">000000000000</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">value</span><span class="token punctuation" style="color:#393A34">]</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Có thể dễ thấy Appium server đơn giản chỉ proxy request của ta tới 1 server khác chạy ở port 8100 <code>http://127.0.0.1:8100</code>.</p>
<blockquote>
<p>Oát dờ phước? Thằng nào đang chạy ở port 8100 vậy?</p>
</blockquote>
<p>Đó là <a href="https://github.com/facebookarchive/WebDriverAgent" target="_blank" rel="noopener noreferrer">WebDriverAgent server</a>, ban đầu được phát triển bởi ông lớn <strong>Facebook</strong>, appium đã fork về thêm mắm thêm muối gì đó vào.</p>
<p>WDA giúp giao tiếp với XCUITest để có thể điều khiển device/simulator iOS từ xa. Bản thân nó cũng đã support sẵn Webdriver Protocol, vậy nên chắc hẳn dev Appium đã nghĩ như sau</p>
<blockquote>
<p>Tội gì mà phải code lại, có sẵn hàng ngon rồi thì dùng luôn thôi =))</p>
</blockquote>
<p>WDA làm gì với device thì mình xin skip, vì cũng ko biết =)) Các bạn có thể tự mình tìm hiểu sâu hơn nếu có hứng thú với nó.</p>
<h5 class="anchor anchorWithStickyNavbar_FlIw" id="322-appium-meets-android">3.2.2. Appium meets Android<a href="#322-appium-meets-android" class="hash-link" aria-label="Direct link to 3.2.2. Appium meets Android" title="Direct link to 3.2.2. Appium meets Android">​</a></h5>
<p>Với Android, ta có ít gợi ý hơn</p>
<div class="language-js codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-js codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token number" style="color:#36acaa">2020</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">12</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">31T02</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">12</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">23</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">289Z </span><span class="token constant" style="color:#36acaa">INFO</span><span class="token plain"> </span><span class="token literal-property property" style="color:#36acaa">webdriver</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token constant" style="color:#36acaa">POST</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> http</span><span class="token operator" style="color:#393A34">:</span><span class="token operator" style="color:#393A34">/</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">localhost</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">4723</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">wd</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">hub</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">session</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">7fc4b801</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">deae</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">49dc</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">947d</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">292d67ba5467</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">element</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">2020</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">12</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">31T02</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">12</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">23</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">414Z </span><span class="token constant" style="color:#36acaa">INFO</span><span class="token plain"> </span><span class="token literal-property property" style="color:#36acaa">webdriver</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">RESULT</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string-property property" style="color:#36acaa">&#x27;element-6066-11e4-a52e-4f735466cecf&#x27;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;bb82f194-16d1-4ba0-a520-33f47e117211&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token constant" style="color:#36acaa">ELEMENT</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;bb82f194-16d1-4ba0-a520-33f47e117211&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Không thấy proxy gì đó phải không nào? Đúng vậy, vì nó có proxy đâu <!-- -->:v</p>
<p>Ở version mới nhất, Appium sử dụng <a href="https://github.com/appium/appium-android-driver" target="_blank" rel="noopener noreferrer">appium-android-driver</a> để giao tiếp với UIAutomator2. Vậy giao tiếp thế nào?</p>
<p>Mỗi khi bắt đầu chạy test, Appium sẽ cài app <strong>Appium Settings</strong> trên device của ta, thằng này sẽ mở port <a href="https://github.com/appium/appium-android-driver/blob/19b949383e9e1300edd25982e33bb76689a001d2/lib/driver.js#L17" target="_blank" rel="noopener noreferrer">4724</a> trên device của ta và expose ra một vài API hệ thống. Appium server <em>abc</em> với app đã cài trên (qua HTTP), và nó sẽ <em>xyz</em> với UIAutomator2 để thực hiện các command.</p>
<p><img decoding="async" loading="lazy" src="https://images.viblo.asia/0b1ef505-609d-4412-b9d6-65508df7358d.jpg" alt="" class="img_XBWr"></p>
<h1>4. Kết luận</h1>
<p>Là một dev, chúng ta không được chủ quan, lệ thuộc vào bên tester, mà hãy tự mình kiểm thử trước khi chuyển qua cho họ. Test chạy cơm là một công việc nhàm chán, vậy thì tại sao chúng ta không làm cho nó thú vị hơn bằng cách automate nó. Tuy sẽ có lúc cần một số thủ thuật, hay là phải dùng nhiều command khá lằng nhằng ( như cái datepicker chẳng hạn =)) ), nhưng một khi chạy được nhất định nó sẽ đem lại cho các bạn một cảm giác phê như con tê tê =))</p>
<p>Code e2e của bài viết chỉ là những đoạn code tạm bợ, các bạn muốn go pro có thể tham khảo <a href="https://github.com/webdriverio/appium-boilerplate" target="_blank" rel="noopener noreferrer">appium-boilerplate</a> của webdriverio về cách chia module, cũng như setup project. Nếu có thời gian mình sẽ viết thêm về việc refactor đống code tạm bợ trên để go pro =)) Giờ thì xin tạm biệt các bạn.</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_qmVs padding--none margin-left--sm"><li class="tag_aHj4"><a class="tag_rlZX tagRegular_E7nr" href="/blog/tags/react-native">react-native</a></li><li class="tag_aHj4"><a class="tag_rlZX tagRegular_E7nr" href="/blog/tags/e-2-e-testing">e2e-testing</a></li><li class="tag_aHj4"><a class="tag_rlZX tagRegular_E7nr" href="/blog/tags/appium">appium</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="https://schema.org/BlogPosting"><meta itemprop="description" content="Ngày nay, container đã là 1 thứ gì đó quá phổ biến, những nền tảng cloud của Amazon, Google, hay Microsoft, v.v... đều đã hỗ trợ deploy container. Và ở local, hay những server test, mọi người cũng đang dần chuẩn sang container vì sự tiện lợi của chúng."><header><h2 class="title_DEF8" itemprop="headline"><a itemprop="url" href="/blog/gioi-thieu-ve-kubernetes">Giới thiệu về Kubernetes</a></h2><div class="container_Y0Yj margin-vert--md"><time datetime="2019-11-21T00:00:00.000Z" itemprop="datePublished">November 21, 2019</time> · <!-- -->11 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_fNYc"><div class="avatar margin-bottom--sm"><a href="https://github.com/moonlight8978" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://avatars.githubusercontent.com/u/26299310?v=4" alt="Lê Sĩ Bích" itemprop="image"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/moonlight8978" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Lê Sĩ Bích</span></a></div><small class="avatar__subtitle" itemprop="description">Ruby on Rails/React Developer</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>Ngày nay, container đã là 1 thứ gì đó quá phổ biến, những nền tảng cloud của Amazon, Google, hay Microsoft, v.v... đều đã hỗ trợ deploy container. Và ở local, hay những server test, mọi người cũng đang dần chuẩn sang container vì sự tiện lợi của chúng.</p>
<p>Tuy nhiên khi số lượng container lớn dần, chúng ngày càng trở nên rắc rối, việc control resource, network, volume của một số lượng lớn container ngày càng khó. Chính vì lý do đó, một số nền tảng quản lý container đã ra đời như Docker Swarm, Kubernetes, ...</p>
<p>Với một hệ thống nhỏ, ta có thể sử dụng Docker Swarm, sử dụng nó rất dễ và đơn giản. Kubernetes cho phép ta customize nhiều thứ trong hệ thống hơn, tuy nhiên cái giá của nó là khó sử dụng hơn nhiều Docker Swarm.</p>
<p>Note: Ta không bao giờ so sánh Kubernetes với Docker, vì k8s thứ là management tool, còn docker là container runtime.</p>
<h1>2. Kiến trúc hạ tầng của Kubernetes</h1>
<p><img decoding="async" loading="lazy" src="https://images.viblo.asia/8fd57971-e1c9-41dd-b205-0ce88a356e50.png" alt="" class="img_XBWr"></p>
<h3 class="anchor anchorWithStickyNavbar_FlIw" id="21-master-components">2.1 Master components<a href="#21-master-components" class="hash-link" aria-label="Direct link to 2.1 Master components" title="Direct link to 2.1 Master components">​</a></h3>
<p>Những components trên master node sẽ đóng vai trò là control plane của cluster. VD như: scheduling các pod, ...</p>
<h5 class="anchor anchorWithStickyNavbar_FlIw" id="211-etcd">2.1.1 etcd<a href="#211-etcd" class="hash-link" aria-label="Direct link to 2.1.1 etcd" title="Direct link to 2.1.1 etcd">​</a></h5>
<p>Đây là database phân tán, sử dụng Raft làm cơ chế đồng thuận.</p>
<p>State của cluster (config, node info, IP addresses, ...) đều được lưu trữ tại đây.</p>
<h5 class="anchor anchorWithStickyNavbar_FlIw" id="212-kube-scheduler">2.1.2 kube-scheduler<a href="#212-kube-scheduler" class="hash-link" aria-label="Direct link to 2.1.2 kube-scheduler" title="Direct link to 2.1.2 kube-scheduler">​</a></h5>
<p>Có nhiệm vụ schedule pod tới những node có đủ resource, và đảm bảo pod đạt được expected status.</p>
<p>Có thể hiểu đơn giản đây là một vòng lặp vô tận, đưa những pod mới được tạo vào 1 queue, từng item trong đó sẽ được schedule t ới node thỏa mãn.</p>
<h5 class="anchor anchorWithStickyNavbar_FlIw" id="213-kube-apiserver">2.1.3 kube-apiserver<a href="#213-kube-apiserver" class="hash-link" aria-label="Direct link to 2.1.3 kube-apiserver" title="Direct link to 2.1.3 kube-apiserver">​</a></h5>
<p>API Server đơn thuần là 1 REST API của Kubernetes cluster.</p>
<p>Khi muốn tạo, cập nhật, hay xóa những resource của hệ thống như pod, ingress, ... thì đều cần thông qua API Server, chứ không call thẳng tới kube-scheduler, etcd, ...</p>
<h5 class="anchor anchorWithStickyNavbar_FlIw" id="214-kube-controller-manager">2.1.4 kube-controller-manager<a href="#214-kube-controller-manager" class="hash-link" aria-label="Direct link to 2.1.4 kube-controller-manager" title="Direct link to 2.1.4 kube-controller-manager">​</a></h5>
<p>Chạy nhiều controller process. Mỗi controller có nhiệm vụ khác nhau như:</p>
<ul>
<li>Node Controller</li>
<li>Replication Controller</li>
<li>...</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_FlIw" id="22-node-components">2.2 Node components<a href="#22-node-components" class="hash-link" aria-label="Direct link to 2.2 Node components" title="Direct link to 2.2 Node components">​</a></h3>
<p>Là những component được cài đặt trên tất cả các node, giúp quản lý container trên node, logging, quản lý network, ...</p>
<h5 class="anchor anchorWithStickyNavbar_FlIw" id="221-kubelet">2.2.1 kubelet<a href="#221-kubelet" class="hash-link" aria-label="Direct link to 2.2.1 kubelet" title="Direct link to 2.2.1 kubelet">​</a></h5>
<p>Có nhiệm vụ quản lý container, đảm bảo container chạy chính xác, kubelet chỉ quản lý container do k8s tạo.</p>
<h5 class="anchor anchorWithStickyNavbar_FlIw" id="222-kube-proxy">2.2.2 kube-proxy<a href="#222-kube-proxy" class="hash-link" aria-label="Direct link to 2.2.2 kube-proxy" title="Direct link to 2.2.2 kube-proxy">​</a></h5>
<p>Là một network proxy, dùng để forward request tới hạ tầng của k8s.</p>
<h5 class="anchor anchorWithStickyNavbar_FlIw" id="223-container-runtime">2.2.3 Container runtime<a href="#223-container-runtime" class="hash-link" aria-label="Direct link to 2.2.3 Container runtime" title="Direct link to 2.2.3 Container runtime">​</a></h5>
<p>Chắn chắn ta không thể thiếu runtime cho container, nó có thể là rkt, Docker, ... hay bất cứ thứ gì khác.</p>
<h3 class="anchor anchorWithStickyNavbar_FlIw" id="23-hoạt-động">2.3 Hoạt động<a href="#23-hoạt-động" class="hash-link" aria-label="Direct link to 2.3 Hoạt động" title="Direct link to 2.3 Hoạt động">​</a></h3>
<p>Chúng ta sẽ cùng xem những component trên sẽ kết hợp với nhau hoạt động ra sao, thông qua việc tạo 1 Pod qua <code>kubectl</code> CLI.</p>
<p><strong>Pod</strong> ở đây có thể coi là 1 máy ảo, hay 1 container như Docker cho dễ hình dung.</p>
<p><img decoding="async" loading="lazy" src="https://images.viblo.asia/f19795c9-fbc9-48e1-9391-53fc439c1391.jpg" alt="" class="img_XBWr"></p>
<ul>
<li>Trước tiên ta sử dụng <code>kubectl</code> để yêu cầu tạo 1 Pod. Bản chất của command này là sẽ thực hiện 1 HTTP request tới <strong>apiserver</strong> của cluster.</li>
<li><strong>apiserver</strong> sẽ thực hiện ghi lại current state, và desired state của cluster lại vào <strong>etcd</strong> (asynchronous)</li>
<li><strong>etcd</strong> sẽ notify lại <strong>apiserver</strong> khi entry được tạo thành công</li>
<li>Tiếp theo <strong>kube-scheduler</strong> sẽ thực hiện việc schedule Pod. Khi tìm thấy node thích hợp, nó sẽ báo cho <strong>apiserver</strong> là Pod đó đã được bind vào node nào. <strong>apiserver</strong> sẽ lại update vào <strong>etcd</strong></li>
<li><strong>kubelet</strong> tại node đó sẽ thực hiện việc theo dõi container tạo bởi <strong>container runtime</strong> (Docker), xem chúng có chạy đúng với PodSpec không. <strong>kubelet</strong> sẽ gọi tới <strong>apiserver</strong> để update state của Pod đó thường xuyên.</li>
</ul>
<h1>3. Kiến trúc của ứng dụng trên Kubernetes</h1>
<p>Ta sẽ chỉ tập trung vào 3 yếu tố chính để một hệ thống có thể hoạt động được:</p>
<ul>
<li>Ứng dụng</li>
<li>Network</li>
<li>Storage</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_FlIw" id="31-pod">3.1 Pod<a href="#31-pod" class="hash-link" aria-label="Direct link to 3.1 Pod" title="Direct link to 3.1 Pod">​</a></h3>
<h5 class="anchor anchorWithStickyNavbar_FlIw" id="pod-là-gì">Pod là gì<a href="#pod-là-gì" class="hash-link" aria-label="Direct link to Pod là gì" title="Direct link to Pod là gì">​</a></h5>
<p><strong>Pod</strong> là đơn vị nhỏ nhất trong cluster. Mỗi Pod có IP riêng, và có thể chứa nhiều container, những container trong cùng 1 Pod có thể giao tiếp với nhau qua localhost. Vì vậy, có thể coi Pod là một máy ảo cho dễ hình dung.</p>
<p>Tuy nhiên để đơn giản, người ta thường chỉ chạy 1 container trên mỗi Pod, khi đó ta sẽ làm việc với Pod thay vì với từng container riêng lẻ.</p>
<h5 class="anchor anchorWithStickyNavbar_FlIw" id="init-container">Init container<a href="#init-container" class="hash-link" aria-label="Direct link to Init container" title="Direct link to Init container">​</a></h5>
<p>Pod có hỗ trợ init container (1 hoặc nhiều đều được). Trước khi app container (container chính - ví dụ container với command <code>rails s</code>) chạy, tất cả init container sẽ được chạy lần lượt, cái trước thành công rồi đến cái sau chạy.</p>
<p>Ví dụ như 1 ứng dụng Rails, ta có thể settings <code>rails s</code> làm app container, còn <code>rails db:create db:migrate</code> sẽ làm init container.</p>
<h5 class="anchor anchorWithStickyNavbar_FlIw" id="controller">Controller<a href="#controller" class="hash-link" aria-label="Direct link to Controller" title="Direct link to Controller">​</a></h5>
<p>Controller là 1 concept trong Kubernetes, nó dùng để theo dõi 1 loại Resource nào đó. <strong>kube-controller-manager</strong> có nhiệm vụ quản lý những controller này.</p>
<p>Về mặt kỹ thuật thì đây đơn thuần là 1 vòng lặp vô hạn (<em>control loop</em>) để có thể điều chỉnh state của cluster sao cho nó đạt tới được desired state.</p>
<p>Tuy nhiên đang trong mục Pod nên ta sẽ chỉ đề cập tới controller theo dõi Pod trong phần này.</p>
<ul>
<li>
<p><code>Deployment</code>:</p>
<p>Ta sẽ sử dụng <code>Deployment</code> khi cần deploy 1 hoặc nhiều replica (thường là stateless).</p>
<p>Thứ tự khởi động, identify của những replica (Pod) là hoàn toàn ngẫu nhiên.</p>
</li>
<li>
<p><code>StatefulSet</code>:</p>
<p>Nếu app của chúng ta là stateful (ví dụ như 1 set MySQL với 1 master và 2 slave), khi đó việc có 1 stable identity là rất quan trọng. Ngoài ra với mỗi replica trong <code>StatefulSet</code>, Kubernetes sẽ cung cấp cho nó một storage riêng.</p>
<p><code>StatefulSet</code> thêm prefix <code>0</code>, <code>1</code>, <code>2</code>, ... là thứ tự khởi động của pod vào tên pod.</p>
<p>Khi đó network identity, cũng như storage của Pod sẽ trở nên stable. Nếu mysql-0 của ta là master, nó sẽ luôn là master, và nó cũng luôn request tới storage của master.</p>
</li>
<li>
<p><code>DaemonSet</code>:</p>
<p>Ta dùng <code>DaemonSet</code> trong trường hợp muốn tất cả các node đều phải chạy 1 Pod nào đó.</p>
<p>Ví dụ như storage cluster như <strong>glusterd</strong>, hay log agent như <strong>fluentd</strong>, ...</p>
</li>
<li>
<p><code>Job</code>:</p>
<p>Khi ta cần chạy one-off Pod. Ví dụ như việc import master data.</p>
</li>
<li>
<p><code>CronJob</code>:</p>
<p>Như tên gọi c  ủa nó, cứ định kì nó sẽ tạo Pod để thực hiện job.</p>
</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_FlIw" id="32-networking">3.2 Networking<a href="#32-networking" class="hash-link" aria-label="Direct link to 3.2 Networking" title="Direct link to 3.2 Networking">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_FlIw" id="321-service">3.2.1 Service<a href="#321-service" class="hash-link" aria-label="Direct link to 3.2.1 Service" title="Direct link to 3.2.1 Service">​</a></h4>
<p>Trên môi trường production, rất hiếm khi ta thấy 1 service chỉ chạy trên 1 server. Thay vì thế, thường sẽ có 2 hoặc nhiều hơn server cùng chạy, khi server này chết, ta có thể forward request tới những server heo-thì (healthy) còn lại (trong trường hợp có set load balancer và healthcheck), không làm cho service của ta ngỏm luôn.</p>
<p>Tuy nhiên IP của Pod trong cluster luôn thay đổi, vậy thì ta biết phải setup cho load balancer như thế nào? Và đây chính là đất diễn của <code>Service</code>.</p>
<p><code>Service</code> là một tập hợp các Pod, thường sẽ dùng <code>label</code> để group các Pod.</p>
<p>Thông thường, mỗi <code>Service</code> sẽ được gán cho 1 cluster IP, Kubernetes sẽ cung cấp DNS name, và đồng thời cũng load-balance cho các Pod của <code>Service</code>.</p>
<p><img decoding="async" loading="lazy" src="https://images.viblo.asia/2a7f4968-7280-47eb-a225-60ab2f06ab6e.png" alt="" class="img_XBWr"></p>
<p>Ta cũng có thể sử dụng <code>Service</code> cho external endpoint.</p>
<p>Ví dụ khi hệ thống cần call đến <em><a href="https://google.com.vn" target="_blank" rel="noopener noreferrer">https://google.com.vn</a></em>. Tuy nhiên ta lại không muốn call trực tiếp, hay hardcode trong code, mà muốn endpoint này cũng trở thành 1 phần của cluster, để dễ quản lý. Khi đó ta có thể thay đổi endpoint này mà không phải đụng đến code, hay biến ENV gì đó. Khi đó, ta sẽ define 1 <code>Service</code>, và set <code>Endpoint</code> thủ công cho service này, thay vì sử dụng <code>label</code>.</p>
<p>Ngoài ra còn có <code>Headless Service</code>, loại service này sẽ không được gán cluster IP. Ta sẽ sử dụng khi ta muốn sử dụng cách load balance riêng, không phụ thuộc Kubernetes.</p>
<h4 class="anchor anchorWithStickyNavbar_FlIw" id="322-load-balancer">3.2.2 Load balancer<a href="#322-load-balancer" class="hash-link" aria-label="Direct link to 3.2.2 Load balancer" title="Direct link to 3.2.2 Load balancer">​</a></h4>
<p>Khi tạo Service, nếu đây là service cho phép traffic từ bên ngoài Internet, ta hoàn toàn có thể sử dụng Load Balancer của các nhà cung cấp dịch vụ cloud (thường là L3 Load Balancer).</p>
<p>Khi call tới Load Balancer nói trên, nó sẽ trực tiếp forward traffic tới service trong cluster, thuật toán load-balance sẽ do Load Balancer này quyết định.</p>
<p><img decoding="async" loading="lazy" src="https://images.viblo.asia/fdf97441-6cc1-4b42-ac48-342541d0421e.png" alt="" class="img_XBWr"></p>
<h4 class="anchor anchorWithStickyNavbar_FlIw" id="323-ingress">3.2.3 Ingress<a href="#323-ingress" class="hash-link" aria-label="Direct link to 3.2.3 Ingress" title="Direct link to 3.2.3 Ingress">​</a></h4>
<p><code>Ingress</code> hoạt động giống 1 Reverse Proxy hay Layer 7 Load Balancer. Nó cũng có nét tương đồng với API Gateway.</p>
<p><code>Ingress</code> có thể điều hướng cả internal traffic lẫn external traffic dựa vào URL, đồng thời cung cấp thêm cả load balancing giữa những pod của service. Một điểm đáng lưu ý là <code>Ingress</code> sẽ load balance trực tiếp các backend Pod mà không thông qua service, do đó, ta có thể tùy chỉnh được thuật toán, ... liên quan tới LB cho toàn bộ <code>Ingress</code> của cluster.</p>
<p>Ngoài ra, người ta cũng dùng <code>Ingress</code> để terminate TLS session.</p>
<p><img decoding="async" loading="lazy" src="https://images.viblo.asia/5809feda-e282-4d5f-9cfb-11077d952add.jpg" alt="" class="img_XBWr"></p>
<p>Kubernetes sau khi init mặc định sẽ không có ingress controller. Nếu ta chỉ tạo <code>Ingress</code> thì sẽ không có ý nghĩa gì. Để sử dụng <code>Ingress</code> ta sẽ phải setup thủ công Ingress Controller. Tuy nhiên việc này khá đơn giản, do nhiều hãng đã build sẵn mọi thứ, ta chỉ cần lấy file manifest của họ về rồi chạy là được.</p>
<ul>
<li>nginx: <a href="https://kubernetes.github.io/ingress-nginx/" target="_blank" rel="noopener noreferrer">NGINX Ingress Controller</a></li>
<li>traefik: <a href="https://docs.traefik.io/providers/kubernetes-ingress/" target="_blank" rel="noopener noreferrer">Kubernetes Ingress</a></li>
<li>...</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_FlIw" id="324-practice">3.2.4 Practice<a href="#324-practice" class="hash-link" aria-label="Direct link to 3.2.4 Practice" title="Direct link to 3.2.4 Practice">​</a></h4>
<p><img decoding="async" loading="lazy" src="https://images.viblo.asia/5001a20e-979c-473f-b2da-92c8668f621e.png" alt="" class="img_XBWr"></p>
<ul>
<li>Traffic từ phía client sẽ được tập trung tại Layer 4 Load Balancer.</li>
<li>L4 LB sẽ phân bố traffic tới các Node trong cluster (thường qua <code>NodePort</code>).</li>
<li><code>Ingress</code> được map với <code>NodePort</code> đó sẽ terminate SSL, routing, và load balance traffic tới những Pod thích hợp.<!-- -->
<ul>
<li>Traffic tới <code>/web</code> sẽ được điều hướng tới Frontend Pods</li>
<li>Traffic tới <code>/api</code> sẽ được điều hướng tới Backend Pods</li>
</ul>
</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_FlIw" id="33-storage---volume">3.3 Storage - Volume<a href="#33-storage---volume" class="hash-link" aria-label="Direct link to 3.3 Storage - Volume" title="Direct link to 3.3 Storage - Volume">​</a></h3>
<p>Một hệ thống khó có thể hoạt động chỉ với stateless service.</p>
<p>Với một số service như database, hay như tính năng upload file, ... Nếu chúng ta không sử dụng external service, thì service của ta sẽ trở thành stateful service. Nó đòi hỏi dữ liệu trong quá trình xử lý phải được lưu lại ngay cả khi bị crash. Ngoài ra có những lúc ta sẽ cần share dữ liệu giữa những container trong cùng 1 Pod. Những lúc như vậy, ta sẽ cần đến <strong>Volume</strong>.</p>
<p>Khi define Pod, ta sẽ chỉ rõ Pod này cần những volume nào, sau đó map những volume đó cho container.</p>
<h5 class="anchor anchorWithStickyNavbar_FlIw" id="persistentvolume">PersistentVolume<a href="#persistentvolume" class="hash-link" aria-label="Direct link to PersistentVolume" title="Direct link to PersistentVolume">​</a></h5>
<p>Kubernetes sử dụng <code>PersistentVolume</code> để tạo nên 1 lớp abstract với những hệ thống storage thật phía sau. <code>PV</code> cũng có life-cycle giống như Pod.</p>
<p>Khi ta sử dụng volume, ta sẽ không cần quan tâm hệ thống đằng sau ngang dọc ra sao, thứ duy nhất ta cần quan tâm là API của <code>PersistentVolume</code>.</p>
<p>Trong Kubernetes, <code>PV</code> có thể được tạo bằng 2 cách:</p>
<ul>
<li>Dynamic Provisioning</li>
<li>Static Provisioning</li>
</ul>
<h5 class="anchor anchorWithStickyNavbar_FlIw" id="static-provisioning">Static Provisioning<a href="#static-provisioning" class="hash-link" aria-label="Direct link to Static Provisioning" title="Direct link to Static Provisioning">​</a></h5>
<p>Admin cluster sẽ tạo ra 1 số <code>PV</code> trước, sau đó cung cấp cho bên Dev/Ops. Những <code>PV</code> này đã được trỏ tới hệ thống storage thật đang hoạt động đằng sau.</p>
<p>Có thể xem danh sách driver mà Kubernetes hỗ trợ tại <a href="https://kubernetes.io/docs/concepts/storage/volumes/#types-of-volumes" target="_blank" rel="noopener noreferrer">đây</a>.</p>
<p>Ví dụ: Ta có 1 cluster Glusterfs với 3 node, tổng dung lượng là 3TB. Khi cần 10GB cho việc lưu trữ share resource, ta sẽ tạo <code>PersistentVolume</code> với dung lượng 10GB, trỏ tới cluster nói trên. Sau đó ta sẽ sử dụng volume trên tương tự như các volume khác trong hệ thống.</p>
<h5 class="anchor anchorWithStickyNavbar_FlIw" id="dynamic-provisioning">Dynamic Provisioning<a href="#dynamic-provisioning" class="hash-link" aria-label="Direct link to Dynamic Provisioning" title="Direct link to Dynamic Provisioning">​</a></h5>
<p><code>PV</code> sẽ được tạo 1 cách động. Tức là khi nào Pod của ta cần volume, thì <code>PV</code> sẽ được tạo 1 cách tự động, nhờ vào <code>StorageClass</code> (sẽ đề cập sau).</p>
<p>Cách làm này đòi hỏi hệ thống storage của ta cũng phải support dynamic provisioning.</p>
<h5 class="anchor anchorWithStickyNavbar_FlIw" id="persistentvolumeclaim">PersistentVolumeClaim<a href="#persistentvolumeclaim" class="hash-link" aria-label="Direct link to PersistentVolumeClaim" title="Direct link to PersistentVolumeClaim">​</a></h5>
<p>Để có thể sử dụng được <code>PV</code>, ta cần tạo thêm <code>PersistentVolumeClaim</code> (PVC).</p>
<p>Ta có thể sử dụng Claim trên cho config, hay volume, ... của Pod.</p>
<h1>4. High Availability Setup</h1>
<p><img decoding="async" loading="lazy" src="https://images.viblo.asia/48635fac-b09b-4174-b279-4f8d0fa29fb6.png" alt="" class="img_XBWr"></p>
<h1>5. Reference</h1>
<p>kubernetes.io - <a href="https://documentationo/docs/home/" target="_blank" rel="noopener noreferrer">Kubernetes Official Documentation</a></p>
<p>youtube.com - <a href="https://www.youtube.com/watch?v=GXq3FS8M_kw" target="_blank" rel="noopener noreferrer">June 2018 Online Meetup: Kubernetes Networking Master Class</a></p>
<p>x-team.com - <a href="https://x-team.com/blog/introduction-kubernetes-architecture/" target="_blank" rel="noopener noreferrer">INTRODUCTION TO KUBERNETES ARCHITECTURE</a></p>
<p>ovh.com - <a href="https://www.ovh.com/blog/getting-external-traffic-into-kubernetes-clusterip-nodeport-loadbalancer-and-ingress/" target="_blank" rel="noopener noreferrer">Getting external traffic into Kubernetes – ClusterIp, NodePort, LoadBalancer, and Ingress</a></p>
<p>medium.com - <a href="https://medium.com/jorgeacetozi/kubernetes-master-components-etcd-api-server-controller-manager-and-scheduler-3a0179fc8186" target="_blank" rel="noopener noreferrer">Kubernetes Master Components: Etcd, API Server, Controller Manager, and Scheduler</a></p>
<p>medium.com - <a href="https://medium.com/google-cloud/kubernetes-nodeport-vs-loadbalancer-vs-ingress-when-should-i-use-what-922f010849e0" target="_blank" rel="noopener noreferrer">Kubernetes NodePort vs LoadBalancer vs Ingress? When should I use what?</a></p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_qmVs padding--none margin-left--sm"><li class="tag_aHj4"><a class="tag_rlZX tagRegular_E7nr" href="/blog/tags/devops">devops</a></li><li class="tag_aHj4"><a class="tag_rlZX tagRegular_E7nr" href="/blog/tags/kubernetes">kubernetes</a></li><li class="tag_aHj4"><a class="tag_rlZX tagRegular_E7nr" href="/blog/tags/introduction">introduction</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="https://schema.org/BlogPosting"><meta itemprop="description" content="Có 2 hướng tối ưu Database chính:"><header><h2 class="title_DEF8" itemprop="headline"><a itemprop="url" href="/blog/toi-uu-menh-de-where-mysql">Tối ưu mệnh đề WHERE (MySQL)</a></h2><div class="container_Y0Yj margin-vert--md"><time datetime="2019-11-14T00:00:00.000Z" itemprop="datePublished">November 14, 2019</time> · <!-- -->9 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_fNYc"><div class="avatar margin-bottom--sm"><a href="https://github.com/moonlight8978" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://avatars.githubusercontent.com/u/26299310?v=4" alt="Lê Sĩ Bích" itemprop="image"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/moonlight8978" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Lê Sĩ Bích</span></a></div><small class="avatar__subtitle" itemprop="description">Ruby on Rails/React Developer</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>Có 2 hướng tối ưu Database chính:</p>
<h3 class="anchor anchorWithStickyNavbar_FlIw" id="1-tối-ưu-tầng-db">1. Tối ưu tầng DB<a href="#1-tối-ưu-tầng-db" class="hash-link" aria-label="Direct link to 1. Tối ưu tầng DB" title="Direct link to 1. Tối ưu tầng DB">​</a></h3>
<h5 class="anchor anchorWithStickyNavbar_FlIw" id="cấu-trúc-db">Cấu trúc DB:<a href="#cấu-trúc-db" class="hash-link" aria-label="Direct link to Cấu trúc DB:" title="Direct link to Cấu trúc DB:">​</a></h5>
<ul>
<li>Đọc nhiều =&gt; ít table, nhiều column</li>
<li>Ghi nhiều =&gt; nhiều table, ít column</li>
</ul>
<h5 class="anchor anchorWithStickyNavbar_FlIw" id="index-đã-ổn-chưa">Index đã ổn chưa?<a href="#index-đã-ổn-chưa" class="hash-link" aria-label="Direct link to Index đã ổn chưa?" title="Direct link to Index đã ổn chưa?">​</a></h5>
<h5 class="anchor anchorWithStickyNavbar_FlIw" id="engine-cho-table">Engine cho table<a href="#engine-cho-table" class="hash-link" aria-label="Direct link to Engine cho table" title="Direct link to Engine cho table">​</a></h5>
<ul>
<li>MyISAM: Table-locking, phù hợp với table đọc nhiều, ghi ít</li>
<li>InnoDB: Row-locking, đáp ứng đư  ợc việc ghi nhiều.</li>
</ul>
<h5 class="anchor anchorWithStickyNavbar_FlIw" id="caching">Caching<a href="#caching" class="hash-link" aria-label="Direct link to Caching" title="Direct link to Caching">​</a></h5>
<h3 class="anchor anchorWithStickyNavbar_FlIw" id="2-tối-ưu-phần-cứng">2. Tối ưu phần cứng<a href="#2-tối-ưu-phần-cứng" class="hash-link" aria-label="Direct link to 2. Tối ưu phần cứng" title="Direct link to 2. Tối ưu phần cứng">​</a></h3>
<h5 class="anchor anchorWithStickyNavbar_FlIw" id="disk-seek">Disk seek:<a href="#disk-seek" class="hash-link" aria-label="Direct link to Disk seek:" title="Direct link to Disk seek:">​</a></h5>
<ul>
<li>Thời gian HDD quay khi tìm dữ liệu, SDD không cần quay để tìm dữ liệu.</li>
<li>Phân tán dữ liệu để tìm trên nhiều ổ đĩa cùng lúc.</li>
</ul>
<h5 class="anchor anchorWithStickyNavbar_FlIw" id="disk-rw">Disk R/W:<a href="#disk-rw" class="hash-link" aria-label="Direct link to Disk R/W:" title="Direct link to Disk R/W:">​</a></h5>
<ul>
<li>Khi tìm được dữ liệu thì sẽ cần đọc dữ liệu vào RAM.</li>
<li>Phân tán để đọc/ghi nhiều trên nhiều ổ đĩa cùng lúc.</li>
</ul>
<h5 class="anchor anchorWithStickyNavbar_FlIw" id="cpu-cycle">CPU cycle<a href="#cpu-cycle" class="hash-link" aria-label="Direct link to CPU cycle" title="Direct link to CPU cycle">​</a></h5>
<ul>
<li>Khi đã load được vào RAM rồi, thì sẽ tới CPU xử lý những dữ liệu đó.</li>
</ul>
<h5 class="anchor anchorWithStickyNavbar_FlIw" id="memory-bandwidth">Memory bandwidth:<a href="#memory-bandwidth" class="hash-link" aria-label="Direct link to Memory bandwidth:" title="Direct link to Memory bandwidth:">​</a></h5>
<ul>
<li>Khi CPU cần nhiều dữ liệu, nhưng cache lại không đủ, sẽ cần đến memory bandwith.</li>
</ul>
<h1>2. Tối ưu câu lệnh WHERE</h1>
<h5 class="anchor anchorWithStickyNavbar_FlIw" id="ngoài-select-thì-còn-áp-dụng-được-cho-cả-update-delete-vv">Ngoài SELECT thì còn áp dụng được cho cả UPDATE, DELETE, v.v.<a href="#ngoài-select-thì-còn-áp-dụng-được-cho-cả-update-delete-vv" class="hash-link" aria-label="Direct link to Ngoài SELECT thì còn áp dụng được cho cả UPDATE, DELETE, v.v." title="Direct link to Ngoài SELECT thì còn áp dụng được cho cả UPDATE, DELETE, v.v.">​</a></h5>
<h5 class="anchor anchorWithStickyNavbar_FlIw" id="mysql-sẽ-tự-động-tối-ưu-những-trường-hợp-sau">MySQL sẽ tự động tối ưu những trường hợp sau:<a href="#mysql-sẽ-tự-động-tối-ưu-những-trường-hợp-sau" class="hash-link" aria-label="Direct link to MySQL sẽ tự động tối ưu những trường hợp sau:" title="Direct link to MySQL sẽ tự động tối ưu những trường hợp sau:">​</a></h5>
<ul>
<li>
<p>Loại bỏ những dấu ngoặc thừa</p>
<div class="language-sql codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-sql codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">a </span><span class="token operator" style="color:#393A34">AND</span><span class="token plain"> b</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">AND</span><span class="token plain"> c </span><span class="token operator" style="color:#393A34">OR</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">a </span><span class="token operator" style="color:#393A34">AND</span><span class="token plain"> b</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">AND</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">c </span><span class="token operator" style="color:#393A34">AND</span><span class="token plain"> d</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">=</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">a </span><span class="token operator" style="color:#393A34">AND</span><span class="token plain"> b </span><span class="token operator" style="color:#393A34">AND</span><span class="token plain"> c</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">OR</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">a </span><span class="token operator" style="color:#393A34">AND</span><span class="token plain"> b </span><span class="token operator" style="color:#393A34">AND</span><span class="token plain"> c </span><span class="token operator" style="color:#393A34">AND</span><span class="token plain"> d</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
</li>
<li>
<p>Thay thế biến bởi hằng số</p>
<div class="language-sql codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-sql codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">a</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">b </span><span class="token operator" style="color:#393A34">AND</span><span class="token plain"> b</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">c</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">AND</span><span class="token plain"> a</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">5</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">=</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> b</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token number" style="color:#36acaa">5</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">AND</span><span class="token plain"> b</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">c </span><span class="token operator" style="color:#393A34">AND</span><span class="token plain"> a</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">5</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
</li>
<li>
<p>Loại bỏ những điều kiện hằng</p>
<div class="language-sql codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-sql codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">b</span><span class="token operator" style="color:#393A34">&gt;=</span><span class="token number" style="color:#36acaa">5</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">AND</span><span class="token plain"> b</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">5</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">OR</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">b</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">6</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">AND</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">5</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">OR</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">b</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">7</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">AND</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">6</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">=</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> b</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">5</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">OR</span><span class="token plain"> b</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">6</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
</li>
<li>
<p>Biểu thức hằng (constant expression) sẽ chỉ được tính toán 1 lần duy nhất.</p>
<div class="language-sql codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-sql codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> t</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"> id </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> POW</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> t</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"> id </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> FLOOR</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> RAND</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">49</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
</li>
<li>
<p><code>HAVING</code> sẽ được gộp với <code>WHERE</code> khi không sử dụng <code>GROUP BY</code> hay những function như <code>COUNT()</code>, <code>MIN()</code>, <code>MAX()</code>, ...</p>
</li>
<li>
<p>Đối với <strong>MyISAM</strong> hay <strong>MEMORY</strong> table, kết quả của <code>COUNT(*)</code> (không có điều kiện <code>WHERE</code> sẽ được lấy trực tiếp từ <strong>information_schema</strong>.</p>
</li>
</ul>
<p>=&gt; Ta có thể ngừng việc tối ưu lại, và viết những câu lệnh SQL dễ hiểu, dễ bảo trì.</p>
<h1>3. Range optimization</h1>
<ul>
<li><code>range</code> là một <strong>access method</strong></li>
<li><code>range</code> sử dụng index để lấy ra những subset của kết quả cuối cùng.</li>
<li><code>range</code> support cả single-part lẫn multiple-part index.</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_FlIw" id="những-trường-hợp-sau-mysql-sẽ-coi-như-là-range-condition">Những trường hợp sau, MySQL sẽ coi như là <code>range condition</code>:<a href="#những-trường-hợp-sau-mysql-sẽ-coi-như-là-range-condition" class="hash-link" aria-label="Direct link to những-trường-hợp-sau-mysql-sẽ-coi-như-là-range-condition" title="Direct link to những-trường-hợp-sau-mysql-sẽ-coi-như-là-range-condition">​</a></h4>
<ul>
<li>
<p>Mệnh đề <code>WHERE</code> đối với những trường được đánh index (sử dụng BTree hoặc Hash), mà sử dụng những toán tử sau: <code>=</code>, <code>&lt;=&gt;</code>, <code>IN()</code>, <code>IS NULL</code>, hay <code>IS NOT NULL</code></p>
<p>Đối với, BTree, ngoài những phép toán trên, còn support thêm <code>&gt;</code>, <code>&lt;</code>, <code>&lt;=</code>, <code>&gt;=</code>, <code>BETWEEN</code>, <code>!=</code>, hay <code>&lt;&gt;</code> với <strong>constant value</strong>, hoặc <code>LIKE</code> cũng là range condition. Chú ý khi sử dụng <code>LIKE</code>, vế phải phải là 1 string hằng, và không bắt đầu bởi wildcard như <code>%</code> hay <code>_</code>.</p>
<div class="language-sql codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-sql codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> t1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"> key_col </span><span class="token operator" style="color:#393A34">LIKE</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;ab%&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
</li>
<li>
<p>Kết hợp nhiều range condition sử dụng <code>AND</code> hoặc <code>OR</code>, ta vẫn thu được range condition.</p>
</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_FlIw" id="constant-value">Constant value<a href="#constant-value" class="hash-link" aria-label="Direct link to Constant value" title="Direct link to Constant value">​</a></h4>
<h5 class="anchor anchorWithStickyNavbar_FlIw" id="là-giá-trị-được-tính-toán-trước-thời-điểm-runtime-khi-runtime-giá-trị-của-nó-sẽ-không-thay-đổi">Là giá trị được tính toán trước thời điểm runtime, khi runtime, giá trị của nó sẽ không thay đổi<a href="#là-giá-trị-được-tính-toán-trước-thời-điểm-runtime-khi-runtime-giá-trị-của-nó-sẽ-không-thay-đổi" class="hash-link" aria-label="Direct link to Là giá trị được tính toán trước thời điểm runtime, khi runtime, giá trị của nó sẽ không thay đổi" title="Direct link to Là giá trị được tính toán trước thời điểm runtime, khi runtime, giá trị của nó sẽ không thay đổi">​</a></h5>
<ul>
<li>Hằng số truyền thẳng vào tham số của câu truy vấn</li>
<li>Một cột của <code>const</code> hay <code>system</code> table<!-- -->
<ul>
<li><code>const</code> table là bảng chỉ có tối đa 1 row (hay 0 hoặc 1 row).</li>
<li><code>const</code> table có thể là kết quả của 1 câu truy vấn chứa mệnh đề <code>WHERE</code> đối với 1 field unique, not null, có dạng <code>column = constant</code>. Truy vấn này luôn trả về 1 kết quả duy nhất.</li>
<li>table có 1 row thì gọi là <code>system</code> table</li>
</ul>
</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_FlIw" id="btree-hash-index">BTree, Hash index<a href="#btree-hash-index" class="hash-link" aria-label="Direct link to BTree, Hash index" title="Direct link to BTree, Hash index">​</a></h4>
<h5 class="anchor anchorWithStickyNavbar_FlIw" id="btree">BTree:<a href="#btree" class="hash-link" aria-label="Direct link to BTree:" title="Direct link to BTree:">​</a></h5>
<ul>
<li>
<p>Self-balancing tree, cấu trúc dạng cây, có thể tự cân bằng nhằm giữ chiều cao của cây thấp nhất có thể.</p>
</li>
<li>
<p>Tránh nhầm với Binary Tree (cây nhị phân)</p>
</li>
<li>
<p>Thời gian tìm kiếm O(logn)</p>
</li>
<li>
<p>Phù hợp với đa dạng các phép toán: <code>=</code>, <code>&lt;=&gt;</code>, <code>IN()</code>, <code>IS NULL</code>, <code>IS NOT NULL</code>, <code>&gt;</code>, <code>&lt;</code>, <code>&lt;=</code>, <code>&gt;=</code>, <code>BETWEEN</code>, <code>!=</code>, <code>&lt;&gt;</code>, hay thậm chí cả <code>LIKE</code></p>
</li>
</ul>
<p><img decoding="async" loading="lazy" src="https://camo.githubusercontent.com/cb15fccfa6fafa1cea762a58c1dd51ad8f32fe2c/68747470733a2f2f63646e2d696d616765732d312e6d656469756d2e636f6d2f6d61782f313630302f312a70453453457a374370727a4664375a77772d617866512e6a706567" alt="" class="img_XBWr"></p>
<h5 class="anchor anchorWithStickyNavbar_FlIw" id="hash">Hash:<a href="#hash" class="hash-link" aria-label="Direct link to Hash:" title="Direct link to Hash:">​</a></h5>
<ul>
<li>
<p>Bảng băm, là cấu trúc dữ liệu lưu theo key-value</p>
</li>
<li>
<p>Tìm kiếm theo key rất nhanh - O(1)</p>
</li>
<li>
<p>Phù hợp với những phép toán: <code>=</code>, <code>&lt;=&gt;</code>, <code>IN()</code>, <code>IS NULL</code>, hay <code>IS NOT NULL</code>.</p>
</li>
</ul>
<p><img decoding="async" loading="lazy" src="https://camo.githubusercontent.com/b1df2be12b1c8779b7cf941d88d1cc8e2178753f/68747470733a2f2f696d616765732e7669626c6f2e617369612f30356236313638372d386230342d346536352d613834642d3361353363343035386437642e6a7067" alt="" class="img_XBWr"></p>
<h2 class="anchor anchorWithStickyNavbar_FlIw" id="31-single-part-index">3.1. Single-part index<a href="#31-single-part-index" class="hash-link" aria-label="Direct link to 3.1. Single-part index" title="Direct link to 3.1. Single-part index">​</a></h2>
<h5 class="anchor anchorWithStickyNavbar_FlIw" id="single-part-index-là-những-index-được-đánh-riêng-lẻ-cho-1-field">Single-part index là những index được đánh riêng lẻ cho 1 field.<a href="#single-part-index-là-những-index-được-đánh-riêng-lẻ-cho-1-field" class="hash-link" aria-label="Direct link to Single-part index là những index được đánh riêng lẻ cho 1 field." title="Direct link to Single-part index là những index được đánh riêng lẻ cho 1 field.">​</a></h5>
<div class="language-sql codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-sql codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">CREATE</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">INDEX</span><span class="token plain"> index_name </span><span class="token keyword" style="color:#00009f">ON</span><span class="token plain"> t1 </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">key_col</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Khi thực hiện truy vấn với những index loại này, với mỗi possible key (có thể sử dụng <code>EXPLAIN</code> để check), MySQL sẽ tiến hành extract range condition. Những điều kiện không thể cấu thành range condition sẽ bị loại bỏ, những điều kiện có thể bị overlap sẽ được gộp với nhau.</p>
<p>Sau khi extract, MySQL sẽ áp dụng những điều kiện đó để tận dụng được tối đa index của table, sau đó kết hợp thêm với những điều kiện còn lại để lọc tiếp.</p>
<p>MySQL chỉ bỏ qua index, nếu như nó tin rằng việc duyệt full table tối ưu hơn, hoặc dùng <code>FORCE INDEX</code>.</p>
<p>VD:</p>
<div class="language-sql codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-sql codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> t1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">key1 </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;abc&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">AND</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">key1 </span><span class="token operator" style="color:#393A34">LIKE</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;abcde%&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">OR</span><span class="token plain"> key1 </span><span class="token operator" style="color:#393A34">LIKE</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;%b&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token operator" style="color:#393A34">OR</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">key1 </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;bar&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">AND</span><span class="token plain"> nonkey </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">4</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token operator" style="color:#393A34">OR</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">key1 </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;uux&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">AND</span><span class="token plain"> key1 </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;z&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">=</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">key1 </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;abc&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">AND</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">key1 </span><span class="token operator" style="color:#393A34">LIKE</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;abcde%&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">OR</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">TRUE</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">OR</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">key1 </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;bar&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">AND</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">TRUE</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">OR</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">key1 </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;uux&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">AND</span><span class="token plain"> key1 </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;z&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">=</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">key1 </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;abc&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">AND</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">TRUE</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">OR</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">key1 </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;bar&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">AND</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">TRUE</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">OR</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token boolean" style="color:#36acaa">FALSE</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">=</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> key1 </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;abc&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">OR</span><span class="token plain"> key1 </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;bar&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">=</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> key1 </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;bar&#x27;</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_FlIw" id="32-multiple-part-index">3.2. Multiple-part index<a href="#32-multiple-part-index" class="hash-link" aria-label="Direct link to 3.2. Multiple-part index" title="Direct link to 3.2. Multiple-part index">​</a></h2>
<h5 class="anchor anchorWithStickyNavbar_FlIw" id="multiple-part-index-là-những-index-được-đánh-cho-nhiều-trường-cùng-lúc">Multiple-Part Index là những index được đánh cho nhiều trường cùng lúc<a href="#multiple-part-index-là-những-index-được-đánh-cho-nhiều-trường-cùng-lúc" class="hash-link" aria-label="Direct link to Multiple-Part Index là những index được đánh cho nhiều trường cùng lúc" title="Direct link to Multiple-Part Index là những index được đánh cho nhiều trường cùng lúc">​</a></h5>
<div class="language-sql codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-sql codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">CREATE</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">INDEX</span><span class="token plain"> index_name </span><span class="token keyword" style="color:#00009f">ON</span><span class="token plain"> t1 </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">key_part1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> key_part2</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Range condition sẽ sử dụng <strong>key tuple intervals</strong> để tìm kiếm. Key tuple intervals được định nghĩa bởi những key tuples, có thứ tự.</p>
<p><strong>Tuple</strong> là 1 cặp giá trị. VD: (1, 2, 3), (1, &#x27;a&#x27;, 3), ...</p>
<p>Lấy ví dụ về 1 multiple-part index <code>key1(key_part1, key_part2, key_part3)</code>, và những tuples ứng với key tuple (key_part1, key_part2, key_part3) sau:</p>
<div class="language-plaintext codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-plaintext codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token plain">key_part1  key_part2  key_part3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  NULL       1          &#x27;abc&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  NULL       1          &#x27;xyz&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  NULL       2          &#x27;foo&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   1         1          &#x27;abc&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   1         1          &#x27;xyz&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   1         2          &#x27;abc&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   2         1          &#x27;aaa&#x27;</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><code>key_part1 = 1</code> define interval sau:</p>
<div class="language-plaintext codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-plaintext codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token plain">(1,-inf,-inf) &lt;= (key_part1,key_part2,key_part3) &lt; (1,+inf,+inf)</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Interval trên sẽ được sử dụng bởi <code>range</code> access method.</p>
<p>Bên cạnh đó, <code>key_part3 = &#x27;abc&#x27;</code> không tạo ra interval nào (giá trị liền mạch nhau), vì thế sẽ không thể sử dụng bởi <code>range</code></p>
<p>Chú ý khi sử dụng:</p>
<ul>
<li>
<p>Với Hash index, nếu index có <code>N</code> part, thì condition của ta phải có format sau</p>
<div class="language-sql codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-sql codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token plain">    key_part1 cmp const1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">AND</span><span class="token plain"> key_part2 cmp const2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">AND</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">AND</span><span class="token plain"> key_partN cmp constN</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><code>cmp</code> là một trong những toán tử <code>=</code>, <code>&lt;=&gt;</code>, hoặc <code>IS NULL</code></p>
</li>
<li>
<p>Với BTree index, 1 interval có thể sử dụng cho những điều kiện kết hợp bởi <code>AND</code>, trong đó mỗi điều kiện so sánh 1 key part với 1 hằng số, sử dụng <code>=</code>, <code>&lt;=&gt;</code>, <code>IS NULL</code>, <code>&gt;</code>, <code>&lt;</code>, <code>&gt;=</code>, <code>&lt;=</code>, <code>!=</code>, <code>&lt;&gt;</code>.</p>
<p>Optimizer trong khi tính toán interval, sẽ sử dụng thêm key part nếu toán tử là <code>=</code>, <code>&lt;=&gt;</code> hay <code>IS NULL</code>. Còn nếu là <code>&gt;</code>, <code>&lt;</code>, <code>&gt;=</code>, <code>&lt;=</code>, <code>!=</code>, <code>&lt;&gt;</code>, <code>BETWEEN</code> hay <code>LIKE</code> thì sẽ không lấy thêm key part nữa.</p>
<p>VD1:</p>
<div class="language-sql codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-sql codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token plain">key_part1 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;foo&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">AND</span><span class="token plain"> key_part2 </span><span class="token operator" style="color:#393A34">&gt;=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">10</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">AND</span><span class="token plain"> key_part3 </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">10</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>sẽ sử dụng interval:</p>
<div class="language-sql codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-sql codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;foo&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">10</span><span class="token punctuation" style="color:#393A34">,</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">inf</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">key_part1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">key_part2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">key_part3</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;foo&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token operator" style="color:#393A34">+</span><span class="token plain">inf</span><span class="token punctuation" style="color:#393A34">,</span><span class="token operator" style="color:#393A34">+</span><span class="token plain">inf</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>VD2:</p>
<div class="language-sql codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-sql codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">key_part1 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">AND</span><span class="token plain"> key_part2 </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">OR</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">key_part1 </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>sẽ sử dụng 2 interval:</p>
<div class="language-sql codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-sql codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">inf</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">key_part1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">key_part2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">5</span><span class="token punctuation" style="color:#393A34">,</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">inf</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">key_part1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">key_part2</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Trong ví dụ này, interval thứ nhất sử dụng 1 key part ở vế trái, vế phải sử dụng 2 key part.</p>
<p>Interval thứ 2 chỉ sử dụng 1 key part.</p>
<p>Giá trị <code>key_len</code> khi thực hiện <code>EXPLAIN</code> sẽ trả về độ dài tối đa của key prefix được sử dụng.</p>
</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_FlIw" id="index-dive">Index Dive<a href="#index-dive" class="hash-link" aria-label="Direct link to Index Dive" title="Direct link to Index Dive">​</a></h3>
<p>Index dive được thực hiện trong khi optimizing để tính toán estimate (số row thỏa mãn 1 condition), để quyết định xem có nên dùng index hay không. Có thể skip bằng cách dùng <code>FORCE INDEX</code></p>
<p>Nếu điều kiện phức tạp thì index dive sẽ mất nhiều thời gian.</p>
<p>Ngoài index dive, MySQL cũng có thể sử dụng index statistics để estimate, tuy nhiên độ chính xác thấp hơn, có thể dùng <code>ANALYZE TABLE</code> để update lại index statistics, tăng cường độ chính xác.</p>
<p>Index dive bị skip trong trường hợp thỏa mãn tất cả điều kiện sau (chỉ áp dụng cho single table query):</p>
<ul>
<li><code>FORCE INDEX</code></li>
<li>Nonunique index, và không phải <code>FULLTEXT</code> index.</li>
<li>Không có subquery</li>
<li>Không có <code>DISTINCT</code>, <code>GROUP BY</code>, hoặc <code>ORDER BY</code>.</li>
</ul>
<h5 class="anchor anchorWithStickyNavbar_FlIw" id="equality-range-optimization-of-many-valued-comparisons">Equality Range Optimization of Many-Valued Comparisons<a href="#equality-range-optimization-of-many-valued-comparisons" class="hash-link" aria-label="Direct link to Equality Range Optimization of Many-Valued Comparisons" title="Direct link to Equality Range Optimization of Many-Valued Comparisons">​</a></h5>
<div class="language-sql codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-sql codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token plain">col_name </span><span class="token operator" style="color:#393A34">IN</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">val1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> valN</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">col_name </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> val1 </span><span class="token operator" style="color:#393A34">OR</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">OR</span><span class="token plain"> col_name </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> valN</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Những biểu thức như trên, với <code>col_name</code> được đánh index, và so sánh với nhiều giá trị, được gọi là range comparisions (mỗi range là 1 giá trị). Optimizer sẽ estimate cost của mỗi range như sau:</p>
<ul>
<li>Nếu index là unique, cost = 1</li>
<li>Nếu không unique, sẽ cần sử dụng index dive hoặc index statistics để estimate.</li>
</ul>
<p>Ứng với mỗi range là 2 lần dive (1 cho điểm bắt đầu, 1 cho điểm kết thúc) của range (interval).</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_qmVs padding--none margin-left--sm"><li class="tag_aHj4"><a class="tag_rlZX tagRegular_E7nr" href="/blog/tags/mysql">mysql</a></li><li class="tag_aHj4"><a class="tag_rlZX tagRegular_E7nr" href="/blog/tags/database">database</a></li><li class="tag_aHj4"><a class="tag_rlZX tagRegular_E7nr" href="/blog/tags/optimization">optimization</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="https://schema.org/BlogPosting"><meta itemprop="description" content="Rails 6 đã bước vào giai đoạn beta với phiên bản v6.0.0.rc1. RC là viết tắt của Release Candidate, đây là phiên bản mà có xác suất trở thành final release rất cao. Ta có thể áp dụng nó vào dự án ngay kể từ bây giờ mà không cần lo sợ có những breaking change."><header><h2 class="title_DEF8" itemprop="headline"><a itemprop="url" href="/blog/cung-tim-hieu-ve-actiontext-trong-rails-6">Cùng tìm hiểu về ActionText trong Rails 6</a></h2><div class="container_Y0Yj margin-vert--md"><time datetime="2019-07-20T00:00:00.000Z" itemprop="datePublished">July 20, 2019</time> · <!-- -->11 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_fNYc"><div class="avatar margin-bottom--sm"><a href="https://github.com/moonlight8978" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://avatars.githubusercontent.com/u/26299310?v=4" alt="Lê Sĩ Bích" itemprop="image"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/moonlight8978" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Lê Sĩ Bích</span></a></div><small class="avatar__subtitle" itemprop="description">Ruby on Rails/React Developer</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>Rails 6 đã bước vào giai đoạn beta với phiên bản <a href="https://github.com/rails/rails/releases/tag/v6.0.0.rc1" target="_blank" rel="noopener noreferrer">v6.0.0.rc1</a>. RC là viết tắt của <strong>R</strong>elease <strong>C</strong>andidate, đây là phiên bản mà có xác suất trở thành final release rất cao. Ta có thể áp dụng nó vào dự án ngay kể từ bây giờ mà không cần lo sợ có những breaking change.</p>
<p>Nếu bạn sử dụng Docker, mình khuyên nên sử dụng ruby 2.6.3, vì trước đây mình đã dùng thử ruby:2.7.0-preview1-alpine3.10 thì khá nhiều lỗi khi up server, mà chả biết phải fix sao :sad:</p>
<p>Ở Rails 6, có khá nhiều tính năng mới hay ho:</p>
<ul>
<li>Action Text</li>
<li>Parallel Testing</li>
<li>Action Model custom error message format.</li>
<li>vân vân mây mây...</li>
</ul>
<p>Ở bài này, mình sẽ chỉ tập trung đề cập tới Action Text. Đây là một package giúp ta xây dựng WYSIWYG editor một cách nhanh chóng, hơn nữa, việc upload cũng được integrate với Active Storage.</p>
<p><strong>Chú ý:</strong> Bài khá dài và embed nhiều code <!-- -->:v</p>
<h1>Cách dùng</h1>
<h2 class="anchor anchorWithStickyNavbar_FlIw" id="cài-đặt-và-sử-dụng">Cài đặt và sử dụng<a href="#cài-đặt-và-sử-dụng" class="hash-link" aria-label="Direct link to Cài đặt và sử dụng" title="Direct link to Cài đặt và sử dụng">​</a></h2>
<p>Vì là Rails nên cách sử dụng rất đơn giản, nhưng ta sẽ chả biết nó chạy cái gì đằng sau cả =))</p>
<p>Cài đặt Action Text bằng CLI command sau:</p>
<div class="language-bash codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-bash codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token plain">rails action_text:install</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Nhớ hãy chạy thêm cả command install Active Storage nữa.</p>
<div class="language-bash codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-bash codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token plain">rails active_storage:install</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Để áp dụng cho field <code>content</code> của model <code>Post</code>, ta sẽ dùng tới macro <code>has_rich_text</code></p>
<div class="language-ruby codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-ruby codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token plain">class CreatePosts &lt; ActiveRecord::Migration[6.0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  def change</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    create_table :posts do |t|</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      t.string :content</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      t.string :category</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      t.timestamps</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><code>content</code> ở đây mình dùng string, nhưng khuyến khích dùng text hơn.</p>
<div class="language-ruby codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-ruby codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token plain">class Post &lt; ApplicationRecord</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	has_rich_text :content</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Trên form, ta chỉ việc dùng <code>rich_text_area</code></p>
<div class="language-erb codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-erb codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token plain">&lt;%= form_with(model: @post) do |form| %&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &lt;div class=&quot;field&quot;&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &lt;%= form.label :content %&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &lt;%= form.rich_text_area :content %&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &lt;/div&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&lt;% end %&gt;</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Khi permit params, ta cũng làm như bao field khác</p>
<div class="language-ruby codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-ruby codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class PostsController &lt; ApplicationController</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  def post_params</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    params.require(:post).permit(:category, :content)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Cuối cùng ta hiển thị dữ liệu như sau:</p>
<div class="language-erb codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-erb codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token plain">&lt;%= @post.content %&gt;</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Câu lệnh trên thực chất đang ngầm gọi tới <code>@post.content.to_s</code></p>
<p>Đây là sản phẩm của ta:</p>
<p>Form tạo post với WYSIWYG editor - Sử dụng Trix editor, do Basecamp phát triển, cây nhà lá vườn luôn.</p>
<p>Có thể kéo thả file vào, file đó sẽ được upload bằng Active Storage.</p>
<p><img decoding="async" loading="lazy" src="https://images.viblo.asia/77b9bd23-5ba3-426b-b6fc-cac02edb0b42.png" alt="" class="img_XBWr"></p>
<p>Hiển thị dữ liệu ở màn hình detail</p>
<p><img decoding="async" loading="lazy" src="https://images.viblo.asia/6b1b8da0-ca7f-468b-9705-444a8cb2d736.png" alt="" class="img_XBWr"></p>
<p>Các bạn thấy sao? Cá nhân mình thấy xấu như cờ hó vậy =)) Tuy nhiên ta có thể styling cho nó.</p>
<h2 class="anchor anchorWithStickyNavbar_FlIw" id="styling">Styling<a href="#styling" class="hash-link" aria-label="Direct link to Styling" title="Direct link to Styling">​</a></h2>
<p>Rails đang có sẵn một vài style cơ bản cho nó trong file <code>app/assets/stylesheets/actiontext.scss</code>, ta có thể sửa nó để cho đẹp hơn.</p>
<p>Với đống tool của editor thì có thể dùng selector <code>.trix-button-row</code></p>
<p>Với template attachment (như cái <code>monaco.ttf</code> ở trên), ta cũng có thể custom lại, Rails cung cấp sẵn template mặc định ở file <code>app/views/active_storage/blobs/_blob.html.erb</code></p>
<h1>Tìm hiểu sự ma giáo</h1>
<p>Rồi ta đã lướt qua cách sử dụng nó, nhưng mà có quá nhiều magic.</p>
<p>Liệu bạn có tự đặt ra những câu hỏi thế này hay không?</p>
<ul>
<li>
<p>Không biết cách lưu trữ dữ liệu của nó như thế nào?</p>
</li>
<li>
<p>Làm sao mà cái file trong kia integrate được với Active Storage?</p>
</li>
<li>
<p>Vì sao lại có thể custom lại những attachment bằng template?</p>
</li>
<li>
<p>vân vân mây mây...</p>
</li>
</ul>
<p>Ta sẽ bắt tay vào tìm hiểu nó.</p>
<p>Hãy bắt đầu với <code>has_rich_text</code></p>
<h2 class="anchor anchorWithStickyNavbar_FlIw" id="macro-has_rich_text">Macro <code>has_rich_text</code><a href="#macro-has_rich_text" class="hash-link" aria-label="Direct link to macro-has_rich_text" title="Direct link to macro-has_rich_text">​</a></h2>
<div class="language-ruby codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-ruby codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token plain"># https://github.com/rails/rails/blob/6a5c8b91998c56e50b5cc934d968947cd319f735/actiontext/lib/action_text/attribute.rb#L26</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">def has_rich_text(name)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  class_eval &lt;&lt;-CODE, __FILE__, __LINE__ + 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def #{name}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      rich_text_#{name} || build_rich_text_#{name}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def #{name}=(body)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      self.#{name}.body = body</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  CODE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  has_one :&quot;rich_text_#{name}&quot;, -&gt; { where(name: name) },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    class_name: &quot;ActionText::RichText&quot;, as: :record, inverse_of: :record, autosave: true, dependent: :destroy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # ... codes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Dễ dàng thấy rằng đây là 1 macro giúp định nghĩa getter, setter, và cả association <code>has_one :rich_text_...</code> với <code>ActionText::RichText</code>.</p>
<p>Vậy thì khi ta gọi <code>@post.content</code>, thực chất là ta đang gọi t ới <code>@post.rich_text_content</code>.</p>
<p>Và nó cũng chỉ ra 1 điều nữa là Rails dùng 1 bảng riêng để lưu lại đống rich text của ta.</p>
<p>Hãy dành chút thời gian nhìn vào thư mục <code>db/migrate</code>, ta sẽ thấy file sau:</p>
<div class="language-ruby codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-ruby codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token plain"># db/migrate/20190718085159_create_action_text_tables.action_text.rb</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># This migration comes from action_text (originally 20180528164100)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class CreateActionTextTables &lt; ActiveRecord::Migration[6.0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  def change</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    create_table :action_text_rich_texts do |t|</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      t.string     :name, null: false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      t.text       :body, size: :long</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      t.references :record, null: false, polymorphic: true, index: false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      t.timestamps</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      t.index [ :record_type, :record_id, :name ], name: &quot;index_action_text_rich_texts_uniqueness&quot;, unique: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Quả thật là vậy, <code>body</code> chính là nơi lưu trữ đống text của ta, còn <code>name</code>, <code>record_id</code>, và <code>record_type</code> là những attribute cho polymorphic association, khá quen thuộc nếu bạn đã dùng Active storage</p>
<p>Ta sẽ đi đến bước tiếp theo <code>rich_text_area</code></p>
<h2 class="anchor anchorWithStickyNavbar_FlIw" id="rails-xử-lý-lưu-trữ-rich-text-như-thế-nào">Rails xử lý, lưu trữ rich text như thế nào?<a href="#rails-xử-lý-lưu-trữ-rich-text-như-thế-nào" class="hash-link" aria-label="Direct link to Rails xử lý, lưu trữ rich text như thế nào?" title="Direct link to Rails xử lý, lưu trữ rich text như thế nào?">​</a></h2>
<div class="language-ruby codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-ruby codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token plain"># https://github.com/rails/rails/blob/cc1a5d5620c4cd952b27f6c1bbd16d8780a34d0e/actiontext/app/helpers/action_text/tag_helper.rb#L20</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">def rich_text_area_tag(name, value = nil, options = {})</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  options = options.symbolize_keys</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  options[:input] ||= &quot;trix_input_#{ActionText::TagHelper.id += 1}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  options[:class] ||= &quot;trix-content&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  options[:data] ||= {}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  options[:data][:direct_upload_url] = main_app.rails_direct_uploads_url</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  options[:data][:blob_url_template] = main_app.rails_service_blob_url(&quot;:signed_id&quot;, &quot;:filename&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  editor_tag = content_tag(&quot;trix-editor&quot;, &quot;&quot;, options)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  input_tag = hidden_field_tag(name, value, id: options[:input])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  input_tag + editor_tag</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Có thể thấy đơn giản nó chỉ init cái trix editor cho ta thôi.</p>
<p>Việc kéo thả file, upload hoàn toàn được handle bởi trix editor, ta không custom được template sau khi file upload thành công.</p>
<p>Tuy nhiên Action Text có thêm 1 callback sau khi file được upload thành công:</p>
<div class="language-javascript codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-javascript codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// https://github.com/rails/rails/blob/cc1a5d5620c4cd952b27f6c1bbd16d8780a34d0e/actiontext/app/javascript/actiontext/attachment_upload.js#L26</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">attachment</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">setAttributes</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">sgid</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> attributes</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">attachable_sgid</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">url</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">createBlobUrl</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">attributes</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">signed_id</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> attributes</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">filename</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>đây là 1 step rất quan trọng, nhưng ta sẽ chưa cần chú ý tới nó vội. Attachment của ta sau khi upload thành công sẽ trông như sau:</p>
<div class="language-html codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-html codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">figure</span><span class="token tag" style="color:#00009f"></span><br></span><span class="token-line" style="color:#393A34"><span class="token tag" style="color:#00009f">  </span><span class="token tag attr-name" style="color:#00a4db">contenteditable</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">false</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"></span><br></span><span class="token-line" style="color:#393A34"><span class="token tag" style="color:#00009f">  </span><span class="token tag attr-name" style="color:#00a4db">data-trix-attachment</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&#x27;</span><span class="token tag attr-value" style="color:#e3116c">{&quot;contentType&quot;:&quot;application/zip&quot;,&quot;filename&quot;:&quot;monaco.ttf-master.zip&quot;,&quot;filesize&quot;:88996,&quot;sgid&quot;:&quot;BAh7CEkiCGdpZAY6BkVUSSIvZ2lkOi8vYXBwL0FjdGl2ZVN0b3JhZ2U6OkJsb2IvOD9leHBpcmVzX2luBjsAVEkiDHB1cnBvc2UGOwBUSSIPYXR0YWNoYWJsZQY7AFRJIg9leHBpcmVzX2F0BjsAVDA=--79d2aa5a0af367233a5420a4f0ae02657d3910ab&quot;,&quot;url&quot;:&quot;http://localhost:60100/rails/active_storage/blobs/eyJfcmFpbHMiOnsibWVzc2FnZSI6IkJBaHBEUT09IiwiZXhwIjpudWxsLCJwdXIiOiJibG9iX2lkIn19--e79bebbfa0f10319d319411c129291d12e752d22/monaco.ttf-master.zip&quot;}</span><span class="token tag attr-value punctuation" style="color:#393A34">&#x27;</span><span class="token tag" style="color:#00009f"></span><br></span><span class="token-line" style="color:#393A34"><span class="token tag" style="color:#00009f">  </span><span class="token tag attr-name" style="color:#00a4db">data-trix-content-type</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">application/zip</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"></span><br></span><span class="token-line" style="color:#393A34"><span class="token tag" style="color:#00009f">  </span><span class="token tag attr-name" style="color:#00a4db">data-trix-id</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">1108</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"></span><br></span><span class="token-line" style="color:#393A34"><span class="token tag" style="color:#00009f">  </span><span class="token tag attr-name" style="color:#00a4db">class</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">attachment attachment--file attachment--zip</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"></span><br></span><span class="token-line" style="color:#393A34"><span class="token tag" style="color:#00009f"></span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">figcaption</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">class</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">attachment__caption</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">span</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">class</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">attachment__name</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">monaco.ttf-master.zip</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">span</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">span</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">class</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">attachment__size</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">86.91 KB</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">span</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">figcaption</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">figure</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Tiếp đến là submit dữ liệu, vậy Rails sẽ gửi gì lên?</p>
<p>Đơn giản là Rails sẽ gửi tất cả những gì bên trong <code>&lt;trix-editor&gt;&lt;/trix-editor&gt;</code></p>
<p>Inspect thử params, ta sẽ thấy:</p>
<div class="language-ruby codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-ruby codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token plain">post_params[:content]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># =&gt; &quot;&lt;div&gt;&lt;a href=\&quot;http://localhost:60100/posts/new\&quot;&gt;http://localhost:60100/posts/new&lt;/a&gt;&lt;/div&gt;&lt;div&gt;&lt;strong&gt;Hello world&lt;br&gt;&lt;/strong&gt;&lt;figure data-trix-attachment=\&quot;{&amp;quot;content&amp;quot;:&amp;quot;&lt;figure class=\\&amp;quot;attachment attachment--file attachment--zip\\&amp;quot;&gt;\\n\\n  &lt;figcaption class=\\&amp;quot;attachment__caption\\&amp;quot;&gt;\\n      &lt;span class=\\&amp;quot;attachment__name\\&amp;quot;&gt;monaco.ttf-master.zip&lt;/span&gt;\\n      &lt;span class=\\&amp;quot;attachment__size\\&amp;quot;&gt;86.9 KB&lt;/span&gt;\\n  &lt;/figcaption&gt;\\n&lt;/figure&gt;\\n&amp;quot;,&amp;quot;contentType&amp;quot;:&amp;quot;application/zip&amp;quot;,&amp;quot;filename&amp;quot;:&amp;quot;monaco.ttf-master.zip&amp;quot;,&amp;quot;filesize&amp;quot;:88996,&amp;quot;sgid&amp;quot;:&amp;quot;BAh7CEkiCGdpZAY6BkVUSSIvZ2lkOi8vYXBwL0FjdGl2ZVN0b3JhZ2U6OkJsb2IvNz9leHBpcmVzX2luBjsAVEkiDHB1cnBvc2UGOwBUSSIPYXR0YWNoYWJsZQY7AFRJIg9leHBpcmVzX2F0BjsAVDA=--97b885c24fd3d87464525f34a7b6ea117e4c72e6&amp;quot;,&amp;quot;url&amp;quot;:&amp;quot;http://localhost:60100/rails/active_storage/blobs/eyJfcmFpbHMiOnsibWVzc2FnZSI6IkJBaHBEQT09IiwiZXhwIjpudWxsLCJwdXIiOiJibG9iX2lkIn19--940badfc5aee704ef3f98085f87f909baf870660/monaco.ttf-master.zip&amp;quot;}\&quot; data-trix-content-type=\&quot;application/zip\&quot; class=\&quot;attachment attachment--content attachment--zip\&quot;&gt;&lt;figure class=\&quot;attachment attachment--file attachment--zip\&quot;&gt;\r\n\r\n  &lt;figcaption class=\&quot;attachment__caption\&quot;&gt;\r\n      &lt;span class=\&quot;attachment__name\&quot;&gt;monaco.ttf-master.zip&lt;/span&gt;\r\n      &lt;span class=\&quot;attachment__size\&quot;&gt;86.9 KB&lt;/span&gt;\r\n  &lt;/figcaption&gt;\r\n&lt;/figure&gt;\r\n&lt;figcaption class=\&quot;attachment__caption\&quot;&gt;&lt;/figcaption&gt;&lt;/figure&gt;&lt;/div&gt;&quot;</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Làm đẹp nó chút</p>
<div class="language-html codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-html codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">div</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">a</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">href</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">http://localhost:60100/posts/new</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"></span><br></span><span class="token-line" style="color:#393A34"><span class="token tag" style="color:#00009f">    </span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">http://localhost:60100/posts/new</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">a</span><span class="token tag" style="color:#00009f"></span><br></span><span class="token-line" style="color:#393A34"><span class="token tag" style="color:#00009f">  </span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">div</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">div</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">strong</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">Hello world</span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">br</span><span class="token tag" style="color:#00009f"> </span><span class="token tag punctuation" style="color:#393A34">/&gt;</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">strong</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">figure</span><span class="token tag" style="color:#00009f"></span><br></span><span class="token-line" style="color:#393A34"><span class="token tag" style="color:#00009f">    </span><span class="token tag attr-name" style="color:#00a4db">data-trix-attachment</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">...</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"></span><br></span><span class="token-line" style="color:#393A34"><span class="token tag" style="color:#00009f">    </span><span class="token tag attr-name" style="color:#00a4db">data-trix-content-type</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">application/zip</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"></span><br></span><span class="token-line" style="color:#393A34"><span class="token tag" style="color:#00009f">    </span><span class="token tag attr-name" style="color:#00a4db">class</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">attachment attachment--content attachment--zip</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"></span><br></span><span class="token-line" style="color:#393A34"><span class="token tag" style="color:#00009f">  </span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">figure</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">class</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">attachment attachment--file attachment--zip</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">figcaption</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">class</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">attachment__caption</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">span</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">class</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">attachment__name</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">monaco.ttf-master.zip</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">span</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">span</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">class</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">attachment__size</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">86.9 KB</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">span</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">figcaption</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">figure</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">figcaption</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">class</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">attachment__caption</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">figcaption</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">figure</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">div</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Có thể thấy nó khá giống với content của <code>&lt;trix-editor&gt;&lt;/trix-editor&gt;</code> đúng không nào?</p>
<p>Ta sẽ save đống params này lại, và xem DB ta chứa gì?</p>
<div class="language-sql codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-sql codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token plain">app_development</span><span class="token operator" style="color:#393A34">=</span><span class="token comment" style="color:#999988;font-style:italic"># SELECT body FROM action_text_rich_texts WHERE id = 3;</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-html codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-html codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">div</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">a</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">href</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">http://localhost:60100/posts/new</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"></span><br></span><span class="token-line" style="color:#393A34"><span class="token tag" style="color:#00009f">    </span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">http://localhost:60100/posts/new</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">a</span><span class="token tag" style="color:#00009f"></span><br></span><span class="token-line" style="color:#393A34"><span class="token tag" style="color:#00009f">  </span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">div</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">div</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">strong</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">Hello world</span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">br</span><span class="token tag" style="color:#00009f"> </span><span class="token tag punctuation" style="color:#393A34">/&gt;</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">strong</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">action-text-attachment</span><span class="token tag" style="color:#00009f"></span><br></span><span class="token-line" style="color:#393A34"><span class="token tag" style="color:#00009f">    </span><span class="token tag attr-name" style="color:#00a4db">sgid</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">BAh7CEkiCGdpZAY6BkVUSSIvZ2lkOi8vYXBwL0FjdGl2ZVN0b3JhZ2U6OkJsb2IvNz9leHBpcmVzX2luBjsAVEkiDHB1cnBvc2UGOwBUSSIPYXR0YWNoYWJsZQY7AFRJIg9leHBpcmVzX2F0BjsAVDA=--97b885c24fd3d87464525f34a7b6ea117e4c72e6</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"></span><br></span><span class="token-line" style="color:#393A34"><span class="token tag" style="color:#00009f">    </span><span class="token tag attr-name" style="color:#00a4db">content-type</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">application/zip</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"></span><br></span><span class="token-line" style="color:#393A34"><span class="token tag" style="color:#00009f">    </span><span class="token tag attr-name" style="color:#00a4db">url</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">http://localhost:60100/rails/active_storage/blobs/eyJfcmFpbHMiOnsibWVzc2FnZSI6IkJBaHBEQT09IiwiZXhwIjpudWxsLCJwdXIiOiJibG9iX2lkIn19--940badfc5aee704ef3f98085f87f909baf870660/monaco.ttf-master.zip</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"></span><br></span><span class="token-line" style="color:#393A34"><span class="token tag" style="color:#00009f">    </span><span class="token tag attr-name" style="color:#00a4db">filename</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">monaco.ttf-master.zip</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"></span><br></span><span class="token-line" style="color:#393A34"><span class="token tag" style="color:#00009f">    </span><span class="token tag attr-name" style="color:#00a4db">filesize</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">88996</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"></span><br></span><span class="token-line" style="color:#393A34"><span class="token tag" style="color:#00009f">  </span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">action-text-attachment</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">div</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Các thẻ khác thì vẫn vậy, tuy nhiên attachments của ta lại có một chút khác biệt. Ở đây đống <code>figure</code> đã được minify lại thành <code>action-text-attachment </code> để cho gọn hơn.</p>
<p>Hãy cùng điều tra xem tại sao lại như vậy? Trước tiên ta vào xem <code>ActionText::RichText</code> của ta chứa gì ma giáo</p>
<div class="language-ruby codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-ruby codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token plain"># https://github.com/rails/rails/blob/027085a5972a798cfea60f829a9edabbd67a2818/actiontext/app/models/action_text/rich_text.rb#L11</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class ActionText::RichText &lt; ActiveRecord::Base</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  serialize :body, ActionText::Content</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Vậy là <code>body</code> của ta đang được serialize bởi <code>ActionText::Content</code>, mò đến  đó tiếp thôi.</p>
<div class="language-ruby codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-ruby codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token plain"># https://github.com/rails/rails/blob/df8ee09ce71338cdf9816225df1bdebc707f3560/actiontext/lib/action_text/content.rb#L15</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class ActionText::Content</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  class &lt;&lt; self</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def fragment_by_canonicalizing_content(content)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      fragment = ActionText::Attachment.fragment_by_canonicalizing_attachments(content)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      fragment = ActionText::AttachmentGallery.fragment_by_canonicalizing_attachment_galleries(fragment)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      fragment</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  def initialize(content = nil, options = {})</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    options.with_defaults! canonicalize: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if options[:canonicalize]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      @fragment = self.class.fragment_by_canonicalizing_content(content)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    else</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      @fragment = ActionText::Fragment.wrap(content)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Ta sẽ quan tâm tới hàm <code>initialize</code> trước, khi serialize, mặc định là ta đang không dùng tham số, vậy là options sử dụng sẽ là <code>canonicalize: true</code>, xem tiếp <code>fragment_by_canonicalizing_content</code> nào. Có vẻ lại phải mò <code>fragment_by_canonicalizing_attachments</code> tiếp @@</p>
<div class="language-ruby codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-ruby codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token plain"># https://github.com/rails/rails/blob/df8ee09ce7/actiontext/lib/action_text/attachment.rb#L11</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class ActionText::Attachment</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  TAG_NAME = &quot;action-text-attachment&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  SELECTOR = TAG_NAME</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  class &lt;&lt; self</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def fragment_by_canonicalizing_attachments(content)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      fragment_by_minifying_attachments(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        fragment_by_converting_trix_attachments(content)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><code>fragment_by_minifying_attachments</code>, bạn có thấy từ minify không? Có vẻ ta đang đi đúng hướng. Hãy tiếp tục, nhưng hãy bắt đầu bằng <code>fragment_by_converting_trix_attachments</code></p>
<div class="language-ruby codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-ruby codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token plain"># https://github.com/rails/rails/blob/df8ee09ce71338cdf9816225df1bdebc707f3560/actiontext/lib/action_text/attachments/trix_conversion.rb#L9</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">module ActionText::Attachments::TrixConversion</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  class_methods do</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def fragment_by_converting_trix_attachments(content)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Fragment.wrap(content).replace(TrixAttachment::SELECTOR) do |node|</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        from_trix_attachment(TrixAttachment.new(node))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Nôm na là đoạn này sẽ replace toàn bộ <code>ActionText::TrixAttachment::SELECTOR = &quot;[data-trix-attachment]</code> bằng thẻ <code>ActionText::Attachment::SELECTOR = &quot;action-text-attachment&quot;</code>.</p>
<div class="language-ruby codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-ruby codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token plain">module ActionText::Attachments::Minification</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  class_methods do</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def fragment_by_minifying_attachments(content)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Fragment.wrap(content).replace(ActionText::Attachment::SELECTOR) do |node|</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        node.tap { |n| n.inner_html = &quot;&quot; }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Hàm <code>fragment_by_minifying_attachments</code> của chúng ta sẽ remove toàn bộ inner content của thẻ <code>action-text-attachment</code>.</p>
<p>Sau một hồi lòng vòng, cuối cùng ta đã biết được tại sao đống <code>figure</code> rối rắm kia trở thành <code>action-text-attachment</code> gọn gàng hơn rất nhiều.</p>
<h2 class="anchor anchorWithStickyNavbar_FlIw" id="hiển-thị-dữ-liệu">Hiển thị dữ liệu<a href="#hiển-thị-dữ-liệu" class="hash-link" aria-label="Direct link to Hiển thị dữ liệu" title="Direct link to Hiển thị dữ liệu">​</a></h2>
<p>Hãy vào màn hình detail, và thử inspect element, ta sẽ thấy attachment của ta lại trở về dạng đầy đủ:</p>
<div class="language-ruby codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-ruby codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token plain">&lt;%= @post.content =&gt;</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Đây là những gì ta thu được.</p>
<div class="language-html codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-html codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">div</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">class</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">trix-content</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">div</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">a</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">href</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">http://localhost:60100/posts/new</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"></span><br></span><span class="token-line" style="color:#393A34"><span class="token tag" style="color:#00009f">      </span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">http://localhost:60100/posts/new</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">a</span><span class="token tag" style="color:#00009f"></span><br></span><span class="token-line" style="color:#393A34"><span class="token tag" style="color:#00009f">    </span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">div</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">div</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">strong</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">Hello world</span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">br</span><span class="token tag" style="color:#00009f"> </span><span class="token tag punctuation" style="color:#393A34">/&gt;</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">strong</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">action-text-attachment</span><span class="token tag" style="color:#00009f"></span><br></span><span class="token-line" style="color:#393A34"><span class="token tag" style="color:#00009f">      </span><span class="token tag attr-name" style="color:#00a4db">sgid</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">BAh7CEkiCGdpZAY6BkVUSSIvZ2lkOi8vYXBwL0FjdGl2ZVN0b3JhZ2U6OkJsb2IvNz9leHBpcmVzX2luBjsAVEkiDHB1cnBvc2UGOwBUSSIPYXR0YWNoYWJsZQY7AFRJIg9leHBpcmVzX2F0BjsAVDA=--97b885c24fd3d87464525f34a7b6ea117e4c72e6</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"></span><br></span><span class="token-line" style="color:#393A34"><span class="token tag" style="color:#00009f">      </span><span class="token tag attr-name" style="color:#00a4db">content-type</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">application/zip</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"></span><br></span><span class="token-line" style="color:#393A34"><span class="token tag" style="color:#00009f">      </span><span class="token tag attr-name" style="color:#00a4db">url</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">http://localhost:60100/rails/active_storage/blobs/eyJfcmFpbHMiOnsibWVzc2FnZSI6IkJBaHBEQT09IiwiZXhwIjpudWxsLCJwdXIiOiJibG9iX2lkIn19--940badfc5aee704ef3f98085f87f909baf870660/monaco.ttf-master.zip</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"></span><br></span><span class="token-line" style="color:#393A34"><span class="token tag" style="color:#00009f">      </span><span class="token tag attr-name" style="color:#00a4db">filename</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">monaco.ttf-master.zip</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"></span><br></span><span class="token-line" style="color:#393A34"><span class="token tag" style="color:#00009f">      </span><span class="token tag attr-name" style="color:#00a4db">filesize</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">88996</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"></span><br></span><span class="token-line" style="color:#393A34"><span class="token tag" style="color:#00009f">    </span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">figure</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">class</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">attachment attachment--file attachment--zip</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">figcaption</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">class</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">attachment__caption</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">span</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">class</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">attachment__name</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">monaco.ttf-master.zip</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">span</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">span</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">class</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">attachment__size</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">86.9 KB</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">span</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">figcaption</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">figure</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">action-text-attachment</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">div</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">div</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Bạn còn nhớ mình ghi ở trên, khi ta viết <code>@post.content</code>, thực chất ta đang gọi <code>@post.content.to_s</code> chứ?</p>
<p>Thử đào sâu vào chút:</p>
<div class="language-ruby codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-ruby codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token plain"># https://github.com/rails/rails/blob/df8ee09ce7/actiontext/lib/action_text/content.rb#L90</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">def to_rendered_html_with_layout</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  renderer.render(partial: &quot;action_text/content/layout&quot;, locals: { content: self })</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">def to_s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  to_rendered_html_with_layout</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-erb codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-erb codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token plain">&lt;%# https://github.com/rails/rails/blob/df8ee09ce7/actiontext/app/views/action_text/content/_layout.html.erb %&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&lt;div class=&quot;trix-content&quot;&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &lt;%= render_action_text_content(content) %&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&lt;/div&gt;</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-ruby codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-ruby codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token plain"># https://github.com/rails/rails/blob/0ec2a907545e47f816993b9fd8cabb552454b1a2/actiontext/app/helpers/action_text/content_helper.rb#L12</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">def render_action_text_content(content)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  sanitize_action_text_content(render_action_text_attachments(content))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">def sanitize_action_text_content(content)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  sanitizer.sanitize(content.to_html, tags: allowed_tags, attributes: allowed_attributes, scrubber: scrubber).html_safe</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">def render_action_text_attachments(content)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  content.render_attachments do |attachment|</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    unless attachment.in?(content.gallery_attachments)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      attachment.node.tap do |node|</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        node.inner_html = render(attachment, in_gallery: false).chomp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  end.render_attachment_galleries do |attachment_gallery|</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    render(layout: attachment_gallery, object: attachment_gallery) do</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      attachment_gallery.attachments.map do |attachment|</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        attachment.node.inner_html = render(attachment, in_gallery: true).chomp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        attachment.to_html</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      end.join(&quot;&quot;).html_safe</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    end.chomp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Đại khái là Rails sẽ sanitize đống rich text của ta để tránh XSS attack, và render template đối với những attachment.</p>
<h2 class="anchor anchorWithStickyNavbar_FlIw" id="integrate-với-active-storage">Integrate với Active Storage<a href="#integrate-với-active-storage" class="hash-link" aria-label="Direct link to Integrate với Active Storage" title="Direct link to Integrate với Active Storage">​</a></h2>
<p>Hãy quay trở lại với model <code>ActionText::RichText</code></p>
<div class="language-ruby codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-ruby codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token plain"># https://github.com/rails/rails/blob/df8ee09ce7/actiontext/app/models/action_text/rich_text.rb#L14</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class ActionText::RichText &lt; ActiveRecord::Base</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  has_many_attached :embeds</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  before_save do</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    self.embeds = body.attachments.map(&amp;:attachable) if body.present?</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Ta dễ dàng hiểu 1 cách tổng quan là Rails sẽ tiến hành extract toàn bộ attachment trong body, gán vào embeds. Sau đó sẽ save đống association này lại.</p>
<p>Thử xem Rails sẽ extract attachments ra làm sao.</p>
<div class="language-ruby codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-ruby codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token plain"># https://github.com/rails/rails/blob/027085a5972a798cfea60f829a9edabbd67a2818/actiontext/lib/action_text/content.rb#L53</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">def attachables</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  @attachables ||= attachment_nodes.map do |node|</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ActionText::Attachable.from_node(node)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># https://github.com/rails/rails/blob/027085a5972a798cfea60f829a9edabbd67a2818/actiontext/lib/action_text/content.rb#L113</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">def attachment_nodes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  @attachment_nodes ||= fragment.find_all(ActionText::Attachment::SELECTOR)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Rails sẽ tìm kiếm tất cả thẻ <code>action-text-attachment</code>, extract những thông tin cần thiết để init được <code>ActiveStorage::Blob</code> object.</p>
<p>Ta cần nghía qua hàm <code>Attachable.from_node</code> nữa</p>
<div class="language-ruby codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-ruby codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token plain"># https://github.com/rails/rails/blob/027085a5972a798cfea60f829a9edabbd67a2818/actiontext/lib/action_text/attachable.rb#L10</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">def from_node(node)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  if attachable = attachable_from_sgid(node[&quot;sgid&quot;])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    attachable</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  elsif attachable = ActionText::Attachables::ContentAttachment.from_node(node)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    attachable</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  elsif attachable = ActionText::Attachables::RemoteImage.from_node(node)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    attachable</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  else</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ActionText::Attachables::MissingAttachable</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Trong trường hợp này, Rails sẽ luôn extract theo strategy là <code>sgid</code>, các bạn không cần quan tâm tới 3 nhánh dưới làm gì cho mất công.</p>
<p>Còn nhớ phần trên mình đã đề cập tới <code>sgid</code> chứ?</p>
<div class="language-js codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-js codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">//github.com/rails/rails/blob/cc1a5d5620c4cd952b27f6c1bbd16d8780a34d0e/actiontext/app/javascript/actiontext/attachment_upload.js#L26</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">https</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">attachment</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">setAttributes</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">sgid</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> attributes</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">attachable_sgid</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">url</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">createBlobUrl</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">attributes</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">signed_id</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> attributes</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">filename</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Callback này được gọi sau khi file được upload thành công. Vậy <code>sgid</code> là cái gì?</p>
<p><code>sigd</code> được encrypt từ <code>id</code> của attachment sau khi upload. Khi gửi lên, server sẽ decrypt nó để lấy lại <code>id</code>, gán attachment vào record.</p>
<p>Tại sao lại cần encrypt? Các bạn cứ tưởng tượng, nếu dùng thẳng id, do ta upload ảnh trước khi tạo record, nên khi gửi params từ client lên, chắc chắn sẽ phải đưa attachment id vào để server lưu đúng association. Client nó gửi đúng thì không sao, nhưng nếu nó gửi id attachment của người khác thì sao? Attachment đó sẽ chuyển chủ ngay lập tức <!-- -->:v<!-- --> Còn nếu encrypt thì user đố mà mò được mã hash của attachment người khác.</p>
<p><code>attachable_from_sgid(node[&quot;sgid&quot;])</code> sẽ trả về <code>ActiveStorage::Blob</code> object</p>
<div class="language-ruby codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-ruby codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token plain"># https://github.com/rails/rails/blob/f1b8bb4e1f16e4029ddf05515db0c01942521116/actiontext/lib/action_text/attachable.rb#L22</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">def from_attachable_sgid(sgid, options = {})</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  method = sgid.is_a?(Array) ? :locate_many_signed : :locate_signed</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  record = GlobalID::Locator.public_send(method, sgid, options.merge(for: LOCATOR_NAME))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  record || raise(ActiveRecord::RecordNotFound)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Nếu không tin, bạn hãy thử <code>rails c</code> và gọi hàm:</p>
<div class="language-ruby codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-ruby codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token plain">GlobalID::Locator.locate_signed(sgid, { for: &quot;attachable&quot; })</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h1>Kết luận</h1>
<p><code>Action Text</code> được thiết kế khá hay, code gọn, tất cả method đều rất ngắn, dễ hiểu.</p>
<p>Do là built-in nên ta cũng chả cần cài cắm gì thêm mệt người. Nếu đã upgrade lên Rails 6, bạn hãy thử trải nghiệm nó xem.</p>
<p>Còn đối với phiên bản thấp hơn, ta cũng có thể áp dụng flow của Action Text để build một package hỗ trợ richtext.</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_qmVs padding--none margin-left--sm"><li class="tag_aHj4"><a class="tag_rlZX tagRegular_E7nr" href="/blog/tags/action-text">action-text</a></li><li class="tag_aHj4"><a class="tag_rlZX tagRegular_E7nr" href="/blog/tags/ruby-on-rails">ruby-on-rails</a></li><li class="tag_aHj4"><a class="tag_rlZX tagRegular_E7nr" href="/blog/tags/web">web</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="https://schema.org/BlogPosting"><meta itemprop="description" content="Khi mới bắt đầu code, có thể chúng ta rất ngại handle những exception mà ngay cả 1 hàm đơn giản nhất cũng có thể tung ra. Tuy nhiên, thực tế khi xây dựng hệ thống, ta phải đặc biệt chú ý đến những exception, không thì ứng dụng của ta có thể thăng bất cứ lúc nào :v"><header><h2 class="title_DEF8" itemprop="headline"><a itemprop="url" href="/blog/cung-tim-hieu-ve-railway-oriented-programming">Cùng tìm hiểu về Railway Oriented Programming</a></h2><div class="container_Y0Yj margin-vert--md"><time datetime="2019-03-16T00:00:00.000Z" itemprop="datePublished">March 16, 2019</time> · <!-- -->8 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_fNYc"><div class="avatar margin-bottom--sm"><a href="https://github.com/moonlight8978" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://avatars.githubusercontent.com/u/26299310?v=4" alt="Lê Sĩ Bích" itemprop="image"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/moonlight8978" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Lê Sĩ Bích</span></a></div><small class="avatar__subtitle" itemprop="description">Ruby on Rails/React Developer</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>Khi mới bắt đầu code, có thể chúng ta rất ngại handle những exception mà ngay cả 1 hàm đơn giản nhất cũng có thể tung ra. Tuy nhiên, thực tế khi xây dựng hệ thống, ta phải đặc biệt chú ý đến những exception, không thì ứng dụng của ta có thể thăng bất cứ lúc nào <!-- -->:v</p>
<p>Vậy thì làm sao để handle chúng 1 cách thật <em>clean</em>. Có khá nhiều hướng tiếp cận, tuy nhiên ta hãy cùng thử trải nghiệm theo hướng <em>Railway Oriented</em> xem nó có gì hay.</p>
<p>Bài giới thiệu gốc được viết sử dụng ngôn ngữ F#, nhưng ta hoàn toàn có thể áp dụng vào các ngôn ngữ khác như Javascript, Ruby, ...</p>
<p><em>Railway Oriented Programming</em> phù hợp với style lập trình hàm (Functional Programming - FP)</p>
<p>Tên gọi là <em>Railway</em> cũng bởi trông nó khá giống với đường ray tàu hỏa.</p>
<h1>Vấn đề</h1>
<p>Hãy bắt đầu với 1 usecase rất cơ bản</p>
<blockquote>
<p>Người dùng muốn cập nhật profile của họ.</p>
</blockquote>
<p>Sau khi người dùng submit thông tin ở web, ta hay cùng phân tích những xử lý ở phía server</p>
<p><img decoding="async" loading="lazy" src="https://images.viblo.asia/e37fd6b1-91fc-4340-8938-154196463a70.jpg" alt="" class="img_XBWr"></p>
<p>Tình huống đẹp nhất xảy ra là từ bước 1-5, ứng dụng ta sẽ chạy trơn tru, không có bất cứ 1 lỗi nào.</p>
<p>Nhưng mà ...</p>
<blockquote>
<p>Đời không như mơ, tình không như thơ.</p>
</blockquote>
<p>Từ bước 1-4 đều có thể có lỗi xảy ra, và tất nhiên người dùng sẽ không hề muốn nhìn thấy cảnh này</p>
<p><img decoding="async" loading="lazy" src="https://images.viblo.asia/e05c2f5c-ee9e-4f78-958d-bd54ff7b291c.jpg" alt="" class="img_XBWr"></p>
<p>Vậy thì những gì ta cần làm là xử lý những lỗi này, không thì người dùng một đi không trở lại luôn.</p>
<p><img decoding="async" loading="lazy" src="https://images.viblo.asia/d7ea1ee4-2326-408a-be91-e361803f7f0b.jpeg" alt="" class="img_XBWr"></p>
<p>Và ta sẽ viết code cho nó:</p>
<div class="language-javascript codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-javascript codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">updateUser</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">user</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> request </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">receiveRequest</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">!</span><span class="token function" style="color:#d73a49">isValidRequest</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">request</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword control-flow" style="color:#00009f">return</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Request is forbidden&quot;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">!</span><span class="token function" style="color:#d73a49">isValidUser</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">request</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword control-flow" style="color:#00009f">return</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;User information is invalid&quot;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">try</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">saveToDatabase</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">request</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#00009f">catch</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">error</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword control-flow" style="color:#00009f">return</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;DB error&quot;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">try</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">sendEmail</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">request</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#00009f">catch</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">error</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword control-flow" style="color:#00009f">return</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Mailer error&quot;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">return</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;OK&quot;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Code trên được viết theo style Imperative, vì thế nên ta có thể return bất cứ lúc nào ta muốn. Điều đó làm hàm của ta có thể return theo rất nhiều cách (nhiều kiểu response khác nhau).</p>
<p><img decoding="async" loading="lazy" src="https://images.viblo.asia/13ab6aca-df34-41a5-89fe-85e6b8de4523.png" alt="" class="img_XBWr"></p>
<p>Ta sẽ design lại flow theo style FP.</p>
<p><img decoding="async" loading="lazy" src="https://images.viblo.asia/e20339fb-142c-46a8-8d29-965f6ebcf63f.png" alt="" class="img_XBWr"></p>
<p>Hàm của ta giờ đây:</p>
<ul>
<li>
<p>Chỉ có 2 kiểu trả về: <code>Success</code> hoặc <code>Failure</code>.</p>
<ul>
<li>
<p>Success:</p>
<div class="language-js codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-js codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// @flow</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">type </span><span class="token maybe-class-name">Success</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token literal-property property" style="color:#36acaa">data</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> object </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
</li>
<li>
<p>Failure:</p>
<div class="language-js codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-js codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// @flow</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">type </span><span class="token maybe-class-name">Failure</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token literal-property property" style="color:#36acaa">error</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> string </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
</li>
</ul>
</li>
<li>
<p>Use case được xây dựng từ 1 series các hàm con tương ứng với mỗi step.</p>
</li>
</ul>
<p>Ta sẽ áp dụng <em>Railway Oriented Programming</em> để giải quyết vấn đề này.</p>
<h1>Railway Oriented Programming</h1>
<h4 class="anchor anchorWithStickyNavbar_FlIw" id="monad">Monad<a href="#monad" class="hash-link" aria-label="Direct link to Monad" title="Direct link to Monad">​</a></h4>
<p>Trong lập trình hàm, có một cách để handle lỗi là dùng <em>monad</em>.</p>
<p>Monad thường đi kèm với Applicative và Functor nữa, bọn này khá là xoắn não nên mình sẽ không đề cập ở đây.</p>
<p>Ta sẽ chỉ quan tâm tới: <em>Either</em> monad.</p>
<div class="language-js codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-js codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// @flow</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">type </span><span class="token maybe-class-name">Either</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token constant" style="color:#36acaa">A</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">B</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">A</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">B</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">type </span><span class="token maybe-class-name">FunctionReturnMonad</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token constant" style="color:#36acaa">A</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">B</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token maybe-class-name">Either</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token constant" style="color:#36acaa">A</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">B</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Hiểu một cách nôm na sẽ là: hàm của ta sẽ luôn trả về A hoặc B, nhưng không bao giờ trả về cả 2.</p>
<h4 class="anchor anchorWithStickyNavbar_FlIw" id="switch">Switch<a href="#switch" class="hash-link" aria-label="Direct link to Switch" title="Direct link to Switch">​</a></h4>
<p>Hãy bắt đầu với 1 function có thể gây ra lỗi:</p>
<div class="language-js codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-js codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">validateNameNotBlank</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">user</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">user</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">name</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">===</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword control-flow" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token literal-property property" style="color:#36acaa">error</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Name is blank&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token literal-property property" style="color:#36acaa">data</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> user </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><img decoding="async" loading="lazy" src="https://images.viblo.asia/4214182b-82ca-4ff1-9f86-7161b063632d.jpg" alt="" class="img_XBWr"></p>
<p>Đây chính là 1 switch, nó rẽ nhánh luồng xử lý của ta thành <code>Success</code> và <code>Failure</code>.</p>
<h4 class="anchor anchorWithStickyNavbar_FlIw" id="kết-nối-nhiều-switch">Kết nối nhiều switch<a href="#kết-nối-nhiều-switch" class="hash-link" aria-label="Direct link to Kết nối nhiều switch" title="Direct link to Kết nối nhiều switch">​</a></h4>
<p><img decoding="async" loading="lazy" src="https://images.viblo.asia/b6cf8618-c07c-4502-86a3-90b1b6ab3530.png" alt="" class="img_XBWr"></p>
<p>Đây là <em>đường ray</em> hoàn chỉnh mà ta cần xây dựng từ những switch riêng lẻ trên.</p>
<p>Có thể nhận thấy một vài điểm quan trọng ở railway này:</p>
<ul>
<li>
<p>Khi một step bị lỗi, nó sẽ không return function ngay lập tức, mà sẽ tiếp tục chạy vào các function tiếp theo cho tới khi kết thúc flow.</p>
<p>Tuy nhiên kết quả cuối cùng nhận được chỉ là lỗi đầu tiên phát sinh.</p>
</li>
<li>
<p>Những hàm của từng step đều phải xử lý cả trường hợp có dữ liệu và trường hợp hàm trước trả về lỗi</p>
</li>
</ul>
<p>Bây giờ vấn đề là làm thế nào để nối những switch lại với nhau?</p>
<p>Câu trả lời là <code>compose</code>. Tuy nhiên ta không thể compose theo cách thông thường được.</p>
<p>Ví dụ như:</p>
<p>Nếu đầu vào và đầu ra của ta cùng interface</p>
<div class="language-js codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-js codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token function-variable function" style="color:#d73a49">mul2</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">num</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#393A34">=&gt;</span><span class="token plain"> num </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token function-variable function" style="color:#d73a49">add1</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">num</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#393A34">=&gt;</span><span class="token plain"> num </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">mul2</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">add1</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 4</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Trở lại hàm <code>validateBlank</code> ở trên, nếu ta có nhiều hàm <code>validate</code> khác tương tự</p>
<p><img decoding="async" loading="lazy" src="https://images.viblo.asia/02d95ea0-c572-481b-bb2b-d2801667e9a0.png" alt="" class="img_XBWr"></p>
<p>Ta có thể thấy đầu vào chỉ có 1, mà lại có những 2 đầu ra.</p>
<p>Để có thể compose, ta sẽ phải biến chúng thành những function có thể handle cả trường hợp <code>Success</code> lẫn <code>Failure</code>.</p>
<p>Có thể sử dụng HOC</p>
<div class="language-js codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-js codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token function-variable function" style="color:#d73a49">transformToTwoTrackInput</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">func</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#393A34">=&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter punctuation" style="color:#393A34">{</span><span class="token parameter"> data</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"> error </span><span class="token parameter punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword control-flow" style="color:#00009f">return</span><span class="token plain"> data </span><span class="token operator" style="color:#393A34">?</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">func</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">data</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> error </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> twoTrackValidateNameNotBlank </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">transformToTwoTrackInput</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">validateNameNotBlank</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> twoTrackValidateName50 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">transformToTwoTrackInput</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">validateName50</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> twoTrackValidateEmailNotBlank </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">transformToTwoTrackInput</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  validateEmailNotBlank</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> user </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token literal-property property" style="color:#36acaa">email</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token literal-property property" style="color:#36acaa">name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">twoTrackValidateEmailNotBlank</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">twoTrackValidateName50</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">twoTrackValidateNameNotBlank</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token literal-property property" style="color:#36acaa">data</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> user </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// { error: &#x27;name is blank&#x27; }</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Như vậy là ta đã kết nối được những mảnh ghép trên với nhau.</p>
<p><img decoding="async" loading="lazy" src="https://images.viblo.asia/59045ab0-2465-4163-8c25-1b7529749196.png" alt="" class="img_XBWr"></p>
<h4 class="anchor anchorWithStickyNavbar_FlIw" id="một-vài-kiểu-function-thường-gặp">Một vài kiểu function thường gặp<a href="#một-vài-kiểu-function-thường-gặp" class="hash-link" aria-label="Direct link to Một vài kiểu function thường gặp" title="Direct link to Một vài kiểu function thường gặp">​</a></h4>
<h5 class="anchor anchorWithStickyNavbar_FlIw" id="single-track-function">Single track function<a href="#single-track-function" class="hash-link" aria-label="Direct link to Single track function" title="Direct link to Single track function">​</a></h5>
<p>Nếu một function không gây ra lỗi (chỉ có 1 đầu vào và 1 đầu ra) thì nó sẽ không thể nào compose được vào railway của chúng ta.</p>
<p>Khi đó ta phải wrap nó bởi 2-track function, giống với HOC ở trên.</p>
<p><img decoding="async" loading="lazy" src="https://images.viblo.asia/754c4226-95b0-4b98-81dc-e64ed7842ee9.jpg" alt="" class="img_XBWr"></p>
<div class="language-js codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-js codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">trimEmail</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">user</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token spread operator" style="color:#393A34">...</span><span class="token plain">user</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">email</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> user</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">email</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">trim</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token function-variable function" style="color:#d73a49">transformSingleTrackToTwoTrackInput</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token parameter">func</span><span class="token plain"> </span><span class="token arrow operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter punctuation" style="color:#393A34">{</span><span class="token parameter"> data</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"> error </span><span class="token parameter punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">return</span><span class="token plain"> data </span><span class="token operator" style="color:#393A34">?</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">func</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">data</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> error </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> user </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token literal-property property" style="color:#36acaa">email</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;  sample@email.com&#x27;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">transformSingleTrackToTwoTrackInput</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">trimEmail</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token literal-property property" style="color:#36acaa">data</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> user </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h5 class="anchor anchorWithStickyNavbar_FlIw" id="dead-end-function">Dead-end function<a href="#dead-end-function" class="hash-link" aria-label="Direct link to Dead-end function" title="Direct link to Dead-end function">​</a></h5>
<p>Dead-end function là những hàm void, không có giá trị trả về</p>
<p><img decoding="async" loading="lazy" src="https://images.viblo.asia/55f5aa49-c5c8-498f-a175-edd967b3d5c2.jpg" alt="" class="img_XBWr"></p>
<p>Màu tím chính là nơi ta sẽ đặt <em>dead-end function</em> vào</p>
<div class="language-js codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-js codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token function-variable function" style="color:#d73a49">transformDeadEndFunction</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">func</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#393A34">=&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter punctuation" style="color:#393A34">{</span><span class="token parameter"> data</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"> error </span><span class="token parameter punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">data</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token function" style="color:#d73a49">func</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword control-flow" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> data </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#00009f">else</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword control-flow" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> error </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h5 class="anchor anchorWithStickyNavbar_FlIw" id="function-throw-exception">Function throw Exception<a href="#function-throw-exception" class="hash-link" aria-label="Direct link to Function throw Exception" title="Direct link to Function throw Exception">​</a></h5>
<p>Ta có thể đặt try-catch để trả về Failure</p>
<div class="language-js codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-js codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token function-variable function" style="color:#d73a49">transformExceptionFunction</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">func</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#393A34">=&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter punctuation" style="color:#393A34">{</span><span class="token parameter"> data</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"> error </span><span class="token parameter punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">data</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword control-flow" style="color:#00009f">try</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">func</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#00009f">catch</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">error</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword control-flow" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token literal-property property" style="color:#36acaa">error</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> error</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">message</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">||</span><span class="token plain"> error </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword control-flow" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> data </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#00009f">else</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword control-flow" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> error </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><em>Note</em>: Convert tất cả Exception thành <code>Failure</code></p>
<h4 class="anchor anchorWithStickyNavbar_FlIw" id="kết-quả">Kết quả<a href="#kết-quả" class="hash-link" aria-label="Direct link to Kết quả" title="Direct link to Kết quả">​</a></h4>
<p>Ta không thể trả về dữ liệu kiểu two-track cho client được, vì vậy ta sẽ có thêm 1 bước cuối để trả về thông tin cho client.</p>
<p><img decoding="async" loading="lazy" src="https://images.viblo.asia/08650333-ae3a-4fa8-b960-09c7b11fbd79.jpg" alt="" class="img_XBWr"></p>
<div class="language-js codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-js codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">returnMessage</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter punctuation" style="color:#393A34">{</span><span class="token parameter"> data</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"> error </span><span class="token parameter punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">return</span><span class="token plain"> data </span><span class="token operator" style="color:#393A34">?</span><span class="token plain"> </span><span class="token known-class-name class-name">JSON</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">stringify</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">data</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> error</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">toString</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h1>ROP trong một số ngôn ngữ khác</h1>
<h4 class="anchor anchorWithStickyNavbar_FlIw" id="ruby-framework-rails">Ruby (framework Rails)<a href="#ruby-framework-rails" class="hash-link" aria-label="Direct link to Ruby (framework Rails)" title="Direct link to Ruby (framework Rails)">​</a></h4>
<p>Nếu các bạn sử dụng Rails, hãy thử trải nghiệm qua gem <code>trailblazer</code>. Logic của ứng dụng giờ sẽ tập trung chủ yếu trong các <code>Operation</code> thay vì controller như xưa nữa, mà những operation này được viết theo style ROP.</p>
<p><img decoding="async" loading="lazy" src="https://images.viblo.asia/f425b9c2-0d14-460b-8540-f289e8859972.gif" alt="" class="img_XBWr"></p>
<div class="language-ruby codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-ruby codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token plain">class Song::Create &lt; Trailblazer::Operation</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  step    Model(Song, :new) # init model</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  step    :assign_current_user!</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  step    Contract::Build(constant: SongForm) # create form object</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  step    Contract::Validate() # validate form object</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  failure :log_error!</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  step    Contract::Persist() # save song to db</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  def log_error!(options)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    logger.debug &quot;Errors occurred while creating song.&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  def assign_current_user!(options)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    options[&quot;model&quot;].created_by = options[&quot;current_user&quot;]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Flow của Operation không hoàn toàn giống với ROP như ta đã thấy ở trên, một khi bạn đã vào nhánh Failure, nó sẽ trigger toàn bộ những step handle error phía sau.</p>
<p>Không liên quan lắm nhưng trong <code>trailblazer</code> ecosystem có khá nhiều gem thú vị như: <code>reform</code> (form object pattern), và <code>cells</code> (view components).</p>
<h4 class="anchor anchorWithStickyNavbar_FlIw" id="javascript">Javascript<a href="#javascript" class="hash-link" aria-label="Direct link to Javascript" title="Direct link to Javascript">​</a></h4>
<p>Nếu ta để ý, <code>Promise</code> của Javascript cũng khá giống với ROP.</p>
<div class="language-js codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-js codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> user </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token literal-property property" style="color:#36acaa">username</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;sample&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token literal-property property" style="color:#36acaa">email</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;sample&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token function-variable function" style="color:#d73a49">validatePresenceOfUsername</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">data</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">!</span><span class="token operator" style="color:#393A34">!</span><span class="token plain">data</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">username</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword control-flow" style="color:#00009f">return</span><span class="token plain"> user</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">throw</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Username is blank&quot;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token function-variable function" style="color:#d73a49">validateFormatOfEmail</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">data</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">data</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">email</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> data</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">email</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">match</span><span class="token punctuation" style="color:#393A34">(</span><span class="token regex regex-delimiter" style="color:#36acaa">/</span><span class="token regex regex-source language-regex" style="color:#36acaa">@</span><span class="token regex regex-delimiter" style="color:#36acaa">/</span><span class="token regex regex-flags" style="color:#36acaa">g</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword control-flow" style="color:#00009f">return</span><span class="token plain"> user</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">throw</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Email is in invalid format&quot;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token function-variable function" style="color:#d73a49">logError</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">error</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token console class-name">console</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">error</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">error</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token known-class-name class-name">Promise</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">resolve</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">user</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">then</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">validatePresenceOfUsername</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">then</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">validateFormatOfEmail</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword control-flow" style="color:#00009f">catch</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">logError</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// =&gt; &#x27;Email is in invalid format</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h1>Tham khảo</h1>
<p><a href="https://fsharpforfunandprofit.com/rop/" target="_blank" rel="noopener noreferrer">https://fsharpforfunandprofit.com/rop/</a></p>
<p><a href="https://fsharpforfunandprofit.com/posts/function-composition/" target="_blank" rel="noopener noreferrer">https://fsharpforfunandprofit.com/posts/function-composition/</a></p>
<p><a href="https://dorp.io/posts/railway-oriented-programming/" target="_blank" rel="noopener noreferrer">https://dorp.io/posts/railway-oriented-programming/</a></p>
<p><a href="https://github.com/trailblazer/trailblazer" target="_blank" rel="noopener noreferrer">https://github.com/trailblazer/trailblazer</a></p>
<p><a href="http://trailblazer.to/gems/operation/2.0/api.html" target="_blank" rel="noopener noreferrer">http://trailblazer.to/gems/operation/2.0/api.html</a></p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_qmVs padding--none margin-left--sm"><li class="tag_aHj4"><a class="tag_rlZX tagRegular_E7nr" href="/blog/tags/ruby">ruby</a></li><li class="tag_aHj4"><a class="tag_rlZX tagRegular_E7nr" href="/blog/tags/javascript">javascript</a></li><li class="tag_aHj4"><a class="tag_rlZX tagRegular_E7nr" href="/blog/tags/functional-programing">functional-programing</a></li><li class="tag_aHj4"><a class="tag_rlZX tagRegular_E7nr" href="/blog/tags/railway-oriented-programming">railway-oriented-programming</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="https://schema.org/BlogPosting"><meta itemprop="description" content="Ngày nay, công nghệ ngày càng phát triển, và thế giới Web cũng vậy. Đa số web hiện đại đều đã nói lời tạm biệt với những dòng Ruby, PHP, hay Java được nhúng trong HTML/JS. Phần giao diện người dùng được chính browser phía client xử lý, thay vì server ôm hết như xưa. Các thư viện/framework như React, Angular, Vue, ... đều đã trở nên quá quen thuộc."><header><h2 class="title_DEF8" itemprop="headline"><a itemprop="url" href="/blog/mot-vai-mindset-khi-lam-viec-voi-react">Một vài mindset khi làm việc với React</a></h2><div class="container_Y0Yj margin-vert--md"><time datetime="2019-02-16T00:00:00.000Z" itemprop="datePublished">February 16, 2019</time> · <!-- -->11 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_fNYc"><div class="avatar margin-bottom--sm"><a href="https://github.com/moonlight8978" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://avatars.githubusercontent.com/u/26299310?v=4" alt="Lê Sĩ Bích" itemprop="image"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/moonlight8978" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Lê Sĩ Bích</span></a></div><small class="avatar__subtitle" itemprop="description">Ruby on Rails/React Developer</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>Ngày nay, công nghệ ngày càng phát triển, và thế giới Web cũng vậy. Đa số web hiện đại đều đã nói lời tạm biệt với những dòng Ruby, PHP, hay Java được nhúng trong HTML/JS. Phần giao diện người dùng được chính browser phía client xử lý, thay vì server ôm hết như xưa. Các thư viện/framework như React, Angular, Vue, ... đều đã trở nên quá quen thuộc.</p>
<p>Nếu bạn có ý định học hay đã chuyển sang React thì mong bài viết có thể giúp các bạn có những mindset tốt hơn khi làm việc với nó.</p>
<p>Đây đều là những thứ mình cho rằng cần quan tâm sau 1 thời gian làm việc với React.</p>
<p>Bài viết này không nói về việc hướng dẫn code React.</p>
<h1>Component</h1>
<h3 class="anchor anchorWithStickyNavbar_FlIw" id="react-is-all-about-components">React is all about components<a href="#react-is-all-about-components" class="hash-link" aria-label="Direct link to React is all about components" title="Direct link to React is all about components">​</a></h3>
<p>React được design theo hướng Component, mỗi phần tử nhỏ nhất như thẻ <code>&lt;span&gt;</code>, hay <code>&lt;button&gt;</code> đều có thể wrap thành một component để tái sử dụng 1 cách tối đa.</p>
<div class="language-jsx codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-jsx codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// path/to/button.jsx</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword module" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function maybe-class-name" style="color:#d73a49">Button</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter punctuation" style="color:#393A34">{</span><span class="token parameter"> children</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"> type</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"> onClick </span><span class="token parameter punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">button</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">type</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">button</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">className</span><span class="token tag script language-javascript script-punctuation punctuation" style="color:#393A34">=</span><span class="token tag script language-javascript punctuation" style="color:#393A34">{</span><span class="token tag script language-javascript template-string template-punctuation string" style="color:#e3116c">`</span><span class="token tag script language-javascript template-string string" style="color:#e3116c">btn btn-</span><span class="token tag script language-javascript template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">${</span><span class="token tag script language-javascript template-string interpolation" style="color:#00009f">type</span><span class="token tag script language-javascript template-string interpolation interpolation-punctuation punctuation" style="color:#393A34">}</span><span class="token tag script language-javascript template-string template-punctuation string" style="color:#e3116c">`</span><span class="token tag script language-javascript punctuation" style="color:#393A34">}</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">onClick</span><span class="token tag script language-javascript script-punctuation punctuation" style="color:#393A34">=</span><span class="token tag script language-javascript punctuation" style="color:#393A34">{</span><span class="token tag script language-javascript" style="color:#00009f">onClick</span><span class="token tag script language-javascript punctuation" style="color:#393A34">}</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain-text"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain-text">      </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">children</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain-text"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain-text">    </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">button</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Và ở đâu cần component này, ta sẽ import nó vào để sử dụng.</p>
<div class="language-jsx codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-jsx codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token keyword module" style="color:#00009f">import</span><span class="token plain"> </span><span class="token imports punctuation" style="color:#393A34">{</span><span class="token imports"> </span><span class="token imports maybe-class-name">Button</span><span class="token imports"> </span><span class="token imports punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword module" style="color:#00009f">from</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;./path/to/button&quot;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function maybe-class-name" style="color:#d73a49">Screen</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag class-name" style="color:#00009f">Button</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">type</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">primary</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">onClick</span><span class="token tag script language-javascript script-punctuation punctuation" style="color:#393A34">=</span><span class="token tag script language-javascript punctuation" style="color:#393A34">{</span><span class="token tag script language-javascript punctuation" style="color:#393A34">(</span><span class="token tag script language-javascript punctuation" style="color:#393A34">)</span><span class="token tag script language-javascript" style="color:#00009f"> </span><span class="token tag script language-javascript arrow operator" style="color:#393A34">=&gt;</span><span class="token tag script language-javascript" style="color:#00009f"> </span><span class="token tag script language-javascript console class-name" style="color:#00009f">console</span><span class="token tag script language-javascript punctuation" style="color:#393A34">.</span><span class="token tag script language-javascript method function property-access" style="color:#d73a49">log</span><span class="token tag script language-javascript punctuation" style="color:#393A34">(</span><span class="token tag script language-javascript string" style="color:#e3116c">&quot;Clicked&quot;</span><span class="token tag script language-javascript punctuation" style="color:#393A34">)</span><span class="token tag script language-javascript punctuation" style="color:#393A34">}</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain-text"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain-text">      Click me</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain-text">    </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag class-name" style="color:#00009f">Button</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Với những ngôn ngữ server side truyền thống, ta sẽ viết như sau (slim ruby):</p>
<div class="language-slim codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-slim codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token plain">/ path/to/a.slim</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">button.btn.btn-primary</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  | Button A</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-slim codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-slim codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token plain">/ path/to/b.slim</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">button.btn.btn-primary</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  | Button B</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Có thể thấy là code của ta trông sáng sủa hơn rất nhiều.</p>
<p>Trên thực tế, ta cũng nên viết những component nhỏ nhất có thể như vậy, nó sẽ giúp giao diện app ta đồng bộ, và debug cũng trở nên dễ hơn.</p>
<p>Hay thử với một component phức tạp hơn hơn xíu:</p>
<div class="language-jsx codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-jsx codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function maybe-class-name" style="color:#d73a49">List</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter punctuation" style="color:#393A34">{</span><span class="token parameter"> items</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"> renderItem</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"> emptyText </span><span class="token parameter punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">items</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">length</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">===</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword control-flow" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">div</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain-text"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain-text">        </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">span</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">emptyText</span><span class="token punctuation" style="color:#393A34">}</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">span</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain-text"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain-text">      </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">div</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">return</span><span class="token plain"> </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">div</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">items</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">map</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">item</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">renderItem</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">item</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">}</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">div</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_FlIw" id="cấu-trúc-thư-mục">Cấu trúc thư mục<a href="#cấu-trúc-thư-mục" class="hash-link" aria-label="Direct link to Cấu trúc thư mục" title="Direct link to Cấu trúc thư mục">​</a></h3>
<p>Đối với những dự án lớn, có một cấu trúc thư mục rõ ràng sẽ khiến việc code trở nên dễ chịu hơn nhiều.</p>
<p>Lại quay lại các ngôn ngữ server side MVC cũ - Rails. Đây là một cấu trúc khó mà có thể thay đổi trong tất cả các dự án:</p>
<p><img decoding="async" loading="lazy" src="https://images.viblo.asia/70c519f5-7322-4384-a76f-caae42495028.png" alt="" class="img_XBWr"></p>
<p>Dù với sự hỗ trợ của các Editor/IDE hiện đại trong việc tìm kiếm, mở file, thì cũng khá mất thời gian để có thể tìm được những file liên quan.</p>
<p>Với React thì flexible hơn, bạn có thể tổ chức theo kiểu trên (VD cho 1 project dùng Redux)</p>
<p><img decoding="async" loading="lazy" src="https://images.viblo.asia/a6cd4317-a0e0-4990-bdbe-5eea297d9ced.png" alt="" class="img_XBWr"></p>
<p>Nhưng với mình thì mình thích cách tổ chức theo component/màn hình hơn.</p>
<p><img decoding="async" loading="lazy" src="https://images.viblo.asia/f70e763d-8744-497a-9a0c-6abcfc380195.png" alt="" class="img_XBWr"></p>
<p>Mình học được cấu trúc trên từ một dự án trong list awesome react native - <a href="https://github.com/gitpoint/git-point" target="_blank" rel="noopener noreferrer">Gitpoint</a>, dù nó được viết bằng React Native nhưng bản chất vẫn là React nên không có vấn đề gì hết.</p>
<p>Tuy nhiên cấu trúc này gặp 1 nhược điểm ở chỗ nếu 2 màn hình mà share nhau chung 1 state (redux) thì sẽ gây bối rối, hoặc là lặp code. Với mình, mình chọn giải pháp tạo 1 thư mục shared, rồi cũng tổ chức file giống cấu trúc của thư mục <code>screens</code>. Còn không thì chấp nhận việc code bị lặp 1 chút.</p>
<h1>Functional Programming (FP)</h1>
<p>Nếu như Ruby, Java là các ngôn ngữ lập trình hướng đối tượng (OOP) thì Javascript lại mang phong cách lập trình hàm, mặc dù vẫn có class, object nếu bạn muốn dùng (Prototype)</p>
<p>Với OOP, ta thường xuyên thay đổi trạng thái (các biến instance) của object, nhưng FP lại không thích điều này, mà thường hướng tới tính bất biến (Immutability) và pure function. Ta hãy cũng tìm hiểu thêm về chúng</p>
<h3 class="anchor anchorWithStickyNavbar_FlIw" id="pure-functions">Pure Functions<a href="#pure-functions" class="hash-link" aria-label="Direct link to Pure Functions" title="Direct link to Pure Functions">​</a></h3>
<p>Lấy ví dụ với việc cộng 2 số tự nhiên</p>
<div class="language-js codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-js codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> z </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">10</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token function-variable function" style="color:#d73a49">add</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">x</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"> y</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#393A34">=&gt;</span><span class="token plain"> x </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> y</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">add</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 3</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">add</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 4</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Hàm <code>add</code> nhận 2 tham số <code>x</code> và <code>y</code>, nó chỉ sử dụng 2 tham số đầu vào này để thực hiện phép tính, mà không sử dụng/làm thay đổi các biến ngoài phạm vi hàm.</p>
<p>Hơn nữa nó luôn trả về cùng 1 giá trị nếu như tham số đầu vào không thay đổi.</p>
<p>Còn xem hàm dưới đây</p>
<div class="language-js codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-js codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> bonus </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token function-variable function" style="color:#d73a49">add</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">x</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"> y</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#393A34">=&gt;</span><span class="token plain"> x </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> y </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> bonus</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">add</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 3</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">add</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 3</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Dù luôn trả về một giá trị với cùng tham số, tuy nhiên hàm lại phụ thuộc vào biến <code>bonus</code> (external variable) nên đây được xem là 1 impure function.</p>
<p>Ngoài ra impure function cũng gây ra các side effects như các hàm sau:</p>
<ul>
<li>Gọi HTTP request</li>
<li>Ghi dữ liệu</li>
<li><code>Math.random()</code>, <code>new Date()</code></li>
<li>....</li>
</ul>
<p>Giá trị trả về của chúng không phải lúc nào cũng giống nhau, điều đó khiến kết quả của hàm khó mà lường trước được, khi test ta thường phải mock 1 giá trị cố định.</p>
<p>Pure function sẽ giúp app chúng ta ít lỗi hơn, ngoài ra cũng dễ dàng test hơn.</p>
<p>Trong React, nói đến pure function ta thường nghĩ đến stateless component - Functional Component, nó sẽ chỉ sử dụng props để tính toán và render dựa trên những props đó. Tuy nhiên những update gần đây đã thêm <a href="https://reactjs.org/docs/hooks-intro.html" target="_blank" rel="noopener noreferrer">Hook</a>, nó làm cho Functional Component cũng có thể có state. Cá nhân mình không thích cái Hook này lắm.</p>
<p>Nhưng app của ta không chỉ toàn pure function được, sẽ phải có những hàm gọi API, thay đổi state, lấy state để tính toán, lưu dữ liệu vào localStorage, ... nhưng hãy cố gắng giảm thiểu số lượng side effects xuống thấp nhất có thể.</p>
<h3 class="anchor anchorWithStickyNavbar_FlIw" id="immutability">Immutability<a href="#immutability" class="hash-link" aria-label="Direct link to Immutability" title="Direct link to Immutability">​</a></h3>
<p>Một điều quan trọng nữa là tính bất biến.</p>
<p>Functional programming nói chung và React nói riêng, ta thường tránh việc sửa trực tiếp 1 biến nào đó, hay state. Thay vào đó, ta sẽ tạo 1 biến mới.</p>
<div class="language-js codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-js codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> person </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">age</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">12</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">person</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">name</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Name&quot;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> array </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">array</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">push</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">4</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Nếu trong dự án của bạn có những dòng code như trên, thì code bạn đã mất tính bất biến.
Thay vì trực tiếp chỉnh sửa 1 biến như vậy. Ta nên tạo 1 biến mới với những giá trị cũ, sau đó thêm giá trị mới vào.</p>
<div class="language-js codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-js codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> updatedPerson </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">age</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> person</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">age</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Name&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// hay</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> updatedPerson </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token spread operator" style="color:#393A34">...</span><span class="token plain">person</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Name&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Dễ dàng nhận thấy <code>updatedPerson.age</code> vẫn tham chiếu đến giá trị cũ của <code>person.name</code>, tuy nhiên ta sử dụng biến <code>updatedPerson</code> này thế nào đi nữa, thì cũng sẽ không ảnh hưởng đến giá trị của <code>person</code></p>
<p>Nhưng tại sao lại phải làm vậy? Thử xét 1 vòng lặp đơn giản như:</p>
<div class="language-js codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-js codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> s </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> index </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword control-flow" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">index </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> index </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> data</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">length</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> index</span><span class="token operator" style="color:#393A34">++</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  s </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> data</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">index</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Giả sử đang trong quá trình lặp, thi <code>data[n]</code> bị thay đổi, chẳng phải <code>s += data[index]</code> sẽ sai luôn hay sao.</p>
<p>Còn trong React, ta có <code>React.PureComponent</code> nó sẽ shallow compare props và state để quyết định xem có update component hay không.</p>
<div class="language-jsx codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-jsx codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token keyword module" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">SampleComponent</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">extends</span><span class="token plain"> </span><span class="token class-name">React</span><span class="token class-name punctuation" style="color:#393A34">.</span><span class="token class-name">PureComponent</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  state </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">filter</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token literal-property property" style="color:#36acaa">name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;A name&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token literal-property property" style="color:#36acaa">age</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">21</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">//  shouldComponentUpdate(nextProps, nextState) {</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">//	  return shallowCompare(this, nextProps, nextState)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// 	}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function-variable function" style="color:#d73a49">handleClick</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">state</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">filter</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">name</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;New name&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">render</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword control-flow" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">div</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain-text"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain-text">        </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">h3</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">{</span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">state</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">filter</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">name</span><span class="token punctuation" style="color:#393A34">}</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">h3</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain-text"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain-text">        </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">button</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">onClick</span><span class="token tag script language-javascript script-punctuation punctuation" style="color:#393A34">=</span><span class="token tag script language-javascript punctuation" style="color:#393A34">{</span><span class="token tag script language-javascript keyword" style="color:#00009f">this</span><span class="token tag script language-javascript punctuation" style="color:#393A34">.</span><span class="token tag script language-javascript property-access" style="color:#00009f">handleClick</span><span class="token tag script language-javascript punctuation" style="color:#393A34">}</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain-text">Click me</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">button</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain-text"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain-text">      </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">div</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><code>React.PureComponent</code> đã định nghĩa sẵn cho ta phương thức <code>shouldComponentUpdate</code> như phần mình comment.</p>
<p>Hàm <code>shallowCompare</code> chỉ đơn thuần lặp tất cả các key có trong props và state, so sánh với state/props cũ.</p>
<p>Nó sẽ thực hiện việc so sánh <code>currentState.filter === nextState.filter</code> (so sánh bằng tham chiếu).</p>
<p>Việc này có lợi hơn rất nhiều so với việc deep compare tất cả các giá trị trong filter (cả về thời gian lẫn độ phức tạp).</p>
<p>Tuy nhiên, khi chúng ta trực tiếp chỉnh sửa <code>this.state.filter.name = &#x27;New name&#x27;</code>, sẽ khiến filter không hề thay đổi về tham chiếu. Khi đó:</p>
<div class="language-js codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-js codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token plain">currentState</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">filter</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">===</span><span class="token plain"> nextState</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">filter</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">currentState</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">filter</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">name</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">===</span><span class="token plain"> nextState</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">filter</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">name</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// false</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>và <code>SampleComponent</code> của ta cũng sẽ không re-render, cho dù bạn có click đến sang năm.</p>
<p><img decoding="async" loading="lazy" src="https://images.viblo.asia/ecee315c-f2a5-4eb6-a290-af2c100a8724.png" alt="" class="img_XBWr"></p>
<p>Thay vào đó ta sẽ làm như sau</p>
<div class="language-js codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-js codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token function-variable function" style="color:#d73a49">handleClick</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">setState</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token literal-property property" style="color:#36acaa">filter</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token spread operator" style="color:#393A34">...</span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">state</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">filter</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token literal-property property" style="color:#36acaa">name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;New name&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Ta copy toàn bộ tham chiếu các attribute của <code>state.filter</code> cũ sang 1 object mới, và sau đó thay đổi biến <code>name</code> của object mới này, ta không hề làm thay đổi <code>state.filter</code> cũ.</p>
<p>Khi đó <code>currentState.filter === nextState.filter</code> sẽ trả về <code>false</code>. <code>SampleComponent</code> của ta được re-render lại. Và nếu có action nào không làm thay đổi <code>state</code>, component của ta cũng sẽ không re-render. Vậy là cả React và ta đều happy - <em>một người khỏe, 2 người vui :v</em></p>
<h3 class="anchor anchorWithStickyNavbar_FlIw" id="higher-order-functions-hof">Higher-Order Functions (HOF)<a href="#higher-order-functions-hof" class="hash-link" aria-label="Direct link to Higher-Order Functions (HOF)" title="Direct link to Higher-Order Functions (HOF)">​</a></h3>
<blockquote>
<p>HOF nhận tham số là hàm, hoặc trả về một hàm khác, hoặc là cả 2.</p>
</blockquote>
<p>VD 1 hàm nhận tham số hàm:</p>
<div class="language-js codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-js codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> name </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;React&quot;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> phoneNumber </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;0969696969&quot;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token function-variable function" style="color:#d73a49">numberValidator</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">str</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#393A34">=&gt;</span><span class="token plain"> str</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">match</span><span class="token punctuation" style="color:#393A34">(</span><span class="token regex regex-delimiter" style="color:#36acaa">/</span><span class="token regex regex-source language-regex char-set class-name" style="color:#36acaa">\d</span><span class="token regex regex-source language-regex quantifier number" style="color:#36acaa">+</span><span class="token regex regex-delimiter" style="color:#36acaa">/</span><span class="token regex regex-flags" style="color:#36acaa">g</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token function-variable function" style="color:#d73a49">validate</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">value</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"> validator</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!</span><span class="token operator" style="color:#393A34">!</span><span class="token function" style="color:#d73a49">validator</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">value</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">validate</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">name</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> numberValidator</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">validate</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">phoneNumber</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> numberValidator</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// false</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Hay 1 hàm trả về 1 hàm:</p>
<div class="language-js codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-js codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">makeAdder</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">constantValue</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">return</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">adder</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">value</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword control-flow" style="color:#00009f">return</span><span class="token plain"> constantValue </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> value</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>ta gọi hàm này như sau: <code>makeAdder(10)(20)</code></p>
<p>Thoạt nhìn có vẻ sợ, nhưng nếu viết minh bạch ra</p>
<div class="language-js codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-js codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> add10 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">makeAdder</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">10</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">add10</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">20</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 30</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Mọi thứ trở nên rõ ràng hơn nhiều, <code>makerAdder(10)</code> trả về một hàm, sau đó ta gọi hàm này với tham số là 20</p>
<div class="language-js codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-js codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> add10 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">makeAdder</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">10</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// add10 = function adder(value) {</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">//	 return 10 + value</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// }</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">add10</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">20</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Trong React, ta cũng thường xuyên áp dụng kỹ thuật này, tuy nhiên ngoài HOF, thì ta còn có Higher-Order Component (HOC), nhằm chỉ những hàm nhận vào tham số là 1 Component và trả về 1 Component khác.</p>
<p>VD:</p>
<div class="language-jsx codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-jsx codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">protectRoute</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter maybe-class-name">Component</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"> requiredRole</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">return</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function maybe-class-name" style="color:#d73a49">ProtectedRoute</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">props</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> currentRole </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token dom variable" style="color:#36acaa">localStorage</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">getItem</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;role&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">currentRole </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> requiredRole</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword control-flow" style="color:#00009f">return</span><span class="token plain"> </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag class-name" style="color:#00009f">Redirect</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">to</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">/sign_in</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"> </span><span class="token tag punctuation" style="color:#393A34">/&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword control-flow" style="color:#00009f">return</span><span class="token plain"> </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag class-name" style="color:#00009f">Component</span><span class="token tag" style="color:#00009f"> </span><span class="token tag spread punctuation" style="color:#393A34">{</span><span class="token tag spread operator" style="color:#393A34">...</span><span class="token tag spread" style="color:#00009f">props</span><span class="token tag spread punctuation" style="color:#393A34">}</span><span class="token tag" style="color:#00009f"> </span><span class="token tag punctuation" style="color:#393A34">/&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_FlIw" id="declarative-programming">Declarative Programming<a href="#declarative-programming" class="hash-link" aria-label="Direct link to Declarative Programming" title="Direct link to Declarative Programming">​</a></h3>
<p>Ta có 2 thiên hướng lập trình đối lập nhau, đó là:</p>
<ul>
<li>Imperative Programming: mô tả control flow của việc cần làm</li>
<li>Declarative Programming: chỉ viết ra những gì cần làm mà không mô tả rõ control flow của từng bước.</li>
</ul>
<p>VD tiêu biểu đó là 1 vòng lặp cơ bản:</p>
<p>Style Imperative:</p>
<div class="language-js codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-js codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> arr </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> newArr </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword control-flow" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> arr</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">length</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  newArr</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">push</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">arr</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token console class-name">console</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">log</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">newArr</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// [2, 3]</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Với style này, bạn nêu lần lượt từng bước code bạn thực hiện như thế nào, ta phải đi sâu vào implementation hơn.</p>
<p>Trong khi đó với Declarative:</p>
<div class="language-js codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-js codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> arr </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> newArr </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> arr</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">map</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">element</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#393A34">=&gt;</span><span class="token plain"> element </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// [2, 3]</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Ta sẽ chỉ nói rằng ta cần 1 mảng mới từ arr, mà mỗi phần tử của nó tăng lên 1. Code của ta vừa dễ hiểu và vừa đẹp hơn.</p>
<p>Một số ngôn ngữ tiêu biểu:</p>
<ul>
<li>Imperative: C/C++, Java, ...</li>
<li>Declarative: SQL, HTML, ...</li>
<li>Tạp phế lù: Javascript =)), ...</li>
</ul>
<p>Ở trên là những gì mình search được trên google khi bắt đầu tìm hiểu về Declarative Programming. Tuy nhiên, vẫn khá là khó hiểu, và khó phân biệt giữa 2 thằng Imperative và Declarative</p>
<p>Tuy nhiên khi đọc được comment <a href="https://stackoverflow.com/questions/1784664/what-is-the-difference-between-declarative-and-imperative-programming#comment29365241_1784702" target="_blank" rel="noopener noreferrer">này</a>, mọi thứ đã trở nên sáng sủa hơn nhiều. Mình coi nó là 1 lớp abstract, mà khi gọi hàm đó, ta chỉ cần quan tâm đến <em>what to do</em> mà không phải nghĩ xem <em>how to do</em>.</p>
<p>Hãy sử dụng các hàm có sẵn của javascript như: <code>.map</code>, <code>.reduce</code>, <code>.filter</code>, ... và bạn sẽ nhận thấy được vẻ đẹp của Declarative Programming.</p>
<p>Quay trở lại với React, vậy thì tính Declarative của nó ở đâu?</p>
<p>Chính bản thân các component React đã rất &#x27;declarative&#x27; rồi.</p>
<p>Hãy đọc phần description của React trên <a href="https://github.com/facebook/react" target="_blank" rel="noopener noreferrer">Github</a></p>
<blockquote>
<p>A declarative, efficient, and flexible JavaScript library for building user interfaces.</p>
</blockquote>
<p>Thử so sánh 2 đoạn mã sau:</p>
<div class="language-js codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-js codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// jQuery</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">$</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;.like&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">click</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> $btn </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">$</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">$btn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">hasClass</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;liked&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    $btn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">removeClass</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;liked&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#00009f">else</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    $btn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">addClass</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;liked&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-jsx codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-jsx codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// React</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">LikeButton</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">extends</span><span class="token plain"> </span><span class="token class-name">React</span><span class="token class-name punctuation" style="color:#393A34">.</span><span class="token class-name">Component</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// ...codes</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">render</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">state</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">liked</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword control-flow" style="color:#00009f">return</span><span class="token plain"> </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag class-name" style="color:#00009f">HighlightButton</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain-text">Like</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag class-name" style="color:#00009f">HighlightButton</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword control-flow" style="color:#00009f">return</span><span class="token plain"> </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag class-name" style="color:#00009f">Button</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain-text">Like</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag class-name" style="color:#00009f">Button</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Với jQuery, ta phải mô tả chính xác code ta cần làm gì.</p>
<p>Trong khi đó với React: <em>Tiểu nhị, like rồi thì cho cái <code>HightlightButton</code> ra đây, không thì <code>Button</code> thường thôi.</em></p>
<p>Ta sẽ quan tâm đến việc component cần hiển thị cái gì tương ứng với mỗi (props/state) của nó.</p>
<h1>Link tham khảo</h1>
<p><a href="https://github.com/facebook/react" target="_blank" rel="noopener noreferrer">https://github.com/facebook/react</a></p>
<p><a href="https://github.com/jondot/awesome-react-native" target="_blank" rel="noopener noreferrer">https://github.com/jondot/awesome-react-native</a></p>
<p><a href="https://github.com/gitpoint/git-point" target="_blank" rel="noopener noreferrer">https://github.com/gitpoint/git-point</a></p>
<p><a href="https://medium.freecodecamp.org/all-the-fundamental-react-js-concepts-jammed-into-this-single-medium-article-c83f9b53eac2?gi=7fb0830efbd4" target="_blank" rel="noopener noreferrer">https://medium.freecodecamp.org/all-the-fundamental-react-js-concepts-jammed-into-this-single-medium-article-c83f9b53eac2?gi=7fb0830efbd4</a></p>
<p><a href="https://medium.com/@cscalfani/so-you-want-to-be-a-functional-programmer-part-1-1f15e387e536" target="_blank" rel="noopener noreferrer">https://medium.com/@cscalfani/so-you-want-to-be-a-functional-programmer-part-1-1f15e387e536</a></p>
<p><a href="https://www.miles.no/blogg/tema/teknisk/why-care-about-functional-programming-part-1-immutability" target="_blank" rel="noopener noreferrer">https://www.miles.no/blogg/tema/teknisk/why-care-about-functional-programming-part-1-immutability</a></p>
<p><a href="https://blog.logrocket.com/immutability-in-react-ebe55253a1cc" target="_blank" rel="noopener noreferrer">https://blog.logrocket.com/immutability-in-react-ebe55253a1cc</a></p>
<p><a href="https://stackoverflow.com/questions/1784664/what-is-the-difference-between-declarative-and-imperative-programming#comment29365241_1784702" target="_blank" rel="noopener noreferrer">https://stackoverflow.com/questions/1784664/what-is-the-difference-between-declarative-and-imperative-programming#comment29365241_1784702</a></p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_qmVs padding--none margin-left--sm"><li class="tag_aHj4"><a class="tag_rlZX tagRegular_E7nr" href="/blog/tags/reactjs">reactjs</a></li><li class="tag_aHj4"><a class="tag_rlZX tagRegular_E7nr" href="/blog/tags/web">web</a></li><li class="tag_aHj4"><a class="tag_rlZX tagRegular_E7nr" href="/blog/tags/javascript">javascript</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="https://schema.org/BlogPosting"><meta itemprop="description" content="Ở kì trước, ta đã cùng nhau tìm hiểu về Pixel của CSS, đó là 1 đơn vị độc lập, không bị phụ thuộc vào độ phân giải hay các thông số khác của màn hình. Đối với một loại màn hình (xét theo khoảng cách từ mắt tới màn hình), nó luôn là 1 hằng số không đổi. Điều đó đã giúp cho lập trình viên Web dễ thở hơn rất nhiều."><header><h2 class="title_DEF8" itemprop="headline"><a itemprop="url" href="/blog/cung-tim-hieu-ve-nguyen-tu-cua-the-gioi-front-end-phan-2-density-independent-pixel">Cùng tìm hiểu về nguyên tử của thế giới FrontEnd (Phần 2 - Density-independent Pixel)</a></h2><div class="container_Y0Yj margin-vert--md"><time datetime="2018-11-25T00:00:00.000Z" itemprop="datePublished">November 25, 2018</time> · <!-- -->9 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_fNYc"><div class="avatar margin-bottom--sm"><a href="https://github.com/moonlight8978" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://avatars.githubusercontent.com/u/26299310?v=4" alt="Lê Sĩ Bích" itemprop="image"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/moonlight8978" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Lê Sĩ Bích</span></a></div><small class="avatar__subtitle" itemprop="description">Ruby on Rails/React Developer</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p><a href="https://viblo.asia/p/cung-tim-hieu-ve-nguyen-tu-cua-the-gioi-front-end-phan-1-pixel-4P856PoOZY3" target="_blank" rel="noopener noreferrer">Ở kì trước</a>, ta đã cùng nhau tìm hiểu về Pixel của CSS, đó là 1 đơn vị độc lập, không bị phụ thuộc vào độ phân giải hay các thông số khác của màn hình. Đối với một loại màn hình (xét theo khoảng cách từ mắt tới màn hình), nó luôn là 1 hằng số không đổi. Điều đó đã giúp cho lập trình viên Web dễ thở hơn rất nhiều.</p>
<p>Ở Android cũng có một đơn vị giống như vậy, Google đặt tên cho nó là DP (hay DIP - Density Independent Pixel). Ngoài ra đơn vị này còn dùng trong React Native <a href="https://facebook.github.io/react-native/docs/height-and-width.html#fixed-dimensions" target="_blank" rel="noopener noreferrer">[link]</a></p>
<h1>2. Một số khái niệm cần nhắc lại</h1>
<h4 class="anchor anchorWithStickyNavbar_FlIw" id="pixel-thiết-bị">Pixel thiết bị:<a href="#pixel-thiết-bị" class="hash-link" aria-label="Direct link to Pixel thiết bị:" title="Direct link to Pixel thiết b  ị:">​</a></h4>
<p>Là 1 điểm ảnh, nó phụ thuộc vào kích thước màn hình, và độ phân giải màn hình. Thông thường, 1px thiết bị trên các màn hình đều có giá trị khác nhau.</p>
<p>Pixel này là pixel vật lý của thiết bị khác hoàn toàn so với đơn vị px mà ta hay sử dụng trong CSS.</p>
<h4 class="anchor anchorWithStickyNavbar_FlIw" id="độ-phân-giải-thiết-bị---resolution">Độ phân giải thiết bị - Resolution:<a href="#độ-phân-giải-thiết-bị---resolution" class="hash-link" aria-label="Direct link to Độ phân giải thiết bị - Resolution:" title="Direct link to Độ phân giải thiết bị - Resolution:">​</a></h4>
<p>Các bạn thường thấy màn hình có độ phân giải 4k, HD, FullHD, kèm theo nó là 2 con số có dạng P1xP2 phải không nào?</p>
<p>Những con số này thể hiện số pixel có trên màn hình, P1 là số pixel phân bố theo chiều dài, còn P2 là theo chiều rộng.</p>
<p><img decoding="async" loading="lazy" src="https://images.viblo.asia/d4b0da95-f9d9-44ff-92e9-71931821321a.jpg" alt="" class="img_XBWr"></p>
<p>(<em>ảnh chỉ mang tính chất minh họa, mình k phải seeder đâu nhá =))</em>)</p>
<p>TV trên có chiều dài 52.4 inch, có 3840px theo chiều ngang. 1px sẽ có giá trị</p>
<p><code>1px = 52.4 / 3840 = 0.01365 (inch)</code></p>
<h4 class="anchor anchorWithStickyNavbar_FlIw" id="dpi-ppi">DPI, PPI:<a href="#dpi-ppi" class="hash-link" aria-label="Direct link to DPI, PPI:" title="Direct link to DPI, PPI:">​</a></h4>
<p>DPI - <strong>Dots Per Inch</strong>. PPI - <strong>Points Per Inch</strong></p>
<p>Chúng đều là số pixel/điểm ảnh có trên 1 inch độ dài vật lý của thiết bị, biểu thị mật độ pixel trên màn hình.</p>
<p>DPI thấp, 1px có kích thước lớn, hình ảnh có thể sẽ bị răng cưa, không sắc nét bằng DPI cao</p>
<p><img decoding="async" loading="lazy" src="https://images.viblo.asia/1e74f9f2-8d4e-407c-9023-9f4d248598cf.jpg" alt="" class="img_XBWr"></p>
<p>Lấy lại VD màn hình TV trên:</p>
<p><code>DPI = 3840 / 52.4 = 73.28 (pixels/inch)</code></p>
<h1>3. Density Independent Pixels</h1>
<h3 class="anchor anchorWithStickyNavbar_FlIw" id="31-đặt-vấn-đề">3.1 Đặt vấn đề<a href="#31-đặt-vấn-đề" class="hash-link" aria-label="Direct link to 3.1 Đặt vấn đề" title="Direct link to 3.1 Đặt vấn đề">​</a></h3>
<p>Các điện thoại Android có nhiều loại kích thước (phone, tablet, TV, ...), hơn nữa chúng lại còn có độ phân giải khác nhau, dẫn đến kích thước pixel luôn thay đổi, gây khó khăn cho nhà phát triển khi dựng giao diện.</p>
<p>Lấy ví dụ đơn giản nhất về 2 điện thoại có cùng kích thước đường chéo 5inch, nhưng 1 chiếc FullHD 1080x1920, 1 chiếc 4K 2160 x 3840.</p>
<p>Nếu bạn là dev, bạn sẽ muốn 1 button trong app của mình hiển thị trên 2 điện thoại này giống nhau phải không nào?</p>
<p>Thế nhưng nếu làm việc với px thiết bị, ta sẽ gặp 1 chút rắc rối vì với cùng 1 kích thước, điện thoại 4K luôn cần gấp đôi số px so với FullHD.</p>
<p><img decoding="async" loading="lazy" src="https://images.viblo.asia/4b56fc09-40ee-4f95-b7fc-8409b2961e99.jpg" alt="" class="img_XBWr"></p>
<p>2 cái đã mệt, trên thực tế, ta có ty tỷ loại màn hình, vậy thì style sao cho xuể, chưa kể còn đến tối ưu các file ảnh cho app.</p>
<p>Chính vì vậy, <code>dp</code> ra đời.</p>
<h3 class="anchor anchorWithStickyNavbar_FlIw" id="32-dp">3.2. DP<a href="#32-dp" class="hash-link" aria-label="Direct link to 3.2. DP" title="Direct link to 3.2. DP">​</a></h3>
<p>Google định nghĩa nó như sau:</p>
<blockquote>
<p>One dp is a virtual pixel unit that&#x27;s roughly equal to one pixel on a medium-density screen (160dpi; the &quot;baseline&quot; density). Android translates this value to the appropriate number of real pixels for each other density.</p>
</blockquote>
<p>Nếu bạn đã đọc bài trước của mình về CSS pixel, thì có thể thấy nó khá quen thuộc phải không nào, đây cũng là 1 <em>virtual unit</em>.</p>
<p><strong>1dp tương đương 1 px trên màn hình 160dpi</strong>. Có nghĩa là <code>1dp = 1 / 160 = 0.00625 (inch) = 1px (160dpi)</code></p>
<p>Để quy đổi <code>dp</code> sang <code>px</code> trên các loại màn hình khác, ta nhân dp với 1 số, gọi là scale factor (tỉ lệ DPI của màn hình so với chuẩn 160dpi).</p>
<p>Ví dụ máy 320dpi. <code>1dp = 1 * 320 / 160 = 2px</code></p>
<p>Android sẽ tự động convert sang pixel thiết bị cho ta, nên ta chỉ cần dùng <code>dp</code> là trên mọi thiết bị, phần tử của ta sẽ đều có kích thước bằng nhau (ngoại lệ sẽ đề cập sau).</p>
<p>Khi ta dựng UI, nên tận dụng tối đa <code>dp</code>, tránh sử dụng <code>px</code>.</p>
<p>Bên cạnh đó, Google cũng khuyên ta không nên sử dụng <code>dp</code> cho text, mà hãy dùng <code>sp</code>. Đây cũng là một loại density-independent, nhưng nó có thể bị ảnh hưởng bởi tùy chọn của người dùng. Người dùng chọn cỡ chữ to, thì 1sp cũng lớn lên theo. Vì vậy, cũng tránh dùng <code>sp</code> khi thiết kế layout.</p>
<h3 class="anchor anchorWithStickyNavbar_FlIw" id="33-density-bucket">3.3 Density Bucket<a href="#33-density-bucket" class="hash-link" aria-label="Direct link to 3.3 Density Bucket" title="Direct link to 3.3 Density Bucket">​</a></h3>
<p><code>dp</code> ra đời, nhưng cũng chưa giải quyết được hết các vấn đề. Đó chính là về resource hình ảnh. Style cho ảnh thì có thể sử dụng dp được (ảnh sẽ bị kéo to, hoặc co lại cho đủ size cần thiết), nhưng resource thì đâu có thể to nhỏ tùy ý được, thông số của nó luôn là cố định.</p>
<p>Lấy ví dụ về 1 hình ảnh 500x500px (resolution), với 2 màn hình có kích thước bằng nhau, nhưng khác độ phân giải (khác DPI), 1 chiếc là 360x640, 1 chiếc là 720x1280.</p>
<p>Hình ảnh trên nếu hiển thị trên màn hình 360x640 thì chẳng phải sẽ dư thừa sao? Vì chiều rộng màn hình chỉ có 360px. Còn trên màn hình 720x1280, thì nó chả đáng là bao. Vì vậy ta cần sử dụng hình ảnh có độ phân giải thấp hơn cho màn hình 360x640.</p>
<p>Nhưng không lẽ cứ mỗi độ phân giải lại tạo 1 hình ảnh tương ứng? Vậy thì app size của ta sẽ bùng nổ luôn.</p>
<p>Vì lẽ đó mà ra đời <code>density bucket</code>.</p>
<p>Để cho đơn giản, các loại màn hình có DPI gần bằng nhau sẽ được làm tròn rồi gom vào 1 nhóm. Ví dụ như máy 293dpi, Android sẽ coi như máy đó là 320dpi, khi đó 1dp = 2px. Còn nhiều loại khác nữa, nhưng mình chỉ nêu ra 4 bucket đáng chú ý, best practice là support cả 4 bucket này.</p>
<table><thead><tr><th>Bucket name</th><th>Density bucket</th><th>DPI</th><th>Scale Factor</th></tr></thead><tbody><tr><td>Medium</td><td>mdpi</td><td>160</td><td>1.00</td></tr><tr><td>High</td><td>hdpi</td><td>240</td><td>1.50</td></tr><tr><td>Extra High</td><td>xhdpi</td><td>320</td><td>2.00</td></tr><tr><td>Extra Extra High</td><td>xxhdpi</td><td>480</td><td>3.00</td></tr></tbody></table>
<p>Những gì bạn cần làm là ném hết hình ảnh của các bucket vào thư mục tương ứng. Android sẽ tự detect và chọn hình ảnh tối ưu nhất cho bạn (lấy từ DPI cao nhất về).</p>
<p><img decoding="async" loading="lazy" src="https://images.viblo.asia/653192f1-8c27-469d-a007-1ac22681ea23.png" alt="" class="img_XBWr"></p>
<p><img decoding="async" loading="lazy" src="https://images.viblo.asia/d606e411-f5cc-4151-b13e-4b2dfd626097.png" alt="" class="img_XBWr"></p>
<p>Cũng vì việc làm tròn DPI này, mà 1dp của ta trên các thiết bị có thể không bằng nhau, nhưng <strong>luôn xấp xỉ 1/160 = 0.00625 inch</strong></p>
<table><thead><tr><th>Density</th><th>Bucket</th><th>Scale factor</th><th>Physical Size (inch)</th></tr></thead><tbody><tr><td>293dpi</td><td>xhdpi - 320dpi</td><td>2</td><td>1 * 2 / 293 = 0.00686</td></tr><tr><td>320dpi</td><td>xhdpi</td><td>2</td><td>1 * 2 / 320 = 0.00625</td></tr><tr><td>330 dpi</td><td>xhdpi</td><td>2</td><td>1 * 2 / 330 = 0.00606</td></tr></tbody></table>
<p>Điều này cũng đem đến cho ta 1 lợi ích, đó là với các số máy density khác nhau, nhưng cùng độ phân giải, kích thước bề ngang của ta tính bằng dp đều bằng nhau. Lấy ví dụ 3 máy 720x1280, 1 máy 293 dpi, 1 máy 320 dpi, 1 máy 330 dpi.</p>
<table><thead><tr><th>Density</th><th>Width (without Density Bucket)</th><th>Width (with density bucket)</th></tr></thead><tbody><tr><td>293dpi</td><td>720 / (293 / 160) = 393dp</td><td>360dp</td></tr><tr><td>320dpi</td><td>720 / (320 / 160) = 360dp</td><td>360dp</td></tr><tr><td>330dpi</td><td>720 / (330 / 160) = 349dp</td><td>360dp</td></tr></tbody></table>
<h1>4. Ví dụ</h1>
<p>Sau khi nhồi 1 đống lý thuyết vào đầu, ta hãy thử làm 1 bài tập nho nhỏ, để áp dụng chúng. Hãy thử tự tính toán thông số cho điện thoại của mình xem.</p>
<p>Điện thoại mình 5inch, độ phân giải 720x1280.</p>
<p>Ta dễ dàng tính toán được chiều dài và chiều rộng của máy, dựa vào định lý Pytago:</p>
<div class="language-tx codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-tx codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token plain">5**2 = (1280 * x)**2 + (720 * x)**2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">width = 720 * x = 2.4513 (inch)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">height = 1280 * x = 4.3579 (inch)</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Từ đó ta có thể tính tất cả các thông số khác:</p>
<table><thead><tr><th>Thông số</th><th>Giá trị</th></tr></thead><tbody><tr><td>Device density</td><td>720 / 2.4513 = 294 dpi</td></tr><tr><td>Density bucket</td><td>xhdpi - 320dpi</td></tr><tr><td>Scale factor</td><td>320 / 160 = 2.00</td></tr><tr><td>Width</td><td>720 / 2 = 360dp</td></tr><tr><td>Height</td><td>1280 / 2 = 640dp</td></tr><tr><td>DIP</td><td>1dp = 2px = 0.0068 (inch)</td></tr></tbody></table>
<h1>5. Kết luận</h1>
<p>Sự ra đời của <code>dp</code> và <code>density bucket</code> quả thực đã giúp ta tránh được không ít rắc rối trong khi phát triển ứng dụng Android, tối ưu hình ảnh cho app. Bài viết không tránh khỏi sai sót, nếu có sạn, hãy cứ góp ý, mình sẽ tiếp thu và chỉnh sửa cho phù hợp.</p>
<p>Đây có lẽ là bài cuối của mình trong series về những thứ bé nhỏ mà ít ai để ý trong khi thiết kế giao diện Web, mobile. Cám ơn mọi người đã đọc bài! - nếu các bạn đọc đến tận dòng này =))</p>
<h1>6. Link tham khảo</h1>
<ol>
<li><a href="https://developer.android.com/training/multiscreen/screendensities" target="_blank" rel="noopener noreferrer">https://developer.android.com/training/multiscreen/screendensities</a></li>
<li><a href="https://www.highgroundgaming.com/tas/gaming-mouse-guide/low-vs-high-dpi-example/" target="_blank" rel="noopener noreferrer">https://www.highgroundgaming.com/tas/gaming-mouse-guide/low-vs-high-dpi-example/</a></li>
<li><a href="https://facebook.github.io/react-native/docs/height-and-width.html#fixed-dimensions" target="_blank" rel="noopener noreferrer">https://facebook.github.io/react-native/docs/height-and-width.html#fixed-dimensions</a></li>
<li><a href="https://www.avconcepts.com/2015/09/24/4k-ultra-hd-vs-hd-projection/" target="_blank" rel="noopener noreferrer">https://www.avconcepts.com/2015/09/24/4k-ultra-hd-vs-hd-projection/</a></li>
<li><a href="https://www.captechconsulting.com/blogs/understanding-density-independence-in-android" target="_blank" rel="noopener noreferrer">https://www.captechconsulting.com/blogs/understanding-density-independence-in-android</a></li>
<li><a href="https://medium.com/@sashaserg/a-mysterious-density-independent-pixel-a-quick-introduction-to-android-design-111d68be7cf5" target="_blank" rel="noopener noreferrer">https://medium.com/@sashaserg/a-mysterious-density-independent-pixel-a-quick-introduction-to-android-design-111d68be7cf5</a></li>
</ol></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_qmVs padding--none margin-left--sm"><li class="tag_aHj4"><a class="tag_rlZX tagRegular_E7nr" href="/blog/tags/frontend">frontend</a></li><li class="tag_aHj4"><a class="tag_rlZX tagRegular_E7nr" href="/blog/tags/android">android</a></li></ul></div></footer></article><nav class="pagination-nav" aria-label="Blog list page navigation"><a class="pagination-nav__link pagination-nav__link--next" href="/blog/page/2"><div class="pagination-nav__label">Older Entries</div></a></nav></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs/intro">Tutorial</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Overflow<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_sT5S"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://discordapp.com/invite/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_sT5S"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_sT5S"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/facebook/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_sT5S"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2024 My Project, Inc. Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>