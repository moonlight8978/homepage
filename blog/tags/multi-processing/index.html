<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.0">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="My Site Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="My Site Blog Atom Feed"><title data-react-helmet="true">Posts tagged &quot;multi-processing&quot; | My Site</title><meta data-react-helmet="true" property="og:title" content="Posts tagged &quot;multi-processing&quot; | My Site"><meta data-react-helmet="true" name="description" content="Blog | Tagged &quot;multi-processing&quot;"><meta data-react-helmet="true" property="og:description" content="Blog | Tagged &quot;multi-processing&quot;"><meta data-react-helmet="true" property="og:url" content="https://your-docusaurus-test-site.com/blog/tags/multi-processing"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_tag" content="blog_tags_posts"><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://your-docusaurus-test-site.com/blog/tags/multi-processing"><link data-react-helmet="true" rel="alternate" href="https://your-docusaurus-test-site.com/blog/tags/multi-processing" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://your-docusaurus-test-site.com/blog/tags/multi-processing" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.dc5e9681.css">
<link rel="preload" href="/assets/js/runtime~main.753d92b7.js" as="script">
<link rel="preload" href="/assets/js/main.fa35a9da.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#main" class="skipToContent_1oUP">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle" type="button" tabindex="0"><svg aria-label="Menu" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><img src="/img/logo.svg" alt="My Site Logo" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/img/logo.svg" alt="My Site Logo" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><strong class="navbar__title">My Site</strong></a><a class="navbar__item navbar__link" href="/docs/intro">Tutorial</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/blog">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/facebook/docusaurus" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub</a><div class="react-toggle displayOnlyInLargeViewport_GrZ2 react-toggle--disabled" role="button" tabindex="-1"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_71bT">üåú</span></div><div class="react-toggle-track-x"><span class="toggle_71bT">üåû</span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/"><img src="/img/logo.svg" alt="My Site Logo" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/img/logo.svg" alt="My Site Logo" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><strong class="navbar__title">My Site</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/docs/intro">Tutorial</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link navbar__link--active" href="/blog">Blog</a></li><li class="menu__list-item"><a href="https://github.com/facebook/docusaurus" target="_blank" rel="noopener noreferrer" class="menu__link">GitHub</a></li></ul></div></div></div></nav><div class="main-wrapper blog-wrapper blog-tags-post-page"><div class="container margin-vert--lg"><div class="row"><div class="col col--3"><div class="sidebar_2ahu thin-scrollbar"><h3 class="sidebarItemTitle_2hhb">Recent posts</h3><ul class="sidebarItemList_2xAf"><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/blog/cung-tim-hieu-ve-puma-ruby-on-rails">C√πng t√¨m hi·ªÉu v·ªÅ Puma (Ruby on Rails)</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/blog/cuoi-react-native-xem-appium-phan-1-cung-tim-hieu-cach-hoat-dong-cua-appium">C∆∞·ª°i React Native xem Appium (Ph·∫ßn 1 - C√πng t√¨m hi·ªÉu c√°ch ho·∫°t ƒë·ªông c·ªßa Appium)</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/blog/gioi-thieu-ve-kubernetes">Gi·ªõi thi·ªáu v·ªÅ Kubernetes</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/blog/toi-uu-menh-de-where-mysql">T·ªëi ∆∞u m·ªánh ƒë·ªÅ WHERE (MySQL)</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/blog/cung-tim-hieu-ve-actiontext-trong-rails-6">C√πng t√¨m hi·ªÉu v·ªÅ ActionText trong Rails 6</a></li></ul></div></div><main class="col col--7"><h1>One post tagged with &quot;multi-processing&quot;</h1><a href="/blog/tags">View All Tags</a><div class="margin-vert--xl"><article class="margin-bottom--xl"><header><h2 class="margin-bottom--sm blogPostTitle_GeHD"><a href="/blog/cung-tim-hieu-ve-puma-ruby-on-rails">C√πng t√¨m hi·ªÉu v·ªÅ Puma (Ruby on Rails)</a></h2><div class="margin-vert--md"><time datetime="2021-05-31T00:00:00.000Z" class="blogPostDate_fNvV">May 31, 2021 ¬∑ 11 min read</time></div><div class="avatar margin-vert--md"><div class="avatar__intro"><h4 class="avatar__name"><a href="https://github.com/moonlight8978" target="_blank" rel="noopener noreferrer">L√™ Sƒ© B√≠ch</a></h4><small class="avatar__subtitle">Ruby on Rails/React Developer</small></div></div></header><div class="markdown"><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="1-m·ªü-ƒë·∫ßu"></a>1. M·ªü ƒë·∫ßu<a class="hash-link" href="#1-m·ªü-ƒë·∫ßu" title="Direct link to heading">#</a></h2><p>Ch·∫Øc h·∫≥n Puma kh√¥ng ph·∫£i m·ªôt c√°i t√™n xa l·∫° ƒë·ªëi v·ªõi m·ªói Rails developer, m·ªôt ph·∫ßn c≈©ng v√¨ ƒë√¢y l√† appserver m·∫∑c ƒë·ªãnh khi t·∫°o m·ªõi m·ªôt project Rails.</p><p>H√£y c√πng nh√¨n qua nh·ªØng config c∆° b·∫£n khi ch·∫°y 1 ·ª©ng d·ª•ng Rails v·ªõi Puma server. <a href="https://github.com/rails/rails/blob/0f5700ac3589081126fbfde1e4037dc1d4166cce/railties/lib/rails/generators/rails/app/templates/config/puma.rb.tt" target="_blank" rel="noopener noreferrer">link</a></p><div class="codeBlockContainer_K1bP"><div style="color:#bfc7d5;background-color:#292d3e" class="codeBlockTitle_eoMF">config/puma.rb</div><div class="codeBlockContent_hGly ruby"><div tabindex="0" class="prism-code language-ruby codeBlock_23N8 thin-scrollbar codeBlockWithTitle_2JqI"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">max_threads_count = ENV.fetch(&quot;RAILS_MAX_THREADS&quot;) { 5 }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">min_threads_count = ENV.fetch(&quot;RAILS_MIN_THREADS&quot;) { max_threads_count }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">threads min_threads_count, max_threads_count</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">worker_timeout 3600 if ENV.fetch(&quot;RAILS_ENV&quot;, &quot;development&quot;) == &quot;development&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">port ENV.fetch(&quot;PORT&quot;) { 3000 }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">environment ENV.fetch(&quot;RAILS_ENV&quot;) { &quot;development&quot; }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">pidfile ENV.fetch(&quot;PIDFILE&quot;) { &quot;tmp/pids/server.pid&quot; }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">workers ENV.fetch(&quot;WEB_CONCURRENCY&quot;) { 2 }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">preload_app!</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">plugin :tmp_restart</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>ƒê·ªëi v·ªõi nh·ªØng ng∆∞·ªùi m·ªõi b·∫Øt ƒë·∫ßu, khi deploy puma, c√≥ l·∫Ω s·∫Ω t·ª´ ch·ªëi hi·ªÉu ƒë·ªëng config tr√™n v√† set m·ªôt s·ªë bi·∫øn m√¥i tr∆∞·ªùng nh∆∞ sau:</p><ul><li><code>WEB_CONCURRENCY</code>: b·∫±ng v·ªõi s·ªë l∆∞·ª£ng vcore/process c·ªßa m√°y</li><li><code>RAILS_MAX_THREADS</code>: ·ªù th√¨ nhi·ªÅu RAM th√¨ set 16, 32 cho o√°ch, kh√¥ng th√¨ th√¥i d√πng m·∫∑c ƒë·ªãnh 5 v√† m·∫∑c do d√≤ng ƒë·ªùi x√¥ ƒë·∫©y :v</li></ul><p>H√£y c√πng t√¨m hi·ªÉu th√™m v·ªÅ Puma ƒë·ªÉ g√≥p ph·∫ßn l√†m ch·ªß t·ª´ng d√≤ng code trong app c·ªßa ch√∫ng ta.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="2-multi-processing-v√†-multi-threading"></a>2. Multi-processing v√† Multi-threading<a class="hash-link" href="#2-multi-processing-v√†-multi-threading" title="Direct link to heading">#</a></h2><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="21-puma-d√πng-lo·∫°i-n√†o"></a>2.1. Puma d√πng lo·∫°i n√†o?<a class="hash-link" href="#21-puma-d√πng-lo·∫°i-n√†o" title="Direct link to heading">#</a></h3><ul><li>Khi ch·∫°y 1 Rails app m·ªõi t·∫°o, h√£y ƒë·ªÉ √Ω l√∫c boot server, b·∫°n s·∫Ω th·∫•y:</li></ul><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly log"><div tabindex="0" class="prism-code language-log codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">Puma starting in single mode...</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">* Puma version: 5.3.1 (ruby 3.0.1-p64) (&quot;Sweetnighter&quot;)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">*  Min threads: 5</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">*  Max threads: 5</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">*  Environment: development</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">*          PID: 1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">* Listening on http://0.0.0.0:3000</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Use Ctrl-C to stop</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>ƒê√¢y l√† d·∫•u hi·ªáu cho ta th·∫•y, Rails ƒëang ch·∫°y ·ªü ch·∫ø ƒë·ªô single process (1 process), v√† multi-thread (c·ª• th·ªÉ l√† 5 thread)</p><ul><li>C√≤n khi config deploy, c√≥ th·ªÉ b·∫°n s·∫Ω ƒë∆∞·ª£c 1 ng∆∞·ªùi c√≥ kinh nghi·ªám h∆°n b·∫£o r·∫±ng <em>&quot;B·ªè comment c√°i d√≤ng <code>workers ENV.fetch(&quot;WEB_CONCURRENCY&quot;) { 2 }</code> ƒëi em √™i&quot;</em></li></ul><p>V√† ƒë√¢y l√† k·∫øt qu·∫£ khi ta l√†m nh∆∞ v·∫≠y</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly log"><div tabindex="0" class="prism-code language-log codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">[1] Puma starting in cluster mode...</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">[1] * Puma version: 5.3.1 (ruby 3.0.1-p64) (&quot;Sweetnighter&quot;)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">[1] *  Min threads: 5</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">[1] *  Max threads: 5</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">[1] *  Environment: development</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">[1] *   Master PID: 1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">[1] *      Workers: 2</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">[1] *     Restarts: (ÔøΩÔøΩÔøΩ) hot (ÔøΩÔøΩÔøΩ) phased</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">[1] * Preloading application</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">[1] * Listening on htp://0.0.0.0:3000</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">[1] Use Ctrl-C to stop</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">[1] - Worker 0 (PID: 16) booted in 0.02s, phase: 0</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">[1] - Worker 1 (PID: 17) booted in 0.05s, phase: 0</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>Puma ƒëang ch·∫°y ƒë·ªìng th·ªùi multi-process (2 process) v√† multi-thread (5 thread)</p><blockquote><p>Multi-process, multi-thread l√† c√°i c·ªßa n·ª£ g√¨ v·∫≠y?</p></blockquote><p>Ch√∫ng ta s·∫Ω t√¨m hi·ªÉu v·ªÅ n√≥ ngay sau ƒë√¢y. Tuy nhi√™n ch√∫ng ta s·∫Ω focus v√†o cluster mode c·ªßa Puma nh√©.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="22-multi-threading"></a>2.2. Multi-threading<a class="hash-link" href="#22-multi-threading" title="Direct link to heading">#</a></h3><p>Tr∆∞·ªõc ti√™n ta h√£y nh·ªõ l·∫°i ƒë·ªãnh nghƒ©a v·ªÅ <code>process</code> - ti·∫øn tr√¨nh, m·ªói khi ta ch·∫°y 1 command n√†o ƒë√≥ (v√≠ d·ª• nh∆∞ <code>ruby xxx.rb</code> hay b·∫≠t chrome ch·∫≥ng h·∫°n), OS s·∫Ω t·∫°o 1 process ƒë·ªÉ x·ª≠ l√Ω command c·ªßa ta.</p><p>M·ªói <em>process</em> c√≥ th·ªÉ t·∫°o ra nhi·ªÅu <em>thread</em> ƒë·ªÉ x·ª≠ l√Ω task (v√≠ d·ª• m·ªói tab chrome ƒë∆∞·ª£c handle b·ªüi 1 thread). C√°c thread ƒë∆∞·ª£c t·∫°o b·ªüi 1 process s·∫Ω share nhau 1 v√πng nh·ªõ (memory), trong shared memory n√†y, m·ªói thread s·∫Ω c√≥ stack, register (google ƒë·ªÉ bi·∫øt th√™m ƒë·ªëng n√†y l√† g√¨ =)) ) ri√™ng c·ªßa m√¨nh. Tuy nhi√™n, vi·ªác chung ƒë·ª•ng memory nh∆∞ tr√™n s·∫Ω d·∫´n ƒë·∫øn 1 v·∫•n ƒë·ªÅ l√† nhi·ªÅu thread c√πng ch·ªçc t·ªõi 1 resource n√†o ƒë√≥, d·∫´n t·ªõi conflict v·ªÅ data, hay c√≤n ƒë∆∞·ª£c bi·∫øt ƒë·∫øn v·ªõi c√°i t√™n nguy hi·ªÉm h∆°n l√† <strong>race condition</strong>. Code c·ªßa ta s·∫Ω c·∫ßn <em>thread-safe</em> (c√°c b·∫°n c√≥ th·ªÉ google th√™m :v)</p><p>ƒê·ªëi v·ªõi ·ª©ng d·ª•ng Ruby th√¨ khi ch·∫°y ·ªü m√¥i tr∆∞·ªùng MRI... √Ä ƒë·∫•y l·∫°i nh·∫Øc t·ªõi MRI, ch·∫Øc nhi·ªÅu ng∆∞·ªùi s·∫Ω th·∫Øc m·∫Øc li·ªáu ƒë√≥ l√† g√¨. ƒê√¢y l√† t√™n c·ªßa 1 Ruby Runtime. Ruby 1 chu·∫©n spec, implement ki·ªÉu g√¨ c≈©ng ƒë∆∞·ª£c, mi·ªÖn l√† ƒë√°p ·ª©ng ƒë∆∞·ª£c spec ƒë√≥ th√¨ ƒë·ªÅu l√† Ruby. C√≥ th·ªÉ k·ªÉ ƒë·∫øn c√°c Runtime ph·ªï bi·∫øn sau</p><ul><li><p>MRI - aka CRuby: Matz‚Äôs Ruby Interpreter (Matz - hay Matsumoto Yukihiro) l√† ng∆∞·ªùi t·∫°o ra runtime n√†y, ƒë∆∞·ª£c vi·∫øt b·∫±ng C, n√™n c√≤n g·ªçi l√† CRuby</p><p>ƒêa s·ªë l√† d√πng MRI</p></li><li><p>JRuby: Ruby implement b·∫±ng Java</p></li><li><p>Rubinius</p></li><li><p>mruby</p></li><li><p>...</p></li></ul><p>MRI c√≥ 1 c∆° ch·∫ø l√† <strong>Global Interpreter Lock</strong> (GIL), khi ch·∫°y multi-thread, n√≥ ch·ªâ cho ph√©p 1 thread ch·∫°y source code Ruby t·∫°i 1 th·ªùi ƒëi·ªÉm, n√™n l√† ta c√≥ nhi·ªÅu thread ƒëi chƒÉng n·ªØa th√¨ c≈©ng ch·ªâ c√≥ 1 thread ƒë∆∞·ª£c ch·∫°y m√† th√¥i.</p><p>Tuy nhi√™n v·ªõi c√°c thao t√°c IO nh∆∞ ƒë·ªçc DB, request external resource, ƒë·ªçc ghi file, ... th√¨ GIL kh√¥ng block. Puma ƒë√£ t·∫≠n d·ª•ng ƒëi·ªÅu n√†y, khi 1 thread ƒëang x·ª≠ l√Ω IO, n√≥ s·∫Ω quay tr·ªü l·∫°i x·ª≠ l√Ω ·ªü process, nh·∫≠n th√™m c√°c request kh√°c ƒë·ªÉ x·ª≠ l√Ω.</p><p>Ch√≠nh v√¨ v·∫≠y, ngay c·∫£ khi ch·ªâ ch·∫°y ·ªü single mode, Puma v·∫´n c√≥ th·ªÉ handle ƒë∆∞·ª£c concurrent request. Tuy nhi√™n v·ªõi c√°c request c·∫ßn th·ªùi gian d√†i ƒë·ªÉ x·ª≠ l√Ω, do ch·ªâ c√≥ 1 thread ƒë∆∞·ª£c ch·∫°y, n√™n request sau s·∫Ω ph·∫£i ch·ªù request tr∆∞·ªõc x·ª≠ l√Ω xong, d·∫´n ƒë·∫øn Puma b·ªã th·ªçt trong tr∆∞·ªùng h·ª£p n√†y.</p><p>Ta c√≥ th·ªÉ ki·ªÉm tra v·ªÅ tr·∫°ng th√°i c√°c thread c·ªßa Puma b·∫±ng ƒëo·∫°n code sau:</p><div class="codeBlockContainer_K1bP"><div style="color:#bfc7d5;background-color:#292d3e" class="codeBlockTitle_eoMF">app/controllers/homes_controller.rb</div><div class="codeBlockContent_hGly ruby"><div tabindex="0" class="prism-code language-ruby codeBlock_23N8 thin-scrollbar codeBlockWithTitle_2JqI"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">class HomesController &lt; ApplicationController</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  def show</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    Thread.list.select { |t| t.name&amp;.match?(/puma threadpool \d+/) }.each do |t|</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      Rails.logger.info(&quot;Thread #{t.name}: #{t.status}, alive: #{t.alive?}, current: #{t == Thread.current}&quot;)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    end</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    head :ok</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  end</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">end</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>V√¨ sao l·∫°i l√† <code>/puma threadpool \d+/</code>? C√°c b·∫°n c√≥ th·ªÉ xem t·∫°i <a href="https://github.com/puma/puma/blob/3e80f7c704e5585da4faa32edf0fa7a0abed3689/lib/puma/thread_pool.rb#L104" target="_blank" rel="noopener noreferrer">ƒë√¢y</a>.</p><div class="codeBlockContainer_K1bP"><div style="color:#bfc7d5;background-color:#292d3e" class="codeBlockTitle_eoMF">config/routes.rb</div><div class="codeBlockContent_hGly ruby"><div tabindex="0" class="prism-code language-ruby codeBlock_23N8 thin-scrollbar codeBlockWithTitle_2JqI"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">Rails.application.routes.draw do</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  resource :home</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">end</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><div class="codeBlockContainer_K1bP"><div style="color:#bfc7d5;background-color:#292d3e" class="codeBlockTitle_eoMF">config/puma.rb</div><div class="codeBlockContent_hGly ruby"><div tabindex="0" class="prism-code language-ruby codeBlock_23N8 thin-scrollbar codeBlockWithTitle_2JqI"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">max_threads_count = ENV.fetch(&#x27;RAILS_MAX_THREADS&#x27;, 5)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">min_threads_count = ENV.fetch(&#x27;RAILS_MIN_THREADS&#x27;) { max_threads_count }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">threads min_threads_count, max_threads_count</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">worker_timeout 3600 if ENV.fetch(&#x27;RAILS_ENV&#x27;, &#x27;development&#x27;) == &#x27;development&#x27;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">port ENV.fetch(&#x27;PORT&#x27;, 3000)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">environment ENV.fetch(&#x27;RAILS_ENV&#x27;, &#x27;development&#x27;)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">pidfile ENV.fetch(&#x27;PIDFILE&#x27;, &#x27;tmp/pids/server.pid&#x27;)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">plugin :tmp_restart</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly curl"><div tabindex="0" class="prism-code language-curl codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">curl http://localhost:3000/home</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">tail -n 50 log/development.log</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>V√† ƒë√¢y l√† output:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly log"><div tabindex="0" class="prism-code language-log codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">Thread puma threadpool 001: sleep, alive: true, current: false</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Thread puma threadpool 002: sleep, alive: true, current: false</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Thread puma threadpool 003: sleep, alive: true, current: false</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Thread puma threadpool 004: sleep, alive: true, current: false</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Thread puma threadpool 005: run, alive: true, current: true</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>ƒê√≥ ch√≠nh l√† 5 thread c·ªßa ch√∫ng ta, nh∆∞ v√≠ d·ª• l√† thread 5 ƒëang ti·∫øn h√†nh x·ª≠ l√Ω request, c√≤n nh·ªØng thread kh√°c n·∫øu r·∫£nh n√≥ s·∫Ω ·ªü tr·∫°ng th√°i <code>sleep</code>. ·ªû ƒë√¢y c√≥ 1 ƒëi·ªÉm ƒë√°ng ch√∫ √Ω l√† sau khi k·∫øt th√∫c request, thread kh√¥ng b·ªã kill m√† ch·ªâ v·ªÅ tr·∫°ng th√°i <code>sleep</code>, do v·∫≠y n·∫øu ta tu·ª≥ ti·ªán modify bi·∫øn global, n√≥ s·∫Ω ·∫£nh h∆∞·ªüng t·ªõi request ti·∫øp theo m√† thread ƒë√≥ handle.</p><p>V√≠ d·ª•:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly ruby"><div tabindex="0" class="prism-code language-ruby codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">before_action :set_locale</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">def set_locale</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  I18n.locale = params[:locale] || I18n.default_locale</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">end</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>Kh√¥ng c·∫ßn bi·∫øt code c√°i g√¨, nh∆∞ng modify 1 bi·∫øn global t·∫°i runtime nh∆∞ tr√™n l√† ƒë√£ th·∫•y nguy hi·ªÉm r·ªìi. V√† ta h√£y ti·∫øn h√†nh test xem</p><div class="codeBlockContainer_K1bP"><div style="color:#bfc7d5;background-color:#292d3e" class="codeBlockTitle_eoMF">app/controllers/homes_controller.rb</div><div class="codeBlockContent_hGly ruby"><div tabindex="0" class="prism-code language-ruby codeBlock_23N8 thin-scrollbar codeBlockWithTitle_2JqI"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">class HomesController &lt; ApplicationController</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  def show</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    Thread.current.tap { |t| Rails.logger.info(&quot;Current thread #{t.name}: #{t.status}, alive: #{t.alive?}&quot;) }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    Rails.logger.info(&quot;Before: #{I18n.locale}&quot;)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    I18n.locale = params[:locale]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    Rails.logger.info(&quot;After: #{I18n.locale}&quot;)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    head :ok</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  end</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">end</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>r·ªìi sau ƒë√≥ spam kho·∫£ng ch·ª•c c√°i request</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bash"><div tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token function" style="color:rgb(130, 170, 255)">curl</span><span class="token plain"> http://localhost:3000/home?locale</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain">vi</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>v√† ta s·∫Ω th·∫•y k·∫øt qu·∫£ nh∆∞ sau</p><div class="codeBlockContainer_K1bP"><div style="color:#bfc7d5;background-color:#292d3e" class="codeBlockTitle_eoMF">log/development.log</div><div class="codeBlockContent_hGly log"><div tabindex="0" class="prism-code language-log codeBlock_23N8 thin-scrollbar codeBlockWithTitle_2JqI"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">Current thread puma threadpool 003: run, alive: true</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Before: en</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">After: vi</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Current thread puma threadpool 003: run, alive: true</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Before: vi</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">After: vi</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>C√≥ th·ªÉ d·ªÖ d√†ng nh·∫≠n ra r·∫±ng vi·ªác set <code>I18n.locale = &quot;vi&quot;</code> ·ªü request tr∆∞·ªõc ƒë√£ b·ªã leak sang request sau. N·∫øu ·ªü t·∫•t c·∫£ c√°c request, tr∆∞·ªõc khi x·ª≠ l√Ω ta ƒë·ªÅu set <code>I18n.locale</code> th√¨ vi·ªác leak tr√™n s·∫Ω √≠t ·∫£nh h∆∞·ªüng h∆°n.</p><p>Tuy nhi√™n h√£y th·ª≠ t∆∞·ªüng t∆∞·ª£ng khi app c·ªßa b·∫°n c√≥ ch·ª©a c·∫£ code admin v√† api, b√™n admin c√≥ th·ªÉ ƒë·ªïi ng√¥n ng·ªØ, c√≤n api th√¨ kh√¥ng, th√¨ k·∫øt qu·∫£ s·∫Ω ra sao. Khi admin ƒë·ªïi ng√¥n ng·ªØ, t√¨nh c·ªù, 1 user v√¥ ph√∫c n√†o ƒë√≥ request t·ªõi tr√∫ng c√°i thread v·ª´a handle vi·ªác admin ƒë·ªïi ng√¥n ng·ªØ, v√† API s·∫Ω tr·∫£ v·ªÅ locale c·ªßa √¥ng admin kia :v</p><p>Ch√≠nh v√¨ v·∫≠y, ·ªü docs c·ªßa Rails c≈©ng c√≥ recommend ch√∫ng ta x·ª≠ l√Ω chuy·ªÉn locale b·∫±ng <code>I18n.with_locale</code>, c√°c b·∫°n c√≥ th·ªÉ xem t·∫°i <a href="https://guides.rubyonrails.org/i18n.html#managing-the-locale-across-requests" target="_blank" rel="noopener noreferrer">ƒë√¢y</a></p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly ruby"><div tabindex="0" class="prism-code language-ruby codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">around_action :switch_locale</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">def switch_locale(&amp;action)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  locale = params[:locale] || I18n.default_locale</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  I18n.with_locale(locale, &amp;action)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">end</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>T√∫m v√°y l·∫°i l√† multi-threading h·ªó tr·ª£ concurrent r·∫•t t·ªët, tuy nhi√™n c≈©ng ·∫©n ch·ª©a 1 v√†i v·∫•n ƒë·ªÅ. N√™n s·∫Ω c·∫ßn ch√∫ √Ω h∆°n khi code.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="23-multi-processing"></a>2.3. Multi-processing<a class="hash-link" href="#23-multi-processing" title="Direct link to heading">#</a></h3><p>M√°y t√≠nh hi·ªán nay ƒëa s·ªë ƒë·ªÅu c√≥ kh√° nhi·ªÅu core, v√† ƒë·ªÅu h·ªó tr·ª£ ƒëa nhi·ªám ƒë·ªÉ t·ªëi ∆∞u ho√° vi·ªác x·ª≠ l√Ω song song. V·∫≠y v·ªõi webserver th√¨ sao? C√≥ c·∫ßn ch·ª©, multi-processing gi√∫p ta c√≥ th·ªÉ x·ª≠ l√Ω th√™m nhi·ªÅu request ƒë·ªìng th·ªùi h∆°n n·ªØa. Tr·ª´ khi server c·ªßa ta qu√° y·∫øu, ch·ª© kh√¥ng th√¨ t·ªôi g√¨, nh√† ch·∫£ c√≥ g√¨ ngo√†i core m√† l·∫°i ch·∫°y ƒë∆°n nh√¢n th√¨ ph√≠ c·ªßa gi·ªùi qu√° :v</p><p>M·∫∑c ƒë·ªãnh Puma s·∫Ω ch·∫°y ·ªü single mode, khi ƒë√≥ ch·ªâ c√≥ 1 process, process n√†y s·∫Ω ƒë·∫£m nh·∫≠n h·∫øt t·ª´ vi·ªác l∆∞u code c·ªßa app, ti·∫øp nh·∫≠n request, ... sau ƒë√≥ s·∫Ω ƒë·∫©y request sang cho c√°c thread x·ª≠ l√Ω nh∆∞ ƒë√£ m√¥ t·∫£ ·ªü tr√™n.</p><p>C√≤n ƒë·ªëi v·ªõi cluster mode, tr∆∞·ªõc h·∫øt Puma s·∫Ω t·∫°o ra m·ªôt master process. T·ª´ process n√†y, d·ª±a v√†o gi√° tr·ªã c·ªßa config d∆∞·ªõi, Puma s·∫Ω <em>fork</em> ƒë·ªÉ t·∫°o ra s·ªë process t∆∞∆°ng ·ª©ng, hay c√≤n g·ªçi l√† <em>worker</em>.</p><div class="codeBlockContainer_K1bP"><div style="color:#bfc7d5;background-color:#292d3e" class="codeBlockTitle_eoMF">config/puma.rb</div><div class="codeBlockContent_hGly ruby"><div tabindex="0" class="prism-code language-ruby codeBlock_23N8 thin-scrollbar codeBlockWithTitle_2JqI"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">workers ENV.fetch(&quot;WEB_CONCURRENCY&quot;) { 2 }</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>L·∫°i n√≥i v·ªÅ fork, ƒë√¢y l√† qu√° tr√¨nh m√† 1 process t·∫°o ra 1 process m·ªõi, g·ªçi l√† <em>child process</em>. M·ªói child process ƒë·ªÅu c√≥ process id (PID) ri√™ng bi·ªát, v√† m·ªôt m√¥i tr∆∞·ªùng ri√™ng t√°ch bi·ªát ho√†n to√†n v·ªõi parent process (source code, memory, stack, ...). Kh√¥ng nh∆∞ thread v·∫´n share code v·ªõi process, nh∆∞ng c√≥ stack, register ri√™ng. Do v·∫≠y, c√≥ th·ªÉ n√≥i forking an to√†n v√† b·∫£o m·∫≠t h∆°n so v·ªõi multi-thread.</p><p>Quay tr·ªü l·∫°i v·ªõi Puma, ·ªü cluster mode, master process ch·ªâ ƒë·∫£m nh·∫≠n vi·ªác ti·∫øp nh·∫≠n request, sau ƒë√≥ s·∫Ω b·∫Øn sang c√°c worker ƒë·ªÉ ch√∫ng t·ª± x·ª≠ v·ªõi c√°c thread m√† ch√∫ng spawn. C√°c worker c·ªßa Puma ƒë·ªÅu c√≥ 1 b·∫£n copy source code app ri√™ng, n√™n khi ch·∫°y nhi·ªÅu worker, h√£y ch·∫Øc ch·∫Øn l√† server c·ªßa b·∫°n c√≥ ƒë·ªß RAM :v</p><p>·ªû Ruby, c√≥ th·ªÉ ki·ªÉm tra xem app c·ªßa ta ƒëang ch·∫°y ·ªü process n√†o b·∫±ng c√°ch s·ª≠ d·ª•ng</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly ruby"><div tabindex="0" class="prism-code language-ruby codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">Process.pid  # Current child process</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Process.ppid # Parent process</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>H√£y th·ª≠ ·ªü app Rails c·ªßa ta xem</p><div class="codeBlockContainer_K1bP"><div style="color:#bfc7d5;background-color:#292d3e" class="codeBlockTitle_eoMF">app/controllers/homes_controller.rb</div><div class="codeBlockContent_hGly ruby"><div tabindex="0" class="prism-code language-ruby codeBlock_23N8 thin-scrollbar codeBlockWithTitle_2JqI"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">class HomesController &lt; ApplicationController</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  def show</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    Rails.logger.info(&quot;Current: #{Process.pid}. Parent: #{Process.ppid}&quot;)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    head :ok</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  end</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">end</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><div class="codeBlockContainer_K1bP"><div style="color:#bfc7d5;background-color:#292d3e" class="codeBlockTitle_eoMF">config/puma.rb</div><div class="codeBlockContent_hGly ruby"><div tabindex="0" class="prism-code language-ruby codeBlock_23N8 thin-scrollbar codeBlockWithTitle_2JqI"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain"># ...</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">workers 2</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><div class="codeBlockContainer_K1bP"><div style="color:#bfc7d5;background-color:#292d3e" class="codeBlockTitle_eoMF">log/development.log</div><div class="codeBlockContent_hGly log"><div tabindex="0" class="prism-code language-log codeBlock_23N8 thin-scrollbar codeBlockWithTitle_2JqI"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">Processing by HomesController#show as */*</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Current: 128. Parent: 1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Processing by HomesController#show as */*</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Current: 129. Parent: 1</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bash"><div tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token function" style="color:rgb(130, 170, 255)">ps</span><span class="token plain"> aux</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># USER       PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># root         1  0.5  7.1 236000 145864 pts/0   Ssl+ 03:28   0:04 puma 5.3.1 (tcp://0.0.0.0:3000) [app]</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># root         7  0.0  0.1   3544  3192 pts/1    Ss   03:29   0:00 zsh</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># root       128  0.0  6.9 288680 142008 pts/0   Sl+  03:29   0:00 puma: cluster worker 0: 1 [app]</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># root       129  0.0  6.9 288720 142116 pts/0   Sl+  03:29   0:00 puma: cluster worker 1: 1 [app]</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># root       219  0.0  0.0   1640   856 pts/1    R+   03:40   0:00 ps aux</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="3-k·∫øt-lu·∫≠n"></a>3. K·∫øt lu·∫≠n<a class="hash-link" href="#3-k·∫øt-lu·∫≠n" title="Direct link to heading">#</a></h2><p>C·∫£ multi-threading v√† multi-processing ƒë·ªÅu quan tr·ªçng, ch√∫ng g√≥p ph·∫ßn gi√∫p app ta x·ª≠ l√Ω ƒëc concurrent request. Hy v·ªçng b√†i vi·∫øt c√≥ th·ªÉ gi√∫p √≠ch cho c√°c b·∫°n √≠t nhi·ªÅu.</p><p>Ngo√†i ra, v·ªÅ v·∫•n ƒë·ªÅ set s·ªë worker v√† thread ·ªü ph·∫ßn ƒë·∫ßu ƒë√£ n√≥i, t·ªët nh·∫•t ch·∫Øc v·∫´n l√†:</p><ul><li><code>WEB_CONCURRENCY</code> = vcore, ngo√†i ra c√≤n ph·ª• thu·ªôc v√†o RAM n·ªØa</li><li><code>RAILS_MAX_THREADS</code> kh√¥ng c√≥ con s·ªë c·ª• th·ªÉ, ph·ª• thu·ªôc v√†o RAM v√† CPU, nhi·ªÅu RAM, CPU kho·∫ª th√¨ set ƒë∆∞·ª£c c√†ng nhi·ªÅu, nh∆∞ng c≈©ng kh√° l√† h√™n xui, ph·∫£i ti·∫øn h√†nh test r·ªìi m·ªõi cƒÉn ch·ªânh con s·ªë ph√π h·ª£p ƒë∆∞·ª£c =))</li></ul><p>N·∫øu c√≥ sai s√≥t g√¨ c√°c b·∫°n c·ª© g·∫°ch ƒë√° tho·∫£i m√°i √† :v chi ti·∫øt c√≥ th·ªÉ tham kh·∫£o ·ªü <a href="https://devcenter.heroku.com/articles/deploying-rails-applications-with-the-puma-web-server#workers" target="_blank" rel="noopener noreferrer">ƒë√¢y</a></p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="4-tham-kh·∫£o"></a>4. Tham kh·∫£o<a class="hash-link" href="#4-tham-kh·∫£o" title="Direct link to heading">#</a></h2><ul><li><a href="https://www.speedshop.co/2015/07/29/scaling-ruby-apps-to-1000-rpm.html" target="_blank" rel="noopener noreferrer">https://www.speedshop.co/2015/07/29/scaling-ruby-apps-to-1000-rpm.html</a></li><li><a href="https://devcenter.heroku.com/articles/concurrency-and-database-connections" target="_blank" rel="noopener noreferrer">https://devcenter.heroku.com/articles/concurrency-and-database-connections</a></li><li><a href="https://devcenter.heroku.com/articles/deploying-rails-applications-with-the-puma-web-server" target="_blank" rel="noopener noreferrer">https://devcenter.heroku.com/articles/deploying-rails-applications-with-the-puma-web-server</a></li><li><a href="http://www.geekride.com/fork-forking-vs-threading-thread-linux-kernel/" target="_blank" rel="noopener noreferrer">http://www.geekride.com/fork-forking-vs-threading-thread-linux-kernel/</a></li><li><a href="https://www.studytonight.com/operating-system/multithreading" target="_blank" rel="noopener noreferrer">https://www.studytonight.com/operating-system/multithreading</a></li><li><a href="https://www.tutorialspoint.com/how-to-create-a-process-in-linux#:~:text=A%20new%20process%20can%20be,newly%20is%20called%20child%20process" target="_blank" rel="noopener noreferrer">https://www.tutorialspoint.com/how-to-create-a-process-in-linux#:~:text=A%20new%20process%20can%20be,newly%20is%20called%20child%20process</a>.</li></ul></div><footer class="row margin-vert--lg"><div class="col"><strong>Tags:</strong><a class="margin-horiz--sm" href="/blog/tags/puma">puma</a><a class="margin-horiz--sm" href="/blog/tags/ruby-on-rails">ruby-on-rails</a><a class="margin-horiz--sm" href="/blog/tags/multi-threading">multi-threading</a><a class="margin-horiz--sm" href="/blog/tags/multi-processing">multi-processing</a></div><div class="col text--right"><a aria-label="Read more about C√πng t√¨m hi·ªÉu v·ªÅ Puma (Ruby on Rails)" href="/blog/cung-tim-hieu-ve-puma-ruby-on-rails"><strong>Read More</strong></a></div></footer></article></div></main></div></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><h4 class="footer__title">Docs</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/docs/intro">Tutorial</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Community</h4><ul class="footer__items"><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Overflow</a></li><li class="footer__item"><a href="https://discordapp.com/invite/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord</a></li><li class="footer__item"><a href="https://twitter.com/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">More</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/facebook/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright ¬© 2021 My Project, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.753d92b7.js"></script>
<script src="/assets/js/main.fa35a9da.js"></script>
</body>
</html>