<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-tags-post-list-page plugin-blog plugin-id-default" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.1.1">
<title data-rh="true">One post tagged with &quot;multi-threading&quot; | Welcome to my personal blog | _MoonLight_</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://moonlight8978.github.io/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://moonlight8978.github.io/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://moonlight8978.github.io/blog/tags/multi-threading"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" property="og:title" content="One post tagged with &quot;multi-threading&quot; | Welcome to my personal blog | _MoonLight_"><meta data-rh="true" name="docusaurus_tag" content="blog_tags_posts"><meta data-rh="true" name="docsearch:docusaurus_tag" content="blog_tags_posts"><link data-rh="true" rel="icon" href="/favicon.ico"><link data-rh="true" rel="canonical" href="https://moonlight8978.github.io/blog/tags/multi-threading"><link data-rh="true" rel="alternate" href="https://moonlight8978.github.io/blog/tags/multi-threading" hreflang="en"><link data-rh="true" rel="alternate" href="https://moonlight8978.github.io/blog/tags/multi-threading" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Welcome to my personal blog | _MoonLight_ RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Welcome to my personal blog | _MoonLight_ Atom Feed">




<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.24/dist/katex.min.css" integrity="sha384-odtC+0UGzzFL/6PNoE8rX/SPcQDXBJ+uRepguP4QkPCm2LBxH3FA3y+fKSiJ+AmM" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/styles.9709e2f3.css">
<script src="/assets/js/runtime~main.0f8698e7.js" defer="defer"></script>
<script src="/assets/js/main.2e5390a1.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_pAeB" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/peach-goma-pc-night-keyboard-smashing-sd.gif" alt="Goma smashing his keyboard" class="themedComponent_RIc6 themedComponent--light_aQWN"><img src="/peach-goma-pc-night-keyboard-smashing-sd.gif" alt="Goma smashing his keyboard" class="themedComponent_RIc6 themedComponent--dark_XAeT"></div><b class="navbar__title text--truncate">Home</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/blog">Blog</a><a class="navbar__item navbar__link" href="/docs/intro">Notes</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/facebook/docusaurus" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_sT5S"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_c7W3 colorModeToggle_k_Ia"><button class="clean-btn toggleButton_vdzZ toggleButtonDisabled_T9bY" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_Vd5J"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_Yt2c"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_cTIM"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_jMRO"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_WlgU thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_knSc margin-bottom--md">Recent posts</div><ul class="sidebarItemList_OaoK clean-list"><li class="sidebarItem_gihs"><a class="sidebarItemLink_dDE_" href="/blog/tim-hieu-ve-active-record-encryption">Tìm hiểu về Active Record Encryption</a></li><li class="sidebarItem_gihs"><a class="sidebarItemLink_dDE_" href="/blog/websocket-hoat-dong-nhu-the-nao">WebSocket hoạt động như thế nào?</a></li><li class="sidebarItem_gihs"><a class="sidebarItemLink_dDE_" href="/blog/cung-tim-hieu-ve-puma-ruby-on-rails">Cùng tìm hiểu về Puma (Ruby on Rails)</a></li><li class="sidebarItem_gihs"><a class="sidebarItemLink_dDE_" href="/blog/cuoi-react-native-xem-appium-phan-1-cung-tim-hieu-cach-hoat-dong-cua-appium">Cưỡi React Native xem Appium (Phần 1 - Cùng tìm hiểu cách hoạt động của Appium)</a></li><li class="sidebarItem_gihs"><a class="sidebarItemLink_dDE_" href="/blog/gioi-thieu-ve-kubernetes">Giới thiệu về Kubernetes</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="https://schema.org/Blog"><header class="margin-bottom--xl"><h1>One post tagged with &quot;multi-threading&quot;</h1><a href="/blog/tags">View All Tags</a></header><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="https://schema.org/BlogPosting"><meta itemprop="description" content="1. Mở đầu"><header><h2 class="title_DEF8" itemprop="headline"><a itemprop="url" href="/blog/cung-tim-hieu-ve-puma-ruby-on-rails">Cùng tìm hiểu về Puma (Ruby on Rails)</a></h2><div class="container_Y0Yj margin-vert--md"><time datetime="2021-05-31T00:00:00.000Z" itemprop="datePublished">May 31, 2021</time> · <!-- -->11 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_fNYc"><div class="avatar margin-bottom--sm"><a href="https://github.com/moonlight8978" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://avatars.githubusercontent.com/u/26299310?v=4" alt="Lê Sĩ Bích" itemprop="image"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/moonlight8978" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Lê Sĩ Bích</span></a></div><small class="avatar__subtitle" itemprop="description">Ruby on Rails/React Developer</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><h2 class="anchor anchorWithStickyNavbar_FlIw" id="1-mở-đầu">1. Mở đầu<a href="#1-mở-đầu" class="hash-link" aria-label="Direct link to 1. Mở đầu" title="Direct link to 1. Mở đầu">​</a></h2>
<p>Chắc hẳn Puma không phải một cái tên xa lạ đối với mỗi Rails developer, một phần cũng vì đây là appserver mặc định khi tạo mới một project Rails.</p>
<p>Hãy cùng nhìn qua những config cơ bản khi chạy 1 ứng dụng Rails với Puma server. <a href="https://github.com/rails/rails/blob/0f5700ac3589081126fbfde1e4037dc1d4166cce/railties/lib/rails/generators/rails/app/templates/config/puma.rb.tt" target="_blank" rel="noopener noreferrer">link</a></p>
<div class="language-ruby codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-ruby codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token plain">max_threads_count = ENV.fetch(&quot;RAILS_MAX_THREADS&quot;) { 5 }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">min_threads_count = ENV.fetch(&quot;RAILS_MIN_THREADS&quot;) { max_threads_count }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">threads min_threads_count, max_threads_count</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">worker_timeout 3600 if ENV.fetch(&quot;RAILS_ENV&quot;, &quot;development&quot;) == &quot;development&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">port ENV.fetch(&quot;PORT&quot;) { 3000 }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">environment ENV.fetch(&quot;RAILS_ENV&quot;) { &quot;development&quot; }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pidfile ENV.fetch(&quot;PIDFILE&quot;) { &quot;tmp/pids/server.pid&quot; }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">workers ENV.fetch(&quot;WEB_CONCURRENCY&quot;) { 2 }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">preload_app!</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">plugin :tmp_restart</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Đối với những người mới bắt đầu, khi deploy puma, có lẽ sẽ từ chối hiểu đống config trên và set một số biến môi trường như sau:</p>
<ul>
<li><code>WEB_CONCURRENCY</code>: bằng với số lượng vcore/process của máy</li>
<li><code>RAILS_MAX_THREADS</code>: ờ thì nhiều RAM thì set 16, 32 cho oách, không thì thôi dùng mặc định 5 và mặc do dòng đời xô đẩy <!-- -->:v</li>
</ul>
<p>Hãy cùng tìm hiểu thêm về Puma để góp phần làm chủ từng dòng code trong app của chúng ta.</p>
<h2 class="anchor anchorWithStickyNavbar_FlIw" id="2-multi-processing-và-multi-threading">2. Multi-processing và Multi-threading<a href="#2-multi-processing-và-multi-threading" class="hash-link" aria-label="Direct link to 2. Multi-processing và Multi-threading" title="Direct link to 2. Multi-processing và Multi-threading">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_FlIw" id="21-puma-dùng-loại-nào">2.1. Puma dùng loại nào?<a href="#21-puma-dùng-loại-nào" class="hash-link" aria-label="Direct link to 2.1. Puma dùng loại nào?" title="Direct link to 2.1. Puma dùng loại nào?">​</a></h3>
<ul>
<li>Khi chạy 1 Rails app mới tạo, hãy để ý lúc boot server, bạn sẽ thấy:</li>
</ul>
<div class="language-log codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-log codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token plain">Puma starting in single mode...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">* Puma version: 5.3.1 (ruby 3.0.1-p64) (&quot;Sweetnighter&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">*  Min threads: 5</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">*  Max threads: 5</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">*  Environment: development</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">*          PID: 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">* Listening on http://0.0.0.0:3000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Use Ctrl-C to stop</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Đây là dấu hiệu cho ta thấy, Rails đang chạy ở chế độ single process (1 process), và multi-thread (cụ thể là 5 thread)</p>
<ul>
<li>Còn khi config deploy, có thể bạn sẽ được 1 người có kinh nghiệm hơn bảo rằng <em>&quot;Bỏ comment cái dòng <code>workers ENV.fetch(&quot;WEB_CONCURRENCY&quot;) { 2 }</code> đi em êi&quot;</em></li>
</ul>
<p>Và đây là kết quả khi ta làm như vậy</p>
<div class="language-log codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-log codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token plain">[1] Puma starting in cluster mode...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[1] * Puma version: 5.3.1 (ruby 3.0.1-p64) (&quot;Sweetnighter&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[1] *  Min threads: 5</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[1] *  Max threads: 5</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[1] *  Environment: development</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[1] *   Master PID: 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[1] *      Workers: 2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[1] *     Restarts: (���) hot (���) phased</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[1] * Preloading application</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[1] * Listening on htp://0.0.0.0:3000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[1] Use Ctrl-C to stop</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[1] - Worker 0 (PID: 16) booted in 0.02s, phase: 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[1] - Worker 1 (PID: 17) booted in 0.05s, phase: 0</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Puma đang chạy đồng thời multi-process (2 process) và multi-thread (5 thread)</p>
<blockquote>
<p>Multi-process, multi-thread là cái của nợ gì vậy?</p>
</blockquote>
<p>Chúng ta sẽ tìm hiểu về nó ngay sau đây. Tuy nhiên chúng ta sẽ focus vào cluster mode của Puma nhé.</p>
<h3 class="anchor anchorWithStickyNavbar_FlIw" id="22-multi-threading">2.2. Multi-threading<a href="#22-multi-threading" class="hash-link" aria-label="Direct link to 2.2. Multi-threading" title="Direct link to 2.2. Multi-threading">​</a></h3>
<p>Trước tiên ta hãy nhớ lại định nghĩa về <code>process</code> - tiến trình, mỗi khi ta chạy 1 command nào đó (ví dụ như <code>ruby xxx.rb</code> hay bật chrome chẳng hạn), OS sẽ tạo 1 process để xử lý command của ta.</p>
<p>Mỗi <em>process</em> có thể tạo ra nhiều <em>thread</em> để xử lý task (ví dụ mỗi tab chrome được handle bởi 1 thread). Các thread được tạo bởi 1 process sẽ share nhau 1 vùng nhớ (memory), trong shared memory này, mỗi thread sẽ có stack, register (google để biết thêm đống này là gì =)) ) riêng của mình. Tuy nhiên, việc chung đụng memory như trên sẽ dẫn đến 1 vấn đề là nhiều thread cùng chọc tới 1 resource nào đó, dẫn tới conflict về data, hay còn được biết đến với cái tên nguy hiểm hơn là <strong>race condition</strong>. Code của ta sẽ cần <em>thread-safe</em> (các bạn có thể google thêm <!-- -->:v<!-- -->)</p>
<p>Đối với ứng dụng Ruby thì khi chạy ở môi trường MRI... À đấy lại nhắc tới MRI, chắc nhiều người sẽ thắc mắc liệu đó là gì. Đây là tên của 1 Ruby Runtime. Ruby 1 chuẩn spec, implement kiểu gì cũng được, miễn là đáp ứng được spec đó thì đều là Ruby. Có thể kể đến các Runtime phổ biến sau</p>
<ul>
<li>
<p>MRI - aka CRuby: Matz’s Ruby Interpreter (Matz - hay Matsumoto Yukihiro) là người tạo ra runtime này, được viết bằng C, nên còn gọi là CRuby</p>
<p>Đa số là dùng MRI</p>
</li>
<li>
<p>JRuby: Ruby implement bằng Java</p>
</li>
<li>
<p>Rubinius</p>
</li>
<li>
<p>mruby</p>
</li>
<li>
<p>...</p>
</li>
</ul>
<p>MRI có 1 cơ chế là <strong>Global Interpreter Lock</strong> (GIL), khi chạy multi-thread, nó chỉ cho phép 1 thread chạy source code Ruby tại 1 thời điểm, nên là ta có nhiều thread đi chăng nữa thì cũng chỉ có 1 thread được chạy mà thôi.</p>
<p>Tuy nhiên với các thao tác IO như đọc DB, request external resource, đọc ghi file, ... thì GIL không block. Puma đã tận dụng điều này, khi 1 thread đang xử lý IO, nó sẽ quay trở lại xử lý ở process, nhận thêm các request khác để xử lý.</p>
<p>Chính vì vậy, ngay cả khi chỉ chạy ở single mode, Puma vẫn có thể handle được concurrent request. Tuy nhiên với các request cần thời gian dài để xử lý, do chỉ có 1 thread được chạy, nên request sau sẽ phải chờ request trước xử lý xong, dẫn đến Puma bị thọt trong trường hợp này.</p>
<p>Ta có thể kiểm tra về trạng thái các thread của Puma bằng đoạn code sau:</p>
<div class="language-ruby codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-ruby codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token plain">class HomesController &lt; ApplicationController</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  def show</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Thread.list.select { |t| t.name&amp;.match?(/puma threadpool \d+/) }.each do |t|</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Rails.logger.info(&quot;Thread #{t.name}: #{t.status}, alive: #{t.alive?}, current: #{t == Thread.current}&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    head :ok</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Vì sao lại là <code>/puma threadpool \d+/</code>? Các bạn có thể xem tại <a href="https://github.com/puma/puma/blob/3e80f7c704e5585da4faa32edf0fa7a0abed3689/lib/puma/thread_pool.rb#L104" target="_blank" rel="noopener noreferrer">đây</a>.</p>
<div class="language-ruby codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-ruby codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token plain">Rails.application.routes.draw do</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  resource :home</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-ruby codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-ruby codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token plain">max_threads_count = ENV.fetch(&#x27;RAILS_MAX_THREADS&#x27;, 5)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">min_threads_count = ENV.fetch(&#x27;RAILS_MIN_THREADS&#x27;) { max_threads_count }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">threads min_threads_count, max_threads_count</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">worker_timeout 3600 if ENV.fetch(&#x27;RAILS_ENV&#x27;, &#x27;development&#x27;) == &#x27;development&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">port ENV.fetch(&#x27;PORT&#x27;, 3000)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">environment ENV.fetch(&#x27;RAILS_ENV&#x27;, &#x27;development&#x27;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pidfile ENV.fetch(&#x27;PIDFILE&#x27;, &#x27;tmp/pids/server.pid&#x27;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">plugin :tmp_restart</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-curl codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-curl codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token plain">curl http://localhost:3000/home</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tail -n 50 log/development.log</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Và đây là output:</p>
<div class="language-log codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-log codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token plain">Thread puma threadpool 001: sleep, alive: true, current: false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Thread puma threadpool 002: sleep, alive: true, current: false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Thread puma threadpool 003: sleep, alive: true, current: false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Thread puma threadpool 004: sleep, alive: true, current: false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Thread puma threadpool 005: run, alive: true, current: true</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Đó chính là 5 thread của chúng ta, như ví dụ là thread 5 đang tiến hành xử lý request, còn những thread khác nếu rảnh nó sẽ ở trạng thái <code>sleep</code>. Ở đây có 1 điểm đáng chú ý là sau khi kết thúc request, thread không bị kill mà chỉ về trạng thái <code>sleep</code>, do vậy nếu ta tuỳ tiện modify biến global, nó sẽ ảnh hưởng tới request tiếp theo mà thread đó handle.</p>
<p>Ví dụ:</p>
<div class="language-ruby codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-ruby codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token plain">before_action :set_locale</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">def set_locale</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  I18n.locale = params[:locale] || I18n.default_locale</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Không cần biết code cái gì, nhưng modify 1 biến global tại runtime như trên là đã thấy nguy hiểm rồi. Và ta hãy tiến hành test xem</p>
<div class="language-ruby codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-ruby codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token plain">class HomesController &lt; ApplicationController</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  def show</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Thread.current.tap { |t| Rails.logger.info(&quot;Current thread #{t.name}: #{t.status}, alive: #{t.alive?}&quot;) }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Rails.logger.info(&quot;Before: #{I18n.locale}&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    I18n.locale = params[:locale]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Rails.logger.info(&quot;After: #{I18n.locale}&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    head :ok</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>rồi sau đó spam khoảng chục cái request</p>
<div class="language-bash codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-bash codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token plain">curl http://localhost:3000/home?locale=vi</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>và ta sẽ thấy kết quả như sau</p>
<div class="language-log codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-log codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token plain">Current thread puma threadpool 003: run, alive: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Before: en</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">After: vi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Current thread puma threadpool 003: run, alive: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Before: vi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">After: vi</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Có thể dễ dàng nhận ra rằng việc set <code>I18n.locale = &quot;vi&quot;</code> ở request trước đã bị leak sang request sau. Nếu ở tất cả các request, trước khi xử lý ta đều set <code>I18n.locale</code> thì việc leak trên sẽ ít ảnh hưởng hơn.</p>
<p>Tuy nhiên hãy thử tưởng tượng khi app của bạn có chứa cả code admin và api, bên admin có thể đổi ngôn ngữ, còn api thì không, thì kết quả sẽ ra sao. Khi admin đổi ngôn ngữ, tình cờ, 1 user vô phúc nào đó request tới trúng cái thread vừa handle việc admin đổi ngôn ngữ, và API sẽ trả về locale của ông admin kia <!-- -->:v</p>
<p>Chính vì vậy, ở docs của Rails cũng có recommend chúng ta xử lý chuyển locale bằng <code>I18n.with_locale</code>, các bạn có thể xem tại <a href="https://guides.rubyonrails.org/i18n.html#managing-the-locale-across-requests" target="_blank" rel="noopener noreferrer">đây</a></p>
<div class="language-ruby codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-ruby codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token plain">around_action :switch_locale</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">def switch_locale(&amp;action)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  locale = params[:locale] || I18n.default_locale</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  I18n.with_locale(locale, &amp;action)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Túm váy lại là multi-threading hỗ trợ concurrent rất tốt, tuy nhiên cũng ẩn chứa 1 vài vấn đề. Nên sẽ cần chú ý hơn khi code.</p>
<h3 class="anchor anchorWithStickyNavbar_FlIw" id="23-multi-processing">2.3. Multi-processing<a href="#23-multi-processing" class="hash-link" aria-label="Direct link to 2.3. Multi-processing" title="Direct link to 2.3. Multi-processing">​</a></h3>
<p>Máy tính hiện nay đa số đều có khá nhiều core, và đều hỗ trợ đa nhiệm để tối ưu hoá việc xử lý song song. Vậy với webserver thì sao? Có cần chứ, multi-processing giúp ta có thể xử lý thêm nhiều request đồng thời hơn nữa. Trừ khi server của ta quá yếu, chứ không thì tội gì, nhà chả có gì ngoài core mà lại chạy đơn nhân thì phí của giời quá <!-- -->:v</p>
<p>Mặc định Puma sẽ chạy ở single mode, khi đó chỉ có 1 process, process này sẽ đảm nhận hết từ việc lưu code của app, tiếp nhận request, ... sau đó sẽ đẩy request sang cho các thread xử lý như đã mô tả ở trên.</p>
<p>Còn đối với cluster mode, trước hết Puma sẽ tạo ra một master process. Từ process này, dựa vào giá trị của config dưới, Puma sẽ <em>fork</em> để tạo ra số process tương ứng, hay còn gọi là <em>worker</em>.</p>
<div class="language-ruby codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-ruby codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token plain">workers ENV.fetch(&quot;WEB_CONCURRENCY&quot;) { 2 }</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Lại nói về fork, đây là quá trình mà 1 process tạo ra 1 process mới, gọi là <em>child process</em>. Mỗi child process đều có process id (PID) riêng biệt, và một môi trường riêng tách biệt hoàn toàn với parent process (source code, memory, stack, ...). Không như thread vẫn share code với process, nhưng có stack, register riêng. Do vậy, có thể nói forking an toàn và bảo mật hơn so với multi-thread.</p>
<p>Quay trở lại với Puma, ở cluster mode, master process chỉ đảm nhận việc tiếp nhận request, sau đó sẽ bắn sang các worker để chúng tự xử với các thread mà chúng spawn. Các worker của Puma đều có 1 bản copy source code app riêng, nên khi chạy nhiều worker, hãy chắc chắn là server của bạn có đủ RAM <!-- -->:v</p>
<p>Ở Ruby, có thể kiểm tra xem app của ta đang chạy ở process nào bằng cách sử dụng</p>
<div class="language-ruby codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-ruby codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token plain">Process.pid  # Current child process</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Process.ppid # Parent process</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Hãy thử ở app Rails của ta xem</p>
<div class="language-ruby codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-ruby codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token plain">class HomesController &lt; ApplicationController</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  def show</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Rails.logger.info(&quot;Current: #{Process.pid}. Parent: #{Process.ppid}&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    head :ok</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-ruby codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-ruby codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token plain"># ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">workers 2</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-log codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-log codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token plain">Processing by HomesController#show as */*</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Current: 128. Parent: 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Processing by HomesController#show as */*</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Current: 129. Parent: 1</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-bash codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-bash codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token plain">ps aux</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># USER       PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># root         1  0.5  7.1 236000 145864 pts/0   Ssl+ 03:28   0:04 puma 5.3.1 (tcp://0.0.0.0:3000) [app]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># root         7  0.0  0.1   3544  3192 pts/1    Ss   03:29   0:00 zsh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># root       128  0.0  6.9 288680 142008 pts/0   Sl+  03:29   0:00 puma: cluster worker 0: 1 [app]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># root       129  0.0  6.9 288720 142116 pts/0   Sl+  03:29   0:00 puma: cluster worker 1: 1 [app]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># root       219  0.0  0.0   1640   856 pts/1    R+   03:40   0:00 ps aux</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_FlIw" id="3-kết-luận">3. Kết luận<a href="#3-kết-luận" class="hash-link" aria-label="Direct link to 3. Kết luận" title="Direct link to 3. Kết luận">​</a></h2>
<p>Cả multi-threading và multi-processing đều quan trọng, chúng góp phần giúp app ta xử lý đc concurrent request. Hy vọng bài viết có thể giúp ích cho các bạn ít nhiều.</p>
<p>Ngoài ra, về vấn đề set số worker và thread ở phần đầu đã nói, tốt nhất chắc vẫn là:</p>
<ul>
<li><code>WEB_CONCURRENCY</code> = vcore, ngoài ra còn phụ thuộc vào RAM nữa</li>
<li><code>RAILS_MAX_THREADS</code> không có con số cụ thể, phụ thuộc vào RAM và CPU, nhiều RAM, CPU khoẻ thì set được càng nhiều, nhưng cũng khá là hên xui, phải tiến hành test rồi mới căn chỉnh con số phù hợp được =))</li>
</ul>
<p>Nếu có sai sót gì các bạn cứ gạch đá thoải mái à <!-- -->:v<!-- --> chi tiết có thể tham khảo ở <a href="https://devcenter.heroku.com/articles/deploying-rails-applications-with-the-puma-web-server#workers" target="_blank" rel="noopener noreferrer">đây</a></p>
<h2 class="anchor anchorWithStickyNavbar_FlIw" id="4-tham-khảo">4. Tham khảo<a href="#4-tham-khảo" class="hash-link" aria-label="Direct link to 4. Tham khảo" title="Direct link to 4. Tham khảo">​</a></h2>
<ul>
<li><a href="https://www.speedshop.co/2015/07/29/scaling-ruby-apps-to-1000-rpm.html" target="_blank" rel="noopener noreferrer">https://www.speedshop.co/2015/07/29/scaling-ruby-apps-to-1000-rpm.html</a></li>
<li><a href="https://devcenter.heroku.com/articles/concurrency-and-database-connections" target="_blank" rel="noopener noreferrer">https://devcenter.heroku.com/articles/concurrency-and-database-connections</a></li>
<li><a href="https://devcenter.heroku.com/articles/deploying-rails-applications-with-the-puma-web-server" target="_blank" rel="noopener noreferrer">https://devcenter.heroku.com/articles/deploying-rails-applications-with-the-puma-web-server</a></li>
<li><a href="http://www.geekride.com/fork-forking-vs-threading-thread-linux-kernel/" target="_blank" rel="noopener noreferrer">http://www.geekride.com/fork-forking-vs-threading-thread-linux-kernel/</a></li>
<li><a href="https://www.studytonight.com/operating-system/multithreading" target="_blank" rel="noopener noreferrer">https://www.studytonight.com/operating-system/multithreading</a></li>
<li><a href="https://www.tutorialspoint.com/how-to-create-a-process-in-linux#:~:text=A%20new%20process%20can%20be,newly%20is%20called%20child%20process" target="_blank" rel="noopener noreferrer">https://www.tutorialspoint.com/how-to-create-a-process-in-linux#:~:text=A%20new%20process%20can%20be,newly%20is%20called%20child%20process</a>.</li>
</ul></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_qmVs padding--none margin-left--sm"><li class="tag_aHj4"><a class="tag_rlZX tagRegular_E7nr" href="/blog/tags/puma">puma</a></li><li class="tag_aHj4"><a class="tag_rlZX tagRegular_E7nr" href="/blog/tags/ruby-on-rails">ruby-on-rails</a></li><li class="tag_aHj4"><a class="tag_rlZX tagRegular_E7nr" href="/blog/tags/multi-threading">multi-threading</a></li><li class="tag_aHj4"><a class="tag_rlZX tagRegular_E7nr" href="/blog/tags/multi-processing">multi-processing</a></li></ul></div></footer></article><nav class="pagination-nav" aria-label="Blog list page navigation"></nav></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs/intro">Tutorial</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Overflow<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_sT5S"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://discordapp.com/invite/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_sT5S"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_sT5S"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/facebook/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_sT5S"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2024 My Project, Inc. Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>