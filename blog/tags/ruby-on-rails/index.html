<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-tags-post-list-page plugin-blog plugin-id-default" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.1.1">
<title data-rh="true">3 posts tagged with &quot;ruby-on-rails&quot; | Welcome to my personal blog | _MoonLight_</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://moonlight8978.github.io/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://moonlight8978.github.io/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://moonlight8978.github.io/blog/tags/ruby-on-rails"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" property="og:title" content="3 posts tagged with &quot;ruby-on-rails&quot; | Welcome to my personal blog | _MoonLight_"><meta data-rh="true" name="docusaurus_tag" content="blog_tags_posts"><meta data-rh="true" name="docsearch:docusaurus_tag" content="blog_tags_posts"><link data-rh="true" rel="icon" href="/favicon.ico"><link data-rh="true" rel="canonical" href="https://moonlight8978.github.io/blog/tags/ruby-on-rails"><link data-rh="true" rel="alternate" href="https://moonlight8978.github.io/blog/tags/ruby-on-rails" hreflang="en"><link data-rh="true" rel="alternate" href="https://moonlight8978.github.io/blog/tags/ruby-on-rails" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Welcome to my personal blog | _MoonLight_ RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Welcome to my personal blog | _MoonLight_ Atom Feed">




<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.24/dist/katex.min.css" integrity="sha384-odtC+0UGzzFL/6PNoE8rX/SPcQDXBJ+uRepguP4QkPCm2LBxH3FA3y+fKSiJ+AmM" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/styles.9709e2f3.css">
<script src="/assets/js/runtime~main.9d85f8d2.js" defer="defer"></script>
<script src="/assets/js/main.2e5390a1.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_pAeB" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/peach-goma-pc-night-keyboard-smashing-sd.gif" alt="Goma smashing his keyboard" class="themedComponent_RIc6 themedComponent--light_aQWN"><img src="/peach-goma-pc-night-keyboard-smashing-sd.gif" alt="Goma smashing his keyboard" class="themedComponent_RIc6 themedComponent--dark_XAeT"></div><b class="navbar__title text--truncate">Home</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/blog">Blog</a><a class="navbar__item navbar__link" href="/docs/intro">Notes</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/facebook/docusaurus" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_sT5S"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_c7W3 colorModeToggle_k_Ia"><button class="clean-btn toggleButton_vdzZ toggleButtonDisabled_T9bY" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_Vd5J"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_Yt2c"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_cTIM"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_jMRO"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_WlgU thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_knSc margin-bottom--md">Recent posts</div><ul class="sidebarItemList_OaoK clean-list"><li class="sidebarItem_gihs"><a class="sidebarItemLink_dDE_" href="/blog/tim-hieu-ve-active-record-encryption">Tìm hiểu về Active Record Encryption</a></li><li class="sidebarItem_gihs"><a class="sidebarItemLink_dDE_" href="/blog/websocket-hoat-dong-nhu-the-nao">WebSocket hoạt động như thế nào?</a></li><li class="sidebarItem_gihs"><a class="sidebarItemLink_dDE_" href="/blog/cung-tim-hieu-ve-puma-ruby-on-rails">Cùng tìm hiểu về Puma (Ruby on Rails)</a></li><li class="sidebarItem_gihs"><a class="sidebarItemLink_dDE_" href="/blog/cuoi-react-native-xem-appium-phan-1-cung-tim-hieu-cach-hoat-dong-cua-appium">Cưỡi React Native xem Appium (Phần 1 - Cùng tìm hiểu cách hoạt động của Appium)</a></li><li class="sidebarItem_gihs"><a class="sidebarItemLink_dDE_" href="/blog/gioi-thieu-ve-kubernetes">Giới thiệu về Kubernetes</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="https://schema.org/Blog"><header class="margin-bottom--xl"><h1>3 posts tagged with &quot;ruby-on-rails&quot;</h1><a href="/blog/tags">View All Tags</a></header><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="https://schema.org/BlogPosting"><meta itemprop="description" content="1. Mở đầu"><header><h2 class="title_DEF8" itemprop="headline"><a itemprop="url" href="/blog/cung-tim-hieu-ve-puma-ruby-on-rails">Cùng tìm hiểu về Puma (Ruby on Rails)</a></h2><div class="container_Y0Yj margin-vert--md"><time datetime="2021-05-31T00:00:00.000Z" itemprop="datePublished">May 31, 2021</time> · <!-- -->11 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_fNYc"><div class="avatar margin-bottom--sm"><a href="https://github.com/moonlight8978" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://avatars.githubusercontent.com/u/26299310?v=4" alt="Lê Sĩ Bích" itemprop="image"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/moonlight8978" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Lê Sĩ Bích</span></a></div><small class="avatar__subtitle" itemprop="description">Ruby on Rails/React Developer</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><h2 class="anchor anchorWithStickyNavbar_FlIw" id="1-mở-đầu">1. Mở đầu<a href="#1-mở-đầu" class="hash-link" aria-label="Direct link to 1. Mở đầu" title="Direct link to 1. Mở đầu">​</a></h2>
<p>Chắc hẳn Puma không phải một cái tên xa lạ đối với mỗi Rails developer, một phần cũng vì đây là appserver mặc định khi tạo mới một project Rails.</p>
<p>Hãy cùng nhìn qua những config cơ bản khi chạy 1 ứng dụng Rails với Puma server. <a href="https://github.com/rails/rails/blob/0f5700ac3589081126fbfde1e4037dc1d4166cce/railties/lib/rails/generators/rails/app/templates/config/puma.rb.tt" target="_blank" rel="noopener noreferrer">link</a></p>
<div class="language-ruby codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-ruby codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token plain">max_threads_count = ENV.fetch(&quot;RAILS_MAX_THREADS&quot;) { 5 }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">min_threads_count = ENV.fetch(&quot;RAILS_MIN_THREADS&quot;) { max_threads_count }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">threads min_threads_count, max_threads_count</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">worker_timeout 3600 if ENV.fetch(&quot;RAILS_ENV&quot;, &quot;development&quot;) == &quot;development&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">port ENV.fetch(&quot;PORT&quot;) { 3000 }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">environment ENV.fetch(&quot;RAILS_ENV&quot;) { &quot;development&quot; }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pidfile ENV.fetch(&quot;PIDFILE&quot;) { &quot;tmp/pids/server.pid&quot; }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">workers ENV.fetch(&quot;WEB_CONCURRENCY&quot;) { 2 }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">preload_app!</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">plugin :tmp_restart</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Đối với những người mới bắt đầu, khi deploy puma, có lẽ sẽ từ chối hiểu đống config trên và set một số biến môi trường như sau:</p>
<ul>
<li><code>WEB_CONCURRENCY</code>: bằng với số lượng vcore/process của máy</li>
<li><code>RAILS_MAX_THREADS</code>: ờ thì nhiều RAM thì set 16, 32 cho oách, không thì thôi dùng mặc định 5 và mặc do dòng đời xô đẩy <!-- -->:v</li>
</ul>
<p>Hãy cùng tìm hiểu thêm về Puma để góp phần làm chủ từng dòng code trong app của chúng ta.</p>
<h2 class="anchor anchorWithStickyNavbar_FlIw" id="2-multi-processing-và-multi-threading">2. Multi-processing và Multi-threading<a href="#2-multi-processing-và-multi-threading" class="hash-link" aria-label="Direct link to 2. Multi-processing và Multi-threading" title="Direct link to 2. Multi-processing và Multi-threading">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_FlIw" id="21-puma-dùng-loại-nào">2.1. Puma dùng loại nào?<a href="#21-puma-dùng-loại-nào" class="hash-link" aria-label="Direct link to 2.1. Puma dùng loại nào?" title="Direct link to 2.1. Puma dùng loại nào?">​</a></h3>
<ul>
<li>Khi chạy 1 Rails app mới tạo, hãy để ý lúc boot server, bạn sẽ thấy:</li>
</ul>
<div class="language-log codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-log codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token plain">Puma starting in single mode...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">* Puma version: 5.3.1 (ruby 3.0.1-p64) (&quot;Sweetnighter&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">*  Min threads: 5</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">*  Max threads: 5</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">*  Environment: development</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">*          PID: 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">* Listening on http://0.0.0.0:3000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Use Ctrl-C to stop</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Đây là dấu hiệu cho ta thấy, Rails đang chạy ở chế độ single process (1 process), và multi-thread (cụ thể là 5 thread)</p>
<ul>
<li>Còn khi config deploy, có thể bạn sẽ được 1 người có kinh nghiệm hơn bảo rằng <em>&quot;Bỏ comment cái dòng <code>workers ENV.fetch(&quot;WEB_CONCURRENCY&quot;) { 2 }</code> đi em êi&quot;</em></li>
</ul>
<p>Và đây là kết quả khi ta làm như vậy</p>
<div class="language-log codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-log codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token plain">[1] Puma starting in cluster mode...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[1] * Puma version: 5.3.1 (ruby 3.0.1-p64) (&quot;Sweetnighter&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[1] *  Min threads: 5</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[1] *  Max threads: 5</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[1] *  Environment: development</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[1] *   Master PID: 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[1] *      Workers: 2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[1] *     Restarts: (���) hot (���) phased</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[1] * Preloading application</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[1] * Listening on htp://0.0.0.0:3000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[1] Use Ctrl-C to stop</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[1] - Worker 0 (PID: 16) booted in 0.02s, phase: 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[1] - Worker 1 (PID: 17) booted in 0.05s, phase: 0</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Puma đang chạy đồng thời multi-process (2 process) và multi-thread (5 thread)</p>
<blockquote>
<p>Multi-process, multi-thread là cái của nợ gì vậy?</p>
</blockquote>
<p>Chúng ta sẽ tìm hiểu về nó ngay sau đây. Tuy nhiên chúng ta sẽ focus vào cluster mode của Puma nhé.</p>
<h3 class="anchor anchorWithStickyNavbar_FlIw" id="22-multi-threading">2.2. Multi-threading<a href="#22-multi-threading" class="hash-link" aria-label="Direct link to 2.2. Multi-threading" title="Direct link to 2.2. Multi-threading">​</a></h3>
<p>Trước tiên ta hãy nhớ lại định nghĩa về <code>process</code> - tiến trình, mỗi khi ta chạy 1 command nào đó (ví dụ như <code>ruby xxx.rb</code> hay bật chrome chẳng hạn), OS sẽ tạo 1 process để xử lý command của ta.</p>
<p>Mỗi <em>process</em> có thể tạo ra nhiều <em>thread</em> để xử lý task (ví dụ mỗi tab chrome được handle bởi 1 thread). Các thread được tạo bởi 1 process sẽ share nhau 1 vùng nhớ (memory), trong shared memory này, mỗi thread sẽ có stack, register (google để biết thêm đống này là gì =)) ) riêng của mình. Tuy nhiên, việc chung đụng memory như trên sẽ dẫn đến 1 vấn đề là nhiều thread cùng chọc tới 1 resource nào đó, dẫn tới conflict về data, hay còn được biết đến với cái tên nguy hiểm hơn là <strong>race condition</strong>. Code của ta sẽ cần <em>thread-safe</em> (các bạn có thể google thêm <!-- -->:v<!-- -->)</p>
<p>Đối với ứng dụng Ruby thì khi chạy ở môi trường MRI... À đấy lại nhắc tới MRI, chắc nhiều người sẽ thắc mắc liệu đó là gì. Đây là tên của 1 Ruby Runtime. Ruby 1 chuẩn spec, implement kiểu gì cũng được, miễn là đáp ứng được spec đó thì đều là Ruby. Có thể kể đến các Runtime phổ biến sau</p>
<ul>
<li>
<p>MRI - aka CRuby: Matz’s Ruby Interpreter (Matz - hay Matsumoto Yukihiro) là người tạo ra runtime này, được viết bằng C, nên còn gọi là CRuby</p>
<p>Đa số là dùng MRI</p>
</li>
<li>
<p>JRuby: Ruby implement bằng Java</p>
</li>
<li>
<p>Rubinius</p>
</li>
<li>
<p>mruby</p>
</li>
<li>
<p>...</p>
</li>
</ul>
<p>MRI có 1 cơ chế là <strong>Global Interpreter Lock</strong> (GIL), khi chạy multi-thread, nó chỉ cho phép 1 thread chạy source code Ruby tại 1 thời điểm, nên là ta có nhiều thread đi chăng nữa thì cũng chỉ có 1 thread được chạy mà thôi.</p>
<p>Tuy nhiên với các thao tác IO như đọc DB, request external resource, đọc ghi file, ... thì GIL không block. Puma đã tận dụng điều này, khi 1 thread đang xử lý IO, nó sẽ quay trở lại xử lý ở process, nhận thêm các request khác để xử lý.</p>
<p>Chính vì vậy, ngay cả khi chỉ chạy ở single mode, Puma vẫn có thể handle được concurrent request. Tuy nhiên với các request cần thời gian dài để xử lý, do chỉ có 1 thread được chạy, nên request sau sẽ phải chờ request trước xử lý xong, dẫn đến Puma bị thọt trong trường hợp này.</p>
<p>Ta có thể kiểm tra về trạng thái các thread của Puma bằng đoạn code sau:</p>
<div class="language-ruby codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-ruby codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token plain">class HomesController &lt; ApplicationController</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  def show</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Thread.list.select { |t| t.name&amp;.match?(/puma threadpool \d+/) }.each do |t|</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Rails.logger.info(&quot;Thread #{t.name}: #{t.status}, alive: #{t.alive?}, current: #{t == Thread.current}&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    head :ok</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Vì sao lại là <code>/puma threadpool \d+/</code>? Các bạn có thể xem tại <a href="https://github.com/puma/puma/blob/3e80f7c704e5585da4faa32edf0fa7a0abed3689/lib/puma/thread_pool.rb#L104" target="_blank" rel="noopener noreferrer">đây</a>.</p>
<div class="language-ruby codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-ruby codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token plain">Rails.application.routes.draw do</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  resource :home</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-ruby codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-ruby codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token plain">max_threads_count = ENV.fetch(&#x27;RAILS_MAX_THREADS&#x27;, 5)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">min_threads_count = ENV.fetch(&#x27;RAILS_MIN_THREADS&#x27;) { max_threads_count }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">threads min_threads_count, max_threads_count</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">worker_timeout 3600 if ENV.fetch(&#x27;RAILS_ENV&#x27;, &#x27;development&#x27;) == &#x27;development&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">port ENV.fetch(&#x27;PORT&#x27;, 3000)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">environment ENV.fetch(&#x27;RAILS_ENV&#x27;, &#x27;development&#x27;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pidfile ENV.fetch(&#x27;PIDFILE&#x27;, &#x27;tmp/pids/server.pid&#x27;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">plugin :tmp_restart</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-curl codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-curl codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token plain">curl http://localhost:3000/home</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tail -n 50 log/development.log</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Và đây là output:</p>
<div class="language-log codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-log codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token plain">Thread puma threadpool 001: sleep, alive: true, current: false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Thread puma threadpool 002: sleep, alive: true, current: false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Thread puma threadpool 003: sleep, alive: true, current: false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Thread puma threadpool 004: sleep, alive: true, current: false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Thread puma threadpool 005: run, alive: true, current: true</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Đó chính là 5 thread của chúng ta, như ví dụ là thread 5 đang tiến hành xử lý request, còn những thread khác nếu rảnh nó sẽ ở trạng thái <code>sleep</code>. Ở đây có 1 điểm đáng chú ý là sau khi kết thúc request, thread không bị kill mà chỉ về trạng thái <code>sleep</code>, do vậy nếu ta tuỳ tiện modify biến global, nó sẽ ảnh hưởng tới request tiếp theo mà thread đó handle.</p>
<p>Ví dụ:</p>
<div class="language-ruby codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-ruby codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token plain">before_action :set_locale</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">def set_locale</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  I18n.locale = params[:locale] || I18n.default_locale</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Không cần biết code cái gì, nhưng modify 1 biến global tại runtime như trên là đã thấy nguy hiểm rồi. Và ta hãy tiến hành test xem</p>
<div class="language-ruby codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-ruby codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token plain">class HomesController &lt; ApplicationController</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  def show</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Thread.current.tap { |t| Rails.logger.info(&quot;Current thread #{t.name}: #{t.status}, alive: #{t.alive?}&quot;) }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Rails.logger.info(&quot;Before: #{I18n.locale}&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    I18n.locale = params[:locale]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Rails.logger.info(&quot;After: #{I18n.locale}&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    head :ok</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>rồi sau đó spam khoảng chục cái request</p>
<div class="language-bash codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-bash codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token plain">curl http://localhost:3000/home?locale=vi</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>và ta sẽ thấy kết quả như sau</p>
<div class="language-log codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-log codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token plain">Current thread puma threadpool 003: run, alive: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Before: en</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">After: vi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Current thread puma threadpool 003: run, alive: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Before: vi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">After: vi</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Có thể dễ dàng nhận ra rằng việc set <code>I18n.locale = &quot;vi&quot;</code> ở request trước đã bị leak sang request sau. Nếu ở tất cả các request, trước khi xử lý ta đều set <code>I18n.locale</code> thì việc leak trên sẽ ít ảnh hưởng hơn.</p>
<p>Tuy nhiên hãy thử tưởng tượng khi app của bạn có chứa cả code admin và api, bên admin có thể đổi ngôn ngữ, còn api thì không, thì kết quả sẽ ra sao. Khi admin đổi ngôn ngữ, tình cờ, 1 user vô phúc nào đó request tới trúng cái thread vừa handle việc admin đổi ngôn ngữ, và API sẽ trả về locale của ông admin kia <!-- -->:v</p>
<p>Chính vì vậy, ở docs của Rails cũng có recommend chúng ta xử lý chuyển locale bằng <code>I18n.with_locale</code>, các bạn có thể xem tại <a href="https://guides.rubyonrails.org/i18n.html#managing-the-locale-across-requests" target="_blank" rel="noopener noreferrer">đây</a></p>
<div class="language-ruby codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-ruby codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token plain">around_action :switch_locale</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">def switch_locale(&amp;action)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  locale = params[:locale] || I18n.default_locale</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  I18n.with_locale(locale, &amp;action)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Túm váy lại là multi-threading hỗ trợ concurrent rất tốt, tuy nhiên cũng ẩn chứa 1 vài vấn đề. Nên sẽ cần chú ý hơn khi code.</p>
<h3 class="anchor anchorWithStickyNavbar_FlIw" id="23-multi-processing">2.3. Multi-processing<a href="#23-multi-processing" class="hash-link" aria-label="Direct link to 2.3. Multi-processing" title="Direct link to 2.3. Multi-processing">​</a></h3>
<p>Máy tính hiện nay đa số đều có khá nhiều core, và đều hỗ trợ đa nhiệm để tối ưu hoá việc xử lý song song. Vậy với webserver thì sao? Có cần chứ, multi-processing giúp ta có thể xử lý thêm nhiều request đồng thời hơn nữa. Trừ khi server của ta quá yếu, chứ không thì tội gì, nhà chả có gì ngoài core mà lại chạy đơn nhân thì phí của giời quá <!-- -->:v</p>
<p>Mặc định Puma sẽ chạy ở single mode, khi đó chỉ có 1 process, process này sẽ đảm nhận hết từ việc lưu code của app, tiếp nhận request, ... sau đó sẽ đẩy request sang cho các thread xử lý như đã mô tả ở trên.</p>
<p>Còn đối với cluster mode, trước hết Puma sẽ tạo ra một master process. Từ process này, dựa vào giá trị của config dưới, Puma sẽ <em>fork</em> để tạo ra số process tương ứng, hay còn gọi là <em>worker</em>.</p>
<div class="language-ruby codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-ruby codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token plain">workers ENV.fetch(&quot;WEB_CONCURRENCY&quot;) { 2 }</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Lại nói về fork, đây là quá trình mà 1 process tạo ra 1 process mới, gọi là <em>child process</em>. Mỗi child process đều có process id (PID) riêng biệt, và một môi trường riêng tách biệt hoàn toàn với parent process (source code, memory, stack, ...). Không như thread vẫn share code với process, nhưng có stack, register riêng. Do vậy, có thể nói forking an toàn và bảo mật hơn so với multi-thread.</p>
<p>Quay trở lại với Puma, ở cluster mode, master process chỉ đảm nhận việc tiếp nhận request, sau đó sẽ bắn sang các worker để chúng tự xử với các thread mà chúng spawn. Các worker của Puma đều có 1 bản copy source code app riêng, nên khi chạy nhiều worker, hãy chắc chắn là server của bạn có đủ RAM <!-- -->:v</p>
<p>Ở Ruby, có thể kiểm tra xem app của ta đang chạy ở process nào bằng cách sử dụng</p>
<div class="language-ruby codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-ruby codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token plain">Process.pid  # Current child process</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Process.ppid # Parent process</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Hãy thử ở app Rails của ta xem</p>
<div class="language-ruby codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-ruby codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token plain">class HomesController &lt; ApplicationController</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  def show</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Rails.logger.info(&quot;Current: #{Process.pid}. Parent: #{Process.ppid}&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    head :ok</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-ruby codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-ruby codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token plain"># ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">workers 2</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-log codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-log codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token plain">Processing by HomesController#show as */*</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Current: 128. Parent: 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Processing by HomesController#show as */*</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Current: 129. Parent: 1</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-bash codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-bash codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token plain">ps aux</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># USER       PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># root         1  0.5  7.1 236000 145864 pts/0   Ssl+ 03:28   0:04 puma 5.3.1 (tcp://0.0.0.0:3000) [app]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># root         7  0.0  0.1   3544  3192 pts/1    Ss   03:29   0:00 zsh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># root       128  0.0  6.9 288680 142008 pts/0   Sl+  03:29   0:00 puma: cluster worker 0: 1 [app]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># root       129  0.0  6.9 288720 142116 pts/0   Sl+  03:29   0:00 puma: cluster worker 1: 1 [app]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># root       219  0.0  0.0   1640   856 pts/1    R+   03:40   0:00 ps aux</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_FlIw" id="3-kết-luận">3. Kết luận<a href="#3-kết-luận" class="hash-link" aria-label="Direct link to 3. Kết luận" title="Direct link to 3. Kết luận">​</a></h2>
<p>Cả multi-threading và multi-processing đều quan trọng, chúng góp phần giúp app ta xử lý đc concurrent request. Hy vọng bài viết có thể giúp ích cho các bạn ít nhiều.</p>
<p>Ngoài ra, về vấn đề set số worker và thread ở phần đầu đã nói, tốt nhất chắc vẫn là:</p>
<ul>
<li><code>WEB_CONCURRENCY</code> = vcore, ngoài ra còn phụ thuộc vào RAM nữa</li>
<li><code>RAILS_MAX_THREADS</code> không có con số cụ thể, phụ thu  ộc vào RAM và CPU, nhiều RAM, CPU khoẻ thì set được càng nhiều, nhưng cũng khá là hên xui, phải tiến hành test rồi mới căn chỉnh con số phù hợp được =))</li>
</ul>
<p>Nếu có sai sót gì các bạn cứ gạch đá thoải mái à <!-- -->:v<!-- --> chi tiết có thể tham khảo ở <a href="https://devcenter.heroku.com/articles/deploying-rails-applications-with-the-puma-web-server#workers" target="_blank" rel="noopener noreferrer">đây</a></p>
<h2 class="anchor anchorWithStickyNavbar_FlIw" id="4-tham-khảo">4. Tham khảo<a href="#4-tham-khảo" class="hash-link" aria-label="Direct link to 4. Tham khảo" title="Direct link to 4. Tham khảo">​</a></h2>
<ul>
<li><a href="https://www.speedshop.co/2015/07/29/scaling-ruby-apps-to-1000-rpm.html" target="_blank" rel="noopener noreferrer">https://www.speedshop.co/2015/07/29/scaling-ruby-apps-to-1000-rpm.html</a></li>
<li><a href="https://devcenter.heroku.com/articles/concurrency-and-database-connections" target="_blank" rel="noopener noreferrer">https://devcenter.heroku.com/articles/concurrency-and-database-connections</a></li>
<li><a href="https://devcenter.heroku.com/articles/deploying-rails-applications-with-the-puma-web-server" target="_blank" rel="noopener noreferrer">https://devcenter.heroku.com/articles/deploying-rails-applications-with-the-puma-web-server</a></li>
<li><a href="http://www.geekride.com/fork-forking-vs-threading-thread-linux-kernel/" target="_blank" rel="noopener noreferrer">http://www.geekride.com/fork-forking-vs-threading-thread-linux-kernel/</a></li>
<li><a href="https://www.studytonight.com/operating-system/multithreading" target="_blank" rel="noopener noreferrer">https://www.studytonight.com/operating-system/multithreading</a></li>
<li><a href="https://www.tutorialspoint.com/how-to-create-a-process-in-linux#:~:text=A%20new%20process%20can%20be,newly%20is%20called%20child%20process" target="_blank" rel="noopener noreferrer">https://www.tutorialspoint.com/how-to-create-a-process-in-linux#:~:text=A%20new%20process%20can%20be,newly%20is%20called%20child%20process</a>.</li>
</ul></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_qmVs padding--none margin-left--sm"><li class="tag_aHj4"><a class="tag_rlZX tagRegular_E7nr" href="/blog/tags/puma">puma</a></li><li class="tag_aHj4"><a class="tag_rlZX tagRegular_E7nr" href="/blog/tags/ruby-on-rails">ruby-on-rails</a></li><li class="tag_aHj4"><a class="tag_rlZX tagRegular_E7nr" href="/blog/tags/multi-threading">multi-threading</a></li><li class="tag_aHj4"><a class="tag_rlZX tagRegular_E7nr" href="/blog/tags/multi-processing">multi-processing</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="https://schema.org/BlogPosting"><meta itemprop="description" content="Rails 6 đã bước vào giai đoạn beta với phiên bản v6.0.0.rc1. RC là viết tắt của Release Candidate, đây là phiên bản mà có xác suất trở thành final release rất cao. Ta có thể áp dụng nó vào dự án ngay kể từ bây giờ mà không cần lo sợ có những breaking change."><header><h2 class="title_DEF8" itemprop="headline"><a itemprop="url" href="/blog/cung-tim-hieu-ve-actiontext-trong-rails-6">Cùng tìm hiểu về ActionText trong Rails 6</a></h2><div class="container_Y0Yj margin-vert--md"><time datetime="2019-07-20T00:00:00.000Z" itemprop="datePublished">July 20, 2019</time> · <!-- -->11 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_fNYc"><div class="avatar margin-bottom--sm"><a href="https://github.com/moonlight8978" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://avatars.githubusercontent.com/u/26299310?v=4" alt="Lê Sĩ Bích" itemprop="image"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/moonlight8978" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Lê Sĩ Bích</span></a></div><small class="avatar__subtitle" itemprop="description">Ruby on Rails/React Developer</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>Rails 6 đã bước vào giai đoạn beta với phiên bản <a href="https://github.com/rails/rails/releases/tag/v6.0.0.rc1" target="_blank" rel="noopener noreferrer">v6.0.0.rc1</a>. RC là viết tắt của <strong>R</strong>elease <strong>C</strong>andidate, đây là phiên bản mà có xác suất trở thành final release rất cao. Ta có thể áp dụng nó vào dự án ngay kể từ bây giờ mà không cần lo sợ có những breaking change.</p>
<p>Nếu bạn sử dụng Docker, mình khuyên nên sử dụng ruby 2.6.3, vì trước đây mình đã dùng thử ruby:2.7.0-preview1-alpine3.10 thì khá nhiều lỗi khi up server, mà chả biết phải fix sao :sad:</p>
<p>Ở Rails 6, có khá nhiều tính năng mới hay ho:</p>
<ul>
<li>Action Text</li>
<li>Parallel Testing</li>
<li>Action Model custom error message format.</li>
<li>vân vân mây mây...</li>
</ul>
<p>Ở bài này, mình sẽ chỉ tập trung đề cập tới Action Text. Đây là một package giúp ta xây dựng WYSIWYG editor một cách nhanh chóng, hơn nữa, việc upload cũng được integrate với Active Storage.</p>
<p><strong>Chú ý:</strong> Bài khá dài và embed nhiều code <!-- -->:v</p>
<h1>Cách dùng</h1>
<h2 class="anchor anchorWithStickyNavbar_FlIw" id="cài-đặt-và-sử-dụng">Cài đặt và sử dụng<a href="#cài-đặt-và-sử-dụng" class="hash-link" aria-label="Direct link to Cài đặt và sử dụng" title="Direct link to Cài đặt và sử dụng">​</a></h2>
<p>Vì là Rails nên cách sử dụng rất đơn giản, nhưng ta sẽ chả biết nó chạy cái gì đằng sau cả =))</p>
<p>Cài đặt Action Text bằng CLI command sau:</p>
<div class="language-bash codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-bash codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token plain">rails action_text:install</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Nhớ hãy chạy thêm cả command install Active Storage nữa.</p>
<div class="language-bash codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-bash codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token plain">rails active_storage:install</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Để áp dụng cho field <code>content</code> của model <code>Post</code>, ta sẽ dùng tới macro <code>has_rich_text</code></p>
<div class="language-ruby codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-ruby codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token plain">class CreatePosts &lt; ActiveRecord::Migration[6.0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  def change</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    create_table :posts do |t|</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      t.string :content</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      t.string :category</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      t.timestamps</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><code>content</code> ở đây mình dùng string, nhưng khuyến khích dùng text hơn.</p>
<div class="language-ruby codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-ruby codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token plain">class Post &lt; ApplicationRecord</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	has_rich_text :content</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Trên form, ta chỉ việc dùng <code>rich_text_area</code></p>
<div class="language-erb codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-erb codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token plain">&lt;%= form_with(model: @post) do |form| %&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &lt;div class=&quot;field&quot;&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &lt;%= form.label :content %&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &lt;%= form.rich_text_area :content %&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &lt;/div&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&lt;% end %&gt;</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Khi permit params, ta cũng làm như bao field khác</p>
<div class="language-ruby codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-ruby codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class PostsController &lt; ApplicationController</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  def post_params</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    params.require(:post).permit(:category, :content)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Cuối cùng ta hiển thị dữ liệu như sau:</p>
<div class="language-erb codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-erb codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token plain">&lt;%= @post.content %&gt;</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Câu lệnh trên thực chất đang ngầm gọi tới <code>@post.content.to_s</code></p>
<p>Đây là sản phẩm của ta:</p>
<p>Form tạo post với WYSIWYG editor - Sử dụng Trix editor, do Basecamp phát triển, cây nhà lá vườn luôn.</p>
<p>Có thể kéo thả file vào, file đó sẽ được upload bằng Active Storage.</p>
<p><img decoding="async" loading="lazy" src="https://images.viblo.asia/77b9bd23-5ba3-426b-b6fc-cac02edb0b42.png" alt="" class="img_XBWr"></p>
<p>Hiển thị dữ liệu ở màn hình detail</p>
<p><img decoding="async" loading="lazy" src="https://images.viblo.asia/6b1b8da0-ca7f-468b-9705-444a8cb2d736.png" alt="" class="img_XBWr"></p>
<p>Các bạn thấy sao? Cá nhân mình thấy xấu như cờ hó vậy =)) Tuy nhiên ta có thể styling cho nó.</p>
<h2 class="anchor anchorWithStickyNavbar_FlIw" id="styling">Styling<a href="#styling" class="hash-link" aria-label="Direct link to Styling" title="Direct link to Styling">​</a></h2>
<p>Rails đang có sẵn một vài style cơ bản cho nó trong file <code>app/assets/stylesheets/actiontext.scss</code>, ta có thể sửa nó để cho đẹp hơn.</p>
<p>Với đống tool của editor thì có thể dùng selector <code>.trix-button-row</code></p>
<p>Với template attachment (như cái <code>monaco.ttf</code> ở trên), ta cũng có thể custom lại, Rails cung cấp sẵn template mặc định ở file <code>app/views/active_storage/blobs/_blob.html.erb</code></p>
<h1>Tìm hiểu sự ma giáo</h1>
<p>Rồi ta đã lướt qua cách sử dụng nó, nhưng mà có quá nhiều magic.</p>
<p>Liệu bạn có tự đặt ra những câu hỏi thế này hay không?</p>
<ul>
<li>
<p>Không biết cách lưu trữ dữ liệu của nó như thế nào?</p>
</li>
<li>
<p>Làm sao mà cái file trong kia integrate được với Active Storage?</p>
</li>
<li>
<p>Vì sao lại có thể custom lại những attachment bằng template?</p>
</li>
<li>
<p>vân vân mây mây...</p>
</li>
</ul>
<p>Ta sẽ bắt tay vào tìm hiểu nó.</p>
<p>Hãy bắt đầu với <code>has_rich_text</code></p>
<h2 class="anchor anchorWithStickyNavbar_FlIw" id="macro-has_rich_text">Macro <code>has_rich_text</code><a href="#macro-has_rich_text" class="hash-link" aria-label="Direct link to macro-has_rich_text" title="Direct link to macro-has_rich_text">​</a></h2>
<div class="language-ruby codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-ruby codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token plain"># https://github.com/rails/rails/blob/6a5c8b91998c56e50b5cc934d968947cd319f735/actiontext/lib/action_text/attribute.rb#L26</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">def has_rich_text(name)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  class_eval &lt;&lt;-CODE, __FILE__, __LINE__ + 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def #{name}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      rich_text_#{name} || build_rich_text_#{name}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def #{name}=(body)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      self.#{name}.body = body</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  CODE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  has_one :&quot;rich_text_#{name}&quot;, -&gt; { where(name: name) },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    class_name: &quot;ActionText::RichText&quot;, as: :record, inverse_of: :record, autosave: true, dependent: :destroy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  # ... codes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Dễ dàng thấy rằng đây là 1 macro giúp định nghĩa getter, setter, và cả association <code>has_one :rich_text_...</code> với <code>ActionText::RichText</code>.</p>
<p>Vậy thì khi ta gọi <code>@post.content</code>, thực chất là ta đang gọi tới <code>@post.rich_text_content</code>.</p>
<p>Và nó cũng chỉ ra 1 điều nữa là Rails dùng 1 bảng riêng để lưu lại đống rich text của ta.</p>
<p>Hãy dành chút thời gian nhìn vào thư mục <code>db/migrate</code>, ta sẽ thấy file sau:</p>
<div class="language-ruby codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-ruby codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token plain"># db/migrate/20190718085159_create_action_text_tables.action_text.rb</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># This migration comes from action_text (originally 20180528164100)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class CreateActionTextTables &lt; ActiveRecord::Migration[6.0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  def change</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    create_table :action_text_rich_texts do |t|</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      t.string     :name, null: false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      t.text       :body, size: :long</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      t.references :record, null: false, polymorphic: true, index: false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      t.timestamps</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      t.index [ :record_type, :record_id, :name ], name: &quot;index_action_text_rich_texts_uniqueness&quot;, unique: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Quả thật là vậy, <code>body</code> chính là nơi lưu trữ đống text của ta, còn <code>name</code>, <code>record_id</code>, và <code>record_type</code> là những attribute cho polymorphic association, khá quen thuộc nếu bạn đã dùng Active storage</p>
<p>Ta sẽ đi đến bước tiếp theo <code>rich_text_area</code></p>
<h2 class="anchor anchorWithStickyNavbar_FlIw" id="rails-xử-lý-lưu-trữ-rich-text-như-thế-nào">Rails xử lý, lưu trữ rich text như thế nào?<a href="#rails-xử-lý-lưu-trữ-rich-text-như-thế-nào" class="hash-link" aria-label="Direct link to Rails xử lý, lưu trữ rich text như thế nào?" title="Direct link to Rails xử lý, lưu trữ rich text như thế nào?">​</a></h2>
<div class="language-ruby codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-ruby codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token plain"># https://github.com/rails/rails/blob/cc1a5d5620c4cd952b27f6c1bbd16d8780a34d0e/actiontext/app/helpers/action_text/tag_helper.rb#L20</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">def rich_text_area_tag(name, value = nil, options = {})</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  options = options.symbolize_keys</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  options[:input] ||= &quot;trix_input_#{ActionText::TagHelper.id += 1}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  options[:class] ||= &quot;trix-content&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  options[:data] ||= {}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  options[:data][:direct_upload_url] = main_app.rails_direct_uploads_url</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  options[:data][:blob_url_template] = main_app.rails_service_blob_url(&quot;:signed_id&quot;, &quot;:filename&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  editor_tag = content_tag(&quot;trix-editor&quot;, &quot;&quot;, options)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  input_tag = hidden_field_tag(name, value, id: options[:input])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  input_tag + editor_tag</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Có thể thấy đơn giản nó chỉ init cái trix editor cho ta thôi.</p>
<p>Việc kéo thả file, upload hoàn toàn được handle bởi trix editor, ta không custom được template sau khi file upload thành công.</p>
<p>Tuy nhiên Action Text có thêm 1 callback sau khi file được upload thành công:</p>
<div class="language-javascript codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-javascript codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// https://github.com/rails/rails/blob/cc1a5d5620c4cd952b27f6c1bbd16d8780a34d0e/actiontext/app/javascript/actiontext/attachment_upload.js#L26</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">attachment</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">setAttributes</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">sgid</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> attributes</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">attachable_sgid</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">url</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">createBlobUrl</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">attributes</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">signed_id</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> attributes</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">filename</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>đây là 1 step rất quan trọng, nhưng ta sẽ chưa cần chú ý tới nó vội. Attachment của ta sau khi upload thành công sẽ trông như sau:</p>
<div class="language-html codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-html codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">figure</span><span class="token tag" style="color:#00009f"></span><br></span><span class="token-line" style="color:#393A34"><span class="token tag" style="color:#00009f">  </span><span class="token tag attr-name" style="color:#00a4db">contenteditable</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">false</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"></span><br></span><span class="token-line" style="color:#393A34"><span class="token tag" style="color:#00009f">  </span><span class="token tag attr-name" style="color:#00a4db">data-trix-attachment</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&#x27;</span><span class="token tag attr-value" style="color:#e3116c">{&quot;contentType&quot;:&quot;application/zip&quot;,&quot;filename&quot;:&quot;monaco.ttf-master.zip&quot;,&quot;filesize&quot;:88996,&quot;sgid&quot;:&quot;BAh7CEkiCGdpZAY6BkVUSSIvZ2lkOi8vYXBwL0FjdGl2ZVN0b3JhZ2U6OkJsb2IvOD9leHBpcmVzX2luBjsAVEkiDHB1cnBvc2UGOwBUSSIPYXR0YWNoYWJsZQY7AFRJIg9leHBpcmVzX2F0BjsAVDA=--79d2aa5a0af367233a5420a4f0ae02657d3910ab&quot;,&quot;url&quot;:&quot;http://localhost:60100/rails/active_storage/blobs/eyJfcmFpbHMiOnsibWVzc2FnZSI6IkJBaHBEUT09IiwiZXhwIjpudWxsLCJwdXIiOiJibG9iX2lkIn19--e79bebbfa0f10319d319411c129291d12e752d22/monaco.ttf-master.zip&quot;}</span><span class="token tag attr-value punctuation" style="color:#393A34">&#x27;</span><span class="token tag" style="color:#00009f"></span><br></span><span class="token-line" style="color:#393A34"><span class="token tag" style="color:#00009f">  </span><span class="token tag attr-name" style="color:#00a4db">data-trix-content-type</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">application/zip</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"></span><br></span><span class="token-line" style="color:#393A34"><span class="token tag" style="color:#00009f">  </span><span class="token tag attr-name" style="color:#00a4db">data-trix-id</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">1108</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"></span><br></span><span class="token-line" style="color:#393A34"><span class="token tag" style="color:#00009f">  </span><span class="token tag attr-name" style="color:#00a4db">class</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">attachment attachment--file attachment--zip</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"></span><br></span><span class="token-line" style="color:#393A34"><span class="token tag" style="color:#00009f"></span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">figcaption</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">class</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">attachment__caption</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">span</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">class</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">attachment__name</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">monaco.ttf-master.zip</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">span</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">span</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">class</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">attachment__size</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">86.91 KB</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">span</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">figcaption</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">figure</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Tiếp đến là submit dữ liệu, vậy Rails sẽ gửi gì lên?</p>
<p>Đơn giản là Rails sẽ gửi tất cả những gì bên trong <code>&lt;trix-editor&gt;&lt;/trix-editor&gt;</code></p>
<p>Inspect thử params, ta sẽ thấy:</p>
<div class="language-ruby codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-ruby codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token plain">post_params[:content]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># =&gt; &quot;&lt;div&gt;&lt;a href=\&quot;http://localhost:60100/posts/new\&quot;&gt;http://localhost:60100/posts/new&lt;/a&gt;&lt;/div&gt;&lt;div&gt;&lt;strong&gt;Hello world&lt;br&gt;&lt;/strong&gt;&lt;figure data-trix-attachment=\&quot;{&amp;quot;content&amp;quot;:&amp;quot;&lt;figure class=\\&amp;quot;attachment attachment--file attachment--zip\\&amp;quot;&gt;\\n\\n  &lt;figcaption class=\\&amp;quot;attachment__caption\\&amp;quot;&gt;\\n      &lt;span class=\\&amp;quot;attachment__name\\&amp;quot;&gt;monaco.ttf-master.zip&lt;/span&gt;\\n      &lt;span class=\\&amp;quot;attachment__size\\&amp;quot;&gt;86.9 KB&lt;/span&gt;\\n  &lt;/figcaption&gt;\\n&lt;/figure&gt;\\n&amp;quot;,&amp;quot;contentType&amp;quot;:&amp;quot;application/zip&amp;quot;,&amp;quot;filename&amp;quot;:&amp;quot;monaco.ttf-master.zip&amp;quot;,&amp;quot;filesize&amp;quot;:88996,&amp;quot;sgid&amp;quot;:&amp;quot;BAh7CEkiCGdpZAY6BkVUSSIvZ2lkOi8vYXBwL0FjdGl2ZVN0b3JhZ2U6OkJsb2IvNz9leHBpcmVzX2luBjsAVEkiDHB1cnBvc2UGOwBUSSIPYXR0YWNoYWJsZQY7AFRJIg9leHBpcmVzX2F0BjsAVDA=--97b885c24fd3d87464525f34a7b6ea117e4c72e6&amp;quot;,&amp;quot;url&amp;quot;:&amp;quot;http://localhost:60100/rails/active_storage/blobs/eyJfcmFpbHMiOnsibWVzc2FnZSI6IkJBaHBEQT09IiwiZXhwIjpudWxsLCJwdXIiOiJibG9iX2lkIn19--940badfc5aee704ef3f98085f87f909baf870660/monaco.ttf-master.zip&amp;quot;}\&quot; data-trix-content-type=\&quot;application/zip\&quot; class=\&quot;attachment attachment--content attachment--zip\&quot;&gt;&lt;figure class=\&quot;attachment attachment--file attachment--zip\&quot;&gt;\r\n\r\n  &lt;figcaption class=\&quot;attachment__caption\&quot;&gt;\r\n      &lt;span class=\&quot;attachment__name\&quot;&gt;monaco.ttf-master.zip&lt;/span&gt;\r\n      &lt;span class=\&quot;attachment__size\&quot;&gt;86.9 KB&lt;/span&gt;\r\n  &lt;/figcaption&gt;\r\n&lt;/figure&gt;\r\n&lt;figcaption class=\&quot;attachment__caption\&quot;&gt;&lt;/figcaption&gt;&lt;/figure&gt;&lt;/div&gt;&quot;</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Làm đẹp nó chút</p>
<div class="language-html codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-html codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">div</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">a</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">href</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">http://localhost:60100/posts/new</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"></span><br></span><span class="token-line" style="color:#393A34"><span class="token tag" style="color:#00009f">    </span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">http://localhost:60100/posts/new</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">a</span><span class="token tag" style="color:#00009f"></span><br></span><span class="token-line" style="color:#393A34"><span class="token tag" style="color:#00009f">  </span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">div</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">div</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">strong</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">Hello world</span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">br</span><span class="token tag" style="color:#00009f"> </span><span class="token tag punctuation" style="color:#393A34">/&gt;</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">strong</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">figure</span><span class="token tag" style="color:#00009f"></span><br></span><span class="token-line" style="color:#393A34"><span class="token tag" style="color:#00009f">    </span><span class="token tag attr-name" style="color:#00a4db">data-trix-attachment</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">...</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"></span><br></span><span class="token-line" style="color:#393A34"><span class="token tag" style="color:#00009f">    </span><span class="token tag attr-name" style="color:#00a4db">data-trix-content-type</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">application/zip</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"></span><br></span><span class="token-line" style="color:#393A34"><span class="token tag" style="color:#00009f">    </span><span class="token tag attr-name" style="color:#00a4db">class</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">attachment attachment--content attachment--zip</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"></span><br></span><span class="token-line" style="color:#393A34"><span class="token tag" style="color:#00009f">  </span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">figure</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">class</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">attachment attachment--file attachment--zip</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">figcaption</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">class</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">attachment__caption</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">span</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">class</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">attachment__name</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">monaco.ttf-master.zip</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">span</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">span</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">class</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">attachment__size</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">86.9 KB</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">span</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">figcaption</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">figure</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">figcaption</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">class</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">attachment__caption</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">figcaption</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">figure</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">div</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Có thể thấy nó khá giống với content của <code>&lt;trix-editor&gt;&lt;/trix-editor&gt;</code> đúng không nào?</p>
<p>Ta sẽ save đống params này lại, và xem DB ta chứa gì?</p>
<div class="language-sql codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-sql codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token plain">app_development</span><span class="token operator" style="color:#393A34">=</span><span class="token comment" style="color:#999988;font-style:italic"># SELECT body FROM action_text_rich_texts WHERE id = 3;</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-html codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-html codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">div</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">a</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">href</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">http://localhost:60100/posts/new</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"></span><br></span><span class="token-line" style="color:#393A34"><span class="token tag" style="color:#00009f">    </span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">http://localhost:60100/posts/new</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">a</span><span class="token tag" style="color:#00009f"></span><br></span><span class="token-line" style="color:#393A34"><span class="token tag" style="color:#00009f">  </span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">div</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">div</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">strong</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">Hello world</span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">br</span><span class="token tag" style="color:#00009f"> </span><span class="token tag punctuation" style="color:#393A34">/&gt;</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">strong</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">action-text-attachment</span><span class="token tag" style="color:#00009f"></span><br></span><span class="token-line" style="color:#393A34"><span class="token tag" style="color:#00009f">    </span><span class="token tag attr-name" style="color:#00a4db">sgid</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">BAh7CEkiCGdpZAY6BkVUSSIvZ2lkOi8vYXBwL0FjdGl2ZVN0b3JhZ2U6OkJsb2IvNz9leHBpcmVzX2luBjsAVEkiDHB1cnBvc2UGOwBUSSIPYXR0YWNoYWJsZQY7AFRJIg9leHBpcmVzX2F0BjsAVDA=--97b885c24fd3d87464525f34a7b6ea117e4c72e6</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"></span><br></span><span class="token-line" style="color:#393A34"><span class="token tag" style="color:#00009f">    </span><span class="token tag attr-name" style="color:#00a4db">content-type</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">application/zip</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"></span><br></span><span class="token-line" style="color:#393A34"><span class="token tag" style="color:#00009f">    </span><span class="token tag attr-name" style="color:#00a4db">url</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">http://localhost:60100/rails/active_storage/blobs/eyJfcmFpbHMiOnsibWVzc2FnZSI6IkJBaHBEQT09IiwiZXhwIjpudWxsLCJwdXIiOiJibG9iX2lkIn19--940badfc5aee704ef3f98085f87f909baf870660/monaco.ttf-master.zip</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"></span><br></span><span class="token-line" style="color:#393A34"><span class="token tag" style="color:#00009f">    </span><span class="token tag attr-name" style="color:#00a4db">filename</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">monaco.ttf-master.zip</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"></span><br></span><span class="token-line" style="color:#393A34"><span class="token tag" style="color:#00009f">    </span><span class="token tag attr-name" style="color:#00a4db">filesize</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">88996</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"></span><br></span><span class="token-line" style="color:#393A34"><span class="token tag" style="color:#00009f">  </span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">action-text-attachment</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">div</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Các thẻ khác thì vẫn vậy, tuy nhiên attachments của ta lại có một chút khác biệt. Ở đây đống <code>figure</code> đã được minify lại thành <code>action-text-attachment </code> để cho gọn hơn.</p>
<p>Hãy cùng điều tra xem tại sao lại như vậy? Trước tiên ta vào xem <code>ActionText::RichText</code> của ta chứa gì ma giáo</p>
<div class="language-ruby codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-ruby codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token plain"># https://github.com/rails/rails/blob/027085a5972a798cfea60f829a9edabbd67a2818/actiontext/app/models/action_text/rich_text.rb#L11</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class ActionText::RichText &lt; ActiveRecord::Base</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  serialize :body, ActionText::Content</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Vậy là <code>body</code> của ta đang được serialize bởi <code>ActionText::Content</code>, mò đến  đó tiếp thôi.</p>
<div class="language-ruby codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-ruby codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token plain"># https://github.com/rails/rails/blob/df8ee09ce71338cdf9816225df1bdebc707f3560/actiontext/lib/action_text/content.rb#L15</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class ActionText::Content</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  class &lt;&lt; self</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def fragment_by_canonicalizing_content(content)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      fragment = ActionText::Attachment.fragment_by_canonicalizing_attachments(content)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      fragment = ActionText::AttachmentGallery.fragment_by_canonicalizing_attachment_galleries(fragment)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      fragment</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  def initialize(content = nil, options = {})</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    options.with_defaults! canonicalize: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if options[:canonicalize]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      @fragment = self.class.fragment_by_canonicalizing_content(content)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    else</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      @fragment = ActionText::Fragment.wrap(content)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Ta sẽ quan tâm tới hàm <code>initialize</code> trước, khi serialize, mặc định là ta đang không dùng tham số, vậy là options sử dụng sẽ là <code>canonicalize: true</code>, xem tiếp <code>fragment_by_canonicalizing_content</code> nào. Có vẻ lại phải mò <code>fragment_by_canonicalizing_attachments</code> tiếp @@</p>
<div class="language-ruby codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-ruby codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token plain"># https://github.com/rails/rails/blob/df8ee09ce7/actiontext/lib/action_text/attachment.rb#L11</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class ActionText::Attachment</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  TAG_NAME = &quot;action-text-attachment&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  SELECTOR = TAG_NAME</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  class &lt;&lt; self</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def fragment_by_canonicalizing_attachments(content)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      fragment_by_minifying_attachments(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        fragment_by_converting_trix_attachments(content)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><code>fragment_by_minifying_attachments</code>, bạn có thấy từ minify không? Có vẻ ta đang đi đúng hướng. Hãy tiếp tục, nhưng hãy bắt đầu bằng <code>fragment_by_converting_trix_attachments</code></p>
<div class="language-ruby codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-ruby codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token plain"># https://github.com/rails/rails/blob/df8ee09ce71338cdf9816225df1bdebc707f3560/actiontext/lib/action_text/attachments/trix_conversion.rb#L9</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">module ActionText::Attachments::TrixConversion</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  class_methods do</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def fragment_by_converting_trix_attachments(content)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Fragment.wrap(content).replace(TrixAttachment::SELECTOR) do |node|</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        from_trix_attachment(TrixAttachment.new(node))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Nôm na là đoạn này sẽ replace toàn bộ <code>ActionText::TrixAttachment::SELECTOR = &quot;[data-trix-attachment]</code> bằng thẻ <code>ActionText::Attachment::SELECTOR = &quot;action-text-attachment&quot;</code>.</p>
<div class="language-ruby codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-ruby codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token plain">module ActionText::Attachments::Minification</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  class_methods do</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    def fragment_by_minifying_attachments(content)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Fragment.wrap(content).replace(ActionText::Attachment::SELECTOR) do |node|</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        node.tap { |n| n.inner_html = &quot;&quot; }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Hàm <code>fragment_by_minifying_attachments</code> của chúng ta sẽ remove toàn bộ inner content của thẻ <code>action-text-attachment</code>.</p>
<p>Sau một hồi lòng vòng, cuối cùng ta đã biết được tại sao đống <code>figure</code> rối rắm kia trở thành <code>action-text-attachment</code> gọn gàng hơn rất nhiều.</p>
<h2 class="anchor anchorWithStickyNavbar_FlIw" id="hiển-thị-dữ-liệu">Hiển thị dữ liệu<a href="#hiển-thị-dữ-liệu" class="hash-link" aria-label="Direct link to Hiển thị dữ liệu" title="Direct link to Hiển thị dữ liệu">​</a></h2>
<p>Hãy vào màn hình detail, và thử inspect element, ta sẽ thấy attachment của ta lại trở về dạng đầy đủ:</p>
<div class="language-ruby codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-ruby codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token plain">&lt;%= @post.content =&gt;</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Đây là những gì ta thu được.</p>
<div class="language-html codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-html codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">div</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">class</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">trix-content</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">div</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">a</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">href</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">http://localhost:60100/posts/new</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"></span><br></span><span class="token-line" style="color:#393A34"><span class="token tag" style="color:#00009f">      </span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">http://localhost:60100/posts/new</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">a</span><span class="token tag" style="color:#00009f"></span><br></span><span class="token-line" style="color:#393A34"><span class="token tag" style="color:#00009f">    </span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">div</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">div</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">strong</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">Hello world</span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">br</span><span class="token tag" style="color:#00009f"> </span><span class="token tag punctuation" style="color:#393A34">/&gt;</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">strong</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">action-text-attachment</span><span class="token tag" style="color:#00009f"></span><br></span><span class="token-line" style="color:#393A34"><span class="token tag" style="color:#00009f">      </span><span class="token tag attr-name" style="color:#00a4db">sgid</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">BAh7CEkiCGdpZAY6BkVUSSIvZ2lkOi8vYXBwL0FjdGl2ZVN0b3JhZ2U6OkJsb2IvNz9leHBpcmVzX2luBjsAVEkiDHB1cnBvc2UGOwBUSSIPYXR0YWNoYWJsZQY7AFRJIg9leHBpcmVzX2F0BjsAVDA=--97b885c24fd3d87464525f34a7b6ea117e4c72e6</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"></span><br></span><span class="token-line" style="color:#393A34"><span class="token tag" style="color:#00009f">      </span><span class="token tag attr-name" style="color:#00a4db">content-type</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">application/zip</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"></span><br></span><span class="token-line" style="color:#393A34"><span class="token tag" style="color:#00009f">      </span><span class="token tag attr-name" style="color:#00a4db">url</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">http://localhost:60100/rails/active_storage/blobs/eyJfcmFpbHMiOnsibWVzc2FnZSI6IkJBaHBEQT09IiwiZXhwIjpudWxsLCJwdXIiOiJibG9iX2lkIn19--940badfc5aee704ef3f98085f87f909baf870660/monaco.ttf-master.zip</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"></span><br></span><span class="token-line" style="color:#393A34"><span class="token tag" style="color:#00009f">      </span><span class="token tag attr-name" style="color:#00a4db">filename</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">monaco.ttf-master.zip</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"></span><br></span><span class="token-line" style="color:#393A34"><span class="token tag" style="color:#00009f">      </span><span class="token tag attr-name" style="color:#00a4db">filesize</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">88996</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag" style="color:#00009f"></span><br></span><span class="token-line" style="color:#393A34"><span class="token tag" style="color:#00009f">    </span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">figure</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">class</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">attachment attachment--file attachment--zip</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">figcaption</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">class</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">attachment__caption</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">span</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">class</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">attachment__name</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">monaco.ttf-master.zip</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">span</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">span</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">class</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag attr-value" style="color:#e3116c">attachment__size</span><span class="token tag attr-value punctuation" style="color:#393A34">&quot;</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">86.9 KB</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">span</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">figcaption</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">figure</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">action-text-attachment</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">div</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">div</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Bạn còn nhớ mình ghi ở trên, khi ta viết <code>@post.content</code>, thực chất ta đang gọi <code>@post.content.to_s</code> chứ?</p>
<p>Thử đào sâu vào chút:</p>
<div class="language-ruby codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-ruby codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token plain"># https://github.com/rails/rails/blob/df8ee09ce7/actiontext/lib/action_text/content.rb#L90</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">def to_rendered_html_with_layout</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  renderer.render(partial: &quot;action_text/content/layout&quot;, locals: { content: self })</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">def to_s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  to_rendered_html_with_layout</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-erb codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-erb codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token plain">&lt;%# https://github.com/rails/rails/blob/df8ee09ce7/actiontext/app/views/action_text/content/_layout.html.erb %&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&lt;div class=&quot;trix-content&quot;&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &lt;%= render_action_text_content(content) %&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&lt;/div&gt;</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-ruby codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-ruby codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token plain"># https://github.com/rails/rails/blob/0ec2a907545e47f816993b9fd8cabb552454b1a2/actiontext/app/helpers/action_text/content_helper.rb#L12</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">def render_action_text_content(content)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  sanitize_action_text_content(render_action_text_attachments(content))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">def sanitize_action_text_content(content)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  sanitizer.sanitize(content.to_html, tags: allowed_tags, attributes: allowed_attributes, scrubber: scrubber).html_safe</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">def render_action_text_attachments(content)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  content.render_attachments do |attachment|</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    unless attachment.in?(content.gallery_attachments)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      attachment.node.tap do |node|</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        node.inner_html = render(attachment, in_gallery: false).chomp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  end.render_attachment_galleries do |attachment_gallery|</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    render(layout: attachment_gallery, object: attachment_gallery) do</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      attachment_gallery.attachments.map do |attachment|</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        attachment.node.inner_html = render(attachment, in_gallery: true).chomp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        attachment.to_html</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      end.join(&quot;&quot;).html_safe</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    end.chomp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Đại khái là Rails sẽ sanitize đống rich text của ta để tránh XSS attack, và render template đối với những attachment.</p>
<h2 class="anchor anchorWithStickyNavbar_FlIw" id="integrate-với-active-storage">Integrate với Active Storage<a href="#integrate-với-active-storage" class="hash-link" aria-label="Direct link to Integrate với Active Storage" title="Direct link to Integrate với Active Storage">​</a></h2>
<p>Hãy quay trở lại với model <code>ActionText::RichText</code></p>
<div class="language-ruby codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-ruby codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token plain"># https://github.com/rails/rails/blob/df8ee09ce7/actiontext/app/models/action_text/rich_text.rb#L14</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class ActionText::RichText &lt; ActiveRecord::Base</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  has_many_attached :embeds</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  before_save do</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    self.embeds = body.attachments.map(&amp;:attachable) if body.present?</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Ta dễ dàng hiểu 1 cách tổng quan là Rails sẽ tiến hành extract toàn bộ attachment trong body, gán vào embeds. Sau đó sẽ save đống association này lại.</p>
<p>Thử xem Rails sẽ extract attachments ra làm sao.</p>
<div class="language-ruby codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-ruby codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token plain"># https://github.com/rails/rails/blob/027085a5972a798cfea60f829a9edabbd67a2818/actiontext/lib/action_text/content.rb#L53</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">def attachables</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  @attachables ||= attachment_nodes.map do |node|</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ActionText::Attachable.from_node(node)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># https://github.com/rails/rails/blob/027085a5972a798cfea60f829a9edabbd67a2818/actiontext/lib/action_text/content.rb#L113</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">def attachment_nodes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  @attachment_nodes ||= fragment.find_all(ActionText::Attachment::SELECTOR)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Rails sẽ tìm kiếm tất cả thẻ <code>action-text-attachment</code>, extract những thông tin cần thiết để init được <code>ActiveStorage::Blob</code> object.</p>
<p>Ta cần nghía qua hàm <code>Attachable.from_node</code> nữa</p>
<div class="language-ruby codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-ruby codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token plain"># https://github.com/rails/rails/blob/027085a5972a798cfea60f829a9edabbd67a2818/actiontext/lib/action_text/attachable.rb#L10</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">def from_node(node)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  if attachable = attachable_from_sgid(node[&quot;sgid&quot;])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    attachable</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  elsif attachable = ActionText::Attachables::ContentAttachment.from_node(node)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    attachable</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  elsif attachable = ActionText::Attachables::RemoteImage.from_node(node)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    attachable</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  else</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ActionText::Attachables::MissingAttachable</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Trong trường hợp này, Rails sẽ luôn extract theo strategy là <code>sgid</code>, các bạn không cần quan tâm tới 3 nhánh dưới làm gì cho mất công.</p>
<p>Còn nhớ phần trên mình đã đề cập tới <code>sgid</code> chứ?</p>
<div class="language-js codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-js codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">//github.com/rails/rails/blob/cc1a5d5620c4cd952b27f6c1bbd16d8780a34d0e/actiontext/app/javascript/actiontext/attachment_upload.js#L26</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">https</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">attachment</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">setAttributes</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">sgid</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> attributes</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">attachable_sgid</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">url</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">createBlobUrl</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">attributes</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">signed_id</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> attributes</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">filename</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Callback này được gọi sau khi file được upload thành công. Vậy <code>sgid</code> là cái gì?</p>
<p><code>sigd</code> được encrypt từ <code>id</code> của attachment sau khi upload. Khi gửi lên, server sẽ decrypt nó để lấy lại <code>id</code>, gán attachment vào record.</p>
<p>Tại sao lại cần encrypt? Các bạn cứ tưởng tượng, nếu dùng thẳng id, do ta upload ảnh trước khi tạo record, nên khi gửi params từ client lên, chắc chắn sẽ phải đưa attachment id vào để server lưu đúng association. Client nó gửi đúng thì không sao, nhưng nếu nó gửi id attachment của người khác thì sao? Attachment đó sẽ chuyển chủ ngay lập tức <!-- -->:v<!-- --> Còn nếu encrypt thì user đố mà mò được mã hash của attachment người khác.</p>
<p><code>attachable_from_sgid(node[&quot;sgid&quot;])</code> sẽ trả về <code>ActiveStorage::Blob</code> object</p>
<div class="language-ruby codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-ruby codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token plain"># https://github.com/rails/rails/blob/f1b8bb4e1f16e4029ddf05515db0c01942521116/actiontext/lib/action_text/attachable.rb#L22</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">def from_attachable_sgid(sgid, options = {})</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  method = sgid.is_a?(Array) ? :locate_many_signed : :locate_signed</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  record = GlobalID::Locator.public_send(method, sgid, options.merge(for: LOCATOR_NAME))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  record || raise(ActiveRecord::RecordNotFound)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Nếu không tin, bạn hãy thử <code>rails c</code> và gọi hàm:</p>
<div class="language-ruby codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-ruby codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token plain">GlobalID::Locator.locate_signed(sgid, { for: &quot;attachable&quot; })</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h1>Kết luận</h1>
<p><code>Action Text</code> được thiết kế khá hay, code gọn, tất cả method đều rất ngắn, dễ hiểu.</p>
<p>Do là built-in nên ta cũng chả cần cài cắm gì thêm mệt người. Nếu đã upgrade lên Rails 6, bạn hãy thử trải nghiệm nó xem.</p>
<p>Còn đối với phiên bản thấp hơn, ta cũng có thể áp dụng flow của Action Text để build một package hỗ trợ richtext.</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_qmVs padding--none margin-left--sm"><li class="tag_aHj4"><a class="tag_rlZX tagRegular_E7nr" href="/blog/tags/action-text">action-text</a></li><li class="tag_aHj4"><a class="tag_rlZX tagRegular_E7nr" href="/blog/tags/ruby-on-rails">ruby-on-rails</a></li><li class="tag_aHj4"><a class="tag_rlZX tagRegular_E7nr" href="/blog/tags/web">web</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="https://schema.org/BlogPosting"><meta itemprop="description" content="Một vài lưu ý trước khi bắt đầu."><header><h2 class="title_DEF8" itemprop="headline"><a itemprop="url" href="/blog/tdd-bdd-noi-de-hon-lam">TDD/BDD - Nói dễ hơn làm</a></h2><div class="container_Y0Yj margin-vert--md"><time datetime="2018-09-22T00:00:00.000Z" itemprop="datePublished">September 22, 2018</time> · <!-- -->7 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_fNYc"><div class="avatar margin-bottom--sm"><a href="https://github.com/moonlight8978" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://avatars.githubusercontent.com/u/26299310?v=4" alt="Lê Sĩ Bích" itemprop="image"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/moonlight8978" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Lê Sĩ Bích</span></a></div><small class="avatar__subtitle" itemprop="description">Ruby on Rails/React Developer</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>Một vài lưu ý trước khi bắt đầu.</p>
<ul>
<li>Code demo trong bài sẽ sử dụng rspec, capybara, factory_bot (Ruby/Rails), hướng tới đối tượng Web developer.</li>
<li>Bài viết không tránh khỏi thiếu sót, nếu có chỗ nào không đúng, mọi người cứ quăng gạch ở dưới comment <!-- -->:v</li>
</ul>
<p>Ông cha ta có câu &quot;Dục tốc bất đạt&quot;. Trước khi đi vào chi tiết, ta hãy cùng điểm qua một vài khái niệm trước.</p>
<p>Nếu bạn là một developer, chắc hẳn sẽ không lạ lẫm gì khái niệm &quot;testing&quot;.</p>
<p>Ví dụ khi bạn lập trình chức năng đăng nhập của 1 trang web. Sau một hồi hì hục code, chắc hẳn bạn sẽ vào trang đó, tiến hành đăng nhập, rồi chờ xem code mình có chạy đúng hay không <!-- -->:v</p>
<p>Tuy nhiên giờ đây, đa số đều sử dụng các automated test script để tự động hóa quá trình test. Hơn thế, nó còn giúp những người maintainer sau này có thể hiểu <del>cái đống hổ lốn</del> code bạn để lại chạy như thế nào.</p>
<p>Test khác với Debug.</p>
<p>Các loại test nên chú ý:</p>
<ul>
<li>Unit test: test riêng lẻ từng class/function, viết khá dễ.</li>
<li>Integration test, Feature test: ở đây bắt đầu có sự kết hợp giữa nhiều module với nhau để mô tả 1 (hay nhiều) chức năng của ứng dụng.</li>
</ul>
<p>Màu sắc đặc trưng:</p>
<ul>
<li>Đỏ: xin chia buồn test của bạn đã tạch =))</li>
<li>Xanh: chúc mừng, test đã pass, code của bạn &quot;có thể&quot; đã chạy đúng.</li>
</ul>
<h1>2. TDD - Test Driven Development</h1>
<p>Dịch ra thì sẽ là <strong>Phát triển với trọng tâm là kiểm thử (test)</strong>, hay nôm na là test trước code sau.</p>
<p><img decoding="async" loading="lazy" src="https://images.viblo.asia/bd25076f-2ddb-4b27-888e-d58ab8e8c286.png" alt="TDD" class="img_XBWr"></p>
<ul>
<li>
<p>Trước tiên ta viết các test script và chạy chúng, tất nhiên là sẽ fail vì làm gì có code =))</p>
<p>VD ta muốn viết 1 hàm tính số Fibonacci:</p>
<p><img decoding="async" loading="lazy" src="https://wikimedia.org/api/rest_v1/media/math/render/svg/6693d2c78bc8132bb9b65be861148ca574a738ef" alt="Fibonacci" class="img_XBWr"></p>
<div class="language-ruby codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-ruby codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token plain"># spec/fibonacci_spec.rb</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">describe &quot;#fibonacci_of&quot; do</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  context &quot;one&quot; do</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    it &quot;returns 1&quot; do</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      expect(fibonacci_of(1)).to eq 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  context &quot;two&quot; do</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    it &quot;returns 1&quot; do</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      expect(fibonacci_of(2)).to eq 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  context &quot;greater than two&quot; do</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    it &quot;returns sum of two elements before&quot; do</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      expect(fibonacci_of(4)).to eq 3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
</li>
<li>
<p>Rồi ta mới bắt tay vào code, chạy test, nếu fail thì lại hì hục sửa, hỏng đâu vá đó. Lúc này bạn chưa cần bận tâm về việc code mình có dễ hiểu/đẹp không.</p>
<p>Và sau 1 hồi thì cuối cùng test ta cũng pass <!-- -->:v</p>
<div class="language-ruby codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-ruby codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token plain"># fibonacci.rb</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">def fibonacci_of(n)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  case n</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  when 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  when 2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  else</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    fibonacci_of(n - 1) + fibonacci_of(n - 2)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
</li>
<li>
<p>Ta sẽ nhìn lại đống hổ lốn mà ta vừa viết ra, tỉa tót lại cho đẹp mắt, tách service các thứ. Và nhớ rằng đừng làm cho test đỏ lòm.</p>
<div class="language-ruby codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-ruby codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token plain"># fibonacci.rb</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">def fibonacci_of(n)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  return 1 if [1, 2].include?(n)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  fibonacci_of(n - 1) + fibonacci_of(n - 2)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
</li>
</ul>
<p><strong>Lưu ý:</strong> Không phải cứ test pass là app của ta đã chạy đúng, việc này còn bao gồm nhiều yếu tố khác như</p>
<ul>
<li>Ta có hiểu đúng yêu cầu của khách hàng không</li>
<li>Test của ta đã bao gồm hết các trường hợp có thể chưa</li>
</ul>
<p>Có thể dễ dàng nhận thấy, hàm <code>#fibonacci_of</code> ở trên sẽ chết ngay lập tức nếu gặp tham số <code>&lt;= 0</code>.</p>
<h1>3. BDD - Behavior Driven Development</h1>
<p><img decoding="async" loading="lazy" src="http://blog.andolasoft.com/wp-content/uploads/2015/05/TDD-vs-BDD.jpg" alt="BDD" class="img_XBWr"></p>
<p>Kế thừa người tiền nhiệm TDD với phương châm &quot;Test trước code sau&quot;, BDD chỉ khác chút là ta sẽ tập trung vào hành vi người dùng (feature).</p>
<p>Theo đó, ta sẽ viết các feature test trước (mô tả một tính năng của ứng dụng, hoặc usecase/userstory). Với mỗi feature test đó, ta có thể sẽ phải triển khai thêm 1 vài unit test/integration test cho các class/function cần thiết trong feature test.</p>
<p>Ví dụ: Ta muốn xây dựng tính năng tạo album cho ứng dụng quản lý album nhạc.</p>
<p>Trước hết hãy hình dung tính năng này trong đầu:</p>
<blockquote>
<p>Admin từ trang index albums (/albums), bấm nút &quot;Add album&quot;, 1 form sẽ hiện ra để nhập thông tin album (bao gồm title và artist name).</p>
<p>Nếu anh admin này nhập đúng, hãy redirect sang trang index và hiển thị album mới này, còn không thì hãy hiện lỗi để anh admin còn biết đường mà lần.</p>
</blockquote>
<p>Feature test của ta sẽ như sau:</p>
<div class="language-ruby codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-ruby codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token plain"># spec/features/create_album_spec.rb</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RSpec.feature &quot;album creating process&quot;, type: :feature do</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  context &quot;all fields are filled correctly&quot; do</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    it &quot;create a new album&quot; do</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      visit &#x27;/albums&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      click_link &#x27;Add album&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      within &#x27;form#album_form&#x27; do</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        fill_in &#x27;Title&#x27;, with: &#x27;Chay ngay di&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        fill_in &#x27;Artist name&#x27;, with: &quot;Sep&#x27;ss&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      click_button &#x27;Create&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      expect(page).to have_content(&#x27;Chay ngay di&#x27;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  context &quot;title is blank&quot; do</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    it &quot;show errors&quot; do</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      visit &#x27;/albums&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      click_link &#x27;Add album&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      within &#x27;form#album_form&#x27; do</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        fill_in &#x27;Artist name&#x27;, with: &quot;Sep&#x27;ss&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      click_button &#x27;Create&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      expect(page).to have_content(&quot;Title can&#x27;t be blank&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Nếu làm theo đúng flow của Rails, ta sẽ phải viết unit test cho:</p>
<ul>
<li>Controller: index, create - test xem logic bên trong đã đúng chưa, status code ra sao.</li>
<li>View: new, index - test xem trường hợp có lỗi thì form hiển thị sao, hay trường hợp không có album thì view index có thông báo cho người dùng biết hay không.</li>
<li>Model: album - test xem validate có hoạt động hay không.</li>
</ul>
<p>Chi tiết thì mình xin lược bớt vì dài quá, bạn có thể tham khảo thêm ở <a href="http://hanamirb.org/guides/1.2/getting-started/" target="_blank" rel="noopener noreferrer">đây</a>.</p>
<p>Nếu bạn băn khoăn nên test cái gì trong Rails, có thể tham khảo bài <a href="https://m.patrikonrails.com/how-i-test-my-rails-applications-cf150e347a6b" target="_blank" rel="noopener noreferrer">này</a>.</p>
<h1>3. Các nguyên tắc khi viết test (TDD)</h1>
<ol>
<li>
<p>Chỉ viết code khi nó cần thiết để test của bạn pass.</p>
<p>VD bạn viết một hàm lấy về email của người dùng theo <code>id</code>.</p>
<div class="language-ruby codeBlockContainer_TxQF theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_If66"><pre tabindex="0" class="prism-code language-ruby codeBlock_vqFy thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_jmgN"><span class="token-line" style="color:#393A34"><span class="token plain">def get_user_mail_by_id(id)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  user = User.find(id)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  user.mail</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">end</span><br></span></code></pre><div class="buttonGroup_DYdX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_PLQI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_k4AK"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_OnZW"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Ở đây bắt buộc phải truy vấn CSDL để tìm ra user. Không dùng <code>find</code> thì lấy thông tin user thế nào <!-- -->:v</p>
</li>
<li>
<p>Chỉ viết nên unit test trong phạm vi vừa đủ.</p>
</li>
</ol>
<h1>4. Ưu điểm</h1>
<ul>
<li>
<p>Những người não to trên thế giới đã chứng minh được TDD giúp thay đổi mindset của bạn, và bạn sẽ trở thành những lập trình viên tốt hơn.</p>
<p>Nó đòi hỏi bạn phải thu tập trung hơn vào những chi tiết nhỏ để test của mình pass, hơn là suy nghĩ vẩn vơ về cả cái app to đùng.</p>
</li>
<li>
<p>Ngoài kiểm thử, test cũng là docs cho maintainer sau này, nó cung cấp chi tiết về các đặc tả kỹ thuật (specification) của app.</p>
</li>
<li>
<p>Ít bug hơn, dễ bảo trì, phát hiện lỗi sớm.</p>
</li>
<li>
<p>Cho bạn biết code mà bạn vừa viết xong nó làm hỏng cả app không =))</p>
</li>
</ul>
<h1>5. Kết luận</h1>
<ul>
<li>
<p>TDD/BDD thực sự rất tốt, nếu bạn muốn trở thành một lập trình viên tốt hơn, hãy cố gắng tryhard <!-- -->:v</p>
</li>
<li>
<p>Thường mọi người hay có xu hướng code xong mới viết test, và mình cũng là một trong số đó =)). Tuy vậy, hãy cố gắng viết test case của mình thật minh bạch, dễ hiểu, vì chính bản thân ta và các maintainer sau này.</p>
</li>
</ul>
<h1>6. Tham khảo</h1>
<ul>
<li>
<p><a href="https://medium.com/pacroy/test-driven-development-tdd-resource-site-tdd-pacroy-com-a02e02396f32" target="_blank" rel="noopener noreferrer">Test-Driven Development (TDD) Resource Site</a></p>
</li>
<li>
<p><a href="http://blog.andolasoft.com/2014/06/rails-things-you-must-know-about-tdd-and-bdd.html" target="_blank" rel="noopener noreferrer">Rails: Things you must know about TDD and BDD</a></p>
</li>
<li>
<p><a href="https://www.madetech.com/blog/9-benefits-of-test-driven-development" target="_blank" rel="noopener noreferrer">9 Benefits of Test Driven Development</a></p>
</li>
<li>
<p><a href="https://apiumhub.com/tech-blog-barcelona/advantages-of-test-driven-development/" target="_blank" rel="noopener noreferrer">20 ADVANTAGES OF TEST DRIVEN DEVELOPMENT</a></p>
</li>
<li>
<p><a href="http://hanamirb.org/guides/1.2/getting-started/" target="_blank" rel="noopener noreferrer">Hanami Official Guide</a></p>
</li>
<li>
<p><a href="https://m.patrikonrails.com/how-i-test-my-rails-applications-cf150e347a6b" target="_blank" rel="noopener noreferrer">How I test Rails applications</a></p>
</li>
</ul></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_qmVs padding--none margin-left--sm"><li class="tag_aHj4"><a class="tag_rlZX tagRegular_E7nr" href="/blog/tags/tdd">tdd</a></li><li class="tag_aHj4"><a class="tag_rlZX tagRegular_E7nr" href="/blog/tags/bdd">bdd</a></li><li class="tag_aHj4"><a class="tag_rlZX tagRegular_E7nr" href="/blog/tags/testing">testing</a></li><li class="tag_aHj4"><a class="tag_rlZX tagRegular_E7nr" href="/blog/tags/ruby-on-rails">ruby-on-rails</a></li></ul></div></footer></article><nav class="pagination-nav" aria-label="Blog list page navigation"></nav></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs/intro">Tutorial</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Overflow<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_sT5S"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://discordapp.com/invite/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_sT5S"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_sT5S"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/facebook/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_sT5S"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2024 My Project, Inc. Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>