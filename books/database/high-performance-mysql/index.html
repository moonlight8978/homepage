<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.0">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="moonlight8978's Blog Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="moonlight8978's Blog Blog Atom Feed"><title data-react-helmet="true">High Performance MySQL | moonlight8978&#x27;s Blog</title><meta data-react-helmet="true" property="og:url" content="https://moonlight8978.github.io/books/database/high-performance-mysql"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-books-current"><meta data-react-helmet="true" property="og:title" content="High Performance MySQL | moonlight8978&#x27;s Blog"><meta data-react-helmet="true" name="description" content="Architecture"><meta data-react-helmet="true" property="og:description" content="Architecture"><link data-react-helmet="true" rel="shortcut icon" href="https://avatars.githubusercontent.com/u/26299310?v=4"><link data-react-helmet="true" rel="canonical" href="https://moonlight8978.github.io/books/database/high-performance-mysql"><link data-react-helmet="true" rel="alternate" href="https://moonlight8978.github.io/books/database/high-performance-mysql" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://moonlight8978.github.io/books/database/high-performance-mysql" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.5f3c8191.css">
<link rel="preload" href="/assets/js/runtime~main.40b7a2b6.js" as="script">
<link rel="preload" href="/assets/js/main.51f3c1f2.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#main" class="skipToContent_1oUP">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle" type="button" tabindex="0"><svg aria-label="Menu" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><img src="https://avatars.githubusercontent.com/u/26299310?v=4" alt="moonlight8978" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="https://avatars.githubusercontent.com/u/26299310?v=4" alt="moonlight8978" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><strong class="navbar__title">_MoonLight_</strong></a><a class="navbar__item navbar__link" href="/blog">Blog</a><a class="navbar__item navbar__link" href="/docs/intro">Programming notes</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/books/intro">Book notes</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/facebook/docusaurus" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub</a><div class="react-toggle displayOnlyInLargeViewport_GrZ2 react-toggle--disabled" role="button" tabindex="-1"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_71bT">🌜</span></div><div class="react-toggle-track-x"><span class="toggle_71bT">🌞</span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/"><img src="https://avatars.githubusercontent.com/u/26299310?v=4" alt="moonlight8978" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="https://avatars.githubusercontent.com/u/26299310?v=4" alt="moonlight8978" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><strong class="navbar__title">_MoonLight_</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/blog">Blog</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/intro">Programming notes</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link navbar__link--active" href="/books/intro">Book notes</a></li><li class="menu__list-item"><a href="https://github.com/facebook/docusaurus" target="_blank" rel="noopener noreferrer" class="menu__link">GitHub</a></li></ul></div></div></div></nav><div class="main-wrapper docs-wrapper doc-page"><div class="docPage_31aa"><div class="docSidebarContainer_3Kbt" role="complementary"><div class="sidebar_15mo"><div class="menu menu--responsive thin-scrollbar menu_Bmed"><button aria-label="Open menu" aria-haspopup="true" class="button button--secondary button--sm menu__button" type="button"><svg aria-label="Menu" class="sidebarMenuIcon_fgN0" width="24" height="24" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/books/intro">Intro</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">AWS Certified Developer - Associated</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/books/aws-developer-associated/intro">Intro</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/books/aws-developer-associated/api-gateway">AWS API Gateway</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/books/aws-developer-associated/auto-scaling-group">Auto Scaling Group</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/books/aws-developer-associated/ci-cd">CI/CD</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/books/aws-developer-associated/cloud-formation">AWS CloudFormation</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/books/aws-developer-associated/cloud-front">AWS CloudFront</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/books/aws-developer-associated/cloud-trail">AWS Cloud Trail</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/books/aws-developer-associated/code-star">AWS CodeStar</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/books/aws-developer-associated/cognito">AWS Cognito</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/books/aws-developer-associated/dynamo-db">DynamoDB</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/books/aws-developer-associated/ec2">AWS EC2</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/books/aws-developer-associated/ecs">Elastic Container Service</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/books/aws-developer-associated/elasti-cache">AWS Elasti Cache</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/books/aws-developer-associated/elastic-beanstalk">Elastic Beanstalk notes</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/books/aws-developer-associated/elb">Elastic Load Balancer</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/books/aws-developer-associated/event-bridge">AWS EventBridge</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/books/aws-developer-associated/iam">IAM</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/books/aws-developer-associated/kinesis">AWS Kinesis</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/books/aws-developer-associated/kms">AWS KMS</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/books/aws-developer-associated/lambda">Lambda</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/books/aws-developer-associated/parameter-store">AWS SSM Parameter Store</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/books/aws-developer-associated/rds">RDS</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/books/aws-developer-associated/route53">AWS Route 53</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/books/aws-developer-associated/s3">AWS Simple Storage Service</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/books/aws-developer-associated/sam">AWS Serverless Application Model</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/books/aws-developer-associated/secrets-manager">AWS Secrets Manager</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/books/aws-developer-associated/security-group">AWS Security Group</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/books/aws-developer-associated/ses">AWS Simple Email Service</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/books/aws-developer-associated/sns">AWS Simple Notification Service</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/books/aws-developer-associated/sqs">Amazon SQS</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/books/aws-developer-associated/step-functions">AWS Step Functions</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/books/aws-developer-associated/vpc">AWS Virtual Private Cloud</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/books/aws-developer-associated/x-ray">AWS X-Ray</a></li></ul></li><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#!">Database</a><ul class="menu__list"><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--active active" tabindex="0" href="/books/database/high-performance-mysql">High Performance MySQL</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">MySQL Docs - Optimization (Chapter 8)</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/books/mysql-chap8/where">Tối ưu SELECT</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/books/mysql-chap8/subquery">Optimize Subquery với Semijoin transformation</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">World Wide Web</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/books/www/oauth2-in-action">OAuth2 in Action</a></li></ul></li></ul></div></div></div><main class="docMainContainer_3ufF"><div class="container padding-vert--lg docItemWrapper_3FMP"><div class="row"><div class="col docItemCol_3FnS"><div class="docItemContainer_33ec"><article><header><h1 class="docTitle_3a4h">High Performance MySQL</h1></header><div class="markdown"><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="architecture"></a>Architecture<a class="hash-link" href="#architecture" title="Direct link to heading">#</a></h2><p><img alt="Docusaurus" src="/assets/images/architecture-164627ccd1c9c9713bc0d80bce987fae.png"></p><ul><li>First layer: Thread, connection, authentication, ... (những component basic cho mọi ứng dụng client/server)</li><li>Second layer: Logic hại não của MySQL tập trung tại đây: query parsing, analysis, optimization, caching, ...</li><li>Third layer: Storage engine, server layer communicate với layer này thông qua storage engine API.</li></ul><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="concurrency-control"></a>Concurrency control<a class="hash-link" href="#concurrency-control" title="Direct link to heading">#</a></h2><ul><li>MySQL handle ở 2 level: the server level, và storage engine level.</li></ul><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="locking"></a>Locking<a class="hash-link" href="#locking" title="Direct link to heading">#</a></h3><ul><li>Implement locking system to deal with concurrent read/write access<ul><li>Read locks</li><li>Write locks</li></ul></li><li>Table locks:<ul><li>Lowest overhead</li><li>Lock the entire table.</li><li>Write to a table (insert, delete, update, ...) → acquires a write lock → nobody is writing → readers can obtain read locks, which don&#x27;t conflict with other read locks</li><li>Write locks has higher priority than read locks</li><li>Although storage engines can manage their own locks, MySQL also use a variety of locks that are effecient. (e.g. the server use a table-level lock for <code>ALTER TABLE</code>, regardless of the storage engine)</li></ul></li><li>Row locks<ul><li>Offers the greatest concurrency, but also carries the greatest overhead.</li><li>Are implemented in the storage engine, not the server</li></ul></li></ul><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="implicit-locking"></a>Implicit locking<a class="hash-link" href="#implicit-locking" title="Direct link to heading">#</a></h4><p>InnoDB uses a two-phase locking protocol</p><p>Locks can be acquired at any time during a transaction, but it does not release them until a <code>COMMIT</code> or <code>ROLLBACK</code>.</p><p>All locks are released at the same time</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="explicitly-locking"></a>Explicitly locking<a class="hash-link" href="#explicitly-locking" title="Direct link to heading">#</a></h4><ul><li><code>SELECT ... LOCK IN SHARE MODE</code></li><li><code>SELECT ... FOR UPDATE</code></li><li><code>LOCK TABLES</code>, <code>UNLOCK TABLES</code> - implemented in the server, not in the storage engines</li></ul><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="transactions"></a>Transactions<a class="hash-link" href="#transactions" title="Direct link to heading">#</a></h2><ul><li><p>ACID:</p><ul><li>Atomicity: a tx must function as a single indivisible unit of work → either applied or rolled back → all or nothing</li><li>Consistency: always move from one consitent state to the next. If the tx is never committed (crash, etc...), none of the tx&#x27;s changes are ever reflected in the db</li><li>Isolation: the results of a tx are usually invisible to other txs until the tx is complete.</li><li>Durability</li></ul></li><li><p>Downside: db server has to do more work</p><p>→ consider transaction is needed or not</p><p>→ no tx = better performance (use <code>LOCK TABLES</code> instead)</p></li><li><p>Transactions are implemented by the underlying storage engines</p><p>→ Cannot reiably mix different engines within tx</p><p>If transactional and non-transactional tables are mixed in a tx, and a rollback is required, the changes to the non-transactional table cannot be undone</p><p>→ MySQL usually warn or raise error when transactional operations are executed on a nontransactional table.</p></li></ul><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="isolation-levels"></a>Isolation levels<a class="hash-link" href="#isolation-levels" title="Direct link to heading">#</a></h3><p>4 levels, the lower the level, the higher in concurrency &amp; overhead</p><ul><li><p><code>READ UNCOMMITTED</code></p><ul><li>Txs can view the results of uncommitted txs → many problems can occur</li><li>Performance isn&#x27;t much better than the other levels</li><li>Dirty read</li></ul></li><li><p><code>READ COMMITTED</code></p><ul><li>Most db default isolation level. But not MySQL</li><li>Tx will see only thoes changes made by committed txs</li><li>Problem: <em>nonrepeatable read</em> - the same statement can returns different data</li></ul></li><li><p><code>REPEATABLE READ</code></p><ul><li>solve nonrepeatable read problem: it guarantees that any rows a tx reads will look the same in subsequent reads within the same tx</li><li>allows another tricky problem: <em>phantom reads</em> - select a range of rows, another tx inserts a new row to the range, then select the same range again → see that &quot;phantom&quot; row</li><li>InnoDB, XtraDB solve phantom read problem with multiversion concurrent control</li><li>Default MySQL&#x27;s isolation level</li></ul></li><li><p><code>SERIALIZABLE</code></p><ul><li><p>highest level of isolation</p></li><li><p>tx must be ordered so they can&#x27;t possibly conflict (in a nutshell, it places a lock on every row it reads)</p><p>→ a lot of timeout, lock contention</p></li></ul></li></ul><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly mysql"><div tabindex="0" class="prism-code language-mysql codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">SET SESSION TRANSACTION ISOLATION LEVEL READ COMMITTED</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="deadlocks"></a>Deadlocks<a class="hash-link" href="#deadlocks" title="Direct link to heading">#</a></h3><ul><li><p>Two or more tx request locks on each other, create a cycle of depencencies</p><table><thead><tr><th>Timestamp</th><th>Tx 1</th><th>Tx 2</th></tr></thead><tbody><tr><td>1</td><td><code>BEGIN TRANSACTION</code></td><td></td></tr><tr><td>2</td><td><code>UPDATE users SET age = 22 WHERE id = 2</code></td><td></td></tr><tr><td>3</td><td></td><td><code>BEGIN TRANSACTION</code></td></tr><tr><td>4</td><td>done</td><td><code>UPDATE users SET age = 23 WHERE id = 3</code></td></tr><tr><td>5</td><td><code>UPDATE users SET age = 23 WHERE id = 3</code><br>→ Record has been locked in tx 2<br>→ Wait for tx 2 to complete</td><td></td></tr><tr><td>6</td><td></td><td>done</td></tr><tr><td>7</td><td></td><td><code>UPDATE users SET age = 22 WHERE id = 2</code><br>→ Record has been locked in tx 1<br>→ Wait for tx 1 to complete</td></tr></tbody></table></li><li><p>To combat this problem, db systems implements deadlock detection and timeouts.</p><ul><li>InnoDB will notice circular dependencies and return an error instantly</li><li>Others will give up after a specific timeout, which is not always good.</li></ul></li><li><p>Cannot be resolved without rolling back one of the txs</p><ul><li>InnoDB rolls back the transaction that has the fewest exclusive row locks</li></ul></li><li><p>Applications should designed to handle deadlocks</p><ul><li>Many apps simply retry the transaction from the beginning</li></ul></li></ul><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="transaction-logging"></a>Transaction logging<a class="hash-link" href="#transaction-logging" title="Direct link to heading">#</a></h3><ul><li><p>Instead of updating table on disk, the storage engine write a record of change to the transaction log (which on disk too) → very fast</p><p>At some later time, a process can update the table on disk</p><p>Most storage engine use this technique</p></li></ul><ul><li><p>If server crashes before changes to data are made, the storage engine can still recover the changes upon restart</p><p>The recovery method varies between storage engine</p></li></ul><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="autocommit"></a>AUTOCOMMIT<a class="hash-link" href="#autocommit" title="Direct link to heading">#</a></h3><ul><li><p>MySQL&#x27;s default operation mode</p></li><li><p>Unless a tx is explicitly began, it automatically executes each query in a separate transaction.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly mysql"><div tabindex="0" class="prism-code language-mysql codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">SHOW VARIABLES LIKE &#x27;AUTOCOMMIT&#x27;;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># =&gt; ON / OFF</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">SET AUTOCOMMIT = 1;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># 1: ON, 0: OFF</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div></li><li><p><code>AUTOCOMMIT=0</code> → always in a transaction, until a <code>COMMIT</code> or <code>ROLLBACK</code> is issued. MySQL then starts a new transaction immediately.</p></li><li><p>Changing <code>AUTOCOMMIT</code> has no effect on nontransactional tables, such as MyISAM or Memory tables (have no notion of committing or rolling back)</p></li></ul><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="multiversion-concurrency-control---mvcc"></a>Multiversion Concurrency Control - MVCC<a class="hash-link" href="#multiversion-concurrency-control---mvcc" title="Direct link to heading">#</a></h3><ul><li><p>Most of MySQL storage engine use row-level locking in conjunction with a technique for increasing concurrency, known as MVCC.</p></li><li><p>MVCC is not unique to MySQL</p></li><li><p>How MVCC works: Keep a snapshot of the data at some point in time</p><p>→ transactions can see a consistent view of the data</p></li><li><p>Mỗi storage engine có cách implement MVCC khác nihau</p></li><li><p>InnoDB: lưu thêm 2 bản nữa với mỗi record (hidden values), 1 được ghi lại lúc create, và 1 ghi lại lúc expire (hoặc delete).</p><p>Không lưu timestamp của những event trên (create/expire/delete), mà sẽ lưu system version number khi mỗi event đó xảy ra - giá trị này được tăng mỗi khi bắt đầu transaction</p><p>→ Each transaction keeps its own record of the current system version, as the time it began.</p><p>→ Mỗi query cần check version number của mỗi row</p><p>VD:</p><ul><li><code>SELECT</code>: tìm row version at least as old as the transaction (&lt;= transaction version - đảm bảo data không bị outdate). đảm bảo deletion version undefined, hoặc lớn hơn version của transaction (để đảm bảo data chưa bị xoá)</li><li><code>INSERT</code>: records system version number hiện tại với row mới vừa tạo</li><li><code>DELETE</code>: records system version number as the row&#x27;s deletion ID</li><li><code>UPDATE</code>: write new copy of the row, using the system version number for the new row&#x27;s version. also write the system version number as the old row&#x27;s deletion version</li></ul></li><li><p>MVVC giúp cho phần lớn read query không cần lock.</p></li><li><p>Drawback:</p><ul><li>Tốn thêm bộ nhớ</li><li>Phải handle thêm một số operation khác.</li></ul></li><li><p>Chỉ hoạt động trên <code>REPEATABLE READ</code> và <code>READ COMMITTED</code>.</p><ul><li><code>READ UNCOMMITTED</code>: luôn đọc version mới nhất → uncompatible</li><li><code>SERIALIZABLE</code>: read query luôn lock mọi row → uncompatible</li></ul></li></ul><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="innodb"></a>InnoDB<a class="hash-link" href="#innodb" title="Direct link to heading">#</a></h3><ul><li><p>store dữ liệu theo series của 1 hoặc nhiều file, vào tablespace</p></li><li><p>sử dụng MVVC để có high concurrency</p></li><li><p>support cả 4 isolation level, default là <code>REPEATABLE READ</code></p></li><li><p>sử dụng next-key locking để ngăn chặn phantom read</p><ul><li>ngoài việc lock row thì InnoDB lock thêm cả index, để ngăn phantom không insert được vào.</li><li>Table được build trên clustered index (index structure rất khác so với các engine khác)</li></ul></li><li><p>Thay đổi engine</p><ul><li><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly mysql"><div tabindex="0" class="prism-code language-mysql codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">ALTER TABLE mytable ENGINE = InnoDB;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>Cách trên không tối ưu, do server có thể ăn hết resource (disk I/O, cpu)</p></li><li><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly mysql"><div tabindex="0" class="prism-code language-mysql codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">CREATE TABLE innodb_table LIKE myisam_table;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">ALTER TABLE innodb_table ENGINE=InnoDB;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">START TRANSACTION;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">INSERT INTO innodb_table SELECT * FROM myisam_table WHERE id BETWEEN x AND y;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">COMMIT;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>Xử lý theo batch nếu data lớn</p></li></ul></li></ul><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="optimizing-schema-and-data-types"></a>Optimizing Schema and Data Types<a class="hash-link" href="#optimizing-schema-and-data-types" title="Direct link to heading">#</a></h2><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="choosing-optimal-data-types"></a>Choosing optimal data types<a class="hash-link" href="#choosing-optimal-data-types" title="Direct link to heading">#</a></h3><ul><li><p>Smaller is usually better: Use the smallest data type. But never underestimate the range of values we need.</p></li><li><p>Simple is good</p></li><li><p>Avoid <code>NULL</code> if possible:</p><ul><li><p>It&#x27;s harder for MySQL to optimize queries that refer to nullable columns.</p></li><li><p><code>NULL</code> make indexes, index statistics, value comparisons more complicated.</p></li><li><p>More storage space to store, and requies special processing inside MySQL</p></li><li><p>But performance improvement is usually small. But for index columns, avoid making them nullable if possible</p></li></ul></li><li><p>Real numbers</p><ul><li><p><code>FLOAT</code>, <code>DOUBLE</code>: floating-point math. CPU native → faster</p><ul><li>4 bytes/8 bytes</li><li>MySQL sử dụng <code>DOUBLE</code> trong tính toán nội bộ liên quan tới floating-point type</li></ul></li><li><p><code>DECIMAL</code>:</p><ul><li>supports exact math.</li><li>CPU don&#x27;t support the computations directly → chậm → chỉ sử dụng khi cần độ chính xác cao (financial)</li></ul></li><li><p>Cho phép chỉ định độ chính xác</p><ul><li><p><code>DECIMAL</code>: số digit trước và sau decimal point (up to 65 digits)</p><p>→ ảnh hưởng tới space lưu trữ</p></li></ul></li></ul></li><li><p>String</p><ul><li><code>VARCHAR</code><ul><li>variable-length → less storage required</li><li>use 1 or 2 extra bytes to record the value&#x27;s length: 1 byte if the column max length is 255 bytes or less, and 2 bytes if it&#x27;s more</li></ul></li><li><code>CHAR</code><ul><li>Fixed-length</li><li>Trailing spaces will be stripped</li></ul></li></ul></li><li><p>Blob, text</p><ul><li><code>TEXT</code> → <code>SMALLTEXT</code></li><li><code>BLOB</code> → <code>SMALLBLOB</code></li><li>Often store in &quot;external&quot; storage area. Only requires 1-4 bytes of storage space in the row and enough space in external storage to actually hold the value</li><li>Sorting: sorts only the first <code>max_sort_length</code> bytes of the column</li><li>Cannot index the full length, and cannot use the indexes for sorting</li></ul></li><li><p>Enum</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly sql"><div tabindex="0" class="prism-code language-sql codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">CREATE</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">TABLE</span><span class="token plain"> enum_test</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">e </span><span class="token keyword" style="font-style:italic">ENUM</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;fish&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;apple&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;dog&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">NOT</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 88, 116)">NULL</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">INSERT</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">INTO</span><span class="token plain"> enum_test</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">e</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">VALUES</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;fish&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;dog&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;apple&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><ul><li><p>Actually is integers</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly sql"><div tabindex="0" class="prism-code language-sql codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">SELECT</span><span class="token plain"> e </span><span class="token operator" style="color:rgb(137, 221, 255)">+</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">FROM</span><span class="token plain"> enum_test</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># +-------+</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># | e + 0 |</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># +-------+</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># |     1 |</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># |     3 |</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># |     2 |</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># +-------+</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div></li><li><p>Sort by integer values</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly sql"><div tabindex="0" class="prism-code language-sql codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">SELECT</span><span class="token plain"> e </span><span class="token keyword" style="font-style:italic">FROM</span><span class="token plain"> enum_test </span><span class="token keyword" style="font-style:italic">ORDER</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">BY</span><span class="token plain"> e</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># +-------+</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># | e     |</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># +-------+</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># | fish  |</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># | apple |</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># | dog   |</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># +-------+</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>Workaround by using <code>FIELD()</code>. But this prevents MySQL from using the index for sorting</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly sql"><div tabindex="0" class="prism-code language-sql codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">SELECT</span><span class="token plain"> e </span><span class="token keyword" style="font-style:italic">FROM</span><span class="token plain"> enum_test </span><span class="token keyword" style="font-style:italic">ORDER</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">BY</span><span class="token plain"> FIELD</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">e</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;apple&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;dog&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;fish&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div></li></ul></li><li><p>Date, Time</p><ul><li><code>DATETIME</code><ul><li>large range value (year 1001 - 9999), precision of 1s</li><li>Store in YYYYMMDDHH-MMSS format - 8 bytes</li><li>Display in asortable, unambiguous format such as 2008-01-16 22:37:08</li></ul></li><li><code>TIMESTAMP</code><ul><li>Lưu thời gian tính từ 1970-01-01 00:00 GMT tới 2038 - Unix timestamp</li><li>4 bytes</li><li><code>NOT NULL</code> by default</li></ul></li></ul></li><li><p>Bit-Packed</p><ul><li><p><code>BIT</code></p></li><li><p><code>SET</code>: many true/false value → combine into one <code>SET</code></p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly mysql"><div tabindex="0" class="prism-code language-mysql codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">CREATE TABLE acl (perms SET(&#x27;CAN_READ&#x27;, &#x27;CAN_WRITE&#x27;, &#x27;CAN_DELETE&#x27;) NOT NULL);</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div></li></ul></li></ul><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="choosing-identifiers"></a>Choosing identifiers<a class="hash-link" href="#choosing-identifiers" title="Direct link to heading">#</a></h3><ul><li><p>Integer types: usually best choice</p><ul><li>fast</li><li>works with <code>AUTO_INCREMENT</code></li></ul></li><li><p>String: Avoid if possible.</p><ul><li>take up a lot of space</li><li>slower than integer types</li></ul></li></ul><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="beware-of-autogenerated-schemas"></a>BEWARE OF AUTOGENERATED SCHEMAS<a class="hash-link" href="#beware-of-autogenerated-schemas" title="Direct link to heading">#</a></h3><ul><li>Performance problem<ul><li>large <code>VARCHAR</code> for everything</li><li>different types for columns that will be compared in <code>JOIN</code></li></ul></li></ul><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="special-data-types"></a>Special data types<a class="hash-link" href="#special-data-types" title="Direct link to heading">#</a></h3><ul><li>IPv4: It&#x27;s unsigned integers, not string. <code>INET_ATON()</code>, <code>INET_NTOA()</code></li></ul><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="schema-design-gotchas"></a>Schema Design Gotchas<a class="hash-link" href="#schema-design-gotchas" title="Direct link to heading">#</a></h3><ul><li>Too many columns<ul><li>Storage engine API works by copying rows between the server and the storage engine in a row buffer format. The server decodes the buffer into columns. The cost of this conversion depends on the number of columns</li><li>High CPU consumption for wide tables, even though only a few columns were actually used</li></ul></li><li>Too many joins<ul><li>MySQL limit 61 tables per join.</li></ul></li></ul><ul><li><code>ENUM</code>: A new enum cannot be added without an <code>ALTER TABLE</code>, which is a blocking operation.</li><li><code>NULL</code><ul><li><code>NULL</code> can be replaced by a &quot;no value&quot; (zero, special value, empty string, ...). But handling <code>NULL</code> is ofter better than the alternative</li><li>MySQL does index <code>NULL</code></li></ul></li></ul><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="normalization-and-denormalization"></a>Normalization and Denormalization<a class="hash-link" href="#normalization-and-denormalization" title="Direct link to heading">#</a></h3><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="normalized"></a>Normalized<a class="hash-link" href="#normalized" title="Direct link to heading">#</a></h4><ul><li><p>Normalized updates are usually faster than denormalized updates</p></li><li><p>Less duplicated data, less data to change</p></li><li><p>Normalized data are usually smaller</p></li><li><p>Drawbacks: Requires joins, can make some indexing strategies impossible</p></li></ul><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="denormalized"></a>Denormalized<a class="hash-link" href="#denormalized" title="Direct link to heading">#</a></h4><ul><li><p>Avoid joins</p></li><li><p>Even a full table scan can be much faster than a join when the data doesn&#x27;t fit in memory</p></li><li><p>Allows more efficient indexing strategies</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly sql"><div tabindex="0" class="prism-code language-sql codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">SELECT</span><span class="token plain"> message_text</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> user_name</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">FROM</span><span class="token plain"> message</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">INNER</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">JOIN</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">user</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">ON</span><span class="token plain"> message</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">user_id </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">user</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">id</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">WHERE</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">user</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">account_type </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;premium&#x27;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">ORDER</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">BY</span><span class="token plain"> message</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">published </span><span class="token keyword" style="font-style:italic">DESC</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">LIMIT</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">10</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>→ MySQL scan the <code>published</code> index on <code>message</code> table. For each row, it will need to probe into the <code>user</code> table and check whether the user is a premium user.</p><p>→ Inefficient if only a small fraction of users have premium accounts</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly sql"><div tabindex="0" class="prism-code language-sql codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">SELECT</span><span class="token plain"> message_text</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> user_name</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">FROM</span><span class="token plain"> user_message</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">WHERE</span><span class="token plain"> account_type </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;premium&#x27;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">ORDER_BY published </span><span class="token keyword" style="font-style:italic">DESC</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">LIMIT</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">10</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>index on <code>(account_type, published)</code> is needed to make the query efficient</p></li></ul><p>→ Mixture of normalized and denormalized</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="cache-and-summary-tables"></a>Cache and Summary Tables<a class="hash-link" href="#cache-and-summary-tables" title="Direct link to heading">#</a></h3><ul><li><p>Khi cần statistics lớn, với độ chính xác cao.</p><ul><li>Bắt đầu với summary table (ví dụ interval 1h)</li><li>Ta có thể tính được count của 24h gần đây nhất bằng cách lấy tổng count trong 23h từ summary table + với count của 1h tính từ bảng thực </li></ul><p>→ giảm thiểu số lượng data gần count</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly sql"><div tabindex="0" class="prism-code language-sql codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">SELECT</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">SUM</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">cnt</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">FROM</span><span class="token plain"> msg_per_hr</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">WHERE</span><span class="token plain"> hr </span><span class="token operator" style="color:rgb(137, 221, 255)">BETWEEN</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    CONCAT</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">LEFT</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token function" style="color:rgb(130, 170, 255)">NOW</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">14</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;00:00&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">-</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">INTERVAL</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">23</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">HOUR</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token operator" style="color:rgb(137, 221, 255)">AND</span><span class="token plain"> CONCAT</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">LEFT</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token function" style="color:rgb(130, 170, 255)">NOW</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">14</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;00:00&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">-</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">INTERVAL</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">HOUR</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">SELECT</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">COUNT</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">FROM</span><span class="token plain"> message</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">WHERE</span><span class="token plain"> posted </span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;=</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">NOW</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">-</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">INTERVAL</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">24</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">HOUR</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token operator" style="color:rgb(137, 221, 255)">AND</span><span class="token plain"> posted </span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token plain"> CONCAT</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">LEFT</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token function" style="color:rgb(130, 170, 255)">NOW</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">14</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;00:00&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">-</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">INTERVAL</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">23</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">HOUR</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">SELECT</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">COUNT</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">FROM</span><span class="token plain"> message</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">WHERE</span><span class="token plain"> posted </span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;=</span><span class="token plain"> CONCAT</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">LEFT</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token function" style="color:rgb(130, 170, 255)">NOW</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">14</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;00:00&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div></li><li><p>Với các table loại này, có thể dùng storage engine khác để tối ưu.</p></li><li><p>Nếu muốn rebuild summary &amp; cache tables, có thể dùng tới phương pháp &quot;shadow table&quot;</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly mysql"><div tabindex="0" class="prism-code language-mysql codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">DROP TABLE IF EXISTS my_summary_new, my_summary_old;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">CREATE TABLE my_summary_new LIKE my_summary;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># ...populate my_summary_new with new data</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">RENAME TABLE my_summary TO my_summary_old, my_summary_new TO my_summary;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>Có thể giữ lại <code>my_summary</code> để có thể rollback một cách nhanh chóng.</p></li></ul><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="counter-tables"></a>Counter Tables<a class="hash-link" href="#counter-tables" title="Direct link to heading">#</a></h3><p>Concurrency problems when updating the counters</p><p>→ Tạo ra nhiều row, khi increase thì chọn random 1 row để increase. Count bằng cách tính tổng</p><p><strong>Faster reads, Slower writes</strong></p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="indexing"></a>Indexing<a class="hash-link" href="#indexing" title="Direct link to heading">#</a></h3></div></article><div class="margin-vert--xl"><div class="row"><div class="col"><a href="https://github.com/moonlight8978/moonlight8978.github.io/edit/v2/books/books/database/high-performance-mysql.md" target="_blank" rel="noreferrer noopener"><svg fill="currentColor" height="1.2em" width="1.2em" preserveAspectRatio="xMidYMid meet" role="img" viewBox="0 0 40 40" class="iconEdit_2_ui" aria-label="Edit page"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col text--right"><em><small>Last updated on <time datetime="2021-06-03T10:04:20.000Z" class="lastUpdatedDate_1WI_">6/3/2021</time></small></em></div></div></div><div class="margin-vert--lg"><nav class="pagination-nav" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/books/aws-developer-associated/x-ray"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">« AWS X-Ray</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/books/mysql-chap8/where"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Tối ưu SELECT »</div></a></div></nav></div></div></div><div class="col col--3"><div class="tableOfContents_35-E thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#architecture" class="table-of-contents__link">Architecture</a></li><li><a href="#concurrency-control" class="table-of-contents__link">Concurrency control</a><ul><li><a href="#locking" class="table-of-contents__link">Locking</a></li></ul></li><li><a href="#transactions" class="table-of-contents__link">Transactions</a><ul><li><a href="#isolation-levels" class="table-of-contents__link">Isolation levels</a></li><li><a href="#deadlocks" class="table-of-contents__link">Deadlocks</a></li><li><a href="#transaction-logging" class="table-of-contents__link">Transaction logging</a></li><li><a href="#autocommit" class="table-of-contents__link">AUTOCOMMIT</a></li><li><a href="#multiversion-concurrency-control---mvcc" class="table-of-contents__link">Multiversion Concurrency Control - MVCC</a></li><li><a href="#innodb" class="table-of-contents__link">InnoDB</a></li></ul></li><li><a href="#optimizing-schema-and-data-types" class="table-of-contents__link">Optimizing Schema and Data Types</a><ul><li><a href="#choosing-optimal-data-types" class="table-of-contents__link">Choosing optimal data types</a></li><li><a href="#choosing-identifiers" class="table-of-contents__link">Choosing identifiers</a></li><li><a href="#beware-of-autogenerated-schemas" class="table-of-contents__link">BEWARE OF AUTOGENERATED SCHEMAS</a></li><li><a href="#special-data-types" class="table-of-contents__link">Special data types</a></li><li><a href="#schema-design-gotchas" class="table-of-contents__link">Schema Design Gotchas</a></li><li><a href="#normalization-and-denormalization" class="table-of-contents__link">Normalization and Denormalization</a></li><li><a href="#cache-and-summary-tables" class="table-of-contents__link">Cache and Summary Tables</a></li><li><a href="#counter-tables" class="table-of-contents__link">Counter Tables</a></li><li><a href="#indexing" class="table-of-contents__link">Indexing</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><h4 class="footer__title">Docs</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/docs/intro">Self notes</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">More</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/moonlight8978/moonlight8978.github.io" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub</a></li><li class="footer__item"><a href="https://stackoverflow.com/users/8068639/moonlight8978" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Overflow</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2021 moonlight8978. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.40b7a2b6.js"></script>
<script src="/assets/js/main.51f3c1f2.js"></script>
</body>
</html>