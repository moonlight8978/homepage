<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.0">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="moonlight8978's Blog Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="moonlight8978's Blog Blog Atom Feed"><title data-react-helmet="true">Optimize Subquery với Semijoin transformation | moonlight8978&#x27;s Blog</title><meta data-react-helmet="true" property="og:url" content="https://moonlight8978.github.io/books/mysql-chap8/subquery"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-books-current"><meta data-react-helmet="true" property="og:title" content="Optimize Subquery với Semijoin transformation | moonlight8978&#x27;s Blog"><meta data-react-helmet="true" name="description" content="Hoàng thùy link//dev.mysql.com/doc/refman/5.7/en/semijoins.html"><meta data-react-helmet="true" property="og:description" content="Hoàng thùy link//dev.mysql.com/doc/refman/5.7/en/semijoins.html"><link data-react-helmet="true" rel="shortcut icon" href="https://avatars.githubusercontent.com/u/26299310?v=4"><link data-react-helmet="true" rel="canonical" href="https://moonlight8978.github.io/books/mysql-chap8/subquery"><link data-react-helmet="true" rel="alternate" href="https://moonlight8978.github.io/books/mysql-chap8/subquery" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://moonlight8978.github.io/books/mysql-chap8/subquery" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.5f3c8191.css">
<link rel="preload" href="/assets/js/runtime~main.40b7a2b6.js" as="script">
<link rel="preload" href="/assets/js/main.51f3c1f2.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#main" class="skipToContent_1oUP">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle" type="button" tabindex="0"><svg aria-label="Menu" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><img src="https://avatars.githubusercontent.com/u/26299310?v=4" alt="moonlight8978" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="https://avatars.githubusercontent.com/u/26299310?v=4" alt="moonlight8978" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><strong class="navbar__title">_MoonLight_</strong></a><a class="navbar__item navbar__link" href="/blog">Blog</a><a class="navbar__item navbar__link" href="/docs/intro">Programming notes</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/books/intro">Book notes</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/facebook/docusaurus" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub</a><div class="react-toggle displayOnlyInLargeViewport_GrZ2 react-toggle--disabled" role="button" tabindex="-1"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_71bT">🌜</span></div><div class="react-toggle-track-x"><span class="toggle_71bT">🌞</span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/"><img src="https://avatars.githubusercontent.com/u/26299310?v=4" alt="moonlight8978" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="https://avatars.githubusercontent.com/u/26299310?v=4" alt="moonlight8978" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><strong class="navbar__title">_MoonLight_</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/blog">Blog</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/intro">Programming notes</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link navbar__link--active" href="/books/intro">Book notes</a></li><li class="menu__list-item"><a href="https://github.com/facebook/docusaurus" target="_blank" rel="noopener noreferrer" class="menu__link">GitHub</a></li></ul></div></div></div></nav><div class="main-wrapper docs-wrapper doc-page"><div class="docPage_31aa"><div class="docSidebarContainer_3Kbt" role="complementary"><div class="sidebar_15mo"><div class="menu menu--responsive thin-scrollbar menu_Bmed"><button aria-label="Open menu" aria-haspopup="true" class="button button--secondary button--sm menu__button" type="button"><svg aria-label="Menu" class="sidebarMenuIcon_fgN0" width="24" height="24" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/books/intro">Intro</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">AWS Certified Developer - Associated</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/books/aws-developer-associated/intro">Intro</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/books/aws-developer-associated/api-gateway">AWS API Gateway</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/books/aws-developer-associated/auto-scaling-group">Auto Scaling Group</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/books/aws-developer-associated/ci-cd">CI/CD</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/books/aws-developer-associated/cloud-formation">AWS CloudFormation</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/books/aws-developer-associated/cloud-front">AWS CloudFront</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/books/aws-developer-associated/cloud-trail">AWS Cloud Trail</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/books/aws-developer-associated/code-star">AWS CodeStar</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/books/aws-developer-associated/cognito">AWS Cognito</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/books/aws-developer-associated/dynamo-db">DynamoDB</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/books/aws-developer-associated/ec2">AWS EC2</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/books/aws-developer-associated/ecs">Elastic Container Service</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/books/aws-developer-associated/elasti-cache">AWS Elasti Cache</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/books/aws-developer-associated/elastic-beanstalk">Elastic Beanstalk notes</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/books/aws-developer-associated/elb">Elastic Load Balancer</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/books/aws-developer-associated/event-bridge">AWS EventBridge</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/books/aws-developer-associated/iam">IAM</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/books/aws-developer-associated/kinesis">AWS Kinesis</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/books/aws-developer-associated/kms">AWS KMS</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/books/aws-developer-associated/lambda">Lambda</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/books/aws-developer-associated/parameter-store">AWS SSM Parameter Store</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/books/aws-developer-associated/rds">RDS</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/books/aws-developer-associated/route53">AWS Route 53</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/books/aws-developer-associated/s3">AWS Simple Storage Service</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/books/aws-developer-associated/sam">AWS Serverless Application Model</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/books/aws-developer-associated/secrets-manager">AWS Secrets Manager</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/books/aws-developer-associated/security-group">AWS Security Group</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/books/aws-developer-associated/ses">AWS Simple Email Service</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/books/aws-developer-associated/sns">AWS Simple Notification Service</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/books/aws-developer-associated/sqs">Amazon SQS</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/books/aws-developer-associated/step-functions">AWS Step Functions</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/books/aws-developer-associated/vpc">AWS Virtual Private Cloud</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/books/aws-developer-associated/x-ray">AWS X-Ray</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Database</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/books/database/high-performance-mysql">High Performance MySQL</a></li></ul></li><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#!">MySQL Docs - Optimization (Chapter 8)</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/books/mysql-chap8/where">Tối ưu SELECT</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--active active" tabindex="0" href="/books/mysql-chap8/subquery">Optimize Subquery với Semijoin transformation</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">World Wide Web</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/books/www/oauth2-in-action">OAuth2 in Action</a></li></ul></li></ul></div></div></div><main class="docMainContainer_3ufF"><div class="container padding-vert--lg docItemWrapper_3FMP"><div class="row"><div class="col docItemCol_3FnS"><div class="docItemContainer_33ec"><article><header><h1 class="docTitle_3a4h">Optimize Subquery với Semijoin transformation</h1></header><div class="markdown"><p><strong>Hoàng thùy link:</strong> <a href="https://dev.mysql.com/doc/refman/5.7/en/semijoins.html" target="_blank" rel="noopener noreferrer">https://dev.mysql.com/doc/refman/5.7/en/semijoins.html</a></p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="semijoin-là-gì"></a>Semijoin là gì<a class="hash-link" href="#semijoin-là-gì" title="Direct link to heading">#</a></h2><p><strong>Semijoin</strong> là quá trình chuẩn bị trước khi query, optimizer của MySQL có thể sử dụng nhiều strategy như table pullout, duplicate weedout, first match, loose scan, hay materizalization để tối ưu câu lệnh subquery.</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="ví-dụ-về-semijoin"></a>Ví dụ về semijoin<a class="hash-link" href="#ví-dụ-về-semijoin" title="Direct link to heading">#</a></h4><p>Giả sử ta có db về quản lý lớp học, <code>subject</code> là danh sách tất cả các môn học, <code>roster</code> là bảng join của <code>student</code> với <code>subject</code> nhằm thể hiển học sinh đã đăng kí học môn nào. Quan hệ giữa <code>subject</code> và <code>student</code> là many to many.</p><p>Query sau đây sẽ lấy ra được những <code>subject</code> có học sinh đăng kí.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly SQL"><div tabindex="0" class="prism-code language-SQL codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">SELECT subject.id, subject.name</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">FROM subject INNER JOIN roster</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">WHERE subject.id = roster.subject_id;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>Tuy nhiên do là quan hệ many to many, nên trong bảng <code>roster</code> có thể có nhiều <code>subject_id</code> bị trùng lặp. Nên kết quả của query trên có thể sẽ bị duplicate.</p><p>Ta có thể sử dụng <code>SELECT DISTINCT</code> để giải quyết vấn đề này. Tuy nhiên việc query tất, rồi khử đi những giá trị trùng lặp như vậy là không tối ưu.</p><p>Ta có thể giải quyết vấn đề trên bằng việc dùng subquery.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly sql"><div tabindex="0" class="prism-code language-sql codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">SELECT</span><span class="token plain"> subject</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">id</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> subject</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">name</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">FROM</span><span class="token plain"> subject </span><span class="token keyword" style="font-style:italic">INNER</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">JOIN</span><span class="token plain"> roster</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">WHERE</span><span class="token plain"> subject</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">id </span><span class="token operator" style="color:rgb(137, 221, 255)">IN</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">SELECT</span><span class="token plain"> subject_id </span><span class="token keyword" style="font-style:italic">FROM</span><span class="token plain"> roster</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>Câu truy vấn vừa rồi chúng ta sử dụng sẽ sử dụng semijoin.</p><p>Câu truy vấn chính (outer query) có thể sử dụng outer join hoặc inner join. Và reference table có thể là base table, derived table hoặc view.</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="điều-kiện-để-subquery-là-một-semiquery"></a>Điều kiện để subquery là một semiquery<a class="hash-link" href="#điều-kiện-để-subquery-là-một-semiquery" title="Direct link to heading">#</a></h4><p>Subquery phải thỏa mãn những điều kiện sau:</p><ul><li>Phải là <code>IN</code> (hoặc <code>=ANY</code>) subquery, đặt trong mệnh đề <code>WHERE</code> hoặc <code>ON</code> ở top-level.</li><li>Không dùng <code>UNION</code>.</li><li>Không có mệnh đề <code>GROUP BY</code> hoặc <code>HAVING</code>, các aggregate functions.</li><li>Không có <code>ORDER BY</code> đi kèm với <code>LIMIT</code>, chỉ có <code>ORDER_BY</code> thôi thì okay.</li><li>Outer query không dùng <code>STRAIGHT_JOIN</code></li><li>Không có <code>STRAIGHT_JOIN</code> trong subquery.</li><li>Tổng số table cả trong inner query lẫn outer query bé hơn 61 (maximum number of tables permitted in a join)</li></ul><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="strategy"></a>Strategy<a class="hash-link" href="#strategy" title="Direct link to heading">#</a></h4><p>Nếu thỏa mãn những điều kiện trên, MySQL sẽ convert subquery thành semijoin và thực hiện tính toán cost, rồi chọn một trong những strategy sau:</p><ul><li><p>Table pullout: Convert subquery thành join. Hoặc sẽ lấy table trong inner query ra, truy vấn, sau đó inner join với outer table.</p></li><li><p><a href="https://mariadb.com/kb/en/library/duplicateweedout-strategy/" target="_blank" rel="noopener noreferrer">Duplicate Weedout</a>: Join table, lấy ra toàn bộ kết quả trước, sau đó sử dụng bảng tạm để remove đi những giá trị duplicate</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly sql"><div tabindex="0" class="prism-code language-sql codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">select</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">from</span><span class="token plain"> Country</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">where</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   Country</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">code </span><span class="token operator" style="color:rgb(137, 221, 255)">IN</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">select</span><span class="token plain"> City</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">Country</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    </span><span class="token keyword" style="font-style:italic">from</span><span class="token plain"> City</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    </span><span class="token keyword" style="font-style:italic">where</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                      City</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">Population </span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">0.33</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token plain"> Country</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">Population </span><span class="token operator" style="color:rgb(137, 221, 255)">and</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                      City</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">Population </span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token number" style="color:rgb(247, 140, 108)">1000</span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token number" style="color:rgb(247, 140, 108)">1000</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p><img src="https://mariadb.com/kb/en/duplicateweedout-strategy/+image/duplicate-weedout-diagram" alt="duplicate-weedout-diagram"></p></li><li><p><a href="https://mariadb.com/kb/en/library/firstmatch-strategy/" target="_blank" rel="noopener noreferrer">First Match</a>: inner join table, khi tìm được một kết quả thỏa mãn, nó sẽ return luôn, không tìm giá trị tiếp theo nữa để tránh duplicate</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly sql"><div tabindex="0" class="prism-code language-sql codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">select</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">from</span><span class="token plain"> Country</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">where</span><span class="token plain"> Country</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">code </span><span class="token operator" style="color:rgb(137, 221, 255)">IN</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">select</span><span class="token plain"> City</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">Country</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                       </span><span class="token keyword" style="font-style:italic">from</span><span class="token plain"> City</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                       </span><span class="token keyword" style="font-style:italic">where</span><span class="token plain"> City</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">Population </span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token number" style="color:rgb(247, 140, 108)">1000</span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token number" style="color:rgb(247, 140, 108)">1000</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token operator" style="color:rgb(137, 221, 255)">and</span><span class="token plain"> Country</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">continent</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;Europe&#x27;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p><img src="https://mariadb.com/kb/en/firstmatch-strategy/+image/firstmatch-firstmatch" alt="firstmatch-firstmatch"></p></li><li><p><a href="https://mariadb.com/kb/en/library/loosescan-strategy/" target="_blank" rel="noopener noreferrer">Loose Scan</a>: Scan subquery table bằng index, group những giá trị giống nhau lại thành từng group, rồi lấy một giá trị từ mỗi group.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly sql"><div tabindex="0" class="prism-code language-sql codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">select</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">from</span><span class="token plain"> Country</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">where</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  Country</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">code </span><span class="token operator" style="color:rgb(137, 221, 255)">in</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">select</span><span class="token plain"> country_code </span><span class="token keyword" style="font-style:italic">from</span><span class="token plain"> Satellite</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p><img src="https://mariadb.com/kb/en/loosescan-strategy/+image/loosescan-diagram-no-where" alt="loosescan-diagram-no-where"></p></li><li><p>Materialization: Đề cập riêng ở dưới</p></li></ul><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="một-vài-lưu-ý"></a>Một vài lưu ý:<a class="hash-link" href="#một-vài-lưu-ý" title="Direct link to heading">#</a></h4><ul><li><p>Có thể enable/disable semijoin, strategy bằng biến <code>optimizer_switch</code></p></li><li><p>Khi disable <code>duplicateweedout</code>, strategy này sẽ không được sử dụng trừ khi tất cả những strategy khác đều không áp dụng được để tối ưu.</p></li></ul><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="explain-query"></a>EXPLAIN query<a class="hash-link" href="#explain-query" title="Direct link to heading">#</a></h4><ul><li><p>Semijoin table sẽ được hiển thị ở outer select</p></li><li><p>Temporary table được sử dụng sẽ được chỉ ra bằng <strong>Start temporary</strong> và <strong>End temporary</strong> trong cột <code>extra</code></p></li><li><p><strong>FirstMatch(table_name)</strong> trong cột <code>extra</code> cho ta biết shortcut đã được dùng trong strategy First Match.</p></li><li><p><strong>LooseScan(m..n)</strong> trong cột <code>extra</code> chỉ ra rằng Loose Scan đã được áp dụng, m, n là key part number.</p></li><li><p>Temporary table dùng cho materialization được chỉ ra bằng những row có <strong>select_type</strong> của <strong>MATERIALIZED</strong> và những row có <strong>table</strong> của <strong>subqueryN</strong></p></li></ul><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="materialization"></a>Materialization<a class="hash-link" href="#materialization" title="Direct link to heading">#</a></h2><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="materialization-là-gì"></a>Materialization là gì<a class="hash-link" href="#materialization-là-gì" title="Direct link to heading">#</a></h4><p>Khi thấy subquery và outer query là cùng bố khác ông nội (chả liên quan gì tới nhau), thì subquery hoàn toàn có thể tách riêng ra, thực thi 2 query độc lập, cuối cùng join 2 table đó với nhau. Ý tưởng của strategy này là như vậy.</p><p>Khi sử dụng strategy này, trước hết MySQL sẽ query subquery, sau đó lấy kết quả để tạo 1 bảng tạm (materialize), đánh index để remove duplicate, cuối cùng join với outer table.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly sql"><div tabindex="0" class="prism-code language-sql codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">select</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">from</span><span class="token plain"> Country</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">where</span><span class="token plain"> Country</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">code </span><span class="token operator" style="color:rgb(137, 221, 255)">IN</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">select</span><span class="token plain"> City</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">Country</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                       </span><span class="token keyword" style="font-style:italic">from</span><span class="token plain"> City</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                       </span><span class="token keyword" style="font-style:italic">where</span><span class="token plain"> City</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">Population </span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">7</span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token number" style="color:rgb(247, 140, 108)">1000</span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token number" style="color:rgb(247, 140, 108)">1000</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token operator" style="color:rgb(137, 221, 255)">and</span><span class="token plain"> Country</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">continent</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;Europe&#x27;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p><img src="https://mariadb.com/kb/en/semi-join-materialization-strategy/+image/sj-materialization1" alt="sj-materialization1"></p><p>Khi thực hiện phép join với outer table, có 2 hướng:</p><ul><li><p>Join từ bảng tạm vào outer table</p><p>Nếu làm vậy, ta sẽ phải thực hiện fullscan bảng tạm, sau đó lookup những giá trị đó trong outer table</p><p>=&gt; gọi là Materialization-scan</p></li><li><p>Join từ outer table vào bảng tạm</p><p>Khi đó ta sẽ dùng giá trị ở outer table để lookup trong bảng tạm</p><p>=&gt; gọi là Materialization-lookup</p></li></ul><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="điều-kiện"></a>Điều kiện<a class="hash-link" href="#điều-kiện" title="Direct link to heading">#</a></h4><ul><li><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly sql"><div tabindex="0" class="prism-code language-sql codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">oe_1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> oe_2</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> oe_N</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token operator" style="color:rgb(137, 221, 255)">NOT</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">IN</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">SELECT</span><span class="token plain"> ie_1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> i_2</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> ie_N </span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div></li></ul><p>Nếu predicate có form như trên, <code>oe_1</code> và <code>ie_1</code> không được null.</p><ul><li><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly sql"><div tabindex="0" class="prism-code language-sql codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">oe </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token operator" style="color:rgb(137, 221, 255)">NOT</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">IN</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">SELECT</span><span class="token plain"> ie </span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div></li></ul><p>Predicate form này chấp nhận giá trị null.</p><ul><li>Outer expression và inner expression phải có cùng kiểu dữ liệu</li><li>Inner expression không được là kiểu <code>BLOB</code></li></ul><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="rewrite-sql"></a>Rewrite SQL<a class="hash-link" href="#rewrite-sql" title="Direct link to heading">#</a></h4><p>Khi disable materialization semijoin đi, MySQL có thể sẽ convert câu lệnh subquery của ta.</p><p>VD:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly sql"><div tabindex="0" class="prism-code language-sql codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">SELECT</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">FROM</span><span class="token plain"> t1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">WHERE</span><span class="token plain"> t1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">a </span><span class="token operator" style="color:rgb(137, 221, 255)">IN</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">SELECT</span><span class="token plain"> t2</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">b </span><span class="token keyword" style="font-style:italic">FROM</span><span class="token plain"> t2 </span><span class="token keyword" style="font-style:italic">WHERE</span><span class="token plain"> where_condition</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>Ở ví dụ trên, subquery hoàn toàn không liên quan gì tới outer query, nếu bình thường là có thể dùng materialization rồi, nhưng nếu ta disable đi, MySQL sẽ convert lại thành như sau:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly sql"><div tabindex="0" class="prism-code language-sql codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">SELECT</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">FROM</span><span class="token plain"> t1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">WHERE</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">EXISTS</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">SELECT</span><span class="token plain"> t2</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">b </span><span class="token keyword" style="font-style:italic">FROM</span><span class="token plain"> t2 </span><span class="token keyword" style="font-style:italic">WHERE</span><span class="token plain"> where_condition </span><span class="token operator" style="color:rgb(137, 221, 255)">AND</span><span class="token plain"> t1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">a</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain">t2</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">b</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>Inner query và outer query đã trở thành láng giềng với nhau.</p><p>Và cứ mỗi row của <code>t1</code>, sẽ phải lookup 1 lần trong subquery table, khá thốn.</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="example"></a>Example<a class="hash-link" href="#example" title="Direct link to heading">#</a></h4><p>Database structure: <a href="https://github.com/moonlight8978/rsch-glr/blob/mysql/subquery/mysql-optimization/subquery/db/schema.rb" target="_blank" rel="noopener noreferrer">link</a></p><h6><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="first-match"></a>First Match<a class="hash-link" href="#first-match" title="Direct link to heading">#</a></h6><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly sql"><div tabindex="0" class="prism-code language-sql codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">explain</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">select</span><span class="token plain"> cities</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">name </span><span class="token keyword" style="font-style:italic">from</span><span class="token plain"> cities </span><span class="token keyword" style="font-style:italic">where</span><span class="token plain"> id </span><span class="token operator" style="color:rgb(137, 221, 255)">IN</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">select</span><span class="token plain"> city_id </span><span class="token keyword" style="font-style:italic">from</span><span class="token plain"> populations </span><span class="token keyword" style="font-style:italic">where</span><span class="token plain"> number </span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">5000000</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain">\G</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly txt"><div tabindex="0" class="prism-code language-txt codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">*************************** 1. row ***************************</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">           id: 1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  select_type: SIMPLE</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        table: cities</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   partitions: NULL</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">         type: ALL</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">possible_keys: PRIMARY</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          key: NULL</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      key_len: NULL</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          ref: NULL</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">         rows: 7</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">     filtered: 100.00</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        Extra: NULL</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">*************************** 2. row ***************************</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">           id: 1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  select_type: SIMPLE</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        table: populations</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   partitions: NULL</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">         type: ALL</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">possible_keys: index_populations_on_city_id</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          key: NULL</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      key_len: NULL</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          ref: NULL</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">         rows: 7</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">     filtered: 33.33</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        Extra: Using where; FirstMatch(cities); Using join buffer (Block Nested Loop)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">2 rows in set, 1 warning (0.00 sec)</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><h6><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="loose-scan"></a>Loose Scan<a class="hash-link" href="#loose-scan" title="Direct link to heading">#</a></h6><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly sql"><div tabindex="0" class="prism-code language-sql codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">explain</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">select</span><span class="token plain"> cities</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">name </span><span class="token keyword" style="font-style:italic">from</span><span class="token plain"> cities </span><span class="token keyword" style="font-style:italic">where</span><span class="token plain"> id </span><span class="token operator" style="color:rgb(137, 221, 255)">IN</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">select</span><span class="token plain"> city_id </span><span class="token keyword" style="font-style:italic">from</span><span class="token plain"> satellites</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain">\G</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly txt"><div tabindex="0" class="prism-code language-txt codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">*************************** 1. row ***************************</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">           id: 1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  select_type: SIMPLE</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        table: satellites</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   partitions: NULL</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">         type: index</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">possible_keys: index_satellites_on_city_id</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          key: index_satellites_on_city_id</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      key_len: 9</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          ref: NULL</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">         rows: 4</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">     filtered: 50.00</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        Extra: Using where; Using index; LooseScan</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">*************************** 2. row ***************************</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">           id: 1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  select_type: SIMPLE</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        table: cities</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   partitions: NULL</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">         type: eq_ref</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">possible_keys: PRIMARY</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          key: PRIMARY</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      key_len: 8</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          ref: app_development.satellites.city_id</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">         rows: 1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">     filtered: 100.00</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        Extra: NULL</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">2 rows in set, 1 warning (0.00 sec)</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>Đoạn explain trên chỉ ra rằng, bảng <code>satellites</code> đã được áp dụng strategy LooseScan, nó sẽ group những giá trị giống nhau lại, và lấy ra 1 giá trị trong mỗi group.</p><p>Cuối cùng join với bảng <code>cities</code> với access_method <code>eq_ref</code>.</p><h6><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="materialization-1"></a>Materialization<a class="hash-link" href="#materialization-1" title="Direct link to heading">#</a></h6><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly sql"><div tabindex="0" class="prism-code language-sql codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">set</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">session</span><span class="token plain"> optimizer_switch</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;duplicateweedout=off,firstmatch=off,loosescan=off&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">explain</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">select</span><span class="token plain"> cities</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">name </span><span class="token keyword" style="font-style:italic">from</span><span class="token plain"> cities </span><span class="token keyword" style="font-style:italic">where</span><span class="token plain"> id </span><span class="token operator" style="color:rgb(137, 221, 255)">IN</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">select</span><span class="token plain"> city_id </span><span class="token keyword" style="font-style:italic">from</span><span class="token plain"> populations </span><span class="token keyword" style="font-style:italic">where</span><span class="token plain"> number </span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">5000000</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain">\G</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly txt"><div tabindex="0" class="prism-code language-txt codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">*************************** 1. row ***************************</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">           id: 1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  select_type: SIMPLE</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        table: cities</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   partitions: NULL</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">         type: ALL</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">possible_keys: PRIMARY</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          key: NULL</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      key_len: NULL</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          ref: NULL</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">         rows: 7</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">     filtered: 100.00</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        Extra: Using where</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">*************************** 2. row ***************************</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">           id: 1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  select_type: SIMPLE</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        table: &lt;subquery2&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   partitions: NULL</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">         type: eq_ref</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">possible_keys: &lt;auto_key&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          key: &lt;auto_key&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      key_len: 9</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          ref: app_development.cities.id</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">         rows: 1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">     filtered: 100.00</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        Extra: NULL</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">*************************** 3. row ***************************</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">           id: 2</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  select_type: MATERIALIZED</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        table: populations</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   partitions: NULL</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">         type: ALL</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">possible_keys: index_populations_on_city_id,index_populations_on_number</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          key: NULL</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      key_len: NULL</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          ref: NULL</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">         rows: 7</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">     filtered: 57.14</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        Extra: Using where</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">3 rows in set, 1 warning (0.00 sec)</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><ul><li>Row 3 cho thấy bảng populations đã được query, nhưng với điều kiện <code>population &gt; 5000000</code> thì không có index nào được dùng, và nó thực hiện fullscan. MySQL dùng kết quả đó để tạo nên materialized table, chính là bảng <code>&lt;subquery2&gt;</code> ở Row 1.</li><li><code>eq_ref</code> cho thấy <code>&lt;subquery2&gt;</code> và <code>cities</code> đã join với nhau, <code>&lt;subquery2&gt;</code> fullscan =&gt; đây chính là strategy Materialization-Scan.</li></ul><h6><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="rewrite-sql-1"></a>Rewrite SQL<a class="hash-link" href="#rewrite-sql-1" title="Direct link to heading">#</a></h6><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly sql"><div tabindex="0" class="prism-code language-sql codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">explain</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">select</span><span class="token plain"> cities</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">name </span><span class="token keyword" style="font-style:italic">from</span><span class="token plain"> cities </span><span class="token keyword" style="font-style:italic">where</span><span class="token plain"> id </span><span class="token operator" style="color:rgb(137, 221, 255)">IN</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">select</span><span class="token plain"> city_id </span><span class="token keyword" style="font-style:italic">from</span><span class="token plain"> populations</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain">\G</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly txt"><div tabindex="0" class="prism-code language-txt codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">*************************** 1. row ***************************</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">           id: 1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  select_type: PRIMARY</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        table: cities</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   partitions: NULL</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">         type: ALL</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">possible_keys: NULL</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          key: NULL</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      key_len: NULL</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          ref: NULL</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">         rows: 7</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">     filtered: 100.00</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        Extra: Using where</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">*************************** 2. row ***************************</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">           id: 2</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  select_type: DEPENDENT SUBQUERY</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        table: populations</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   partitions: NULL</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">         type: index_subquery</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">possible_keys: index_populations_on_city_id</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          key: index_populations_on_city_id</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      key_len: 9</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          ref: func</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">         rows: 7</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">     filtered: 100.00</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        Extra: Using index</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">2 rows in set, 1 warning (0.00 sec)</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div></div></article><div class="margin-vert--xl"><div class="row"><div class="col"><a href="https://github.com/moonlight8978/moonlight8978.github.io/edit/v2/books/books/mysql-chap8/2-subquery.md" target="_blank" rel="noreferrer noopener"><svg fill="currentColor" height="1.2em" width="1.2em" preserveAspectRatio="xMidYMid meet" role="img" viewBox="0 0 40 40" class="iconEdit_2_ui" aria-label="Edit page"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col text--right"><em><small>Last updated on <time datetime="2021-06-07T07:55:41.000Z" class="lastUpdatedDate_1WI_">6/7/2021</time></small></em></div></div></div><div class="margin-vert--lg"><nav class="pagination-nav" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/books/mysql-chap8/where"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">« Tối ưu SELECT</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/books/www/oauth2-in-action"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">OAuth2 in Action »</div></a></div></nav></div></div></div><div class="col col--3"><div class="tableOfContents_35-E thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#semijoin-là-gì" class="table-of-contents__link">Semijoin là gì</a></li><li><a href="#materialization" class="table-of-contents__link">Materialization</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><h4 class="footer__title">Docs</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/docs/intro">Self notes</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">More</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/moonlight8978/moonlight8978.github.io" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub</a></li><li class="footer__item"><a href="https://stackoverflow.com/users/8068639/moonlight8978" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Overflow</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2021 moonlight8978. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.40b7a2b6.js"></script>
<script src="/assets/js/main.51f3c1f2.js"></script>
</body>
</html>