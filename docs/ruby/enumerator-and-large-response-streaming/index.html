<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.0">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="moonlight8978's Blog Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="moonlight8978's Blog Blog Atom Feed"><title data-react-helmet="true">Enumerator and Large Response Streaming | moonlight8978&#x27;s Blog</title><meta data-react-helmet="true" property="og:url" content="https://moonlight8978.github.io/docs/ruby/enumerator-and-large-response-streaming"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="Enumerator and Large Response Streaming | moonlight8978&#x27;s Blog"><meta data-react-helmet="true" name="description" content="Last updated: 2021-06-04"><meta data-react-helmet="true" property="og:description" content="Last updated: 2021-06-04"><link data-react-helmet="true" rel="shortcut icon" href="https://avatars.githubusercontent.com/u/26299310?v=4"><link data-react-helmet="true" rel="canonical" href="https://moonlight8978.github.io/docs/ruby/enumerator-and-large-response-streaming"><link data-react-helmet="true" rel="alternate" href="https://moonlight8978.github.io/docs/ruby/enumerator-and-large-response-streaming" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://moonlight8978.github.io/docs/ruby/enumerator-and-large-response-streaming" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.5f3c8191.css">
<link rel="preload" href="/assets/js/runtime~main.610c7904.js" as="script">
<link rel="preload" href="/assets/js/main.afbd8574.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#main" class="skipToContent_1oUP">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle" type="button" tabindex="0"><svg aria-label="Menu" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><img src="https://avatars.githubusercontent.com/u/26299310?v=4" alt="moonlight8978" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="https://avatars.githubusercontent.com/u/26299310?v=4" alt="moonlight8978" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><strong class="navbar__title">My Site</strong></a><a class="navbar__item navbar__link" href="/blog">Blog</a><a class="navbar__item navbar__link navbar__link--active" href="/docs/intro">Programming notes</a><a class="navbar__item navbar__link" href="/books/intro">Book notes</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/facebook/docusaurus" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub</a><div class="react-toggle displayOnlyInLargeViewport_GrZ2 react-toggle--disabled" role="button" tabindex="-1"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_71bT">ðŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_71bT">ðŸŒž</span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/"><img src="https://avatars.githubusercontent.com/u/26299310?v=4" alt="moonlight8978" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="https://avatars.githubusercontent.com/u/26299310?v=4" alt="moonlight8978" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><strong class="navbar__title">My Site</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/blog">Blog</a></li><li class="menu__list-item"><a class="menu__link navbar__link--active" href="/docs/intro">Programming notes</a></li><li class="menu__list-item"><a class="menu__link" href="/books/intro">Book notes</a></li><li class="menu__list-item"><a href="https://github.com/facebook/docusaurus" target="_blank" rel="noopener noreferrer" class="menu__link">GitHub</a></li></ul></div></div></div></nav><div class="main-wrapper docs-wrapper doc-page"><div class="docPage_31aa"><div class="docSidebarContainer_3Kbt" role="complementary"><div class="sidebar_15mo"><div class="menu menu--responsive thin-scrollbar menu_Bmed"><button aria-label="Open menu" aria-haspopup="true" class="button button--secondary button--sm menu__button" type="button"><svg aria-label="Menu" class="sidebarMenuIcon_fgN0" width="24" height="24" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/docs/intro">Intro</a></li><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#!">Ruby / Rails</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/ruby/action-text">ActionText</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/ruby/active-storage">ActiveStorage</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/ruby/arel">Arel</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--active active" tabindex="0" href="/docs/ruby/enumerator-and-large-response-streaming">Enumerator and Large Response Streaming</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">DevOps</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/ops/browser-caching-proxy-caching">Caching</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/ops/fluentd-logging">Logging with Fluentd, Logrorate</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Development environment</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/dev-env/javascript">Javascript</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/dev-env/macos">MacOS</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Miscs</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/philosophy/functional-programming">Functional Programming</a></li></ul></li></ul></div></div></div><main class="docMainContainer_3ufF"><div class="container padding-vert--lg docItemWrapper_3FMP"><div class="row"><div class="col docItemCol_3FnS"><div class="docItemContainer_33ec"><article><header><h1 class="docTitle_3a4h">Enumerator and Large Response Streaming</h1></header><div class="markdown"><blockquote><p>Last updated: 2021-06-04</p></blockquote><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="enumerator"></a>Enumerator<a class="hash-link" href="#enumerator" title="Direct link to heading">#</a></h2><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="plain-old-ruby-objects-poros"></a>Plain Old Ruby Objects (POROs)<a class="hash-link" href="#plain-old-ruby-objects-poros" title="Direct link to heading">#</a></h3><ul><li><p>Create an enumerator with block will returns an <code>Enumerator</code> instance with an <code>Enumerator::Generator</code> instance as data source.</p><ul><li><code>Enumerator::Generator</code> can be paused after <code>yielder</code> get called (generate data lazily)</li></ul><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly ruby"><div tabindex="0" class="prism-code language-ruby codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">enumerator = Enumerator.new do |yielder|</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    5.times do |i|</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    puts &quot;i = #{i}&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    yielder &lt;&lt; i</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    end</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">end</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">=&gt; #&lt;Enumerator: #&lt;Enumerator::Generator:0x00007fe6b18839d0&gt;:each&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">enumerator.each do |e|</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  puts &quot;e = #{e}&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">end</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># =&gt; i = 0</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">#    e = 0</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">#    i = 1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">#    e = 1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">#    i = 2</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">#    e = 2</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">#    i = 3</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">#    e = 3</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">#    i = 4</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">#    e = 4</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><ul><li><code>Enumerator</code> datasource is respond to Enumerable method?</li></ul><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly ruby"><div tabindex="0" class="prism-code language-ruby codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">[1, 2].map    =&gt; #&lt;Enumerator: [1, 2]:map&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">[1, 2].select =&gt; #&lt;Enumerator: [1, 2]:select&gt;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div></li><li><p>Custom Enumerator</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly ruby"><div tabindex="0" class="prism-code language-ruby codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">class SampleIterator</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  def brrr(&amp;block)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    puts &quot;1, 2&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    yield(1)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    return 5</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  end</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">end</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">enumerator = SampleIterator.new.enum_for(:brrr)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># =&gt; #&lt;Enumerator: #&lt;SampleIterator:0x00007f2866d45bd0&gt;:brrr&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">b = enumerator.each do |e|</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  puts &quot;e = #{e}&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">end</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">puts &quot;b = #{b}&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># =&gt; 1, 2</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">#    e = 1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">#    b = 5</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div></li></ul><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="stream-large-response-in-rails"></a>Stream large response in Rails<a class="hash-link" href="#stream-large-response-in-rails" title="Direct link to heading">#</a></h2><ul><li>Streaming: <a href="https://api.rubyonrails.org/classes/ActionController/Streaming.html" target="_blank" rel="noopener noreferrer">https://api.rubyonrails.org/classes/ActionController/Streaming.html</a></li><li>Live: <a href="https://api.rubyonrails.org/classes/ActionController/Live.html" target="_blank" rel="noopener noreferrer">https://api.rubyonrails.org/classes/ActionController/Live.html</a></li></ul><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="streaming"></a>Streaming<a class="hash-link" href="#streaming" title="Direct link to heading">#</a></h3><ul><li><p>Usage</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly ruby"><div tabindex="0" class="prism-code language-ruby codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">class PostsController</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  def index</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    response.headers[&quot;Last-Modified&quot;] = Time.current.httpdate</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    render stream: true</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  end</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">end</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div></li><li><p>By default:</p><ul><li>Rails render template first, and then the layout.</li><li>The response is sent to the client after the whole template is rendered, all queries are made, and the layout is processed.</li></ul></li><li><p><code>Streaming</code> reverts the rendering flow</p><ul><li>Render template first</li><li>Stream each part of the layout as they are processed</li></ul></li><li><p>When request</p><ul><li><p>Server will returns the layout first (the header in most time), with response headers, ...</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly html"><div tabindex="0" class="prism-code language-html codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">curl -i localhost:3000 HTTP/1.1 200 OK X-Frame-Options: SAMEORIGIN</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">X-XSS-Protection: 1; mode=block X-Content-Type-Options: nosniff</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">X-Download-Options: noopen X-Permitted-Cross-Domain-Policies: none</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Referrer-Policy: strict-origin-when-cross-origin Last-Modified: Mon, 08 Mar</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">2021 08:27:00 GMT Cache-Control: no-cache Transfer-Encoding: chunked Vary:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Accept Content-Type: text/html; charset=utf-8 X-Request-Id:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">333db74f-4c19-49a3-a141-1780b7205b32 X-Runtime: 0.003117</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token doctype punctuation" style="color:rgb(199, 146, 234);font-style:italic">&lt;!</span><span class="token doctype doctype-tag" style="color:rgb(199, 146, 234);font-style:italic">DOCTYPE</span><span class="token doctype" style="color:rgb(199, 146, 234);font-style:italic"> </span><span class="token doctype name" style="color:rgb(199, 146, 234);font-style:italic">html</span><span class="token doctype punctuation" style="color:rgb(199, 146, 234);font-style:italic">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;</span><span class="token tag" style="color:rgb(255, 85, 114)">html</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;</span><span class="token tag" style="color:rgb(255, 85, 114)">head</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;</span><span class="token tag" style="color:rgb(255, 85, 114)">title</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain">App</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;/</span><span class="token tag" style="color:rgb(255, 85, 114)">title</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;</span><span class="token tag" style="color:rgb(255, 85, 114)">meta</span><span class="token tag" style="color:rgb(255, 85, 114)"> </span><span class="token tag attr-name" style="color:rgb(255, 203, 107)">name</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag attr-value" style="color:rgb(255, 85, 114)">viewport</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag" style="color:rgb(255, 85, 114)"> </span><span class="token tag attr-name" style="color:rgb(255, 203, 107)">content</span><span class="token tag attr-value punctuation attr-equals" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag attr-value" style="color:rgb(255, 85, 114)">width=device-width,initial-scale=1</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag" style="color:rgb(255, 85, 114)"> </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">/&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;/</span><span class="token tag" style="color:rgb(255, 85, 114)">head</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;</span><span class="token tag" style="color:rgb(255, 85, 114)">body</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;/</span><span class="token tag" style="color:rgb(255, 85, 114)">body</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;/</span><span class="token tag" style="color:rgb(255, 85, 114)">html</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div></li><li><p>Response body will be streamed later after the template is ready</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly html"><div tabindex="0" class="prism-code language-html codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;</span><span class="token tag" style="color:rgb(255, 85, 114)">span</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain">1</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;/</span><span class="token tag" style="color:rgb(255, 85, 114)">span</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  0</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;</span><span class="token tag" style="color:rgb(255, 85, 114)">span</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain">2</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;/</span><span class="token tag" style="color:rgb(255, 85, 114)">span</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  0</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;</span><span class="token tag" style="color:rgb(255, 85, 114)">span</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain">3</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;/</span><span class="token tag" style="color:rgb(255, 85, 114)">span</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  0</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;/</span><span class="token tag" style="color:rgb(255, 85, 114)">body</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;/</span><span class="token tag" style="color:rgb(255, 85, 114)">html</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div></li><li><p>If error occurred, server will return a script to redirect to 500 template</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly html"><div tabindex="0" class="prism-code language-html codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;</span><span class="token tag" style="color:rgb(255, 85, 114)">script</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token script language-javascript"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token script language-javascript">  </span><span class="token script language-javascript dom variable" style="color:rgb(191, 199, 213)">window</span><span class="token script language-javascript punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token script language-javascript property-access">location</span><span class="token script language-javascript"> </span><span class="token script language-javascript operator" style="color:rgb(137, 221, 255)">=</span><span class="token script language-javascript"> </span><span class="token script language-javascript operator" style="color:rgb(137, 221, 255)">/</span><span class="token script language-javascript number" style="color:rgb(247, 140, 108)">500.</span><span class="token script language-javascript">html</span></div><div class="token-line" style="color:#bfc7d5"><span class="token script language-javascript"></span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;/</span><span class="token tag" style="color:rgb(255, 85, 114)">script</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div></li></ul></li><li><p>Notes:</p><ul><li>Instance variable won&#x27;t work inside the layout. Use <code>content_for</code>, <code>provide</code>, <code>yield</code> instead</li><li><code>provide</code> is called once for each part, <code>content_for</code> is called multiple times, and are concatenated</li><li>Apply to template only, XML, JSON won&#x27;t work</li></ul></li><li><p>Use case</p><ul><li>Render large data table</li></ul></li></ul><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="actioncontrollerlive"></a>ActionController::Live<a class="hash-link" href="#actioncontrollerlive" title="Direct link to heading">#</a></h3><ul><li><p>Usage</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly ruby"><div tabindex="0" class="prism-code language-ruby codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">class LivesController &lt; ApplicationController</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  include ActionController::Live</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  def show</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    disposition = ActionDispatch::Http::ContentDisposition.format(disposition: &quot;attachment&quot;, filename: &quot;live.csv&quot;)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    response.headers[&quot;Content-Disposition&quot;] = disposition</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    response.headers[&quot;Content-Type&quot;] = &quot;text/csv&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    response.headers[&quot;Last-Modified&quot;] = Time.current.httpdate</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    100.times {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      response.stream.write CSV.generate_line([&quot;1&quot;, &quot;title&quot;, &quot;content&quot;])</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      sleep 0.05</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  ensure</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    response.stream.close</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  end</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">end</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div></li><li><p>Note</p><ul><li>Stream must be close after processed, otherwise the socket will leave open</li><li>The response headers will not available until the stream is over</li><li>Need HTTP 1.1 or higher</li></ul></li><li><p>Request</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly txt"><div tabindex="0" class="prism-code language-txt codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">HTTP/1.1 200 OK</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Server: nginx/1.19.7</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Date: Mon, 08 Mar 2021 08:54:11 GMT</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Content-Type: text/csv</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Transfer-Encoding: chunked</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Connection: keep-alive</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Content-Disposition: attachment; filename=&quot;live.csv&quot;; filename*=UTF-8&#x27;&#x27;live.csv</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Last-Modified: Mon, 08 Mar 2021 08:54:11 GMT</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Cache-Control: no-store, must-revalidate, private, max-age=0</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">X-Request-Id: 1649bd8c-a17f-4413-9406-469aa0a75e9d</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">X-Runtime: 0.004780</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">X-MiniProfiler-Original-Cache-Control: no-cache</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">X-MiniProfiler-Ids: 9dfl9qzc7op6ckrts566,su3q84fa2xlystr0tz7s,2eqh0hmva589dxr9zzy4,7wbhxgbcz4oel99bm67x,vtiyjx7ucywbv85q8jss</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Set-Cookie: __profilin=p%3Dt; path=/; HttpOnly; SameSite=Lax</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">1,title,content</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">1,title,content</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">1,title,content</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">1,title,content</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">1,title,content</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><ul><li>The body is concatenated overtime</li></ul></li></ul><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="actioncontrollermetalresponse_body"></a>ActionController::Metal#response_body=<a class="hash-link" href="#actioncontrollermetalresponse_body" title="Direct link to heading">#</a></h3><ul><li><code>ActionController::Metal#response_body=</code> accept a <code>Enumerator</code> as parameter. So it will lazily generate the needed data, then stream to user client.</li></ul><ul><li><p>Usage</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly ruby"><div tabindex="0" class="prism-code language-ruby codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">respond_to do |format|</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  format.csv do</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    disposition = ActionDispatch::Http::ContentDisposition.format(disposition: &quot;attachment&quot;, filename: &quot;chunked.csv&quot;)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    response.headers[&quot;Content-Disposition&quot;] = disposition</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    response.headers[&quot;Content-Type&quot;] = &quot;text/csv&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    # Tell Rack to stream the content</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    response.headers.delete(&quot;Content-Length&quot;)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    # Don&#x27;t cache anything from this generated endpoint</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    response.headers[&quot;Cache-Control&quot;] = &quot;no-cache&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    # this is a hack to preven middleware from buffering</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    response.headers[&quot;Last-Modified&quot;] = Time.current.httpdate</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    # Don&#x27;t buffer when going through proxy servers</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    response.headers[&quot;X-Accel-Buffering&quot;] = &quot;no&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    self.response_body = Enumerator.new do |yielder|</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      100.times do</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        yielder &lt;&lt; CSV.generate_line([&quot;1&quot;, &quot;title&quot;, &quot;content&quot;])</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        sleep 0.05</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      end</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    end</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  end</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">end</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div></li><li><p>Does not require anything special</p></li><li><p>Request</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly txt"><div tabindex="0" class="prism-code language-txt codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">curl -i localhost/chunk                                                                                                                                            [6804b94]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">HTTP/1.1 200 OK</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Server: nginx/1.19.7</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Date: Mon, 08 Mar 2021 08:56:24 GMT</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Content-Type: text/csv</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Transfer-Encoding: chunked</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Connection: keep-alive</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">X-Frame-Options: SAMEORIGIN</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">X-XSS-Protection: 1; mode=block</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">X-Content-Type-Options: nosniff</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">X-Download-Options: noopen</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">X-Permitted-Cross-Domain-Policies: none</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Referrer-Policy: strict-origin-when-cross-origin</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Content-Disposition: attachment; filename=&quot;chunked.csv&quot;; filename*=UTF-8&#x27;&#x27;chunked.csv</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Cache-Control: no-store, must-revalidate, private, max-age=0</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Last-Modified: Mon, 08 Mar 2021 08:56:24 GMT</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">X-Request-Id: 110883ba-f7d6-47d6-b8f8-d43080362386</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">X-Runtime: 0.017299</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">X-MiniProfiler-Original-Cache-Control: no-cache</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">X-MiniProfiler-Ids: 4909w92x1300zeq1kjfw,su3q84fa2xlystr0tz7s,2eqh0hmva589dxr9zzy4,7wbhxgbcz4oel99bm67x,vtiyjx7ucywbv85q8jss,9dfl9qzc7op6ckrts566</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Set-Cookie: __profilin=p%3Dt; path=/; HttpOnly; SameSite=Lax</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">1,title,content</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">1,title,content</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">1,title,content</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">1,title,content</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">1,title,content</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">1,title,content</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">1,title,content</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">1,title,content</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">1,title,content</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">1,title,content</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">1,title,content</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><ul><li>The body is concatenated overtime</li></ul></li></ul><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="note"></a>Note<a class="hash-link" href="#note" title="Direct link to heading">#</a></h4><ul><li><p>Rails using Rack, which has the following code</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly ruby"><div tabindex="0" class="prism-code language-ruby codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain"># https://github.com/rack/rack/blob/138cba2f49d5c18e91b3dc377a83b9ce1fb70094/lib/rack/etag.rb#L30</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">def call</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  if etag_status?(status) &amp;&amp; etag_body?(body) &amp;&amp; !skip_caching?(headers)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    original_body = body</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    digest, new_body = digest_body(body)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    # ...</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    end</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">end</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">def skip_caching?(headers)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  headers.key?(ETAG_STRING) || headers.key?(&#x27;Last-Modified&#x27;)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">end</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>Even we use Enumerable, the body is still preprocessed to generate the ETag. So, when stream response, we must add <code>Last-Modified</code> header</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly ruby"><div tabindex="0" class="prism-code language-ruby codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">response.headers[&quot;Last-Modified&quot;] = Time.current.httpdate</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div></li><li><p>Nginx will buffer the response (wait until the response is completed), set <code>X-Accel-Buffering</code> header to <code>no</code> to disable it</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly ruby"><div tabindex="0" class="prism-code language-ruby codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">response.headers[&quot;X-Accel-Buffering&quot;] = &quot;no&quot;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div></li></ul><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="other-format"></a>Other format<a class="hash-link" href="#other-format" title="Direct link to heading">#</a></h4><ul><li>JSON</li></ul><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly ruby"><div tabindex="0" class="prism-code language-ruby codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">self.response_body = Enumerator.new do |yielder|</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  yielder &lt;&lt; &quot;[&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  100.times do |index|</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    yielder &lt;&lt; &quot;,&quot; unless index == 0</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    yielder &lt;&lt; { title: &quot;title&quot;, content: &quot;content&quot; }.to_json</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    sleep 0.05</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  end</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  yielder &lt;&lt; &quot;]&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">end</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><ul><li>ZIP<ul><li>Use <a href="https://github.com/WeTransfer/zip_tricks" target="_blank" rel="noopener noreferrer"><code>zip_tricks</code></a></li></ul></li></ul><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly ruby"><div tabindex="0" class="prism-code language-ruby codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">include ZipTricks::RailsStreaming</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">zip_tricks_stream do |zip|</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  zip.write_deflated_file(&quot;users.csv&quot;) do |sink|</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    CSV(sink) do |csv_write|</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      csv_write &lt;&lt; User.column_names</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      User.all.find_each do |user|</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        csv_write &lt;&lt; user.attributes.values</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      end</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    end</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  end</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  zip.write_deflated_file(&quot;posts.csv&quot;) do |sink|</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    # ...</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  end</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">end</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div></div></article><div class="margin-vert--xl"><div class="row"><div class="col"><a href="https://github.com/moonlight8978/moonlight8978.github.io/edit/v2/docs/docs/ruby/enumerator-and-large-response-streaming.md" target="_blank" rel="noreferrer noopener"><svg fill="currentColor" height="1.2em" width="1.2em" preserveAspectRatio="xMidYMid meet" role="img" viewBox="0 0 40 40" class="iconEdit_2_ui" aria-label="Edit page"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col text--right"><em><small>Last updated on <time datetime="2021-06-07T03:11:05.000Z" class="lastUpdatedDate_1WI_">6/7/2021</time></small></em></div></div></div><div class="margin-vert--lg"><nav class="pagination-nav" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/docs/ruby/arel"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Â« Arel</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/docs/ops/browser-caching-proxy-caching"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Caching Â»</div></a></div></nav></div></div></div><div class="col col--3"><div class="tableOfContents_35-E thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#enumerator" class="table-of-contents__link">Enumerator</a><ul><li><a href="#plain-old-ruby-objects-poros" class="table-of-contents__link">Plain Old Ruby Objects (POROs)</a></li></ul></li><li><a href="#stream-large-response-in-rails" class="table-of-contents__link">Stream large response in Rails</a><ul><li><a href="#streaming" class="table-of-contents__link">Streaming</a></li><li><a href="#actioncontrollerlive" class="table-of-contents__link">ActionController::Live</a></li><li><a href="#actioncontrollermetalresponse_body" class="table-of-contents__link">ActionController::Metal#response_body=</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><h4 class="footer__title">Docs</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/docs/intro">Self notes</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">More</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/moonlight8978/moonlight8978.github.io" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub</a></li><li class="footer__item"><a href="https://stackoverflow.com/users/8068639/moonlight8978" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Overflow</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2021 moonlight8978. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.610c7904.js"></script>
<script src="/assets/js/main.afbd8574.js"></script>
</body>
</html>